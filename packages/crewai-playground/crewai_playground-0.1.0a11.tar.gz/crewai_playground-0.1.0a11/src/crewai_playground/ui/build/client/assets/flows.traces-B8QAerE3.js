import{w as le,u as ce}from"./store-BDLt0vbv.js";import{q as de,p as oe,r as m,l as e}from"./chunk-GNGMS2XR-KLeu_BA0.js";import{L as me}from"./Layout-CP5Hc7nX.js";import{F as xe}from"./FlowNavigation-DHrQLs8L.js";import{C as N,a as D,b as F,c as w,d as A}from"./card-DNPziUKJ.js";import{T as ue,a as he,b as B,c as z}from"./tabs-BvsZBTz_.js";import{B as M}from"./badge-CzGG4LGd.js";import{S as G,I as R,T as fe,a as pe,b as je,A as ge,c as Ne,d as we,e as ve}from"./scroll-area-DZ28jUC5.js";import{C as Y,a as Z}from"./separator-CuiPnxqD.js";import{A as be,a as ye,b as Te}from"./alert-DAr1l6eU.js";import{S as Se,i as Ce,j as _e,k as ke,l as Ie}from"./select-CrlOLXkx.js";import{P as L,L as Q}from"./play-BgHo1Tz0.js";import{C as P}from"./clock-D9RgnNZI.js";import"./index-BKaxNvVC.js";import"./chevron-down-BlJJcPQY.js";import"./transform-BEtJ_6wc.js";function Qe(){return[{title:"CrewAI - Flow Traces"},{name:"description",content:"View execution traces for flows"}]}const $=l=>{try{return new Date(l).toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit",fractionalSecondDigits:3})}catch{return"--:--:--"}},J=(l,u)=>{try{const T=new Date(l).getTime(),j=(u?new Date(u).getTime():Date.now())-T;if(j<1e3)return`${j}ms`;if(j<6e4)return`${(j/1e3).toFixed(1)}s`;{const _=Math.floor(j/6e4),b=Math.floor(j%6e4/1e3);return`${_}m ${b}s`}}catch{return"--"}},W=l=>{switch(l.toLowerCase()){case"completed":case"success":return"bg-green-100 text-green-800";case"failed":case"error":return"bg-red-100 text-red-800";case"running":case"started":return"bg-blue-100 text-blue-800";case"initializing":case"pending":return"bg-yellow-100 text-yellow-800";default:return"bg-gray-100 text-gray-800"}},Ee=l=>{switch(l.toLowerCase()){case"completed":case"success":return e.jsx(Y,{className:"h-4 w-4"});case"failed":case"error":return e.jsx(Z,{className:"h-4 w-4"});case"running":case"started":return e.jsx(L,{className:"h-4 w-4"});case"initializing":case"pending":return e.jsx(P,{className:"h-4 w-4"});default:return e.jsx(R,{className:"h-4 w-4"})}};function De(l){var r;const u=Object.keys(l.methods||{}).length,T=((r=l.events)==null?void 0:r.length)||0,v=new Date(l.start_time).getTime(),_=(l.end_time?new Date(l.end_time).getTime():Date.now())-v,b=Object.values(l.methods||{}).filter(p=>p.status==="completed").length,k=Object.values(l.methods||{}).filter(p=>p.status==="failed").length,I=Object.values(l.methods||{}).reduce((p,y)=>p+(y.outputs?JSON.stringify(y.outputs).length:0),0);return{totalMethods:u,totalEvents:T,executionTime:_,completedMethods:b,failedMethods:k,totalOutputSize:I}}const We=le(function(){var H,X;de();const[u,T]=oe(),{flows:v,setFlows:j}=ce(),[_,b]=m.useState(!1),[k,I]=m.useState(null),[r,p]=m.useState(""),[y,O]=m.useState([]),[S,C]=m.useState(null),[Fe,U]=m.useState(null),[V,q]=m.useState(null),[K,ee]=m.useState("overview"),t=m.useMemo(()=>!S||!Array.isArray(y)?null:y.find(s=>s&&s.id===S)||null,[y,S]);m.useEffect(()=>{const s=u.get("flowId"),i=u.get("traceId");s&&p(s),i&&C(i)},[u]),m.useEffect(()=>{const s=new URLSearchParams;r&&s.set("flowId",r),S&&s.set("traceId",S),T(s)},[r,S,T]),m.useEffect(()=>{const s=async()=>{try{const o=await(await fetch("http://localhost:8000/api/flows")).json();o.flows&&(j(o.flows),o.flows.length>0&&!r&&p(o.flows[0].id))}catch(i){console.error("Error fetching flows:",i),I("Failed to fetch flows. Please try again later.")}finally{b(!1)}};v.length?!r&&v.length>0&&p(v[0].id):(b(!0),s())},[v,j,r]),m.useEffect(()=>{const s=u.get("flowId");s&&!r&&p(s)},[u,r]),m.useEffect(()=>{(async()=>{if(!r){O([]),C("");return}try{b(!0),I(null),u.get("flowId")!==r&&T({flowId:r});const o=await(await fetch(`http://localhost:8000/api/flows/${r}/traces`)).json();if(o.status==="success"&&Array.isArray(o.traces)){console.log("Received traces:",o.traces);const h=o.traces.filter(c=>c&&typeof c=="object"&&c.id&&c.start_time!==void 0&&(c.status==="completed"||c.status==="failed"||c.status==="running"||c.status==="initializing"));h.sort((c,g)=>{const n=typeof c.start_time=="number"?c.start_time:0;return(typeof g.start_time=="number"?g.start_time:0)-n}),console.log("Valid traces after filtering:",h),O(h),h.length>0&&!S?C(h[0].id):h.length===0&&C("")}else I(o.detail||"Failed to fetch flow traces"),O([]),C("")}catch(i){console.error("Error fetching flow traces:",i),I("Failed to fetch flow traces. Please try again later."),O([]),C("")}finally{b(!1)}})()},[r]);const d=m.useMemo(()=>t?De(t):null,[t]),se=m.useMemo(()=>{if(!t)return[];const s=[],i=new Date(t.start_time),o=t.end_time?new Date(t.end_time):null,h=o?o.getTime()-i.getTime():0,c={id:t.id,name:`Flow: ${t.flow_name}`,startTime:i,endTime:o,status:t.status,depth:0,duration:h,serviceName:"flow",operation:"execution",children:[]};if(s.push(c),t.events&&t.events.length>0){const n=new Map;t.events.forEach(a=>{if(a.type==="flow.method.execution"){const f=a.method_name||"unknown_method";n.has(f)||n.set(f,{name:f,startTime:null,endTime:null,status:"unknown",events:[]});const x=n.get(f);x.events.push(a);const E=new Date(a.timestamp);a.status==="started"?(x.startTime=E,x.status="running"):(a.status==="completed"||a.status==="failed")&&(x.endTime=E,x.status=a.status)}}),n.forEach((a,f)=>{const x=a.startTime||i,E=a.endTime||null,ie=E?E.getTime()-x.getTime():0,ne={id:`${t.id}-method-${f}`,name:`Method: ${a.name}`,startTime:x,endTime:E,status:a.status,parentId:t.id,depth:1,duration:ie,serviceName:"method",operation:a.name,children:[]};s.push(ne)})}const g=new Map;return s.forEach(n=>g.set(n.id,n)),s.forEach(n=>{n.parentId&&g.has(n.parentId)&&g.get(n.parentId).children.push(n)}),s},[t]),te=s=>{q(s),U(s.id)},ae=()=>_?e.jsxs("div",{className:"flex items-center justify-center p-4",children:[e.jsx(Q,{className:"h-6 w-6 animate-spin mr-2"}),e.jsx("span",{children:"Loading traces..."})]}):k?e.jsx("div",{className:"p-4 text-red-500",children:k}):y.length===0?e.jsx("div",{className:"p-4 text-gray-500 dark:text-gray-400",children:"No traces found."}):e.jsx("div",{className:"space-y-2",children:y.map(s=>e.jsxs("div",{className:`p-3 border rounded-md cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 ${(t==null?void 0:t.id)===s.id?"border-primary bg-gray-50 dark:bg-gray-800":""}`,onClick:()=>{C(s.id),U(null),q(null)},children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"font-medium",children:["Trace ",s.id.slice(0,7)]}),e.jsx(M,{variant:s.status==="completed"?"outline":s.status==="running"?"default":"destructive",className:s.status==="completed"?"bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-300":"",children:s.status})]}),e.jsxs("div",{className:"flex justify-between items-center text-xs text-gray-500 dark:text-gray-400 mt-1",children:[e.jsx("div",{children:$(s.start_time)}),e.jsx("div",{children:J(s.start_time,s.end_time)})]})]},s.id))}),re=e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Flows & Traces"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Select a flow and trace to view details"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Flow"}),e.jsxs(Se,{onValueChange:p,value:r,children:[e.jsx(Ce,{children:e.jsx(_e,{placeholder:"Select a flow"})}),e.jsx(ke,{children:v.map(s=>e.jsx(Ie,{value:s.id,children:s.name},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Traces"}),e.jsx(G,{className:"h-[500px] border rounded-md",children:e.jsx("div",{className:"p-4",children:ae()})})]})]});return e.jsx(me,{rightSidebar:re,children:e.jsxs("div",{className:"w-full",children:[k&&e.jsxs(be,{variant:"destructive",className:"mb-6",children:[e.jsx(ye,{children:"Error"}),e.jsx(Te,{children:k})]}),r&&e.jsx(xe,{flowId:r}),t?e.jsxs(N,{children:[e.jsx(D,{children:e.jsx(F,{children:t.flow_name})}),e.jsx(w,{children:e.jsxs(ue,{defaultValue:"overview",value:K,onValueChange:ee,className:"w-full",children:[e.jsxs(he,{className:"grid grid-cols-3 mb-4",children:[e.jsxs(B,{value:"overview",className:"flex items-center gap-1",children:[e.jsx(R,{className:"h-4 w-4"}),e.jsx("span",{children:"Overview"})]}),e.jsxs(B,{value:"methods",className:"flex items-center gap-1",children:[e.jsx(L,{className:"h-4 w-4"}),e.jsx("span",{children:"Methods"})]}),e.jsxs(B,{value:"events",className:"flex items-center gap-1",children:[e.jsx(P,{className:"h-4 w-4"}),e.jsx("span",{children:"Events"})]})]}),e.jsx(z,{value:"overview",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(N,{children:e.jsx(w,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(L,{className:"h-5 w-5 text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Methods"}),e.jsx("p",{className:"text-2xl font-bold",children:(d==null?void 0:d.totalMethods)||0}),e.jsxs("p",{className:"text-xs text-gray-500",children:[(d==null?void 0:d.completedMethods)||0," ","completed,"," ",(d==null?void 0:d.failedMethods)||0," failed"]})]})]})})}),e.jsx(N,{children:e.jsx(w,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(P,{className:"h-5 w-5 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Events"}),e.jsx("p",{className:"text-2xl font-bold",children:(d==null?void 0:d.totalEvents)||0}),e.jsx("p",{className:"text-xs text-gray-500",children:"Total events captured"})]})]})})}),e.jsx(N,{children:e.jsx(w,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(fe,{className:"h-5 w-5 text-orange-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Execution Time"}),e.jsx("p",{className:"text-2xl font-bold",children:d!=null&&d.executionTime?`${Math.round(d.executionTime/1e3)}s`:"0s"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Total duration"})]})]})})})]}),e.jsxs(N,{children:[e.jsxs(D,{className:"pb-2",children:[e.jsx(F,{className:"text-lg",children:"Flow Summary"}),e.jsx(A,{children:"Overview of flow execution and status"})]}),e.jsxs(w,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"Flow Name"}),e.jsx("div",{className:"text-sm font-mono",children:t.flow_name})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"Status"}),e.jsxs(M,{className:W(t.status),variant:"outline",children:[Ee(t.status),t.status]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"Duration"}),e.jsx("div",{className:"text-sm",children:J(t.start_time,t.end_time)})]})]}),t.output&&e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"Output"}),e.jsx("pre",{className:"text-xs bg-muted p-3 rounded-md overflow-auto max-h-[400px] whitespace-pre-wrap break-words",children:typeof t.output=="string"?t.output:JSON.stringify(t.output,null,2)})]})]})]}),e.jsxs(N,{children:[e.jsxs(D,{className:"pb-2",children:[e.jsx(F,{className:"text-lg",children:"Execution Timeline"}),e.jsx(A,{children:"Visual timeline of flow execution with methods and events"})]}),e.jsx(w,{children:e.jsx(pe,{spans:se,onSpanClick:te})})]}),V&&e.jsxs(N,{children:[e.jsxs(D,{className:"pb-2",children:[e.jsx(F,{className:"text-lg",children:"Span Details"}),e.jsxs(A,{children:["Detailed information for the selected span:"," ",V.name]})]}),e.jsx(w,{children:e.jsx(je,{span:V})})]})]})}),e.jsx(z,{value:"methods",children:e.jsxs(N,{children:[e.jsxs(D,{className:"pb-2",children:[e.jsx(F,{className:"text-lg",children:"Methods"}),e.jsx(A,{children:"Flow execution methods and their details"})]}),e.jsx(w,{children:e.jsx("div",{className:"space-y-4",children:e.jsx(ge,{type:"single",collapsible:!0,className:"w-full",children:Object.entries(t.methods||{}).map(([s,i])=>({...i,id:s,name:i.name||s})).map(s=>e.jsxs(Ne,{value:s.id,children:[e.jsx(we,{className:"hover:bg-muted px-4",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(M,{className:W(s.status),variant:"outline",children:s.status}),e.jsx("span",{className:"ml-2 font-medium",children:s.name})]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:J(s.start_time,s.end_time)})]})}),e.jsxs(ve,{className:"px-4 py-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Method ID"}),e.jsx("div",{className:"text-sm font-mono",children:s.id}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Start Time"}),e.jsx("div",{children:$(s.start_time)}),s.end_time&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"End Time"}),e.jsx("div",{children:$(s.end_time)})]})]}),s.outputs&&Object.keys(s.outputs).length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"Outputs"}),e.jsx("pre",{className:"text-xs bg-muted p-3 rounded-md overflow-auto max-h-[200px]",children:JSON.stringify(s.outputs,null,2)})]})]})]},s.id))})})})]})}),e.jsx(z,{value:"events",children:e.jsxs(N,{children:[e.jsxs(D,{className:"pb-2",children:[e.jsx(F,{className:"text-lg",children:"Events"}),e.jsx(A,{children:"Chronological timeline of flow execution events"})]}),e.jsx(w,{children:e.jsx(G,{className:"h-[600px]",children:e.jsx("div",{className:"space-y-2",children:(X=(H=t.events)==null?void 0:H.sort((s,i)=>new Date(s.timestamp).getTime()-new Date(i.timestamp).getTime()))==null?void 0:X.map((s,i)=>{const o=s.type.toLowerCase(),h=s.status==="completed",c=s.status==="failed",g=s.status==="started";let n="bg-gray-50 dark:bg-gray-900/20",a="border-gray-200 dark:border-gray-700",f="text-gray-500",x=R;return h?(n="bg-green-50 dark:bg-green-900/20",a="border-green-200 dark:border-green-700",f="text-green-600",x=Y):c?(n="bg-red-50 dark:bg-red-900/20",a="border-red-200 dark:border-red-700",f="text-red-600",x=Z):g&&(n="bg-blue-50 dark:bg-blue-900/20",a="border-blue-200 dark:border-blue-700",f="text-blue-600",x=P),o.includes("method")&&(x=L,!c&&!h&&!g&&(f="text-purple-600")),e.jsxs("div",{className:`border rounded-md p-3 ${n} ${a}`,children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{className:`h-4 w-4 ${f}`}),e.jsxs("div",{children:[e.jsx(M,{variant:h?"default":c?"destructive":"secondary",className:"text-xs",children:s.type}),e.jsxs("div",{className:"text-sm font-medium mt-1",children:["Method: ",s.method_name]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Status: ",s.status]})]})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:$(s.timestamp)})]}),(s.outputs||s.params||s.input_state||s.error)&&e.jsxs("details",{className:"mt-3",children:[e.jsx("summary",{className:"text-sm font-medium cursor-pointer hover:text-primary",children:"View Event Data"}),e.jsx("div",{className:"mt-2 text-xs font-mono bg-background/50 p-2 rounded border",children:JSON.stringify({...s.outputs&&{outputs:s.outputs},...s.params&&{params:s.params},...s.input_state&&{input_state:s.input_state},...s.error&&{error:s.error}},null,2)})]})]},i)})})})})]})})]})})]}):_?e.jsx("div",{className:"flex justify-center items-center p-8",children:e.jsx(Q,{className:"h-8 w-8 animate-spin"})}):e.jsx("div",{className:"text-center p-8 text-gray-500",children:"Select a flow and trace to view details"})]})})});export{We as default,Qe as meta};
