!function(){var e,t;e=this,t=function(e,t,d){"use strict";let s=t.spina(o=class extends t.BaseModel{static defaults={actionId:"",domID:null,iconClass:null,isCustomRendered:!1,label:null,url:null,visible:!1}})||o,i=t.spina(o=class extends s{static defaults(){return{children:[]}}})||o,a=t.spina(o=class extends t.BaseView{})||o,r=t.spina(o=class extends a{static events={focusout:"onFocusOut",keydown:"onKeyDown",mouseenter:"openMenu",mouseleave:"closeMenu",touchstart:"onTouchStart"};onInitialRender(){var t=new d.MenuItemsCollection,e=RB.PageManager.getPage();for(const n of this.model.get("children"))if("--"===n)t.add({type:d.MenuItemType.SEPARATOR});else{const o=e.getActionView(n);if(o){var s=o.model,i=s.get("visible"),a=s.get("domID"),r=o.activate?()=>o.activate():null;if(s.get("isCustomRendered"))t.add({childEl:o.el,id:a,onClick:r}),i&&o.$el.show();else if(i){let e=s.get("url");"#"===e&&(e=null);const l=t.add({iconName:s.get("iconClass"),id:a,label:s.get("label"),onClick:r,url:e});this.listenTo(s,"change:iconClass",(e,t)=>{l.set("iconName",t)}),this.listenTo(s,"change:label",(e,t)=>{l.set("label",t)}),this.listenTo(s,"change:url",(e,t)=>{l.set("url",t)})}}else console.error("Unable to find action for %s",n)}this.menu=d.craftComponent("Ink.Menu",{controllerEl:this.el,menuItems:t}),d.renderInto(this.el,this.menu),this.listenTo(this.menu,"opening",this.positionMenu.bind(this))}openMenu(){this.menu.menuItems.isEmpty()||this.menu.open({animate:!0})}closeMenu(){this.menu.menuItems.isEmpty()||this.menu.close({animate:!0})}positionMenu(){var e=this.menu.$el,t=e.width(),s=$(window).width(),i=this.$el.offset().left;let a="auto";s<i+t&&(a=s-(i+Math.min(t,s))),e.css({left:a,"max-width":s})}onFocusOut(e){e.stopPropagation(),e.currentTarget.contains(e.relatedTarget)||this.menu.close({animate:!1})}onKeyDown(e){" "===e.key||"ArrowDown"===e.key||"ArrowUp"===e.key||"Enter"===e.key?(e.stopPropagation(),e.preventDefault(),this.menu.open({animate:!1,currentItemIndex:0})):"Escape"===e.key&&(e.stopPropagation(),e.preventDefault(),this.menu.close({animate:!1}))}onTouchStart(e){var t=$(e.target);t.hasClass(".ink-c-menu__item")||t.parents(".ink-c-menu__item").length||(e.stopPropagation(),e.preventDefault(),this.menu.isOpen?this.closeMenu():this.openMenu())}})||o,n=t.spina(o=class extends a{static events={click:"_onClick",touchstart:"_onTouchStart"};_onClick(e){e.stopPropagation(),e.preventDefault(),this.activate()}_onTouchStart(){this.activate()}activate(){}})||o;var o={Action:s,ActionView:a,MenuAction:i,MenuActionView:r,MenuItemActionView:n};let l=t.spina(h=class extends t.BaseCollection{fetch(e={},t=void 0){return _.isFunction(e.success)||_.isFunction(e.error)?(console.warn("RB.BaseCollection.fetch was called using callbacks. Callers should be updated to use promises instead."),RB.promiseToCallbacks(e,t,e=>this.fetch(e))):new Promise((t,i)=>{super.fetch(_.defaults({error:(e,t,s)=>i(new z(e,t,s)),success:e=>t(e)},e))})}sync(e,t,i={}){return Backbone.sync.call(this,e,t,_.defaults({error:(e,t,s)=>{RB.storeAPIError(e),_.isFunction(i.error)&&i.error(e,t,s)}},i))}})||h,c=t.spina(h=class extends l{hasPrev=!1;hasNext=!1;currentPage=0;_fetchURL=null;initialize(e,t){this.parentResource=t.parentResource,this.extraQueryData=t.extraQueryData,this.maxResults=t.maxResults,this.totalResults=void 0,this._fetchURL=null,this._links=null}url(){var e;return this._fetchURL||(this.parentResource&&(e=this.parentResource.get("links")[_.result(this.model.prototype,"listKey")])?e.href:null)}parse(e,t={}){var s=_.result(this.model.prototype,"listKey");return this._links=e.links||null,this.totalResults=e.total_results,t.fetchingAll?(this.hasPrev=!1,this.hasNext=!1,this.currentPage=0):(this.totalResults=e.total_results,this.hasPrev=null!==this._links&&void 0!==this._links.prev,this.hasNext=null!==this._links&&void 0!==this._links.next,this.currentPage=t.page),e[s]}async fetch(e={},t=void 0){if(_.isFunction(e.success)||_.isFunction(e.error)||_.isFunction(e.complete))return console.warn("RB.ResourceCollection.fetch was called using callbacks. Callers should be updated to use promises instead."),RB.promiseToCallbacks(e,t,e=>this.fetch(e));var t=_.extend({},e.data),s=(void 0!==e.start&&(t.start=e.start),this.extraQueryData&&void 0!==this.extraQueryData["max-results"]||(void 0!==e.maxResults?t["max-results"]=e.maxResults:this.maxResults&&(t["max-results"]=this.maxResults)),void 0===e.reset&&(e.reset=!0),e.remove=e.reset,this.model.prototype.expandedFields);0<s.length&&(t.expand=s.join(",")),this.extraQueryData&&_.defaults(t,this.extraQueryData),e.data=t,this.parentResource&&await this.parentResource.ready(),await super.fetch(e)}fetchPrev(e={},t=void 0){return _.isFunction(e.success)||_.isFunction(e.error)||_.isFunction(e.complete)?(console.warn("RB.ResourceCollection.fetchPrev was called using callbacks. Callers should be updated to use promises instead."),RB.promiseToCallbacks(e,t,e=>this.fetchPrev(e))):this.hasPrev?(this._fetchURL=this._links.prev.href,this.fetch(_.defaults({page:this.currentPage-1},e))):Promise.resolve()}fetchNext(e={},t=void 0){return _.isFunction(e.success)||_.isFunction(e.error)||_.isFunction(e.complete)?(console.warn("RB.ResourceCollection.fetchNext was called using callbacks. Callers should be updated to use promises instead."),RB.promiseToCallbacks(e,t,e=>this.fetchNext(e))):this.hasNext||!1===e.enforceHasNext?(this._fetchURL=this._links.next.href,this.fetch(_.defaults({page:this.currentPage+1},e))):Promise.resolve()}async fetchAll(e={},t=void 0){if(_.isFunction(e.success)||_.isFunction(e.error)||_.isFunction(e.complete))return console.warn("RB.ResourceCollection.fetchNext was called using callbacks. Callers should be updated to use promises instead."),RB.promiseToCallbacks(e,t,e=>this.fetchAll(e));var s=_.defaults({enforceHasNext:!1,fetchingAll:!0,maxResults:50,reset:!1},e);for(this._fetchURL=null,this.reset(),await this.fetch(s);this._links.next;)await this.fetchNext(s)}_prepareModel(e,t){e=super._prepareModel(e,t);return e.set("parentObject",this.parentResource),e}})||h,u=t.spina(h=class extends t.BaseModel{toJSON(){var e,t,s={};for([e,t]of Object.entries(this.attributes))s["extra_data."+e]=t;return s}})||h;var h={_setupExtraData(){this.extraData=new u,this.extraData.attributes=this.attributes.extraData,this.listenTo(this.extraData,"change",this._onExtraDataChanged)},set(e,t,s){let i;_.isObject(e)?(i=e,s=t):(i={})[e]=t;e=_.has(i,"extraData")&&_.has(this,"extraData");return e&&i.extraData instanceof u&&(i.extraData=_.clone(i.extraData.attributes)),Backbone.Model.prototype.set.call(this,i,s),e&&(this.extraData.attributes=this.attributes.extraData),this},_onExtraDataChanged(e,t){this.trigger("change:extraData",this,e,t),this.trigger("change",this,t)},getExtraData(e){return this.extraData.get(e)},setExtraData(e,t){this.extraData.set(e,t)}};let p=t.spina({automergeAttrs:["attrToJsonMap","deserializers","serializers"],mixins:[h],prototypeAttrs:["attrToJsonMap","deserializedAttrs","deserializers","expandedFields","extraQueryArgs","listKey","payloadFileKeys","rspNamespace","serializedAttrs","serializers","supportsExtraData","urlIDAttr"]})(w=class p extends t.BaseModel{static strings={INVALID_EXTRADATA_TYPE:"extraData must be an object or undefined",INVALID_EXTRADATA_VALUE_TYPE:"extraData.{key} must be null, a number, boolean, or string",UNSET_PARENT_OBJECT:"parentObject must be set"};static rspNamespace="";static urlIDAttr="id";static expandedFields=[];static extraQueryArgs={};static supportsExtraData=!1;static attrToJsonMap={};static serializedAttrs=[];static deserializedAttrs=[];static serializers={};static deserializers={};static payloadFileKeys=[];static defaults(){return{extraData:{},links:null,loaded:!1,parentObject:null}}static listKey(){return this.rspNamespace+"s"}initialize(e,t){this.supportsExtraData&&this._setupExtraData()}url(){var e=this.get("links");if(e)return e.self.href;var t=this.get("parentObject");if(t&&(e=t.get("links"))){t=e[_.result(this,"listKey")];if(t)return e=t.href,this.isNew()?e:e+this.get(this.urlIDAttr)+"/"}return null}async ready(e={},t=void 0){if(_.isFunction(e.success)||_.isFunction(e.error)||_.isFunction(e.complete)||_.isFunction(e.ready))return console.warn("BaseResource.ready was called using callbacks. Callers should be updated to use promises instead."),RB.promiseToCallbacks(e,t,()=>this.ready());t=this.get("parentObject");this.get("loaded")||(this.isNew()?t&&await t.ready():await this.fetch({data:e.data}))}async ensureCreated(e={},t=void 0){if(_.isFunction(e.success)||_.isFunction(e.error)||_.isFunction(e.complete))return console.warn("BaseResource.ensureCreated was called using callbacks. Callers should be updated to use promises instead."),RB.promiseToCallbacks(e,t,()=>this.ensureCreated());await this.ready(),this.get("loaded")||await this.save()}async fetch(t={},e=void 0){if(_.isFunction(t.success)||_.isFunction(t.error)||_.isFunction(t.complete))return console.warn("BaseResource.fetch was called using callbacks. Callers should be updated to use promises instead."),RB.promiseToCallbacks(t,e,e=>this.fetch(e));if(this.isNew())throw new Error("fetch cannot be used on a resource without an ID");e=this.get("parentObject");return e&&await e.ready(),new Promise((e,i)=>{super.fetch(_.extend({error:(e,t,s)=>i(new z(e,t,s)),success:()=>e()},t))})}async save(e={},t=void 0){if(e??={},_.isFunction(e.success)||_.isFunction(e.error)||_.isFunction(e.complete))return console.warn("BaseResource.save was called using callbacks. Callers should be updated to use promises instead."),RB.promiseToCallbacks(e,t,e=>this.save(e));this.trigger("saving",e),await this.ready();t=this.get("parentObject");return t&&await t.ensureCreated(),this._saveObject(e)}_saveObject(o){return new Promise((s,i)=>{if(_.result(this,"url")){const a=_.defaults({error:(e,t,s)=>{this.trigger("saveFailed",s),i(new z(e,t,s))},success:(e,t)=>{this.trigger("saved",o),s(t)}},o),r=(a.attrs=o.attrs||this.toJSON(o),[]),n=[];o.form||this.payloadFileKeys&&window.File&&this.payloadFileKeys.forEach(e=>{e=a.attrs[e];e&&r.push(e)}),0<r.length?r.forEach(e=>{var t=new FileReader;n.push(t),t.onloadend=()=>{n.every(e=>e.readyState===FileReader.DONE)&&this._saveWithFiles(r,n,a)},t.readAsArrayBuffer(e)}):super.save({},a)}else i(new Error("The object must either be loaded from the server or have a parent object before it can be saved"))})}_saveWithFiles(e,t,s){var i,a,r,n,o,l=s.boundary||"-----multipartformboundary"+(new Date).getTime(),d=[];for([i,a,r]of _.zip(this.payloadFileKeys,e,t))a&&r&&(d.push("--"+l+"\r\n"),d.push('Content-Disposition: form-data; name="'+i+'"; filename="'+a.name+'"\r\n'),d.push("Content-Type: "+a.type+"\r\n"),d.push("\r\n"),d.push(r.result),d.push("\r\n"));for([n,o]of Object.entries(s.attrs))this.payloadFileKeys.includes(n)||void 0===o||null===o||(d.push("--"+l+"\r\n"),d.push('Content-Disposition: form-data; name="'+n+'"\r\n'),d.push("\r\n"),d.push(o+"\r\n"));d.push("--"+l+"--\r\n\r\n"),super.save({},_.extend({contentType:"multipart/form-data; boundary="+l,data:new Blob(d),processData:!1},s))}async destroy(e={},t=void 0){if(_.isFunction(e.success)||_.isFunction(e.error)||_.isFunction(e.complete))return console.warn("BaseResource.destroy was called using callbacks. Callers should be updated to use promises instead."),RB.promiseToCallbacks(e,t,e=>this.destroy(e));this.trigger("destroying",e);t=this.get("parentObject");!this.isNew()&&t&&await t.ready(),await this._destroyObject(e)}async _destroyObject(e={}){if(_.result(this,"url"))await this.ready();else if(!this.isNew())throw new Error("The object must either be loaded from the server or have a parent object before it can be deleted");await this._finishDestroy(e)}_finishDestroy(s){return new Promise((e,i)=>{const t=this.get("parentObject");super.destroy({error:(e,t,s)=>i(new z(e,t,s)),success:()=>{this.set(_.defaults({id:null,parentObject:t},_.result(this,"defaults"))),this.trigger("destroyed",s),e()},wait:!0})})}parse(e){return console.assert(this.rspNamespace,"rspNamespace must be defined on the resource model"),void 0!==e.stat&&(e=e[this.rspNamespace]),_.defaults({extraData:e.extra_data,id:e.id,links:e.links,loaded:!0},this.parseResourceData(e))}parseResourceData(t){var s={};for(const a of this.deserializedAttrs){var i=this.deserializers[a];let e=t[this.attrToJsonMap[a]||a];void 0!==(e=i?i.call(this,e):e)&&(s[a]=e)}return s}toJSON(e){var t={isNew:this.isNew(),loaded:this.get("loaded")},s={};for(const a of this.serializedAttrs){var i=this.serializers[a];let e=this.get(a);i&&(e=i.call(this,e,t)),s[this.attrToJsonMap[a]||a]=e}return this.supportsExtraData&&_.extend(s,this.extraData.toJSON()),s}sync(e,t,a={}){let s,i;"read"===e?(s=a.data||{},r=_.result(this,"extraQueryArgs",{}),_.isEmpty(r)||(s=_.extend({},r,s))):(a.form?s=null:a.attrs&&!_.isArray(a.attrs)?s=a.attrs:(s=t.toJSON(a),a.attrs&&(s=_.pick(s,a.attrs.map(e=>this.attrToJsonMap[e]||e)))),i="application/x-www-form-urlencoded");var r=_.defaults({},a,{contentType:i,data:s,processData:!0});return!a.form&&0<this.expandedFields.length&&(r.data.expand=this.expandedFields.join(",")),r.error=(e,t,s)=>{RB.storeAPIError(e);var i=e.errorPayload;i&&_.has(i,this.rspNamespace)&&this.set(this.parse(i)),_.isFunction(a.error)&&a.error(e,t,s)},Backbone.sync.call(this,e,t,r)}validate(e){if(this.supportsExtraData&&void 0!==e.extraData){var t,s,i=p.strings;if(!_.isObject(e.extraData))return i.INVALID_EXTRADATA_TYPE;for([t,s]of Object.entries(e.extraData))if(!_.isNull(s)&&(!_.isNumber(s)||_.isNaN(s))&&!_.isBoolean(s)&&!_.isString(s))return i.INVALID_EXTRADATA_VALUE_TYPE.replace("{key}",t)}}})||w,m=t.spina(w=class extends p{static defaults={baseURL:null,loaded:!0,objectID:null,stored:!1};url(){let e=this.get("baseURL");return this.get("stored")&&(e+=this.get("objectID")+"/"),e}isNew(){return!this.get("stored")}toJSON(){return{object_id:this.get("objectID")||void 0}}parse(){}})||w,f=t.spina(w=class extends p{defaults(){return _.defaults({addError:"",removeError:""},super.defaults())}url(){return this.get("url")}addImmediately(e){var t=this.url();return t?new m({baseURL:t,objectID:String(e.id)}).save():Promise.reject(new Error(this.attributes.addError))}removeImmediately(s){const i=this.url();return new Promise((e,t)=>{i?e(new m({baseURL:i,objectID:String(s.id),stored:!0}).destroy()):t(new Error(this.attributes.removeError))})}})||w,g=t.spina(w=class extends t.BaseModel{static instance=null;static create(e){return console.assert(!this.instance,"UserSession.create can only be called once."),this.instance=new this(e),this.instance}defaults={archivedReviewRequestsURL:null,authenticated:!1,diffsShowExtraWhitespace:!1,fullName:null,loginURL:null,mutedReviewRequestsURL:null,readOnly:!1,sessionURL:null,showReviewDialogTips:!0,timezoneOffset:"0",userFileAttachmentsURL:null,userPageURL:null,username:null,watchedReviewGroupsURL:null,watchedReviewRequestsURL:null};initialize(){this.watchedGroups=new f({url:this.get("watchedReviewGroupsURL"),addError:gettext("Must log in to add a watched item."),removeError:gettext("Must log in to remove a watched item.")}),this.watchedReviewRequests=new f({url:this.get("watchedReviewRequestsURL"),addError:gettext("Must log in to add a watched item."),removeError:gettext("Must log in to remove a watched item.")}),this.archivedReviewRequests=new f({url:this.get("archivedReviewRequestsURL"),removeError:gettext("Must log in to remove a archived item."),addError:gettext("Must log in to add an archived item.")}),this.mutedReviewRequests=new f({url:this.get("mutedReviewRequestsURL"),removeError:gettext("Must log in to remove a muted item."),addError:gettext("Must log in to add a muted item.")}),this._bindCookie({attr:"diffsShowExtraWhitespace",cookieName:"show_ew",deserialize:e=>"false"!==e}),this._bindCookie({attr:"showReviewDialogTips",cookieName:"show_review_dialog_tips",deserialize:e=>"false"!==e})}toggleAttr(e){this.set(e,!this.get(e))}getAvatarHTML(e){return(this.get("avatarHTML")||{})[e]||""}_bindCookie(s){var e=s.deserialize||_.identity;const i=s.serialize||(e=>e.toString());this.set(s.attr,e($.cookie(s.cookieName))),this.on("change:"+s.attr,(e,t)=>{$.cookie(s.cookieName,i(t),{path:SITE_ROOT})})}})||w;function b(e){return e||void 0}function R(e,t){return t.isNew?e:void 0}function y(e){return e?"markdown":"plain"}var w=Object.defineProperty({__proto__:null,onlyIfNew:R,onlyIfUnloaded:function(e,t){return t.loaded?void 0:e},onlyIfUnloadedAndValue:function(e,t){if(!t.loaded&&e)return e},onlyIfValue:b,textType:y},Symbol.toStringTag,{value:"Module"});let x=function(e){return e.DROPPED="dropped",e.OPEN="open",e.RESOLVED="resolved",e.VERIFYING_DROPPED="verifying-dropped",e.VERIFYING_RESOLVED="verifying-resolved",e}({}),v=t.spina(B=class v extends p{static defaults(){return{forceTextType:null,html:null,includeTextTypes:null,issueOpened:null,issueStatus:null,markdownTextFields:{},rawTextFields:{},richText:null,text:""}}static extraQueryArgs(){let e="raw";return g.instance.get("defaultUseRichText")&&(e+=",markdown"),{"force-text-type":"html","include-text-types":e}}static supportsExtraData=!0;static attrToJsonMap={forceTextType:"force_text_type",includeTextTypes:"include_text_types",issueOpened:"issue_opened",issueStatus:"issue_status",richText:"text_type"};static serializedAttrs=["forceTextType","includeTextTypes","issueOpened","issueStatus","richText","text"];static deserializedAttrs=["issueOpened","issueStatus","text","html"];static serializers={forceTextType:b,includeTextTypes:b,issueStatus:function(e){if(this.get("loaded")&&this.get("parentObject").get("public"))return e},richText:y};static STATE_DROPPED=x.DROPPED;static STATE_OPEN=x.OPEN;static STATE_RESOLVED=x.RESOLVED;static STATE_VERIFYING_DROPPED=x.VERIFYING_DROPPED;static STATE_VERIFYING_RESOLVED=x.VERIFYING_RESOLVED;static strings={INVALID_ISSUE_STATUS:`issueStatus must be one of STATE_DROPPED, STATE_OPEN,
STATE_RESOLVED, STATE_VERIFYING_DROPPED, or
STATE_VERIFYING_RESOLVED.`};static isStateOpen(e){return e===x.OPEN||e===x.VERIFYING_DROPPED||e===x.VERIFYING_RESOLVED}destroyIfEmpty(){this.get("text")||this.destroy()}parseResourceData(e){var t=e.raw_text_fields||e,s=super.parseResourceData(e);return s.richText="markdown"===t.text_type,e.raw_text_fields&&(s.rawTextFields={text:e.raw_text_fields.text}),e.markdown_text_fields&&(s.markdownTextFields={text:e.markdown_text_fields.text}),e.html_text_fields&&(s.html=e.html_text_fields.text),s}validate(e){var t;return _.has(e,"parentObject")&&!e.parentObject?p.strings.UNSET_PARENT_OBJECT:(t=e.issueStatus)&&t!==x.DROPPED&&t!==x.OPEN&&t!==x.RESOLVED&&t!==x.VERIFYING_DROPPED&&t!==x.VERIFYING_RESOLVED?v.strings.INVALID_ISSUE_STATUS:super.validate(e)}requiresVerification(){var e=this.get("extraData");return e&&!0===e.require_verification}getAuthorUsername(){return this.get("parentObject").get("links").user.title}})||B,T=t.spina(B=class extends p{static defaults={fileRegex:null,name:null};static rspNamespace="default_reviewer";static attrToJsonMap={fileRegex:"file_regex"};static serializedAttrs=["fileRegex","name"];static deserializedAttrs=["fileRegex","name"];url(){var e=this.get("localSitePrefix")||"",e=""+SITE_ROOT+e+"api/default-reviewers/";return this.isNew()?e:e+this.id+"/"}})||B;var B={async destroy(e={},t=void 0){if(_.isFunction(e.success)||_.isFunction(e.error)||_.isFunction(e.complete))return console.warn("RB.DraftResourceChildModelMixin.destroy was called using callbacks. Callers should be updated to use promises instead."),RB.promiseToCallbacks(e,t,e=>this.destroy(e));await this.get("parentObject").ensureCreated(),await _super(this).destroy.call(this,e)},async ready(e={},t=void 0){if(_.isFunction(e.success)||_.isFunction(e.error)||_.isFunction(e.complete)||_.isFunction(e.ready))return console.warn("RB.DraftResourceChildModelMixin.ready was called using callbacks. Callers should be updated to use promises instead."),RB.promiseToCallbacks(e,t,e=>this.ready());await this.get("parentObject").ensureCreated(),await _super(this).ready.call(this)}},D=function(e){return e.DELETED="deleted",e.DRAFT="draft",e.NEW="new",e.NEW_REVISION="new-revision",e.PENDING_DELETION="pending-deletion",e.PUBLISHED="published",e}({});let I=t.spina(S=class extends p{static defaults={attachmentHistoryID:null,canAccessReviewUI:null,caption:null,downloadURL:null,file:null,filename:null,publishedCaption:null,reviewURL:null,revision:null,state:D.NEW,thumbnailHTML:null};static rspNamespace="file_attachment";static payloadFileKeys=["path"];static supportsExtraData=!0;static attrToJsonMap={attachmentHistoryID:"attachment_history_id",canAccessReviewUI:"is_review_ui_accessible_by",downloadURL:"url",file:"path",reviewURL:"review_url",thumbnailHTML:"thumbnail"};static serializedAttrs=["attachmentHistoryID","caption","file"];static deserializedAttrs=["attachmentHistoryID","canAccessReviewUI","caption","downloadURL","filename","reviewURL","revision","state","thumbnailHTML"];static serializers={attachmentHistoryID:R,file:R}})||S,E=t.spina({mixins:[B]})(S=class extends I{static rspNamespace="draft_file_attachment"})||S;var N,S={async ready(e={},t=void 0){if(_.isFunction(e.success)||_.isFunction(e.error)||_.isFunction(e.complete)||_.isFunction(e.ready))return console.warn("RB.DraftResourceModelMixin.ready was called using callbacks. Callers should be updated to use promises instead."),RB.promiseToCallbacks(e,t,e=>this.ready(e));!this.get("loaded")&&this.isNew()&&void 0===this._needDraft&&(this._needDraft=!0),await _super(this).ready.call(this,e),this._needDraft&&await this._retrieveDraft(e)},async destroy(e={},t=void 0){if(_.isFunction(e.success)||_.isFunction(e.error)||_.isFunction(e.complete))return console.warn("RB.DraftResourceModelMixin.destroy was called using callbacks. Callers should be updated to use promises instead."),RB.promiseToCallbacks(e,t,e=>this.destroy(e));await this.ready(),await _super(this).destroy.call(this,e),this._needDraft=!0},url(){var e,t;return this._needDraft?(e=this.get("parentObject"),t=_.result(this,"listKey"),e.get("links")[t].href+"draft/?"+$.now()):_super(this).url.call(this)},_retrieveDraft(e){if(!RB.UserSession.instance.get("authenticated"))return Promise.reject(new z(this,{errorText:gettext("You must be logged in to retrieve the draft.")},{}));let t=e.data||{};e=_.result(this,"extraQueryArgs",{});return _.isEmpty(e)||(t=_.extend({},e,t)),new Promise((i,a)=>{Backbone.Model.prototype.fetch.call(this,{data:t,error:(e,t,s)=>{404===t.status?(this._needDraft=!1,i()):a(new z(e,t,s))},processData:!0,success:()=>{this._needDraft=!1,i()}})})}};let C=t.spina({mixins:[S],prototypeAttrs:["COMMENT_LINK_NAMES","extraQueryArgs"]})(N=class C extends p{static defaults(){return{bodyBottom:null,bodyBottomRichText:!1,bodyTop:null,bodyTopRichText:!1,forceTextType:null,includeTextTypes:null,public:!1,rawTextFields:{},review:null,timestamp:null}}static rspNamespace="reply";static listKey="replies";static extraQueryArgs={"force-text-type":"html","include-text-types":"raw"};static attrToJsonMap={bodyBottom:"body_bottom",bodyBottomRichText:"body_bottom_text_type",bodyTop:"body_top",bodyTopRichText:"body_top_text_type",forceTextType:"force_text_type",includeTextTypes:"include_text_types"};static serializedAttrs=["bodyBottom","bodyBottomRichText","bodyTop","bodyTopRichText","forceTextType","includeTextTypes","public"];static deserializedAttrs=["bodyBottom","bodyTop","public","timestamp"];static serializers={bodyBottomRichText:y,bodyTopRichText:y,forceTextType:b,includeTextTypes:b,public:e=>!!e||void 0};static COMMENT_LINK_NAMES=["diff_comments","file_attachment_comments","general_comments","screenshot_comments"];parseResourceData(e){var t=e.raw_text_fields||e,s=super.parseResourceData(e);return s.bodyTopRichText="markdown"===t.body_top_text_type,s.bodyBottomRichText="markdown"===t.body_bottom_text_type,s.rawTextFields=e.raw_text_fields||{},s}async publish(e={},t=void 0){if(_.isFunction(e.success)||_.isFunction(e.error)||_.isFunction(e.complete))return console.warn("RB.ReviewReply.publish was called using callbacks. Callers should be updated to use promises instead."),RB.promiseToCallbacks(e,t,e=>this.publish(e));this.trigger("publishing"),await this.ready(),this.set("public",!0);try{await this.save({data:{public:1,trivial:e.trivial?1:0}})}catch(e){throw this.trigger("publishError",e.message),e}this.trigger("published")}async discardIfEmpty(e={},t=void 0){return _.isFunction(e.success)||_.isFunction(e.error)||_.isFunction(e.complete)?(console.warn("RB.ReviewReply.discardIfEmpty was called using callbacks. Callers should be updated to use promises instead."),RB.promiseToCallbacks(e,t,e=>this.discardIfEmpty(e))):(await this.ready(),!(this.isNew()||this.get("bodyTop")||this.get("bodyBottom"))&&this._checkCommentsLink(0))}_checkCommentsLink(a){return new Promise((t,i)=>{const s=C.COMMENT_LINK_NAMES[a];var e=this.get("links")[s].href;RB.apiCall({error:(e,t,s)=>i(new z(e,t,s)),success:e=>{0<e[s].length?t(!1):a<C.COMMENT_LINK_NAMES.length-1?t(this._checkCommentsLink(a+1)):t(this.destroy().then(()=>!0))},type:"GET",url:e})})}})||N,A=t.spina(N=class extends p{static defaults(){return{authorName:null,bodyBottom:null,bodyBottomRichText:!1,bodyTop:null,bodyTopRichText:!1,draftReply:null,forceTextType:null,htmlTextFields:{},includeTextTypes:null,markdownTextFields:{},public:!1,rawTextFields:{},shipIt:!1,timestamp:null}}static rspNamespace="review";static attrToJsonMap={bodyBottom:"body_bottom",bodyBottomRichText:"body_bottom_text_type",bodyTop:"body_top",bodyTopRichText:"body_top_text_type",forceTextType:"force_text_type",includeTextTypes:"include_text_types",shipIt:"ship_it"};static serializedAttrs=["forceTextType","includeTextTypes","shipIt","bodyTop","bodyTopRichText","bodyBottom","bodyBottomRichText","public"];static deserializedAttrs=["shipIt","bodyTop","bodyBottom","public","timestamp"];static serializers={bodyBottomRichText:y,bodyTopRichText:y,forceTextType:b,includeTextTypes:b,public:e=>e?1:void 0};static supportsExtraData=!0;parseResourceData(e){var t=e.raw_text_fields||e,s=super.parseResourceData(e);return s.bodyTopRichText="markdown"===t.body_top_text_type,s.bodyBottomRichText="markdown"===t.body_bottom_text_type,e.raw_text_fields&&(s.rawTextFields={bodyBottom:e.raw_text_fields.body_bottom,bodyTop:e.raw_text_fields.body_top}),e.markdown_text_fields&&(s.markdownTextFields={bodyBottom:e.markdown_text_fields.body_bottom,bodyTop:e.markdown_text_fields.body_top}),e.html_text_fields&&(s.htmlTextFields={bodyBottom:e.html_text_fields.body_bottom,bodyTop:e.html_text_fields.body_top}),s}createDiffComment(e){return e.interFileDiffID&&e.baseFileDiffID?(console.error("Options `interFileDiffID` and `baseFileDiffID` for RB.Review.createDiffComment() are mutually exclusive."),null):new RB.DiffComment(_.defaults({parentObject:this},e))}createScreenshotComment(e,t,s,i,a,r){return new RB.ScreenshotComment({height:r,id:e,parentObject:this,screenshotID:t,width:a,x:s,y:i})}createFileAttachmentComment(e,t,s){return new RB.FileAttachmentComment({diffAgainstFileAttachmentID:s,fileAttachmentID:t,id:e,parentObject:this})}createGeneralComment(e,t){return new RB.GeneralComment({id:e,issueOpened:t,parentObject:this})}createReply(){let e=this.get("draftReply");return null===e&&(e=new C({parentObject:this}),this.set("draftReply",e),e.once("published",()=>{this.get("parentObject").markUpdated(e.get("timestamp")),this.set("draftReply",null)})),e}})||N,O=t.spina({mixins:[S]})(N=class extends A{static defaults={publishAndArchive:!1,publishToOwnerOnly:!1};static attrToJsonMap={publishAndArchive:"publish_and_archive",publishToOwnerOnly:"publish_to_owner_only"};static serializedAttrs=["publishAndArchive","publishToOwnerOnly"].concat(A.serializedAttrs);static serializers={publishAndArchive:b,publishToOwnerOnly:b};async publish(e={},t=void 0){if(_.isFunction(e.success)||_.isFunction(e.error)||_.isFunction(e.complete))return console.warn(`RB.DraftReview.publish was called using callbacks.
                          Callers should be updated to use promises instead.`),RB.promiseToCallbacks(e,t,e=>this.publish(e));this.trigger("publishing"),await this.ready(),this.set("public",!0);try{await this.save({attrs:e.attrs})}catch(e){throw this.trigger("publishError",e.xhr.errorText),e}this.trigger("published")}})||N,P=t.spina(N=class extends p{static defaults={filesOnly:!1,localSitePrefix:null,name:null,requiresBasedir:!1,requiresChangeNumber:!1,scmtoolName:null,supportsPostCommit:!1};static rspNamespace="repository";static attrToJsonMap={name:"name",requiresBasedir:"requires_basedir",requiresChangeNumber:"requires_change_number",scmtoolName:"tool",supportsPostCommit:"supports_post_commit"};static deserializedAttrs=["name","requiresBasedir","requiresChangeNumber","scmtoolName","supportsPostCommit"];static listKey="repositories";initialize(e,t){super.initialize(e,t),this.branches=new RB.RepositoryBranches,this.branches.url=_.result(this,"url")+"branches/"}getCommits(e){return new RB.RepositoryCommits([],{branch:e.branch,start:e.start,urlBase:_.result(this,"url")+"commits/"})}url(){var e=SITE_ROOT+(this.get("localSitePrefix")||"")+"api/repositories/";return this.isNew()?e:e+this.id+"/"}})||N,k=t.spina(N=class extends p{static defaults={added:!1,loaded:!0,username:null};static serializedAttrs=["username"];url(){let e=this.get("baseURL");return this.get("added")&&(e+=this.get("username")+"/"),e}isNew(){return!this.get("added")}parse(e){return{}}})||N,L=t.spina(N=class extends p{static defaults={name:null};static rspNamespace="group";url(){let e=SITE_ROOT+(this.get("localSitePrefix")||"")+"api/groups/";return this.isNew()||(e+=this.get("name")+"/"),e}setStarred(t,e={},s=void 0){return _.isFunction(e.success)||_.isFunction(e.error)||_.isFunction(e.complete)?(console.warn("RB.ReviewGroup.setStarred was called using callbacks. Callers should be updated to use promises instead."),RB.promiseToCallbacks(e,s,e=>this.setStarred(t))):(e=g.instance.watchedGroups,t?e.addImmediately(this):e.removeImmediately(this))}addUser(t,e={},s=void 0){return _.isFunction(e.success)||_.isFunction(e.error)||_.isFunction(e.complete)?(console.warn("RB.ReviewGroup.addUser was called using callbacks. Callers should be updated to use promises instead."),RB.promiseToCallbacks(e,s,e=>this.addUser(t))):(s=this.url()+"users/")&&!this.isNew()?new k({baseURL:s,username:t}).save():Promise.reject(new z(this,{errorText:"Unable to add to the group."},e))}removeUser(t,e={},s=void 0){return _.isFunction(e.success)||_.isFunction(e.error)||_.isFunction(e.complete)?(console.warn("RB.ReviewGroup.removeUser was called using callbacks. Callers should be updated to use promises instead."),RB.promiseToCallbacks(e,s,e=>this.removeUser(t))):(s=this.url()+"users/")&&!this.isNew()?new k({added:!0,baseURL:s,username:t}).destroy():Promise.reject(new z(this,{errorText:"Unable to remove from the group."},e))}})||N,M=t.spina(N=class M extends p{static defaults(){return{approvalFailure:null,approved:!1,branch:null,bugTrackerURL:null,bugsClosed:null,closeDescription:null,closeDescriptionRichText:!1,commitID:null,dependsOn:[],description:null,descriptionRichText:!1,draftReview:null,lastUpdated:null,localSitePrefix:null,public:null,repository:null,reviewURL:null,state:null,summary:null,targetGroups:[],targetPeople:[],testingDone:null,testingDoneRichText:!1}}static rspNamespace="review_request";static extraQueryArgs={"force-text-type":"html","include-text-types":"raw"};static attrToJsonMap={approvalFailure:"approval_failure",bugsClosed:"bugs_closed",closeDescription:"close_description",closeDescriptionRichText:"close_description_text_type",dependsOn:"depends_on",descriptionRichText:"description_text_type",lastUpdated:"last_updated",reviewURL:"url",targetGroups:"target_groups",targetPeople:"target_people",testingDone:"testing_done",testingDoneRichText:"testing_done_text_type"};static deserializedAttrs=["approved","approvalFailure","branch","bugsClosed","closeDescription","dependsOn","description","lastUpdated","public","reviewURL","summary","targetGroups","targetPeople","testingDone"];static CHECK_UPDATES_MSECS=3e5;static CLOSE_DISCARDED=1;static CLOSE_SUBMITTED=2;static PENDING=3;static VISIBILITY_VISIBLE=1;static VISIBILITY_ARCHIVED=2;static VISIBILITY_MUTED=3;reviews=new t.Collection([],{model:A});initialize(e,t={}){super.initialize(e,t),this.draft=new RB.DraftReviewRequest(_.defaults({branch:this.get("branch"),bugsClosed:this.get("bugsClosed"),dependsOn:this.get("dependsOn"),description:this.get("description"),descriptionRichText:this.get("descriptionRichText"),parentObject:this,summary:this.get("summary"),targetGroups:this.get("targetGroups"),targetPeople:this.get("targetPeople"),testingDone:this.get("testingDone"),testingDoneRichText:this.get("testingDoneRichText")},t.extraDraftAttrs))}url(){var e=SITE_ROOT+(this.get("localSitePrefix")||"")+"api/review-requests/";return this.isNew()?e:e+this.id+"/"}createFromCommit(e){return console.assert(!!e),console.assert(this.isNew()),this.set("commitID",e),this.save({createFromCommit:!0})}createDiff(){return new RB.Diff({parentObject:this})}createReview(e,t={}){let s;return void 0===e?null===(s=this.get("draftReview"))&&(s=new RB.DraftReview({parentObject:this}),this.set("draftReview",s)):(s=this.reviews.get(e))||(s=new A(_.defaults({id:e,parentObject:this},t)),this.reviews.add(s)),s}createScreenshot(e){return new RB.Screenshot({id:e,parentObject:this})}createFileAttachment(e){return new I(_.defaults({parentObject:this},e))}async setStarred(e){var t=g.instance.watchedReviewRequests;e?await t.addImmediately(this):await t.removeImmediately(this)}async close(e){var t={};if(console.assert(e),e.type===M.CLOSE_DISCARDED)t.status="discarded";else{if(e.type!==M.CLOSE_SUBMITTED)return Promise.reject(new Error("Invalid close type"));t.status="submitted"}void 0!==e.description&&(t.close_description=e.description),void 0!==e.richText&&(t.close_description_text_type=e.richText?"markdown":"plain"),void 0!==e.postData&&_.extend(t,e.postData);var s=e.type!==this.get("state"),t=_.defaults({data:t},e);delete t.type,delete t.description,await this.save(t),s&&this.trigger("closed"),this.markUpdated(this.get("lastUpdated"))}async reopen(){await this.save({data:{status:"pending"}}),this.trigger("reopened"),this.markUpdated(this.get("lastUpdated"))}markUpdated(e){this._lastUpdateTimestamp=e}async beginCheckForUpdates(e,t){this._checkUpdatesType=e,this._lastUpdateTimestamp=t,await this.ready(),setTimeout(this._checkForUpdates.bind(this),M.CHECK_UPDATES_MSECS)}_checkForUpdates(){RB.apiCall({noActivityIndicator:!0,prefix:this.get("sitePrefix"),success:e=>{e=e.last_update;this._checkUpdatesType&&this._checkUpdatesType!==e.type||this._lastUpdateTimestamp===e.timestamp||this.trigger("updated",e),this._lastUpdateTimestamp=e.timestamp,setTimeout(this._checkForUpdates.bind(this),M.CHECK_UPDATES_MSECS)},type:"GET",url:this.get("links").last_update.href})}toJSON(e={}){var t,s,i;return this.isNew()?(t=this.get("commitID"),s=this.get("repository"),i={},t&&(i.commit_id=t,e.createFromCommit)&&(i.create_from_commit_id=!0),s&&(i.repository=s),i):super.toJSON(e)}parseResourceData(e){var t={discarded:M.CLOSE_DISCARDED,pending:M.PENDING,submitted:M.CLOSE_SUBMITTED}[e.status],s=e.raw_text_fields||e,e=super.parseResourceData(e);return e.state=t,e.closeDescriptionRichText="markdown"===s.close_description_text_type,e.descriptionRichText="markdown"===s.description_text_type,e.testingDoneRichText="markdown"===s.testing_done_text_type,e}})||N,F=t.spina(N=class F extends t.BaseModel{static instance=null;static getInstance(){return this.instance}#channel;initialize(){console.assert(null===F.instance),this.#channel=new BroadcastChannel("reviewboard"),this.#channel.addEventListener("message",e=>{e=e.data;"reload"===e.event?this._onReload(e):console.warn("Received unknown event from BroadcastChannel",e)}),F.instance=this}close(){this.#channel.close(),console.assert(F.instance===this),F.instance=null}reload(){var e=RB.PageManager.getPage().getReloadData();null===e?console.warn(`Ignoring page reload request: No page data to send over the
broadcast channel. This would have affected all tabs without
reload data!`):this.#channel.postMessage({data:e,event:"reload"})}_onReload(e){var t=RB.PageManager.getPage();t&&null!==(t=t.getReloadData())&&_.isEqual(e.data,t)&&this.trigger("reload")}})||N,U=t.spina(N=class extends t.BaseModel{})||N,V=t.spina({prototypeAttrs:["windowResizeThrottleMS"]})(N=class extends t.BaseView{static windowResizeThrottleMS=100;#commChannel=null;$mainSidebar=null;$pageContainer=null;$pageContent=null;_$mainSidebarPane=null;_$pageSidebar=null;_$pageSidebarPanes=null;_actionViews=[];drawer=null;hasSidebar=null;headerView=null;inMobileMode=null;isFullPage=null;isPageRendered=!1;initialize(e={}){this.options=e,this.$window=$(window),window.rbRunningTests||(this.#commChannel=new F,this.listenTo(this.#commChannel,"reload",()=>{alert(gettext("This page is out of date and needs to be reloaded.")),RB.reload()}))}remove(){return this.$window&&this.$window.off("resize.rbPageView"),this.headerView&&this.headerView.remove(),super.remove()}onInitialRender(){var e=this.options,t=e.$body||$(document.body);this.$pageContainer=e.$pageContainer||$("#page-container"),this.$pageContent=e.$pageContent||$("#content"),this._$pageSidebar=e.$pageSidebar||$("#page-sidebar"),this._$pageSidebarPanes=this._$pageSidebar.children(".rb-c-page-sidebar__panes"),this._$mainSidebarPane=this._$pageSidebarPanes.children(".rb-c-page-sidebar__pane.-is-shown"),this.$mainSidebar=this._$mainSidebarPane.children(".rb-c-page-sidebar__pane-content"),this.headerView=new RB.HeaderView({$body:t,$pageSidebar:this._$pageSidebar,el:e.$headerBar||$("#headerbar")}),this.headerView.render(),this.hasSidebar=t.hasClass("-has-sidebar")||t.hasClass("has-sidebar"),this.isFullPage=t.hasClass("-is-content-full-page")||t.hasClass("full-page-content"),this.inMobileMode=this.headerView.inMobileMode,this.renderPage(),t.addClass("-is-loaded"),this.$window.on("resize.rbPageView",_.throttle(()=>this._updateSize(),this.windowResizeThrottleMS)),this.listenTo(this.headerView,"mobileModeChanged",this._onMobileModeChanged),this._onMobileModeChanged(this.inMobileMode),this._actionViews.forEach(e=>e.render()),this.isPageRendered=!0}getReloadData(){return null}setDrawer(e){console.assert(null===this.drawer,"A drawer has already been set up for this page."),console.assert(this.hasSidebar,"Drawers can only be set up on pages with a sidebar."),(this.drawer=e).render(),this._reparentDrawer(),this.listenTo(e,"visibilityChanged",this._updateSize)}renderPage(){}resizeElementForFullHeight(e,t){void 0===t&&(t=this.$pageContainer),e.outerHeight(t.height()-e.position().top)}onResize(){}onMobileModeChanged(e){}addActionView(e){this._actionViews.push(e),this.isPageRendered&&e.render()}getActionView(e){for(const t of this._actionViews)if(t.model.get("actionId")===e)return t;return null}_updateSize(){var e=this.$window.height();let t=null,s=null;this.isFullPage&&(t=e-this.$pageContainer.offset().top),this.inMobileMode?null!==t&&null!==this.drawer&&this.drawer.isVisible&&(t-=this.drawer.$el.outerHeight()):null!==t&&(s=e-this._$pageSidebar.offset().top),null===t?this.$pageContainer.css("height",""):this.$pageContainer.outerHeight(t),null===s?this._$pageSidebar.css("height",""):this._$pageSidebar.outerHeight(s),this.onResize()}_reparentDrawer(){var e=this.drawer.$el.detach();this.inMobileMode?e.insertBefore(this._$pageSidebar):e.appendTo(this._$pageSidebarPanes)}_onMobileModeChanged(e){this.inMobileMode=e,this._updateSize(),null!==this.drawer&&this._reparentDrawer(),this.onMobileModeChanged(this.inMobileMode),this.trigger("inMobileModeChanged",this.inMobileMode)}})||N;e.Actions=o,e.BaseCollection=l,e.BaseComment=v,e.BaseResource=p,e.ClientCommChannel=F,e.CommentIssueStatusType=x,e.DefaultReviewer=T,e.DraftFileAttachment=E,e.DraftResourceChildModelMixin=B,e.DraftResourceModelMixin=S,e.DraftReview=O,e.EnabledFeatures={},e.ExtraData=u,e.ExtraDataMixin=h,e.FileAttachment=I,e.FileAttachmentStates=D,e.JSONSerializers=w,e.Page=U,e.PageView=V,e.Product={isRelease:!1,manualURL:"",name:"Review Board",version:"",versionInfo:[0,0,0,0,"",0]},e.Repository=P,e.ResourceCollection=c,e.Review=A,e.ReviewGroup=L,e.ReviewReply=C,e.ReviewRequest=M,e.UserSession=g,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@beanbag/spina"),require("@beanbag/ink")):"function"==typeof define&&define.amd?define(["exports","@beanbag/spina","@beanbag/ink"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).RB=e.RB||{},e.Spina,e.Ink),_.bindCallbacks=function(e,t,s=["success","error","complete"]){if(!t)return e;var i,a,r={};for([i,a]of Object.entries(e))s.includes(i)&&_.isFunction(a)&&(r[i]=_.bind(a,t));return _.defaults(r,e)},_.deferred=function(e){return()=>{_.defer(e)}},_.throttleLayout=function(i,a={}){let r=!1;return function(){if(!r){const t=this,s=arguments;r=!0;let e=()=>{i.apply(t,s),r=!1};a.defer&&(e=_.deferred(e)),requestAnimationFrame(e)}}},window._super=function(e){return e.hasOwnProperty("__super__")?e.__super__.prototype:Object.getPrototypeOf(Object.getPrototypeOf(e))},$(document).ready(function(){$(".user").user_infobox(),$(".bug").bug_infobox(),$(".review-request-link").review_request_infobox(),$("time.timesince").timesince()}),RB.APIErrors={NO_ERROR:0,SERVICE_NOT_CONFIGURED:1,DOES_NOT_EXIST:100,PERMISSION_DENIED:101,INVALID_ATTRIBUTE:102,NOT_LOGGED_IN:103,LOGIN_FAILED:104,INVALID_FORM_DATA:105,MISSING_ATTRIBUTE:105,ENABLE_EXTENSION_FAILED:107,DISABLE_EXTENSION_FAILED:108,EXTENSION_INSTALLED:109,INSTALL_EXTENSION_FAILED:110,UNSPECIFIED_DIFF_REVISION:200,INVALID_DIFF_REVISION:201,INVALID_ACTION:202,INVALID_CHANGE_NUMBER:203,CHANGE_NUMBER_IN_USE:204,MISSING_REPOSITORY:205,INVALID_REPOSITORY:206,REPO_FILE_NOT_FOUND:207,INVALID_USER:208,REPO_NOT_IMPLEMENTED:209,REPO_INFO_ERROR:210,NOTHING_TO_PUBLISH:211,EMPTY_CHANGESET:212,SERVER_CONFIG_ERROR:213,BAD_HOST_KEY:214,UNVERIFIED_HOST_KEY:215,MISSING_USER_KEY:217,REPO_AUTHENTICATION_ERROR:218,DIFF_EMPTY:219,DIFF_TOO_BIG:220,FILE_RETRIEVAL_ERROR:221,HOSTINGSVC_AUTH_ERROR:222,GROUP_ALREADY_EXISTS:223,DIFF_PARSE_ERROR:224},$.ajaxTransport("arraybuffer blob",function(r,e,t){if(!window.FormData)return null;let n;return{send(e,t){(n=r.xhr()).addEventListener("load",()=>{var e={};e[r.dataType]=n.response,t(n.status,n.statusText,e,n.getAllResponseHeaders())}),r.username?n.open(r.type,r.url,r.async,r.username,r.password):n.open(r.type,r.url,r.async),n.responseType=r.dataType;var s=r.xhrFields;if(s)for(var i in s)s.hasOwnProperty(i)&&(n[i]=s[i]);r.crossDomain||e["X-Requested-With"]||(e["X-Requested-With"]="XMLHttpRequest");try{for(var a in e)e.hasOwnProperty(a)&&n.setRequestHeader(a,e[a])}catch(e){}n.send(r.hasContent?r.data:null)},abort(){n&&4!==n.readyState&&n.abort()}}}),RB.setActivityIndicator=function(e,t){var s=t._$activityIndicator||$("#activity-indicator");e?RB.ajaxOptions.enableIndicator&&!t.noActivityIndicator&&(s.children(".indicator-text").text(t.type&&"GET"===t.type?gettext("Loading..."):gettext("Saving...")),s.removeClass("error").show()):!RB.ajaxOptions.enableIndicator||t.noActivityIndicator||s.hasClass("error")||(t._activityIndicatorHideImmediately?s.hide():s.delay(250).fadeOut("fast"))},RB.apiCall=function(n){var e=n.prefix||"";const o=n.url||SITE_ROOT+e+"api"+n.path;function t(){const i=n._$activityIndicator||$("#activity-indicator");n.buttons&&n.buttons.attr("disabled",!0),RB.setActivityIndicator(!0,n);var e={url:o,data:n.data,dataType:n.dataType||"json",error:function(a,e,t){const r=a.responseText;let s=null;try{s=JSON.parse(r)}catch(e){}s&&s.stat||204===a.status?_.isFunction(n.success)&&n.success(s,a.status):(i.addClass("error").text(gettext("A server error occurred.")).append($('<a href="#">').text(gettext("Show Details")).click(()=>{{var e=a,t=r;const i=$("<iframe>").width("100%");var s=n.data?$.param(n.data):"(none)";$('<div class="server-error-box">').appendTo(document.body).append("<p><b>"+gettext("Error Code:")+"</b> "+e.status+"</p>").append("<p><b>"+gettext("Error Text:")+"</b> "+e.statusText+"</p>").append("<p><b>"+gettext("Request URL:")+"</b> "+o+"</p>").append("<p><b>"+gettext("Request Data:")+"</b> "+s+"</p>").append('<p class="response-data"><b>'+gettext("Response Data:")+"</b></p>").append(gettext('<p>There may be useful error details below. The following error page may be useful to your system administrator or when <a href="https://www.reviewboard.org/bugs/new/">reporting a bug</a>. To save the page, right-click the error below and choose "Save Page As," if available, or "View Source" and save the result as a <tt>.html</tt> file.</p>')).append(gettext("<p><b>Warning:</b> Be sure to remove any sensitive material that may exist in the error page before reporting a bug!</p>")).append(i).on("resize",function(){i.height($(this).height()-i.position().top)}).modalBox({stretchX:!0,stretchY:!0,title:gettext("Server Error Details")}),(e=i[0].contentDocument||i[0].contentWindow.document).open(),e.write(t),e.close()}})).append($('<a href="#">').text(gettext("Dismiss")).click(function(){return i.fadeOut("fast"),!1})),_.isFunction(n.error)&&n.error(a,e,t))}},e=$.extend(!0,e,n,{complete:function(e,t){n.buttons&&n.buttons.attr("disabled",!1),RB.setActivityIndicator(!1,n),_.isFunction(n.complete)&&n.complete(e,t),$.funcQueue("rbapicall").next()}});(null===e.data||void 0===e.data||e.data instanceof Object&&!(window.Blob&&e.data instanceof Blob))&&(e.data=$.extend({api_format:"json"},e.data||{})),n.form?n.form.ajaxSubmit(e):$.ajax(e)}n.type=n.type||"POST","GET"!==n.type&&"HEAD"!==n.type&&RB.UserSession.instance.get("readOnly")?console.error("%s request not sent. Site is in read-only mode.",n.type):RB.ajaxOptions.enableQueuing&&"GET"!==n.type?($.funcQueue("rbapicall").add(t),$.funcQueue("rbapicall").start()):t()},RB.storeAPIError=function(t){try{var e=JSON.parse(t.responseText);t.errorPayload=e,t.errorText=e.err.msg}catch(e){t.errorPayload=null,t.errorText="HTTP "+t.status+" "+t.statusText}},RB.ajaxOptions={enableQueuing:!0,enableIndicator:!0},Backbone.ajax=e=>RB.apiCall(e);class z extends Error{constructor(e,t,s){super(t.errorText),this.modelOrCollection=e,this.xhr=t,this.options=s}}RB.promiseToCallbacks=function(e,t,s){const i=_.isFunction(e.success)?e.success:_.isFunction(e.ready)?e.ready:void 0,a=_.isFunction(e.error)?e.error:void 0,r=_.isFunction(e.complete)?e.complete:void 0;s(_.omit(e,["success","ready","error","complete"])).then(e=>{i&&i.call(t,e)}).catch(e=>{a&&a.call(t,e.modelOrCollection,e.xhr,e.options)}).finally(()=>{r&&r.call(t)})},RB.DataUtils={ArrayBufferTypes:{int8:{size:1,funcName:"setInt8"},uint8:{size:1,funcName:"setUint8"},int16:{size:2,funcName:"setInt16"},uint16:{size:2,funcName:"setUint16"},int32:{size:4,funcName:"setInt32"},uint32:{size:4,funcName:"setUint32"},float32:{size:4,funcName:"setFloat32"},float64:{size:8,funcName:"setFloat64"}},readBlobAsArrayBuffer(e,t){RB.DataUtils._readBlobAs("readAsArrayBuffer",e,t)},readBlobAsString(e,t){RB.DataUtils._readBlobAs("readAsText",e,t)},readManyBlobsAsArrayBuffers(e,t){RB.DataUtils._readManyBlobsAs("readBlobAsArrayBuffer",e,t)},readManyBlobsAsStrings(e,t){RB.DataUtils._readManyBlobsAs("readBlobAsString",e,t)},buildArrayBuffer(t){var s=RB.DataUtils.ArrayBufferTypes;let i=0;for(let e=0;e<t.length;e++){var a=t[e];i+=s[a.type].size*a.values.length}var e=new ArrayBuffer(i),r=new DataView(e);let n=0;for(let e=0;e<t.length;e++){var o=t[e],l=o.values,d=!o.bigEndian,o=s[o.type],c=r[o.funcName],u=o.size;for(let e=0;e<l.length;e++)c.call(r,n,l[e],d),n+=u}return e},buildBlob(t){var s=[];for(let e=0;e<t.length;e++){var i=t[e];_.isArray(i)?s.push(RB.DataUtils.buildArrayBuffer(i)):s.push(i)}return new Blob(s)},_readBlobAs(e,t,s){const i=new FileReader;i.addEventListener("loadend",()=>s(i.result)),i[e](t)},_readManyBlobsAs(e,i,a){const t=RB.DataUtils[e];let r=new Array(i.length),n=0;i.forEach((e,s)=>{t(e,e=>{return t=s,e=e,r[t]=e,void(++n===i.length&&a.apply(null,r));var t})})}},RB.LinkifyUtils={URL_RE:new RegExp("\\b(("+["https://","http://","ftp://","ftps://","gopher://","mailto:","news:","sms:"].join("|")+")[\\-A-Za-z0-9+&@#/%?=~_()|!:,.;]*([\\-A-Za-z0-9+@#/%=~_();|]|))","g"),linkifyURLs(e){return e.replace(RB.LinkifyUtils.URL_RE,function(e){var t=e.match(/^(.*)(&[a-z]+;|\))$/),s=e.match(/.*\(.*/);let i="";return null!==t&&null===s&&(e=t[1],i=t[2]),`<a target="_blank" href="${e}">${e}</a>`+i})},linkifyReviewRequests(e){return e.replace(/(^|\s|&lt;|\(|\[|{)\/(r\/\d+(\/[\-A-Za-z0-9+&@#\/%?=~_()|!:,.;]*[\-A-Za-z0-9+&@#\/%=~_()|]*)?)/g,function(e,t,s){var i=s.match(/^(.*)(&[a-z]+;|\))$/);let a="",r=s;return null!==i&&(r=i[1],a=i[2]),`${t}<a target="_blank" href="${SITE_ROOT+r+("/"===r.substr(-1)?"":"/")}" class="review-request-link">/${r}</a>`+a})},linkifyBugs(e,r){return r?e.replace(/\b(bug|issue) (#([^.,)\]\s]+)|#?(\d+))/gi,function(e,t,s,i,a){return`<a target="_blank" href="${r.replace("--bug_id--",i||a)}">${e}</a>`}):e},linkifyText(e,t,s){return s||(e=_.escape(e)),e=RB.LinkifyUtils.linkifyURLs(e),e=RB.LinkifyUtils.linkifyReviewRequests(e),e=RB.LinkifyUtils.linkifyBugs(e,t)},linkifyChildren(t,s){for(let e=0;e<t.childNodes.length;e++){var i,a=t.childNodes[e];a.nodeType===a.TEXT_NODE?a.textContent&&(i=RB.LinkifyUtils.linkifyText(a.textContent,s))!==a.textContent&&$(a).replaceWith(i):a.nodeType===a.ELEMENT_NODE&&"PRE"!==a.nodeName&&"A"!==a.nodeName&&RB.LinkifyUtils.linkifyChildren(a,s)}}},RB.MathUtils={clip(e,t,s){return Math.min(s,Math.max(t,e))}},RB.KeyBindingsMixin={delegateKeyBindings(){this.$el.on("keypress.keybindings."+this.cid,_.bind(function(t){if(!(t.altKey||t.ctrlKey||t.metaKey||"INPUT"===t.target.tagName||"TEXTAREA"===t.target.tagName||t.target.isContentEditable)){var s,e=String.fromCharCode(t.which);for(s of Object.keys(this.keyBindings))if(-1!==s.indexOf(e)){t.stopPropagation(),t.preventDefault();let e=this.keyBindings[s];(e=_.isFunction(e)?e:this[e]).call(this,t)}}},this))},undelegateKeyBindings(){this.$el&&this.$el.off("keypress.keybindings."+this.cid)},delegateEvents(e){e=Backbone.View.prototype.delegateEvents.call(this,e);return this.delegateKeyBindings(),e},undelegateEvents(){var e=Backbone.View.prototype.undelegateEvents.call(this);return this.undelegateKeyBindings(),e}},RB.getLocationHash=function(e){var e=(e=void 0===e?window.location.href:e).split("#")[1]||"",t=decodeURIComponent(e);return t.match(/^[A-Za-z0-9,_\.-]*$/)?t:(console.warn('Ignoring location hash "%s".',e),"")},RB.navigateTo=function(e,t={}){t&&t.replace?window.location.replace(e):window.location=e},RB.reload=function(){window.location.reload()},RB.FilteredCollection=RB.BaseCollection.extend({initialize(e,t){this.collection=t.collection,this.filters=t.filters,this.listenTo(this.collection,"add",this._onItemAdded),this.listenTo(this.collection,"remove",this.remove),this.listenTo(this.collection,"reset",this._rebuild),this._rebuild()},setFilters(e){this.filters=e,this._rebuild()},_onItemAdded(e){this._passesFilters(e,!0)&&this.add(e)},_rebuild(){_.isEmpty(this.filters)?this.reset(this.collection.models):this.reset(this.collection.filter(this._passesFilters,this))},_passesFilters(s,e){return!(!e||this.filters&&!_.isEmpty(this.filters))||_.every(this.filters,(e,t)=>{t=s.get(t);return _.isString(e)?0===t.indexOf(e):t===e})}}),RB.Extension=Djblets.Extension,RB.ExtensionHook=Djblets.ExtensionHook,RB.ExtensionHookPoint=Djblets.ExtensionHookPoint,RB.CommentDialogHook=RB.ExtensionHook.extend({hookPoint:new RB.ExtensionHookPoint,defaults:_.defaults({viewType:null},RB.ExtensionHook.prototype.defaults),setUpHook(){console.assert(this.get("viewType"),'CommentDialogHook instance does not have a "viewType" attribute set.')}}),RB.FileAttachmentThumbnailContainerHook=RB.ExtensionHook.extend({hookPoint:new RB.ExtensionHookPoint,defaults:_.defaults({viewType:null},RB.ExtensionHook.prototype.defaults),setUpHook(){console.assert(this.get("viewType"),'FileAttachmentThumbnailContainerHook instance does not have a "viewType" attribute set.')}}),RB.ReviewDialogCommentHook=RB.ExtensionHook.extend({hookPoint:new RB.ExtensionHookPoint,defaults:_.defaults({viewType:null},RB.ExtensionHook.prototype.defaults),setUpHook(){console.assert(this.get("viewType"),'ReviewDialogCommentHook instance does not have a "viewType" attribute set.')}}),RB.ReviewDialogHook=RB.ExtensionHook.extend({hookPoint:new RB.ExtensionHookPoint,defaults:_.defaults({viewType:null},RB.ExtensionHook.prototype.defaults),setUpHook(){console.assert(this.get("viewType"),'ReviewDialogHook instance does not have a "viewType" attribute set.')}}),RB.ReviewRequestActionHook=RB.ExtensionHook.extend({hookPoint:new RB.ExtensionHookPoint,defaults:_.defaults({callbacks:null},RB.ExtensionHook.prototype.defaults),setUpHook(){console.assert(this.get("callbacks"),'ReviewRequestActionHook instance does not have a "callbacks" attribute set.')}}),RB.PageManager=Backbone.Model.extend({defaults:{page:null,rendered:!1},initialize(){this.once("change:page",()=>{this.trigger("beforeRender"),"complete"===document.readyState?this._renderPage():$(this._renderPage.bind(this))})},beforeRender(e,t){console.assert(!this.get("rendered"),"beforeRender called after page was rendered");var s=this.get("page");s?e.call(t,s):this.once("beforeRender",()=>e.call(t,this.get("page")))},ready(e,t){var s=this.get("page");s&&this.get("rendered")?e.call(t,s):this.once("change:rendered",()=>e.call(t,this.get("page")))},_renderPage(){this.get("page").render();var e=RB.HeaderView.instance;e.isRendered||e.render(),this.set("rendered",!0)}},{instance:null,setupPage(e){null!==this.getPage()?(console.warn(["A subclass of RB.PageView has already been set up in the ","PageManager. This might be an older template manually ","instantiating a PageView.\n","\n","Please update your template to use the js-page-view-type, ","js-page-view-options, js-page-model-type, ","js-page-model-type, and js-page-model-options blocks.\n","\n","Make sure they also call the parent initialize() method and ","override renderPage() instead of render().\n","\n","Support for legacy page registration is deprecated and will ","be removed in Review Board 5.0."].join("")),null===RB.HeaderView.instance&&new RB.HeaderView({el:$("#headerbar")})):(e=new e.viewType(_.extend({el:document.body,model:new e.modelType(e.modelAttrs,e.modelOptions)},e.viewOptions)),this.setPage(e))},beforeRender(e,t){this.instance.beforeRender(e,t)},ready(e,t){this.instance.ready(e,t)},setPage(e){this.instance.set("page",e)},getPage(){return this.instance.get("page")}}),RB.PageManager.instance=new RB.PageManager,RB.APIToken=RB.BaseResource.extend({defaults(){return _.defaults({deprecated:!1,expired:!1,expires:null,invalidDate:null,invalidReason:null,lastUsed:null,note:null,policy:{},tokenValue:null,userName:null,valid:!0},RB.BaseResource.prototype.defaults())},rspNamespace:"api_token",url(){var e=SITE_ROOT+(this.get("localSitePrefix")||"")+"api/users/"+this.get("userName")+"/api-tokens/";return this.isNew()?e:e+this.id+"/"},toJSON(){return{expires:this.get("expires"),note:this.get("note"),policy:JSON.stringify(this.get("policy"))}},parseResourceData(e){return{deprecated:e.deprecated,expired:e.expired,expires:e.expires,invalidDate:e.invalid_date,invalidReason:e.invalid_reason,lastUsed:e.last_used,note:e.note,policy:e.policy,tokenValue:e.token,valid:e.valid}}},{defaultPolicies:{readWrite:{},readOnly:{resources:{"*":{allow:["GET","HEAD","OPTIONS"],block:["*"]}}},custom:{resources:{"*":{allow:["*"],block:[]}}}}}),RB.RepositoryBranch=RB.BaseResource.extend({defaults(){return _.defaults({name:null,commit:null,isDefault:!1},RB.BaseResource.prototype.defaults())},rspNamespace:"branches",deserializedAttrs:["id","name","commit","isDefault"],serializedAttrs:["id","name","commit","isDefault"],attrToJsonMap:{isDefault:"default"},parse(e){return{id:e.id,name:e.name,commit:e.commit,isDefault:e.default}}}),RB.RepositoryCommit=RB.BaseResource.extend({defaults(){return _.defaults({accessible:!0,authorName:null,date:null,parent:null,message:null,summary:null,reviewRequestURL:null},RB.BaseResource.prototype.defaults())},rspNamespace:"commits",deserializedAttrs:["authorName","date","id","parent","message","summary","reviewRequestURL"],serializedAttrs:["authorName","date","id","parent","message","reviewRequestURL"],attrToJsonMap:{authorName:"author_name",reviewRequestURL:"review_request_url",summary:"message"},deserializers:{date:e=>e?new Date(e):"",summary:e=>e.split("\n",1)[0]},serializers:{date:e=>e.toString()},parseResourceData(e){var t=RB.BaseResource.prototype.parseResourceData.call(this,e);return t.accessible=e.date||e.message||e.author_name,t}}),RB.DraftReviewRequest=RB.BaseResource.extend(_.defaults({defaults(){return _.defaults({branch:null,bugsClosed:null,changeDescription:null,changeDescriptionRichText:!1,dependsOn:[],description:null,descriptionRichText:!1,public:null,rawTextFields:null,submitter:null,summary:null,targetGroups:[],targetPeople:[],testingDone:null,testingDoneRichText:!1},RB.BaseResource.prototype.defaults())},rspNamespace:"draft",listKey:"draft",supportsExtraData:!0,expandedFields:["depends_on","target_people","target_groups"],extraQueryArgs:{"force-text-type":"html","include-text-types":"raw"},attrToJsonMap:{bugsClosed:"bugs_closed",changeDescription:"changedescription",changeDescriptionRichText:"changedescription_text_type",dependsOn:"depends_on",descriptionRichText:"description_text_type",targetGroups:"target_groups",targetPeople:"target_people",testingDone:"testing_done",testingDoneRichText:"testing_done_text_type"},deserializedAttrs:["branch","bugsClosed","changeDescription","dependsOn","description","public","summary","targetGroups","targetPeople","testingDone"],url(){return this.get("parentObject").get("links").draft.href},createFileAttachment(e){return new RB.DraftFileAttachment(_.defaults({parentObject:this},e))},async publish(e={},t=void 0){if(_.isFunction(e.success)||_.isFunction(e.error)||_.isFunction(e.complete))return console.warn("RB.DraftReview.publish was called using callbacks. Callers should be updated to use promises instead."),RB.promiseToCallbacks(e,t,e=>this.publish(e));await this.ready();t=this.validate(this.attributes,{publishing:!0});if(t)throw new z(this,{errorText:t},e);await this.save(_.defaults({data:{public:1,trivial:e.trivial?1:0}},e))},parseResourceData(e){var t=e.raw_text_fields||e,s=RB.BaseResource.prototype.parseResourceData.call(this,e);return s.submitter=e.links.submitter,s.changeDescriptionRichText="markdown"===t.changedescription_text_type,s.descriptionRichText="markdown"===t.description_text_type,s.testingDoneRichText="markdown"===t.testing_done_text_type,s.rawTextFields=t||null,s}},RB.DraftResourceModelMixin)),RB.BaseCommentReply=RB.BaseResource.extend({defaults(){return _.defaults({forceTextType:null,includeTextTypes:null,rawTextFields:{},replyToID:null,richText:!1,text:""},RB.BaseResource.prototype.defaults())},attrToJsonMap:{forceTextType:"force_text_type",includeTextTypes:"include_text_types",replyToID:"reply_to_id",richText:"text_type"},serializedAttrs:["forceTextType","includeTextTypes","replyToID","richText","text"],deserializedAttrs:["text"],serializers:{forceTextType:RB.JSONSerializers.onlyIfValue,includeTextTypes:RB.JSONSerializers.onlyIfValue,replyToID:RB.JSONSerializers.onlyIfUnloaded,richText:RB.JSONSerializers.textType},destroyIfEmpty(){this.get("text")||this.destroy.apply(this,arguments)},parseResourceData(e){var t=e.raw_text_fields||e,s=RB.BaseResource.prototype.parseResourceData.call(this,e);return s.rawTextFields=e.raw_text_fields||{},s.richText="markdown"===t.text_type,s},validate(e){if(_.has(e,"parentObject")&&!e.parentObject)return RB.BaseResource.strings.UNSET_PARENT_OBJECT}}),RB.DiffComment=RB.BaseComment.extend({defaults:_.defaults({beginLineNum:0,endLineNum:0,fileDiff:null,fileDiffID:null,interFileDiff:null,interFileDiffID:null,baseFileDiffID:null},RB.BaseComment.prototype.defaults()),rspNamespace:"diff_comment",expandedFields:["filediff","interfilediff"],attrToJsonMap:_.defaults({baseFileDiffID:"base_filediff_id",beginLineNum:"first_line",fileDiffID:"filediff_id",interFileDiffID:"interfilediff_id",numLines:"num_lines"},RB.BaseComment.prototype.attrToJsonMap),serializedAttrs:["baseFileDiffID","beginLineNum","fileDiffID","interFileDiffID","numLines"].concat(RB.BaseComment.prototype.serializedAttrs),deserializedAttrs:["beginLineNum","endLineNum"].concat(RB.BaseComment.prototype.deserializedAttrs),serializers:_.defaults({fileDiffID:RB.JSONSerializers.onlyIfUnloaded,interFileDiffID:RB.JSONSerializers.onlyIfUnloadedAndValue,baseFileDiffID:RB.JSONSerializers.onlyIfUnloadedAndValue,numLines:function(){return this.getNumLines()}},RB.BaseComment.prototype.serializers),getNumLines(){return this.get("endLineNum")-this.get("beginLineNum")+1},parseResourceData(e){var t=RB.BaseComment.prototype.parseResourceData.call(this,e);return t.endLineNum=e.num_lines+t.beginLineNum-1,t.fileDiff=new RB.FileDiff(e.filediff,{parse:!0}),e.interfilediff&&(t.interFileDiff=new RB.FileDiff(e.interfilediff,{parse:!0})),t},validate(e){var t,s;return this.isNew()&&_.has(e,"fileDiffID")&&!e.fileDiffID?RB.DiffComment.strings.INVALID_FILEDIFF_ID:(t=_.has(e,"beginLineNum"))&&e.beginLineNum<0?RB.DiffComment.strings.BEGINLINENUM_GTE_0:(s=_.has(e,"endLineNum"))&&e.endLineNum<0?RB.DiffComment.strings.ENDLINENUM_GTE_0:t&&s&&e.beginLineNum>e.endLineNum?RB.DiffComment.strings.BEGINLINENUM_LTE_ENDLINENUM:RB.BaseComment.prototype.validate.apply(this,arguments)}},{strings:{INVALID_FILEDIFF_ID:"fileDiffID must be a valid ID",BEGINLINENUM_GTE_0:"beginLineNum must be >= 0",ENDLINENUM_GTE_0:"endLineNum must be >= 0",BEGINLINENUM_LTE_ENDLINENUM:"beginLineNum must be <= endLineNum"}}),RB.DiffCommentReply=RB.BaseCommentReply.extend({rspNamespace:"diff_comment"}),RB.Diff=RB.BaseResource.extend({defaults(){return _.defaults({diff:null,parentDiff:null,basedir:null},RB.BaseResource.prototype.defaults())},rspNamespace:"diff",attrToJsonMap:{diff:"path",parentDiff:"parent_diff_path"},serializedAttrs:["basedir","diff","parentDiff"].concat(RB.BaseResource.prototype.serializedAttrs),payloadFileKeys:["path","parent_diff_path"],listKey:"diffs",getErrorString(e){return e.err.code===RB.APIErrors.REPO_FILE_NOT_FOUND?interpolate(gettext('The file "%(file)s" (revision %(revision)s) was not found in the repository'),{file:e.file,revision:e.revision},!0):e.err.msg}}),RB.FileAttachmentComment=RB.BaseComment.extend({defaults:_.defaults({diffAgainstFileAttachmentID:null,diffAgainstFileAttachment:null,fileAttachmentID:null,fileAttachment:null,linkText:null,reviewURL:null,thumbnailHTML:null},RB.BaseComment.prototype.defaults()),rspNamespace:"file_attachment_comment",expandedFields:["diff_against_file_attachment","file_attachment"],attrToJsonMap:_.defaults({diffAgainstFileAttachmentID:"diff_against_file_attachment_id",fileAttachmentID:"file_attachment_id",linkText:"link_text",reviewURL:"review_url",thumbnailHTML:"thumbnail_html"},RB.BaseComment.prototype.attrToJsonMap),serializedAttrs:["diffAgainstFileAttachmentID","fileAttachmentID"].concat(RB.BaseComment.prototype.serializedAttrs),deserializedAttrs:["linkText","thumbnailHTML","reviewURL"].concat(RB.BaseComment.prototype.deserializedAttrs),serializers:_.defaults({fileAttachmentID:RB.JSONSerializers.onlyIfUnloaded,diffAgainstFileAttachmentID:RB.JSONSerializers.onlyIfUnloadedAndValue},RB.BaseComment.prototype.serializers),parseResourceData(e){var t=RB.BaseComment.prototype.parseResourceData.call(this,e);return t.fileAttachment=new RB.FileAttachment(e.file_attachment,{parse:!0}),t.fileAttachmentID=t.fileAttachment.id,e.diff_against_file_attachment&&(t.diffAgainstFileAttachment=new RB.FileAttachment(e.diff_against_file_attachment,{parse:!0}),t.diffAgainstFileAttachmentID=t.diffAgainstFileAttachment.id),t},validate(e,t){return _.has(e,"fileAttachmentID")&&!e.fileAttachmentID?RB.FileAttachmentComment.strings.INVALID_FILE_ATTACHMENT_ID:_super(this).validate.call(this,e,t)}},{strings:{INVALID_FILE_ATTACHMENT_ID:"fileAttachmentID must be a valid ID"}}),RB.FileAttachmentCommentReply=RB.BaseCommentReply.extend({rspNamespace:"file_attachment_comment"}),RB.GeneralComment=RB.BaseComment.extend({rspNamespace:"general_comment"}),RB.GeneralCommentReply=RB.BaseCommentReply.extend({rspNamespace:"general_comment"}),RB.FileDiff=RB.BaseResource.extend({defaults(){return _.defaults({destFilename:null,sourceFilename:null,sourceRevision:null},RB.BaseResource.prototype.defaults())},rspNamespace:"filediff",parseResourceData:function(e){return{destFilename:e.dest_file,sourceFilename:e.source_file,sourceRevision:e.source_revision}}}),RB.Screenshot=RB.BaseResource.extend({defaults(){return _.defaults({caption:null,filename:null,reviewURL:null},RB.BaseResource.prototype.defaults())},rspNamespace:"screenshot",attrToJsonMap:{reviewURL:"review_url"},serializedAttrs:["caption"],deserializedAttrs:["caption","filename","reviewURL"],getDisplayName(){return this.get("caption")||this.get("filename")}}),RB.ScreenshotComment=RB.BaseComment.extend({defaults:_.defaults({x:null,y:null,width:null,height:null,screenshotID:null,screenshot:null,thumbnailURL:null},RB.BaseComment.prototype.defaults()),rspNamespace:"screenshot_comment",expandedFields:["screenshot"],attrToJsonMap:_.defaults({width:"w",height:"h",thumbnailURL:"thumbnail_url",screenshotID:"screenshot_id"},RB.BaseComment.prototype.attrToJsonMap),serializedAttrs:["x","y","width","height","screenshotID"].concat(RB.BaseComment.prototype.serializedAttrs),deserializedAttrs:["x","y","width","height","thumbnailURL"].concat(RB.BaseComment.prototype.deserializedAttrs),serializers:_.defaults({screenshotID:RB.JSONSerializers.onlyIfUnloaded},RB.BaseComment.prototype.serializers),parseResourceData(e){var t=RB.BaseComment.prototype.parseResourceData.call(this,e);return t.screenshot=new RB.Screenshot(e.screenshot,{parse:!0}),t.screenshotID=t.screenshot.id,t},validate(e){return _.has(e,"screenshotID")&&!e.screenshotID?RB.ScreenshotComment.strings.INVALID_SCREENSHOT_ID:_.has(e,"x")&&e.x<0?RB.ScreenshotComment.strings.INVALID_X:_.has(e,"y")&&e.y<0?RB.ScreenshotComment.strings.INVALID_Y:_.has(e,"width")&&e.width<=0?RB.ScreenshotComment.strings.INVALID_WIDTH:_.has(e,"height")&&e.height<=0?RB.ScreenshotComment.strings.INVALID_HEIGHT:RB.BaseComment.prototype.validate.apply(this,arguments)}},{strings:{INVALID_SCREENSHOT_ID:"screenshotID must be a valid ID",INVALID_X:"x must be >= 0",INVALID_Y:"y must be >= 0",INVALID_WIDTH:"width must be > 0",INVALID_HEIGHT:"height must be > 0"}}),RB.ScreenshotCommentReply=RB.BaseCommentReply.extend({rspNamespace:"screenshot_comment"}),RB.UserFileAttachment=RB.BaseResource.extend({defaults(){return _.defaults({caption:null,downloadURL:null,file:null,filename:null},RB.BaseResource.prototype.defaults())},rspNamespace:"user_file_attachment",payloadFileKeys:["path"],attrToJsonMap:{downloadURL:"absolute_url",file:"path"},serializedAttrs:["caption","file"],deserializedAttrs:["caption","downloadURL","filename"],serializers:{file:RB.JSONSerializers.onlyIfValue},url(){var e=RB.UserSession.instance.get("userFileAttachmentsURL");return this.isNew()?e:""+e+this.id+"/"}}),RB.ValidateDiffModel=RB.Diff.extend({defaults:_.defaults({repository:null,localSitePrefix:""},_.result(RB.Diff.prototype,"defaults")),serializedAttrs:["repository"].concat(RB.Diff.prototype.serializedAttrs),url(){return SITE_ROOT+(this.get("localSitePrefix")||"")+"api/validation/diffs/"},parse(){}}),RB.RepositoryBranches=RB.BaseCollection.extend({model:RB.RepositoryBranch,parse(e){return e.branches}}),RB.RepositoryCommits=RB.BaseCollection.extend({model:RB.RepositoryCommit,initialize(e,t){Backbone.Collection.prototype.initialize.call(this,e,t),this.options=t,this.busy=!1,this.complete=!1,this._nextStart=null},parse(e){var t=e.commits;return this._nextStart=t[t.length-1].parent,this.complete=!this._nextStart,e.commits},url(){var e={};return void 0!==this.options.start&&(e.start=this.options.start),void 0!==this.options.branch&&(e.branch=this.options.branch),this.options.urlBase+"?"+$.param(e)},canFetchNext(){return!this.busy&&!this.complete&&0<this.models.length},async fetchNext(e={},t=void 0){if(_.isFunction(e.success)||_.isFunction(e.error)||_.isFunction(e.complete))return console.warn("RB.RepositoryCommits.fetchNext was called using callbacks. Callers should be updated to use promises instead."),RB.promiseToCallbacks(e,t,e=>this.fetchNext(e));this.canFetchNext()&&(this.options.start=this._nextStart,await this.fetch({remove:!1}),this.busy=!1)}}),RB.DialogView=Backbone.View.extend({title:null,body:null,buttons:[],defaultOptions:{},events:{"submit form":"_onFormSubmit"},initialize(e={}){(this.options=e).title&&(this.title=e.title),e.body&&(this.body=e.body),e.buttons&&(this.buttons=e.buttons),this.visible=!1},render(){return this},show(){var e;this.visible||((e=_.result(this,"body"))&&this.$el.append(e),this._makeButtons(),this.render(),this.$el.modalBox(_.defaults({title:_.result(this,"title"),buttons:this.$buttonsList,destroy:()=>this.visible=!1},this.options,this.defaultOptions)),this.$el.closest(".modalbox-inner").on("keydown",this._onDialogKeyDown.bind(this)),this.visible=!0)},hide(){this.visible&&(this.$el.data("uiModalBox")&&this.$el.modalBox("destroy"),this.visible=!1)},remove(){this.hide(),Backbone.View.prototype.remove.call(this)},_makeButtons(){this.$buttonsMap={},this.$buttonsList=this.buttons.map(e=>{var t={id:e.id},t=(e.class&&(t.class=e.class),e.disabled&&(t.disabled=!0),e.primary?t.type="primary":e.danger&&(t.type="danger"),e.onClick&&(t.onClick=_.isFunction(e.onClick)?e.onClick:this[e.onClick].bind(this)),$(Ink.paintComponent("Ink.Button",t,e.label)));return this.$buttonsMap[e.id]=t,e.primary&&(this._$primaryButton=t),t})},_onFormSubmit(e){$(e.target).attr("action")||(e.preventDefault(),e.stopPropagation(),this._$primaryButton&&this._$primaryButton[0].click())},_onDialogKeyDown(e){e.which===$.ui.keyCode.ESCAPE&&(e.stopPropagation(),e.preventDefault(),this.hide())}}),RB.FormView=Backbone.View.extend({events:{"click .rb-c-form-fieldset__toggle":"_onToggleFieldSetClicked"},initialize(){this._$subforms=null,this._subformsByGroup={},this._formWidgetsInitialized=!1},render(){return this._$subforms=this.$(".rb-c-form-fieldset.-is-subform"),0<this._$subforms.length&&this._setupSubforms(),this.setupFormWidgets(),this},setupFormWidgets(e){void 0===e&&(e=this.$el),window.DateTimeShortcuts&&0<e.find(".datetimeshortcuts").length&&(this._formWidgetsInitialized&&$(".datetimeshortcuts").remove(),DateTimeShortcuts.init()),window.SelectFilter&&(e.find(".selectfilter").each((e,t)=>{var s=t.name.split("-");SelectFilter.init(t.id,s[s.length-1],!1)}),e.find(".selectfilterstacked").each((e,t)=>{var s=t.name.split("-");SelectFilter.init(t.id,s[s.length-1],!0)})),this._formWidgetsInitialized=!0},setSubformVisibility(e){console.assert(_.isObject(e),"An options object must be provided.");var t=e.group;const s=e.subformID,i=e.visible;console.assert(t,'Missing option "group"');var a=this._subformsByGroup[t];console.assert(a,"Invalid subform group "+t),e.hideOthers||!s?_.each(a,(e,t)=>{t=void 0===s?!i:t!==s;e.prop({disabled:t,hidden:t})}):(console.assert(void 0!==i,'Missing option "visible"'),t=a[s],console.assert(t,"Invalid subform ID "+s),t.prop({disabled:!i,hidden:!i}))},_setupSubforms(){const c={};this._$subforms.each((e,t)=>{const s=$(t);var i=s.data("subform-controller"),a=s.data("subform-id"),r=s.data("subform-enabler");let n=s.data("subform-group"),o,l;if(a)if(n||i||r){if(i){o=this.$("#"+i),console.assert(1===o.length,"Missing controller #"+i);var d=o.data("subform-group");if(void 0===n)n=d;else if(d!==n)return void console.error("Subform %o and controller %s have different values for data-subform-group",t,i)}else r&&(l=this.$("#"+r),window.$form=this.$el,console.assert(1===l.length,"Missing enabler #"+r));this._subformsByGroup.hasOwnProperty(n)||(this._subformsByGroup[n]={}),this._subformsByGroup[n][a]=s,o&&(this.setSubformVisibility({group:n,subformID:a,visible:o.val()===a}),c[i]||(c[i]=!0,o.on("change",()=>this.setSubformVisibility({group:n,subformID:o.val(),visible:!0,hideOthers:!0})))),l&&(d=l.is(":checked"),s.toggle(d).prop("disabled",!d),l.on("change",()=>{var e=l.is(":checked");s.toggle(e).prop("disabled",!e)}))}else console.error("Subform %o is missing data-subform-group=, data-subform-controller=, or data-subform-enable=",t);else console.error("Subform %o is missing data-subform-id=",t)})},_onToggleFieldSetClicked(e){e.preventDefault(),e.stopPropagation();var e=$(e.target),t=e.closest(".rb-c-form-fieldset");t.hasClass("-is-collapsed")?(t.removeClass("-is-collapsed"),e.text(gettext("(Hide)"))):(t.addClass("-is-collapsed"),e.text(gettext("(Show)")))}}),RB.BaseInfoboxView=Backbone.View.extend({infoboxID:null,DEFAULT_POSITIONING:{side:"tb",xOffset:-20,yDistance:10},events:{"mouseenter .infobox-hover-item-anchor":"_onHoverItemMouseEnter","mouseleave .infobox-hover-item":"_onHoverItemMouseLeave","mouseenter .infobox-scrollable-section":"_onScrollableMouseEnter","mouseleave .infobox-scrollable-section":"_onScrollableMouseLeave"},initialize(){this.positioning=this.DEFAULT_POSITIONING,this._scrollbarWidth=null},className(){return"infobox "+this.infoboxID},getURLForTarget(e){return e.attr("href")+"infobox/"},setContents(e){this.$el.html(e),this.render()},render(){return this._scrollbarWidth=null,this.$el.css("width","").find(".infobox-scrollable-section").css("padding-right",this._getScrollbarWidth()),_.defer(()=>this.$el.width(this.$el.width())),this},_getScrollbarWidth(){var e,t,s;return null===this._scrollbarWidth&&(t=(e=$("<div>test</div>").css({visibility:"hidden",position:"absolute",left:-1e4,top:-1e4}).appendTo(document.body)).width(),e.css("overflow-y","scroll"),s=e.width(),e.remove(),this._scrollbarWidth=s-t),this._scrollbarWidth},_onHoverItemMouseEnter(e){$(e.target).closest(".infobox-hover-item").addClass("infobox-hover-item-opened")},_onHoverItemMouseLeave(e){$(e.target).closest(".infobox-hover-item").removeClass("infobox-hover-item-opened")},_onScrollableMouseEnter(e){$(e.target).closest(".infobox-scrollable-section").css("padding-right",0)},_onScrollableMouseLeave(e){$(e.target).closest(".infobox-scrollable-section").css("padding-right",this._getScrollbarWidth())}}),RB.InfoboxManagerView=Backbone.View.extend({POPUP_DELAY_MS:700,HIDE_DELAY_MS:400,FADE_IN_MS:200,FADE_OUT_MS:150,initialize(){this._infoboxViews={},this._activeInfoboxView=null,this._cache={},this._showTimeout=null,this._hideTimeout=null},remove(){for(var e in Backbone.View.prototype.remove.call(this),this._infoboxViews)this._infoboxViews.hasOwnProperty(e)&&this._infoboxViews[e].remove();this._infoboxViews={},this._cache={},this._activeInfoboxView=null},addTargets(s,e){e.each((e,t)=>{t=$(t);t.data("has-infobox")||t.data("has-infobox",!0).on("mouseenter",this._onTargetMouseEnter.bind(this,t,s)).on("mouseleave",this._onMouseLeave.bind(this))})},setPositioning(e,t){this.getOrCreateInfobox(e).positioning=t},getOrCreateInfobox(e){var t=e.prototype.infoboxID,s=(console.assert(t,"RB.BaseInfoboxView subclasses must have an infoboxID defined."),this._infoboxViews[t]);return s||((s=new e).$el.hide().on("mouseenter",this._onInfoboxMouseEnter.bind(this)).on("mouseleave",this._onMouseLeave.bind(this)).appendTo(document.body),this._infoboxViews[t]=s),s},_loadInfobox(t,s){console.assert(1===t.length,"Too many targets matched when fetching infobox contents");const i=s.getURLForTarget(t),a=this._cache[i];void 0!==a&&(s.setContents(a),this._showInfobox(s,t)),this._fetchInfoboxContents(i,e=>{this._cache[i]=e,s.setContents(e),void 0===a&&this._showInfobox(s,t)})},_fetchInfoboxContents(e,t){$.ajax(e,{ifModified:!0}).done(t)},_showInfobox(e,t){e.$el.positionToSide(t,_.defaults(e.positioning,{fitOnScreen:!0})).fadeIn(this.FADE_IN_MS),this._activeInfoboxView=e},_hideInfobox(){if(this._activeInfoboxView){const e=this._activeInfoboxView;this._activeInfoboxView.$el.fadeOut(this.FADE_OUT_MS,()=>{e===this._activeInfoboxView&&(this._activeInfoboxView=null)})}},_onInfoboxMouseEnter(){clearTimeout(this._hideTimeout),this._hideTimeout=null},_onTargetMouseEnter(e,t){clearTimeout(this._hideTimeout),this._hideTimeout=null,this._showTimeout=setTimeout(()=>{this._showTimeout=null,this._loadInfobox(e,this.getOrCreateInfobox(t))},this.POPUP_DELAY_MS)},_onMouseLeave(){clearTimeout(this._showTimeout),this._showTimeout=null,this._activeInfoboxView&&(clearTimeout(this._hideTimeout),this._hideTimeout=setTimeout(()=>{this._hideInfobox(),this._hideTimeout=null},this.HIDE_DELAY_MS))}},{_instance:null,getInstance(){let e=RB.InfoboxManagerView._instance;return e||(e=new RB.InfoboxManagerView,this._instance=e),e},createJQueryFn(e){return function(){return RB.InfoboxManagerView.getInstance().addTargets(e,this),this}}}),RB.BugInfoboxView=RB.BaseInfoboxView.extend({infoboxID:"bug-infobox"}),$.fn.bug_infobox=RB.InfoboxManagerView.createJQueryFn(RB.BugInfoboxView),RB.DrawerView=Backbone.View.extend({className:"rb-c-drawer",initialize(){this.isVisible=!1,this.$content=null,this._$body=null},render(){return this.$content=$('<div class="rb-c-drawer__content">'),this._$body=$(document.body),this.$el.empty().append(this.$content),this},show(){this.isVisible=!0,this._$body.addClass("js-rb-c-drawer-is-shown"),this.trigger("visibilityChanged",!0)},hide(){this.isVisible=!1,this._$body.removeClass("js-rb-c-drawer-is-shown"),this.trigger("visibilityChanged",!1)}}),RB.NotificationManager=Backbone.View.extend({initialize(){this._canNotify=!1,this._notification=null},setup(){var e=RB.NotificationManager.Notification;this._canNotify=void 0!==e&&RB.UserSession.instance.get("enableDesktopNotifications"),this._canNotify&&!this._haveNotificationPermissions()&&e.requestPermission()},_haveNotificationPermissions(){return this._canNotify&&"granted"===RB.NotificationManager.Notification.permission},shouldNotify(){return this._canNotify&&this._haveNotificationPermissions()},notify(e){if(this._canNotify){this._notification&&this._notification.close(),console.assert(e.hasOwnProperty("title"),'RB.NotificationManager.notify requires "title" property');const t=new RB.NotificationManager.Notification(e.title,{body:e.body,icon:e.iconURL});(this._notification=t).onclick=function(){_.isFunction(e.onClick)&&e.onClick(),t.close()},_.delay(()=>t.close(),RB.NotificationManager.NOTIFICATION_LIFETIME_MSECS)}}},{instance:null,NOTIFICATION_LIFETIME_MSECS:1e4,Notification:window.Notification||window.mozNotification||window.webkitNotification}),RB.NotificationManager.instance=new RB.NotificationManager,RB.ReviewRequestInfoboxView=RB.BaseInfoboxView.extend({infoboxID:"review-request-infobox"}),$.fn.review_request_infobox=RB.InfoboxManagerView.createJQueryFn(RB.ReviewRequestInfoboxView),RB.ScrollManagerView=Backbone.View.extend({initialize(){this.scrollYOffset=0,this.window=window,this._updateScrollPosScheduled=!1,this._pendingElements=new Map,this._elements=new Map,this._oldScrollY=null,this._useScrollYOffset=!1},scrollToElement(e){this.scrollToPosition(e.offset().top)},scrollToPosition(e){this._oldScrollY=e,this._useScrollYOffset=!0,this.window.scrollTo(this.window.pageXOffset,e),"scrollRestoration"in history&&(history.scrollRestoration="manual"),this._scheduleUpdateScrollPos(!0)},markForUpdate(e){console.assert(1===e.length);var t=e.offset();this._pendingElements.set(e[0],{oldHeight:e.outerHeight(),oldOffset:{left:t.left,top:t.top}}),null===this._oldScrollY&&(this._oldScrollY=this.window.pageYOffset)},markUpdated(e){console.assert(1===e.length);var t=e[0],s=this._pendingElements.get(t);s&&(s.newHeight=e.outerHeight(),s.newOffset=e.offset(),this._elements.set(t,s),this._pendingElements.delete(t)),this._scheduleUpdateScrollPos()},_scheduleUpdateScrollPos(){this._updateScrollPosScheduled||(this._updateScrollPosScheduled=!0,this.window.requestAnimationFrame(this._updateScrollPos.bind(this)))},_updateScrollPos(){const s=[];this._elements.forEach((e,t)=>{e.oldHeight!==e.newHeighht&&(e.el=t,s.push(e))});let t=this._oldScrollY;if(this._useScrollYOffset&&(t-=this.scrollYOffset),0<s.length){s.sort((e,t)=>e.newOffset.top-t.newOffset.top);for(let e=0;e<s.length;e++){var i=s[e];i.newOffset.top+i.newHeight<t&&(t+=i.newHeight-i.oldHeight+(i.newOffset.top-i.oldOffset.top))}}this.window.scrollTo(this.window.pageXOffset,t),this._elements.clear(),this._oldScrollY=null,this._useScrollYOffset=!1,this._updateScrollPosScheduled=!1}}),RB.scrollManager=new RB.ScrollManagerView,RB.UserInfoboxView=RB.BaseInfoboxView.extend({infoboxID:"user-infobox",render(){RB.BaseInfoboxView.prototype.render.call(this);var e,t=this.$(".localtime").children("time");return 0<t.length&&(e=t.data("timezone"),e=moment.tz(e),t.text(e.format("LT"))),this.$(".timesince").timesince(),this}}),$.fn.user_infobox=RB.InfoboxManagerView.createJQueryFn(RB.UserInfoboxView),RB.StarManager=Backbone.Model.extend({defaults(){return{objects:{},starred:{}}}}),RB.ClientLoginView=Backbone.View.extend({contentTemplate:_.template(`<h1><%- header %></h1>
<p><%- message %><span id="redirect-counter"><%- count %></span></p>`),initialize(e){this._clientName=e.clientName,this._clientURL=decodeURIComponent(e.clientURL),this._payload=e.payload,this._redirectTo=decodeURIComponent(e.redirectTo),this._username=e.username,this._redirectCounter=3},async render(){let e;var t=this._clientName,s=this._username,i=this._redirectCounter,a=this.$(".auth-header");try{e=await this._sendDataToClient()}catch(e){return a.html(this.contentTemplate({count:"",header:interpolate(gettext("Failed to log in for %(clientName)s"),{clientName:t},!0),message:interpolate(gettext("Could not connect to %(clientName)s. Please contact your administrator."),{clientName:t},!0)})),this}return e.ok?this._redirectTo?(a.html(this.contentTemplate({count:` ${i}...`,header:interpolate(gettext("Logged in to %(clientName)s"),{clientName:t},!0),message:interpolate(gettext("You have successfully logged in to %(clientName)s as %(username)s. Redirecting in"),{clientName:t,username:s},!0)})),this._$counter=$("#redirect-counter"),this._interval=setInterval(this._redirectCountdown.bind(this),1e3)):a.html(this.contentTemplate({count:"",header:interpolate(gettext("Logged in to %(clientName)s"),{clientName:t},!0),message:interpolate(gettext("You have successfully logged in to %(clientName)s as %(username)s. You can now close this page."),{clientName:t,username:s},!0)})):a.html(this.contentTemplate({count:"",header:interpolate(gettext("Failed to log in for %(clientName)s"),{clientName:t},!0),message:interpolate(gettext("Failed to log in for %(clientName)s as %(username)s. Please contact your administrator."),{clientName:t,username:s},!0)})),this},_redirectCountdown(){var e=--this._redirectCounter;this._$counter.text(` ${e}...`),e<=0&&(clearInterval(this._interval),RB.navigateTo(this._redirectTo))},async _sendDataToClient(){return await fetch(this._clientURL,{method:"POST",headers:{"Content-Type":"application/json; charset=UTF-8"},body:JSON.stringify(this._payload)})}}),RB.HeaderView=Backbone.View.extend({SEARCH_SUMMARY_TRIM_LEN:28,DESKTOP_SEARCH_RESULTS_WIDTH:350,events:{"click #nav_toggle":"_handleNavClick","touchstart #nav_toggle":"_handleNavClick","focus #search_field":"_closeMobileMenu"},_ensureSingleton(){null!==RB.HeaderView.instance?console.warn("There are two instances of RB.HeaderView on the page. Make sure only one RB.PageView is instantiated and registered through RB.PageManager.setupPage()."):RB.HeaderView.instance=this},initialize(e={}){this._ensureSingleton(),this.options=e,this.isRendered=!1,this._mobileMenuOpened=!1,this._$window=null,this._$body=null,this._$navToggle=null,this._$mobileMenuMask=null},remove(){RB.HeaderView.instance===this&&(RB.HeaderView.instance=null),this._$window&&this._$window.off("resize.rbHeaderView",this._recalcFunc),Backbone.View.prototype.remove.call(this)},render(){var e=this.options;return this._$window=$(window),this._$body=e.body||$(document.body),this._$navToggle=$("#nav_toggle"),this._$mobileMenuMask=$('<div id="mobile_menu_mask">').on("click touchstart",this._closeMobileMenu.bind(this)).insertAfter(e.$pageSidebar||$("#page-sidebar")),this._recalcFunc=_.throttle(this._recalcMobileMode.bind(this),100),this._$window.on("resize.rbHeaderView",this._recalcFunc),this._recalcMobileMode(),this._setupSearch(),this.isRendered=!0,this},_handleNavClick(e){e.stopPropagation(),e.preventDefault(),this._setMobileMenuOpened(!this._mobileMenuOpened)},_recalcMobileMode(){var e=this._$navToggle.is(":visible");e!==this.inMobileMode&&(e||this._setMobileMenuOpened(!1),this.inMobileMode=e,this.trigger("mobileModeChanged",e))},_closeMobileMenu(){return this._setMobileMenuOpened(!1),!1},_setupSearch(){this._$search=$("#search_field").rbautocomplete({formatItem:e=>{let t;var s;return e.username?(t=e.username,e.fullname&&(t+=` <span>(${_.escape(e.fullname)})</span>`)):e.name?(s=_.escape(e.display_name),t=e.name+` <span>(${s})</span>`):e.summary&&(t=e.summary.length<this.SEARCH_SUMMARY_TRIM_LEN?e.summary:e.summary.substring(0,this.SEARCH_SUMMARY_TRIM_LEN),t+=` <span>(${_.escape(e.id)})</span>`),t},matchCase:!1,multiple:!1,clickToURL:!0,selectFirst:!1,width:this.DESKTOP_SEARCH_RESULTS_WIDTH,enterToURL:!0,resultsParentEl:$("#page-container"),resultsClass:"ui-autocomplete-results search-results",parse:e=>{var s=["users","groups","review_requests"],i=["username","name","summary"],a=[];for(let t=0;t<s.length;t++){var r=s[t],n=e.search[r];for(let e=0;e<n.length;e++){var o=n[e],l=i[t];(2!==t||o.public)&&a.push({data:o,value:o[l],result:o[l]})}}return a},url:SITE_ROOT+"api/search/",extraParams:{"only-fields":"display_name,fullname,id,name,public,summary,url,username","only-links":""}})},_setMobileMenuOpened(e){e!==this._mobileMenuOpened&&(e?(this._$mobileMenuMask.show(),_.defer(()=>this._$body.addClass("js-mobile-menu-open"))):(this._$body.removeClass("js-mobile-menu-open"),_.delay(()=>this._$mobileMenuMask.hide(),300)),this._mobileMenuOpened=e)}},{instance:null}),RB.CollectionView=Backbone.View.extend({itemViewType:null,initialize(e){e.itemViewType&&(this.itemViewType=e.itemViewType),this.itemViewOptions=e.itemViewOptions||{};e=e.collection;this.collection=e,this.views=[],this._viewsByModelID={},e.each(this._onAdded,this),this.listenTo(e,"add",this._onAdded),this.listenTo(e,"remove",this._onRemoved),this.listenTo(e,"sort",this._onSorted),this.listenTo(e,"reset",this._onReset),this.$container=this.$el},render(){return this._rendered=!0,this.$container.empty(),this._addCollectionViews(),this},_addCollectionViews(){this.views.forEach(e=>this.$container.append(e.render().el))},_onAdded(e){console.assert(this.itemViewType,"itemViewType must be defined by the subclass");var t=new this.itemViewType(_.defaults({model:e},this.itemViewOptions));this.views.push(t),this._viewsByModelID[e.cid]=t,this._rendered&&this.$container.append(t.render().el)},_onRemoved(e){var t=this._viewsByModelID[e.cid];t&&(delete this._viewsByModelID[e.cid],this.views=_.without(this.views,t),this._rendered)&&t.remove()},_onSorted(){this.views;var t=this.collection.models,s=this.views;let i=!1;if(t.length===s.length){for(let e=0;e<s.length;e++)if(s[e].model!==t[e]){i=!0;break}}else i=!0;i&&(this.views=this.collection.map(e=>this._viewsByModelID[e.cid]),this._rendered)&&(this.$container.children().detach(),this._addCollectionViews())},_onReset(){this.views.forEach(e=>e.remove()),this.views=[],this._viewsByModelID={},this.collection.each(this._onAdded,this)}}),RB.StarManagerView=Backbone.View.extend({initialize(e={}){const r=this.model.get("objects"),n=this.model.get("starred");this._datagridMode=e.datagridMode,this.$("div.star").on("click",this._toggleStar.bind(this)).each((e,t)=>{var t=$(t),s=t.attr("data-object-type"),i=t.attr("data-object-id"),t=1===parseInt(t.attr("data-starred"),10);let a;if("reviewrequests"===s)a=new RB.ReviewRequest({id:i});else if("groups"===s)a=new RB.ReviewGroup({id:i});else{if(void 0===s)return;console.assert("Unknown star object type: %s",s)}r[i]=a,n[i]=t}),this._watchUpdates=!1,this._toUpdate={},this._datagridMode&&(this.$el.on("datagridDisplayModeChanged",(e,t)=>{if("desktop"===t.mode){for(var s in this._toUpdate)this._toUpdate.hasOwnProperty(s)&&this._updateStarColumn(s);this._watchUpdates=!1,this._toUpdate={}}else"mobile"===t.mode&&(this._watchUpdates=!0)}),"mobile"===this.$el.attr("data-datagrid-display-mode"))&&(this._watchUpdates=!0)},_updateStarColumn(e){var t=this.$(`.star[data-object-id="${e}"]`),e=this.model.get("starred")[e];t.toggleClass("rb-icon-star-on",e).toggleClass("rb-icon-star-off",!e).attr("title",e?gettext("Starred"):gettext("Click to star"))},_toggleStar(e){var t=$(e.target),s=t.attr("data-object-id"),i=this.model.get("objects")[s],a=this.model.get("starred"),r=!a[s];e.preventDefault(),e.stopPropagation(),RB.UserSession.instance.get("readOnly")||(i.setStarred(r),a[s]=r,this._watchUpdates&&(this._toUpdate.hasOwnProperty(s)?delete this._toUpdate[s]:this._toUpdate[s]=!0),t.toggleClass("rb-icon-star-on",r).toggleClass("rb-icon-star-off",!r).attr("title",r?gettext("Starred"):gettext("Click to star")))}})}.call(this);
