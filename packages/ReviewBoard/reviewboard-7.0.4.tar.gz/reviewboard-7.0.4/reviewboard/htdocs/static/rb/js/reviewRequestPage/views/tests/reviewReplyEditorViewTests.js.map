{"version":3,"file":"reviewReplyEditorViewTests.js","names":["suite","reviewReply","editor","view","beforeEach","$container","$","appendTo","$testsScratch","RB","ReviewReply","id","spyOn","and","resolveTo","ReviewRequestPage","ReviewReplyEditor","anchorPrefix","replyObject","review","Review","parentObject","ReviewRequest","contextType","contextID","ReviewReplyEditorView","model","el","_$commentsList","append","describe","it","commentText","now","moment","$el","_makeCommentElement","commentID","text","render","expect","get","toBe","valueOf","milliseconds","_$draftComment","_$addCommentLink","is","click","not","hasClass","done","length","on","trigger","$draftEl","fn","callThrough","set","data","user_infobox","toHaveBeenCalled","timesince","$anchor","children","attr","$floatingAnchor","find","openCommentEditor","testRendering","richText","expectedHTML","$comment","$reviewText","html"],"sources":["../../../../../../../static/rb/js/reviewRequestPage/views/tests/reviewReplyEditorViewTests.es6.js"],"sourcesContent":["suite('rb/reviewRequestPage/views/ReviewReplyEditorView', function() {\n    let reviewReply;\n    let editor;\n    let view;\n\n    beforeEach(function() {\n        const $container = $('<div>').appendTo($testsScratch);\n\n        reviewReply = new RB.ReviewReply({\n            id: 121\n        });\n\n        /* Some tests will invoke this, so just pretend it works. */\n        spyOn(reviewReply, 'discardIfEmpty').and.resolveTo(true);\n\n        editor = new RB.ReviewRequestPage.ReviewReplyEditor({\n            anchorPrefix: 'header-reply',\n            replyObject: reviewReply,\n            review: new RB.Review({\n                id: 42,\n                parentObject: new RB.ReviewRequest(),\n            }),\n            reviewReply: reviewReply,\n            contextType: 'rcbt',\n            contextID: '100',\n        });\n\n        view = new RB.ReviewRequestPage.ReviewReplyEditorView({\n            model: editor,\n            el: $testsScratch,\n        });\n\n        /* Necessary to do pre-render so we can use makeCommentElement. */\n        view._$commentsList = $('<ul class=\"reply-comments\">');\n\n        $container\n            .append(view._$commentsList)\n            .append($('<a href=\"#\" class=\"add_comment_link\">New Comment</a>'));\n    });\n\n    describe('Construction', function() {\n        it('Populate from draft comment', function() {\n            const commentText = 'Test comment';\n            const now = moment();\n            const $el = view._makeCommentElement({\n                commentID: 16,\n                now: now,\n                text: commentText,\n            });\n\n            view.render();\n\n            expect(editor.get('commentID')).toBe(16);\n            expect(editor.get('text')).toBe(commentText);\n            expect(editor.get('hasDraft')).toBe(true);\n            expect(editor.get('timestamp').valueOf())\n                .toBe(now.milliseconds(0).valueOf());\n            expect(view._$draftComment[0]).toBe($el[0]);\n            expect(view._$addCommentLink.is(':visible')).toBe(false);\n        });\n    });\n\n    describe('Actions', function() {\n        it('Add comment link', function() {\n            view.render();\n\n            expect(view._$addCommentLink.is(':visible')).toBe(true);\n            view._$addCommentLink.click();\n\n            expect(view._$addCommentLink.is(':visible')).toBe(false);\n            expect(view._$draftComment).not.toBe(null);\n            expect(view._$draftComment.hasClass('draft')).toBe(true);\n        });\n    });\n\n    describe('Event handling', function() {\n        it('Comment discarded', function(done) {\n            view._makeCommentElement({\n                text: 'Test comment',\n            });\n\n            view.render();\n\n            let $el = view.$('.reply-comments li');\n            expect($el.length).toBe(1);\n\n            editor.on('discarded-finished', () => {\n                $el = view.$('.reply-comments li');\n                expect($el.length).toBe(0);\n                expect(view._$draftComment).toBe(null);\n\n                done();\n            });\n\n            reviewReply.trigger('destroyed');\n        });\n\n        it('Comment published', function() {\n            const $draftEl = view._makeCommentElement({\n                commentID: 16,\n            });\n\n            spyOn($.fn, 'user_infobox').and.callThrough();\n            spyOn($.fn, 'timesince').and.callThrough();\n\n            view.render();\n            editor.set('text', 'Test **comment**');\n            reviewReply.trigger('published');\n\n            const $el = view.$('.reply-comments li');\n\n            expect($el.length).toBe(1);\n            expect($draftEl).not.toBe($el);\n            expect($el.hasClass('draft')).toBe(false);\n            expect($el.data('comment-id')).toBe(16);\n            expect(view._$draftComment).toBe(null);\n            expect($.fn.user_infobox).toHaveBeenCalled();\n            expect($.fn.timesince).toHaveBeenCalled();\n\n            const $anchor = $el.children('.comment-anchor');\n            expect($anchor.length).toBe(1);\n            expect($anchor.attr('name')).toBe('header-reply121');\n\n            const $floatingAnchor = $el.find('> .floating-anchor > a');\n            expect($floatingAnchor.length).toBe(1);\n            expect($floatingAnchor.attr('href')).toBe('#header-reply121');\n            expect($floatingAnchor.hasClass('fa fa-link fa-flip-horizontal'))\n                .toBe(true);\n        });\n    });\n\n    describe('Methods', function() {\n        it('openCommentEditor', function() {\n            view.render();\n\n            expect(view._$addCommentLink.is(':visible')).toBe(true);\n            expect(view._$draftComment).toBe(null);\n\n            view.openCommentEditor();\n\n            expect(view._$addCommentLink.is(':visible')).toBe(false);\n            expect(view._$draftComment).not.toBe(null);\n            expect(view._$draftComment.hasClass('draft')).toBe(true);\n        });\n    });\n\n    describe('Text rendering', function() {\n        function testRendering(richText, expectedHTML) {\n            view.render();\n\n            const $comment = view._makeCommentElement({\n                text: '<p><strong>Test</strong> &amp;lt;</p>',\n                richText: richText,\n            });\n\n            const $reviewText = $comment.find('.reviewtext');\n            expect($reviewText.length).toBe(1);\n            expect($reviewText.hasClass('rich-text')).toBe(richText);\n            expect($reviewText.html()).toBe(expectedHTML);\n        }\n\n        it('richText=true', function() {\n            testRendering(true, '<p><strong>Test</strong> &amp;lt;</p>');\n        });\n\n        it('richText=false', function() {\n            testRendering(false,\n                          '&lt;p&gt;&lt;strong&gt;Test&lt;/strong&gt; ' +\n                          '&amp;amp;lt;&lt;/p&gt;');\n        });\n    });\n});\n"],"mappings":";;AAAAA,KAAK,CAAC,kDAAkD,EAAE,YAAW;EACjE,IAAIC,WAAW;EACf,IAAIC,MAAM;EACV,IAAIC,IAAI;EAERC,UAAU,CAAC,YAAW;IAClB,MAAMC,UAAU,GAAGC,CAAC,CAAC,OAAO,CAAC,CAACC,QAAQ,CAACC,aAAa,CAAC;IAErDP,WAAW,GAAG,IAAIQ,EAAE,CAACC,WAAW,CAAC;MAC7BC,EAAE,EAAE;IACR,CAAC,CAAC;;IAEF;IACAC,KAAK,CAACX,WAAW,EAAE,gBAAgB,CAAC,CAACY,GAAG,CAACC,SAAS,CAAC,IAAI,CAAC;IAExDZ,MAAM,GAAG,IAAIO,EAAE,CAACM,iBAAiB,CAACC,iBAAiB,CAAC;MAChDC,YAAY,EAAE,cAAc;MAC5BC,WAAW,EAAEjB,WAAW;MACxBkB,MAAM,EAAE,IAAIV,EAAE,CAACW,MAAM,CAAC;QAClBT,EAAE,EAAE,EAAE;QACNU,YAAY,EAAE,IAAIZ,EAAE,CAACa,aAAa,CAAC;MACvC,CAAC,CAAC;MACFrB,WAAW,EAAEA,WAAW;MACxBsB,WAAW,EAAE,MAAM;MACnBC,SAAS,EAAE;IACf,CAAC,CAAC;IAEFrB,IAAI,GAAG,IAAIM,EAAE,CAACM,iBAAiB,CAACU,qBAAqB,CAAC;MAClDC,KAAK,EAAExB,MAAM;MACbyB,EAAE,EAAEnB;IACR,CAAC,CAAC;;IAEF;IACAL,IAAI,CAACyB,cAAc,GAAGtB,CAAC,CAAC,6BAA6B,CAAC;IAEtDD,UAAU,CACLwB,MAAM,CAAC1B,IAAI,CAACyB,cAAc,CAAC,CAC3BC,MAAM,CAACvB,CAAC,CAAC,sDAAsD,CAAC,CAAC;EAC1E,CAAC,CAAC;EAEFwB,QAAQ,CAAC,cAAc,EAAE,YAAW;IAChCC,EAAE,CAAC,6BAA6B,EAAE,YAAW;MACzC,MAAMC,WAAW,GAAG,cAAc;MAClC,MAAMC,GAAG,GAAGC,MAAM,CAAC,CAAC;MACpB,MAAMC,GAAG,GAAGhC,IAAI,CAACiC,mBAAmB,CAAC;QACjCC,SAAS,EAAE,EAAE;QACbJ,GAAG,EAAEA,GAAG;QACRK,IAAI,EAAEN;MACV,CAAC,CAAC;MAEF7B,IAAI,CAACoC,MAAM,CAAC,CAAC;MAEbC,MAAM,CAACtC,MAAM,CAACuC,GAAG,CAAC,WAAW,CAAC,CAAC,CAACC,IAAI,CAAC,EAAE,CAAC;MACxCF,MAAM,CAACtC,MAAM,CAACuC,GAAG,CAAC,MAAM,CAAC,CAAC,CAACC,IAAI,CAACV,WAAW,CAAC;MAC5CQ,MAAM,CAACtC,MAAM,CAACuC,GAAG,CAAC,UAAU,CAAC,CAAC,CAACC,IAAI,CAAC,IAAI,CAAC;MACzCF,MAAM,CAACtC,MAAM,CAACuC,GAAG,CAAC,WAAW,CAAC,CAACE,OAAO,CAAC,CAAC,CAAC,CACpCD,IAAI,CAACT,GAAG,CAACW,YAAY,CAAC,CAAC,CAAC,CAACD,OAAO,CAAC,CAAC,CAAC;MACxCH,MAAM,CAACrC,IAAI,CAAC0C,cAAc,CAAC,CAAC,CAAC,CAAC,CAACH,IAAI,CAACP,GAAG,CAAC,CAAC,CAAC,CAAC;MAC3CK,MAAM,CAACrC,IAAI,CAAC2C,gBAAgB,CAACC,EAAE,CAAC,UAAU,CAAC,CAAC,CAACL,IAAI,CAAC,KAAK,CAAC;IAC5D,CAAC,CAAC;EACN,CAAC,CAAC;EAEFZ,QAAQ,CAAC,SAAS,EAAE,YAAW;IAC3BC,EAAE,CAAC,kBAAkB,EAAE,YAAW;MAC9B5B,IAAI,CAACoC,MAAM,CAAC,CAAC;MAEbC,MAAM,CAACrC,IAAI,CAAC2C,gBAAgB,CAACC,EAAE,CAAC,UAAU,CAAC,CAAC,CAACL,IAAI,CAAC,IAAI,CAAC;MACvDvC,IAAI,CAAC2C,gBAAgB,CAACE,KAAK,CAAC,CAAC;MAE7BR,MAAM,CAACrC,IAAI,CAAC2C,gBAAgB,CAACC,EAAE,CAAC,UAAU,CAAC,CAAC,CAACL,IAAI,CAAC,KAAK,CAAC;MACxDF,MAAM,CAACrC,IAAI,CAAC0C,cAAc,CAAC,CAACI,GAAG,CAACP,IAAI,CAAC,IAAI,CAAC;MAC1CF,MAAM,CAACrC,IAAI,CAAC0C,cAAc,CAACK,QAAQ,CAAC,OAAO,CAAC,CAAC,CAACR,IAAI,CAAC,IAAI,CAAC;IAC5D,CAAC,CAAC;EACN,CAAC,CAAC;EAEFZ,QAAQ,CAAC,gBAAgB,EAAE,YAAW;IAClCC,EAAE,CAAC,mBAAmB,EAAE,UAASoB,IAAI,EAAE;MACnChD,IAAI,CAACiC,mBAAmB,CAAC;QACrBE,IAAI,EAAE;MACV,CAAC,CAAC;MAEFnC,IAAI,CAACoC,MAAM,CAAC,CAAC;MAEb,IAAIJ,GAAG,GAAGhC,IAAI,CAACG,CAAC,CAAC,oBAAoB,CAAC;MACtCkC,MAAM,CAACL,GAAG,CAACiB,MAAM,CAAC,CAACV,IAAI,CAAC,CAAC,CAAC;MAE1BxC,MAAM,CAACmD,EAAE,CAAC,oBAAoB,EAAE,MAAM;QAClClB,GAAG,GAAGhC,IAAI,CAACG,CAAC,CAAC,oBAAoB,CAAC;QAClCkC,MAAM,CAACL,GAAG,CAACiB,MAAM,CAAC,CAACV,IAAI,CAAC,CAAC,CAAC;QAC1BF,MAAM,CAACrC,IAAI,CAAC0C,cAAc,CAAC,CAACH,IAAI,CAAC,IAAI,CAAC;QAEtCS,IAAI,CAAC,CAAC;MACV,CAAC,CAAC;MAEFlD,WAAW,CAACqD,OAAO,CAAC,WAAW,CAAC;IACpC,CAAC,CAAC;IAEFvB,EAAE,CAAC,mBAAmB,EAAE,YAAW;MAC/B,MAAMwB,QAAQ,GAAGpD,IAAI,CAACiC,mBAAmB,CAAC;QACtCC,SAAS,EAAE;MACf,CAAC,CAAC;MAEFzB,KAAK,CAACN,CAAC,CAACkD,EAAE,EAAE,cAAc,CAAC,CAAC3C,GAAG,CAAC4C,WAAW,CAAC,CAAC;MAC7C7C,KAAK,CAACN,CAAC,CAACkD,EAAE,EAAE,WAAW,CAAC,CAAC3C,GAAG,CAAC4C,WAAW,CAAC,CAAC;MAE1CtD,IAAI,CAACoC,MAAM,CAAC,CAAC;MACbrC,MAAM,CAACwD,GAAG,CAAC,MAAM,EAAE,kBAAkB,CAAC;MACtCzD,WAAW,CAACqD,OAAO,CAAC,WAAW,CAAC;MAEhC,MAAMnB,GAAG,GAAGhC,IAAI,CAACG,CAAC,CAAC,oBAAoB,CAAC;MAExCkC,MAAM,CAACL,GAAG,CAACiB,MAAM,CAAC,CAACV,IAAI,CAAC,CAAC,CAAC;MAC1BF,MAAM,CAACe,QAAQ,CAAC,CAACN,GAAG,CAACP,IAAI,CAACP,GAAG,CAAC;MAC9BK,MAAM,CAACL,GAAG,CAACe,QAAQ,CAAC,OAAO,CAAC,CAAC,CAACR,IAAI,CAAC,KAAK,CAAC;MACzCF,MAAM,CAACL,GAAG,CAACwB,IAAI,CAAC,YAAY,CAAC,CAAC,CAACjB,IAAI,CAAC,EAAE,CAAC;MACvCF,MAAM,CAACrC,IAAI,CAAC0C,cAAc,CAAC,CAACH,IAAI,CAAC,IAAI,CAAC;MACtCF,MAAM,CAAClC,CAAC,CAACkD,EAAE,CAACI,YAAY,CAAC,CAACC,gBAAgB,CAAC,CAAC;MAC5CrB,MAAM,CAAClC,CAAC,CAACkD,EAAE,CAACM,SAAS,CAAC,CAACD,gBAAgB,CAAC,CAAC;MAEzC,MAAME,OAAO,GAAG5B,GAAG,CAAC6B,QAAQ,CAAC,iBAAiB,CAAC;MAC/CxB,MAAM,CAACuB,OAAO,CAACX,MAAM,CAAC,CAACV,IAAI,CAAC,CAAC,CAAC;MAC9BF,MAAM,CAACuB,OAAO,CAACE,IAAI,CAAC,MAAM,CAAC,CAAC,CAACvB,IAAI,CAAC,iBAAiB,CAAC;MAEpD,MAAMwB,eAAe,GAAG/B,GAAG,CAACgC,IAAI,CAAC,wBAAwB,CAAC;MAC1D3B,MAAM,CAAC0B,eAAe,CAACd,MAAM,CAAC,CAACV,IAAI,CAAC,CAAC,CAAC;MACtCF,MAAM,CAAC0B,eAAe,CAACD,IAAI,CAAC,MAAM,CAAC,CAAC,CAACvB,IAAI,CAAC,kBAAkB,CAAC;MAC7DF,MAAM,CAAC0B,eAAe,CAAChB,QAAQ,CAAC,+BAA+B,CAAC,CAAC,CAC5DR,IAAI,CAAC,IAAI,CAAC;IACnB,CAAC,CAAC;EACN,CAAC,CAAC;EAEFZ,QAAQ,CAAC,SAAS,EAAE,YAAW;IAC3BC,EAAE,CAAC,mBAAmB,EAAE,YAAW;MAC/B5B,IAAI,CAACoC,MAAM,CAAC,CAAC;MAEbC,MAAM,CAACrC,IAAI,CAAC2C,gBAAgB,CAACC,EAAE,CAAC,UAAU,CAAC,CAAC,CAACL,IAAI,CAAC,IAAI,CAAC;MACvDF,MAAM,CAACrC,IAAI,CAAC0C,cAAc,CAAC,CAACH,IAAI,CAAC,IAAI,CAAC;MAEtCvC,IAAI,CAACiE,iBAAiB,CAAC,CAAC;MAExB5B,MAAM,CAACrC,IAAI,CAAC2C,gBAAgB,CAACC,EAAE,CAAC,UAAU,CAAC,CAAC,CAACL,IAAI,CAAC,KAAK,CAAC;MACxDF,MAAM,CAACrC,IAAI,CAAC0C,cAAc,CAAC,CAACI,GAAG,CAACP,IAAI,CAAC,IAAI,CAAC;MAC1CF,MAAM,CAACrC,IAAI,CAAC0C,cAAc,CAACK,QAAQ,CAAC,OAAO,CAAC,CAAC,CAACR,IAAI,CAAC,IAAI,CAAC;IAC5D,CAAC,CAAC;EACN,CAAC,CAAC;EAEFZ,QAAQ,CAAC,gBAAgB,EAAE,YAAW;IAClC,SAASuC,aAAaA,CAACC,QAAQ,EAAEC,YAAY,EAAE;MAC3CpE,IAAI,CAACoC,MAAM,CAAC,CAAC;MAEb,MAAMiC,QAAQ,GAAGrE,IAAI,CAACiC,mBAAmB,CAAC;QACtCE,IAAI,EAAE,uCAAuC;QAC7CgC,QAAQ,EAAEA;MACd,CAAC,CAAC;MAEF,MAAMG,WAAW,GAAGD,QAAQ,CAACL,IAAI,CAAC,aAAa,CAAC;MAChD3B,MAAM,CAACiC,WAAW,CAACrB,MAAM,CAAC,CAACV,IAAI,CAAC,CAAC,CAAC;MAClCF,MAAM,CAACiC,WAAW,CAACvB,QAAQ,CAAC,WAAW,CAAC,CAAC,CAACR,IAAI,CAAC4B,QAAQ,CAAC;MACxD9B,MAAM,CAACiC,WAAW,CAACC,IAAI,CAAC,CAAC,CAAC,CAAChC,IAAI,CAAC6B,YAAY,CAAC;IACjD;IAEAxC,EAAE,CAAC,eAAe,EAAE,YAAW;MAC3BsC,aAAa,CAAC,IAAI,EAAE,uCAAuC,CAAC;IAChE,CAAC,CAAC;IAEFtC,EAAE,CAAC,gBAAgB,EAAE,YAAW;MAC5BsC,aAAa,CAAC,KAAK,EACL,6CAA6C,GAC7C,wBAAwB,CAAC;IAC3C,CAAC,CAAC;EACN,CAAC,CAAC;AACN,CAAC,CAAC","ignoreList":[]}