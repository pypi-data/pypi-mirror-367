{% load difftags i18n djblets_deco djblets_utils reviewtags static %}

{% if standalone and error %}
{{error}}
{% endif %}

{% definevar 'line_fmt' %}
  <tr line="%(linenum_row)s"%(row_class_attr)s>
{%  if not file.is_new_file %}
   <th%(header_1_class_attr)s>%(anchor_html)s%(warnings_html)s%(linenum1)s</th>
   <td%(cell_1_class_attr)s>
    %(moved_to_html)s
    %(begin_collapse_html)s
    <pre>%(line1)s</pre>
    %(end_collapse_html)s
   </td>
{%  endif %}
   <th%(header_2_class_attr)s>{% if file.is_new_file %}%(warnings_html)s{% endif %}%(linenum2)s</th>
   <td%(cell_2_class_attr)s>
    %(moved_from_html)s
    <pre>%(line2)s</pre>
   </td>
  </tr>
{% enddefinevar %}

{% definevar 'anchor_fmt' %}
 <a name="%(anchor)s" class="chunk-anchor"></a>
{% enddefinevar %}

{% definevar 'begin_collapse_fmt' %}
<div class="collapse-floater">
{%  include "diffviewer/_collapse_button.html" with chunk_index="%(chunk_index)s" %}
{% enddefinevar %}

{% definevar 'end_collapse_fmt' %}
</div>
{% enddefinevar %}

{% definevar 'moved_fmt' %}
 <a href="#" class="%(class)s" data-line="%(line)s" target="%(target)s">%(text)s</a>
{% enddefinevar %}

{% definevar 'line_warnings_fmt' %}
<span class="fa fa-warning" title="{% blocktrans %}Suspicious content was found on this line: %(warning_labels)s{% endblocktrans %}"></span>
{% enddefinevar %}

{% if not standalone %}
<table id="file{{file.filediff.id}}" class="{% spaceless %}
  sidebyside
  {% if file.is_new_file %}newfile{% endif %}
  {% if file.binary %}diff-binary{% endif %}
  {% if file.deleted %}diff-deleted{% endif %}
  {% endspaceless %}"
       data-lines-equal="{{equal_lines}}">
 <colgroup>
{%  if not file.is_new_file %}
  <col class="line" />
  <col class="left" />
{%  endif %}
  <col class="line" />
  <col class="right" />
 </colgroup>
 <thead>
  <tr class="filename-row">
{%  if file.modified_filename == file.orig_filename %}
   <th colspan="4">
    <a name="{{file.index}}" class="file-anchor"></a>
{%   if file.binary %}
{%    if modified_diff_file_attachment %}
    <img class="header-file-icon" src="{{modified_diff_file_attachment.icon_url}}" />
{%    elif orig_diff_file_attachment %}
    <img class="header-file-icon" src="{{orig_diff_file_attachment.icon_url}}" />
{%    endif %}
{%   endif %}
    {{file.orig_filename}}
    {% if file.is_symlink %}{% trans " (symlink)" %}{% endif %}
  </th>
{%  else %}
{%   if not file.is_new_file %}
   <th colspan="2"><a name="{{file.index}}" class="file-anchor"></a>{{ file.orig_filename }}</th>
{%   endif %}
   <th colspan="2">
{%   if file.is_new_file %}
    <a name="{{file.index}}" class="file-anchor"></a>
{%   endif %}
    {{file.modified_filename}}{% if file.moved %}{% trans " (moved)" %}{% elif file.copied %}{% trans " (copied)" %}{% endif %}{% if file.is_symlink %}{% trans " (symlink)" %}{% endif %}</th>
{%  endif %}{# file.modified_filename == file.orig_filename #}
  </tr>
  <tr class="revision-row">
{%  if file.moved_or_copied and file.num_changes == 0 %}
   <th colspan="4"></th>
{%  else %}
{%   if not file.is_new_file %}
   <th></th>
   <th class="revision-col">
{%    if download_orig_url %}
    <a class="rb-icon rb-icon-download download-link" href="{{download_orig_url}}" rel="nofollow" alt="{% trans 'Download' %}" title="{% trans 'Download' %}"></a>
{%    endif %}
    {{file.orig_revision}}
    </th>
{%   endif %}
   <th></th>
{%   if not file.deleted %}
   <th class="revision-col">
{%    if download_modified_url %}
    <a class="rb-icon rb-icon-download download-link" href="{{download_modified_url}}" rel="nofollow" alt="{% trans 'Download' %}" title="{% trans 'Download' %}"></a>
{%    endif %}
    {{file.modified_revision}}
   </th>
{%   else %}
   <th></th>
{%   endif %}
{%  endif %}{# num_changes and moved #}
  </tr>
 </thead>
{% endif %}{# not standalone #}

{% if file.binary %}
 <tbody class="binary" data-file-id="{{modified_diff_file_attachment.id}}">
  <tr class="inline-files-container">
{%  if diff_attachment_review_ui_html %}
  <td colspan="4" class="diff-review-ui">{{diff_attachment_review_ui_html}}</td>
{%  else %}
{%   if file.moved_or_copied and file.num_changes == 0 or file.newfile and not orig_diff_file_attachment %}
   <td colspan="4" class="diff-review-ui">
{%   else %}
   <td colspan="2">
{%    if not orig_diff_file_attachment %}
{%     trans "This is a binary file. The content cannot be displayed." %}
{%    elif orig_attachment_review_ui_html %}
{{     orig_attachment_review_ui_html}}
{%    elif orig_diff_file_attachment.thumbnail %}
    <div class="file-thumbnail-container">{{orig_diff_file_attachment.thumbnail}}</div>
{%    else %}
{%     trans "No preview available." %}
{%    endif %}
   </td>
   <td colspan="2">
{%   endif %}
{%   if not modified_diff_file_attachment %}
{%    trans "This is a binary file. The content cannot be displayed." %}
{%   elif modified_attachment_review_ui_html %}
{{    modified_attachment_review_ui_html}}
{%   elif modified_diff_file_attachment.thumbnail %}
    <div class="file-thumbnail-container">{{modified_diff_file_attachment.thumbnail}}</div>
{%   else %}
{%    trans "No preview available." %}
{%   endif %}
{%  endif %}
   </td>
  </tr>
 </tbody>
{% elif file.moved_or_copied and file.num_changes == 0 %}
 <tbody class="rb-c-diff-file-notice">
  <tr>
   <td colspan="4">
    <div class="rb-c-diff-file-notice__body">
     <div class="rb-c-diff-file-notice__message">
      {% trans "No changes were made to this file." %}
     </div>
    </div>
   </td>
  </tr>
 </tbody>
{% elif file.newfile and file.num_chunks == 0 %}
 <tbody class="rb-c-diff-file-notice -is-new-file-notice">
  <tr>
   <td colspan="4">
    <div class="rb-c-diff-file-notice__body">
     <div class="rb-c-diff-file-notice__message">
      {% trans "This is a newly-added empty file." %}
     </div>
    </div>
   </td>
  </tr>
 </tbody>
{% elif file.deleted and not show_deleted %}
 <tbody class="rb-c-diff-file-notice -is-deleted-file-notice">
  <tr>
   <td colspan="4">
    <div class="rb-c-diff-file-notice__body">
     <div class="rb-c-diff-file-notice__message">
{%  if file.num_changes == 0 %}
{%   trans "This empty file was deleted. The content cannot be displayed." %}
{%  else %}
{%   trans "This file was deleted." %}
      <a class="show-deleted-content-action" href="#">{% trans "Show content." %}</a>
{%  endif %}
     </div>
    </div>
   </td>
  </tr>
 </tbody>
{% else %}
{%  if not standalone %}
{%   if file.code_safety_results %}
{%    for checker_id, checker_results in file.code_safety_results.items %}
<tbody class="rb-c-diff-file-notice -is-warning">
  <tr>
   <td colspan="4">
{%     diff_code_safety_file_alert checker_id checker_results %}
   </td>
  </tr>
 </tbody>
{%    endfor %}
{%   endif %}
{%   if file.whitespace_only %}
 <tbody class="rb-c-diff-file-notice">
  <tr>
   <td colspan="4">
    <div class="rb-c-diff-file-notice__body">
     <div class="rb-c-diff-file-notice__message">
      {% trans "This file contains only whitespace changes." %}
     </div>
    </div>
   </td>
  </tr>
 </tbody>
{%   endif %}
{%  endif %}
{%  for chunk in file.chunks %}
{%   if not chunk.collapsable or not collapseall %}
 <tbody id="chunk{{file.index}}.{{chunk.index}}"{% attr "class" %}
  {{chunk.change}}
{%     if chunk.change != "equal" %}
{%      if chunk.meta.whitespace_chunk %} whitespace-chunk{% endif %}
{%     else %}
{%      if chunk.collapsable %} collapsable{% endif %}
{%     endif %}
{%     if standalone %} loaded{% endif %}
{%    endattr %}>
{%    diff_lines index=file.index chunk=chunk standalone=standalone line_fmt=line_fmt anchor_fmt=anchor_fmt begin_collapse_fmt=begin_collapse_fmt end_collapse_fmt=end_collapse_fmt moved_fmt=moved_fmt line_warnings_fmt=line_warnings_fmt %}
 </tbody>
{%   else %}
 <tbody class="diff-header" id="collapsed-chunk{{file.index}}.{{chunk.index}}">
  <tr>
   <th>
{%    if chunk.index != 0 %}
    {% diff_expand_link 'above' _('Show 20 more lines above') 20 0 %}
{%    endif %}
   </th>
   <td colspan="3">
    {% definevar 'expand_text' %}{% blocktrans count lines=chunk.numlines %}{{lines}} line{% plural %}{{lines}} lines{% endblocktrans %}{% enddefinevar %}
    {% diff_expand_link 'all' _('Show all lines') 0 0 expand_text %}
   </td>
  </tr>
{%    if chunk.index|add:1 != file.num_chunks %}
  <tr>
   <th>{% diff_expand_link 'below' _('Show 20 more lines below') 0 20 %}</th>
{%     if chunk.meta.headers and chunk.meta.headers.0 %}
{%      if chunk.meta.headers.0.text == chunk.meta.headers.1.text %}
   <td colspan="3">{% diff_chunk_header chunk.meta.headers.0 %}</td>
{%      else %}
   <td>{% diff_chunk_header chunk.meta.headers.0 %}</td>
   <td colspan="2">
{%       if chunk.meta.headers.1 %}
{%        diff_chunk_header chunk.meta.headers.1 %}
{%       endif %}
   </td>
{%      endif %}
{%     else %}
   <td colspan="3"></td>
{%     endif %}
  </tr>
{%    endif %}
 </tbody>
{%   endif %}
{%  endfor %}{# chunks #}
{% endif %}{# file deleted, binary and whitespace_only #}

{% if not standalone %}
</table>
{%  endif %}
