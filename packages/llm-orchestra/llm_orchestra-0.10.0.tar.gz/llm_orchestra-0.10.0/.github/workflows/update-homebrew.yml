name: Update Homebrew Formula

on:
  release:
    types: [published]

jobs:
  update-homebrew:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4

      - name: Get release information
        id: release
        run: |
          # Extract version from tag (remove 'v' prefix if present)
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          
          # Get the tarball URL
          TARBALL_URL="https://github.com/mrilikecoding/llm-orc/archive/refs/tags/${GITHUB_REF#refs/tags/}.tar.gz"
          echo "tarball_url=${TARBALL_URL}" >> $GITHUB_OUTPUT
          
          # Download and calculate SHA256
          echo "Downloading release tarball to calculate SHA256..."
          curl -L -s "${TARBALL_URL}" | sha256sum | cut -d' ' -f1 > sha256.txt
          SHA256=$(cat sha256.txt)
          echo "sha256=${SHA256}" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Release Information:"
          echo "   Version: ${VERSION}"
          echo "   Tarball URL: ${TARBALL_URL}"
          echo "   SHA256: ${SHA256}"

      - name: Checkout Homebrew tap repository
        uses: actions/checkout@v4
        with:
          repository: mrilikecoding/homebrew-llm-orchestra
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update Homebrew formula
        run: |
          cd homebrew-tap
          
          echo "üìù Updating Homebrew formula..."
          
          # Backup original formula
          cp Formula/llm-orchestra.rb Formula/llm-orchestra.rb.bak
          
          # Update the formula with new version and SHA256
          sed -i "s|archive/refs/tags/v[0-9.]*\.tar\.gz|archive/refs/tags/${GITHUB_REF#refs/tags/}.tar.gz|g" Formula/llm-orchestra.rb
          sed -i "s/sha256 \"[a-f0-9]*\"/sha256 \"${{ steps.release.outputs.sha256 }}\"/g" Formula/llm-orchestra.rb
          
          # Show what changed
          echo "üìã Changes made to formula:"
          diff Formula/llm-orchestra.rb.bak Formula/llm-orchestra.rb || true
          
          # Verify the formula syntax
          echo "‚úÖ Updated formula:"
          head -20 Formula/llm-orchestra.rb

      - name: Validate formula changes
        run: |
          cd homebrew-tap
          
          # Check that we actually made changes
          if ! git diff --quiet Formula/llm-orchestra.rb; then
            echo "‚úÖ Formula has been updated"
          else
            echo "‚ùå No changes detected in formula"
            exit 1
          fi
          
          # Basic syntax validation
          if grep -q "sha256.*${{ steps.release.outputs.sha256 }}" Formula/llm-orchestra.rb; then
            echo "‚úÖ SHA256 hash updated correctly"
          else
            echo "‚ùå SHA256 hash not found in formula"
            exit 1
          fi
          
          if grep -q "${GITHUB_REF#refs/tags/}" Formula/llm-orchestra.rb; then
            echo "‚úÖ Version tag updated correctly"
          else
            echo "‚ùå Version tag not found in formula"
            exit 1
          fi

      - name: Commit and push changes
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add Formula/llm-orchestra.rb
          git commit -m "feat: Update formula to v${{ steps.release.outputs.version }}

          - Updated URL to point to ${{ github.ref_name }} release
          - Updated SHA256 hash to ${{ steps.release.outputs.sha256 }}
          
          Auto-generated by GitHub Actions from llm-orc release workflow.
          Source: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          echo "üöÄ Pushing changes to Homebrew tap..."
          git push origin master
          
          echo "‚úÖ Successfully updated Homebrew formula to v${{ steps.release.outputs.version }}"

      - name: Summary
        run: |
          echo "üéâ Homebrew Formula Update Complete!"
          echo ""
          echo "üì¶ Updated package: llm-orchestra"
          echo "üè∑Ô∏è  New version: v${{ steps.release.outputs.version }}"
          echo "üîê SHA256 hash: ${{ steps.release.outputs.sha256 }}"
          echo "üìã Repository: mrilikecoding/homebrew-llm-orchestra"
          echo ""
          echo "Users can now install the latest version with:"
          echo "  brew update"
          echo "  brew upgrade llm-orchestra"
          echo ""
          echo "Or new users can install with:"
          echo "  brew tap mrilikecoding/llm-orchestra"
          echo "  brew install llm-orchestra"