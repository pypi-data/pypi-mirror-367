name: ğŸ¤– AI-Assisted Development Check
# AI è¼”åŠ©é–‹ç™¼æª¢æŸ¥ï¼šç¢ºä¿ä»£ç¢¼è®Šæ›´èˆ‡åŠŸèƒ½è¨­è¨ˆæ–‡æª”åŒæ­¥

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'petsard/**'
      - '.ai/functional_design/**'
      - 'tests/**'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  ai-development-check:
    name: ğŸ” AI Development Compliance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´æ­·å²ä¾†åˆ†æè®Šæ›´
          
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests
          
      - name: ğŸ” Analyze Code Changes
        id: analyze
        run: |
          python .ai/scripts/development-assistant.py --mode=ci --pr-number=${{ github.event.number }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ“ Generate AI Development Report
        id: report
        run: |
          # ç”Ÿæˆè©³ç´°çš„åˆ†æå ±å‘Š
          cat > ai_development_report.md << 'EOF'
          # ğŸ¤– AI è¼”åŠ©é–‹ç™¼åˆ†æå ±å‘Š
          
          ## ğŸ“Š è®Šæ›´åˆ†æ Change Analysis
          
          **åˆ†ææ™‚é–“**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **PR ç·¨è™Ÿ**: #${{ github.event.number }}
          **åˆ†æ”¯**: ${{ github.head_ref }}
          
          ## ğŸ” æª¢æ¸¬åˆ°çš„æ¨¡çµ„è®Šæ›´ Detected Module Changes
          
          EOF
          
          # åŸ·è¡Œåˆ†æè…³æœ¬ä¸¦é™„åŠ çµæœ
          python .ai/scripts/development-assistant.py --mode=report >> ai_development_report.md
          
      - name: ğŸ’¬ Comment on PR with Analysis
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('ai_development_report.md', 'utf8');
            
            // æª¢æŸ¥æ˜¯å¦å·²æœ‰ AI åˆ†æç•™è¨€
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ¤– AI è¼”åŠ©é–‹ç™¼åˆ†æå ±å‘Š')
            );
            
            if (botComment) {
              // æ›´æ–°ç¾æœ‰ç•™è¨€
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
            } else {
              // å‰µå»ºæ–°ç•™è¨€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
            }
            
      - name: ğŸš¨ Check Compliance Status
        id: compliance
        run: |
          # åŸ·è¡Œåˆè¦æ€§æª¢æŸ¥
          python .ai/scripts/development-assistant.py --mode=compliance --strict
          echo "compliance_status=$?" >> $GITHUB_OUTPUT
          
      - name: âŒ Fail if Non-Compliant (Optional)
        if: steps.compliance.outputs.compliance_status != '0'
        run: |
          echo "::warning::AI è¼”åŠ©é–‹ç™¼åˆè¦æ€§æª¢æŸ¥å¤±æ•—ã€‚è«‹æª¢æŸ¥ PR ç•™è¨€ä¸­çš„å»ºè­°ã€‚"
          echo "::notice::é€™æ˜¯è­¦å‘Šæ¨¡å¼ï¼Œä¸æœƒé˜»æ­¢ PR åˆä½µã€‚å¦‚éœ€å¼·åˆ¶æ¨¡å¼ï¼Œè«‹ä¿®æ”¹å·¥ä½œæµç¨‹è¨­å®šã€‚"
          # exit 1  # å–æ¶ˆè¨»è§£ä»¥å•Ÿç”¨å¼·åˆ¶æ¨¡å¼
          
  documentation-sync-check:
    name: ğŸ“š Documentation Sync Check
    runs-on: ubuntu-latest
    needs: ai-development-check
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Check Documentation Sync
        run: |
          # æª¢æŸ¥åŠŸèƒ½è¨­è¨ˆæ–‡æª”æ˜¯å¦éœ€è¦æ›´æ–°
          changed_files=$(git diff --name-only origin/main...HEAD)

          echo "## ğŸ“‹ æ–‡æª”åŒæ­¥æª¢æŸ¥çµæœ" >> doc_sync_report.md
          echo "" >> doc_sync_report.md

          # æª¢æŸ¥å„æ¨¡çµ„çš„è®Šæ›´
          for module in loader metadater evaluator system; do
            if echo "$changed_files" | grep -q "petsard/$module/"; then
              echo "### ğŸ”„ $module æ¨¡çµ„å·²è®Šæ›´" >> doc_sync_report.md
              echo "- **å°æ‡‰æ–‡æª”**: [.ai/functional_design/$module.md](.ai/functional_design/$module.md)" >> doc_sync_report.md
              echo "- **å»ºè­°å‹•ä½œ**: è«‹æª¢æŸ¥ä¸¦æ›´æ–°åŠŸèƒ½è¨­è¨ˆæ–‡æª”" >> doc_sync_report.md
              echo "" >> doc_sync_report.md
            fi
          done
          
      - name: ğŸ’¬ Add Documentation Sync Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('doc_sync_report.md')) {
              const report = fs.readFileSync('doc_sync_report.md', 'utf8');
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ğŸ“š æ–‡æª”åŒæ­¥æé†’\n\n${report}\n\n---\n*æ­¤ç•™è¨€ç”± AI è¼”åŠ©é–‹ç™¼ç³»çµ±è‡ªå‹•ç”Ÿæˆ*`
              });
            }