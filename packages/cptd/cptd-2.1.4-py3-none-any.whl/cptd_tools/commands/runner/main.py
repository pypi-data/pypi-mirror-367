from pathlib import Path
import argparse, yaml, subprocess, sys, shutil, json, os
from cptd_tools.syntax_utils import print_help
from util.runner import execute_workflow

SYNTAX = {
    "name": "runner",
    "description": "Run commands defined in a YAML workflow file",
    "usage": "cptd runner [options]",
    "arguments": [
        {"name": "--file", "required": False, "help": "YAML workflow file"},
        {"name": "--add-yaml", "required": False, "help": "Copy YAML file to workflow directory"},
        {"name": "--del-yaml", "required": False, "help": "Delete YAML file from workflow directory"},
        {"name": "--set-path", "required": False, "help": "Set custom workflow directory"},
        {"name": "--reset-path", "required": False, "help": "Reset workflow directory to default"},
        {"name": "--list", "required": False, "help": "List available workflow YAMLs"},
        {"name": "--dry-run", "required": False, "help": "Show commands without executing"},
        {"name": "--log", "required": False, "help": "Log output to a file"},
        {"name": "--summary", "required": False, "help": "Show summary at the end"},
        {"name": "--example", "required": False, "help": "Example a YAML file"},
        {"name": "--repo", "required": False, "help": "Directory to run the commands in"}  # ÐÐ¾Ð²Ñ‹Ð¹ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€
    ],
    "examples": [
        "cptd runner --file deploy.yaml --repo /path/to/repo",
        "cptd runner --add-yaml myfile.yaml",
        "cptd runner --log out.txt --file deploy.yaml --summary"
    ]
}

def get_config_file():
    return Path(__file__).parent / "workflow_config.json"

def get_workflow_path():
    config = get_config_file()
    if config.exists():
        try:
            data = json.loads(config.read_text(encoding="utf-8"))
            return Path(data.get("workflow_path"))
        except:
            pass
    return Path(__file__).parent / "workflow"

def run(argv):
    # Check if --help or -h is passed
    if "--help" in argv or "-h" in argv:
        print_help(SYNTAX)
        return
    
    parser = argparse.ArgumentParser("cptd runner", add_help=False)
    parser.add_argument("--file", type=str)
    parser.add_argument("--add-yaml", type=str)
    parser.add_argument("--del-yaml", type=str)
    parser.add_argument("--set-path", type=str)
    parser.add_argument("--reset-path", action="store_true")
    parser.add_argument("--list", action="store_true")
    parser.add_argument("--dry-run", action="store_true")
    parser.add_argument("--log", type=str)
    parser.add_argument("--summary", action="store_true")
    parser.add_argument("--example", action="store_true")
    parser.add_argument("--repo", type=str, help="Directory to run the commands in")  # Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€ repo

    try:
        args = parser.parse_args(argv)
    except Exception as e:
        print(f"[!] Argument error: {e}")
        print_help(SYNTAX)
        return

    config_file = get_config_file()
    workflow_dir = get_workflow_path()
    workflow_dir.mkdir(parents=True, exist_ok=True)

    if args.set_path:
        config_file.write_text(json.dumps({"workflow_path": args.set_path}, indent=2))
        print(f"[âœ”] Workflow path set to: {args.set_path}")
        return

    if args.reset_path:
        if config_file.exists():
            config_file.unlink()
            print("[âœ”] Workflow path reset to default")
        else:
            print("[â„¹] Workflow path was already default")
        return

    if args.add_yaml:
        src = Path(args.add_yaml)
        if not src.exists():
            print(f"[âœ˜] File not found: {src}")
            return
        shutil.copy(src, workflow_dir / src.name)
        print(f"[âœ”] YAML copied to: {src.name}")
        return

    if args.del_yaml:
        tgt = workflow_dir / args.del_yaml
        if tgt.exists():
            tgt.unlink()
            print(f"[âœ”] Deleted: {tgt.name}")
        else:
            print(f"[âœ˜] File not found: {tgt}")
        return

    if args.list:
        print(f"ðŸ“‚ Available YAMLs in {workflow_dir}")
        for f in workflow_dir.glob("*.yaml"):
            print("  â€¢", f.name)
        return

    if "--example" in argv:
        example_path = Path.cwd() / "example.yaml"
        example_content = """name: "Example Workflow"
repo: "/path/to/"  # Specify the path to the directory if necessary
steps:
  - name: "Generate file"
    command: "bash"
    args: ["-c", "echo 'Generated by cptd runner' > testfile.txt"]

  - name: "List files"
    command: "bash"
    args: ["-c", "ls"]

  - name: "Create directory"
    command: "bash"
    args: ["-c", "mkdir -p /example_directory"]

  - name: "Show system info"
    command: "uname"
    args: ["-a"]

  - name: "Ping a server"
    command: "ping"
    args: ["-c", "4", "example.com"]

  - name: "Run Python script"
    command: "python3"
    args: ["-c", "print('Hello from Python!')"]
"""
        example_path.write_text(example_content)
        print(f"[âœ”] Example written to: {example_path}")
        return

    # Processing the repo parameter in the YAML file
    if args.repo:
        repo_path = Path(args.repo)
        if not repo_path.exists():
            print(f"[âœ˜] Repository path not found: {repo_path}")
            return
        os.chdir(repo_path)  # Change the working directory to the one specified in the repo parameter
        print(f"[âœ”] Changed working directory to: {repo_path}")
    else:
        # If the repo parameter is not set, check it in the YAML file
        if args.file:
            yaml_path = workflow_dir / args.file
            if not yaml_path.exists():
                print(f"[âœ˜] File not found: {yaml_path}")
                return
            
            # Reading YAML file to get repo value
            with open(yaml_path, 'r') as f:
                yaml_content = yaml.safe_load(f)
                repo_path = yaml_content.get("repo")
                if repo_path:
                    repo_path = Path(repo_path)
                    if repo_path.exists():
                        os.chdir(repo_path)
                        print(f"[âœ”] Changed working directory to: {repo_path}")
                    else:
                        print(f"[âœ˜] Repo path in YAML not found: {repo_path}")

    # Launching command execution from YAML
    if args.file:
        execute_workflow(yaml_path, dry_run=args.dry_run, log_path=args.log, summary=args.summary)
        return


if __name__ == "__main__":
    run(sys.argv[1:])
