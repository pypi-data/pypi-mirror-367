import{r as l,j as X}from"./index-B3TsnAiv.js";var Y=Object.defineProperty,G=Object.defineProperties,Z=Object.getOwnPropertyDescriptors,B=Object.getOwnPropertySymbols,x=Object.prototype.hasOwnProperty,ee=Object.prototype.propertyIsEnumerable,D=(e,t,n)=>t in e?Y(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,I=(e,t)=>{for(var n in t||(t={}))x.call(t,n)&&D(e,n,t[n]);if(B)for(var n of B(t))ee.call(t,n)&&D(e,n,t[n]);return e},T=(e,t)=>G(e,Z(t)),L=(e,t,n)=>D(e,t+"",n);class W extends Error{}class te extends Error{constructor(t){super(`Value required at path: '${t.toString()}'`),L(this,"name","MissingError"),this.ptr=t}}class ne extends Error{constructor(t,n){super(`Test failed: '${t}' !== '${n}'`),L(this,"name","TestError"),this.actual=t,this.expected=n}}class re extends Error{constructor(t){super(`Invalid operation: '${JSON.stringify(t)}'`),L(this,"name","InvalidOperationError"),this.op=t}}class h{constructor(t){this.tokens=t}static from(t){if(t instanceof h)return t;if(typeof t=="object"&&"buffer"in t&&t.buffer instanceof Uint8Array&&(t=t.buffer),(t instanceof Uint8Array||t instanceof ArrayBuffer)&&(t=new TextDecoder().decode(t)),typeof t!="string")throw new W(`Invalid pointer '${t}'`);const[,...n]=t.split("/");return new h(n.map(ie))}delete(t){if(N.asymmetricMatch(this))return;const[n,r]=this.evaluatePointer(t);if(n===null)throw new te(this);return Array.isArray(n)?r==="-"?n.pop():n.splice(Number(r),1):n instanceof Map?n.delete(r):r!==void 0&&delete n[r],t}evaluatePointer(t){var n;let r=null,s,a=t;for(let i=0;i<this.tokens.length;i++)if(r=a,s=this.tokens[i],s==="-")if(!r)a=void 0;else if(Array.isArray(r))a=r[r.length-1];else throw new W(`Invalid key '-' for ${r}`);else a=(n=r==null?void 0:r[s])!=null?n:void 0;return[r,s,a]}extend(t){return t===-1&&(t="-"),new h(t!==void 0?[...this.tokens,t]:this.tokens)}get(t){const[,,n]=this.evaluatePointer(t);return n}inspect(){return`Pointer '${this.toString()}'`}push(t,n){const[r,s]=this.evaluatePointer(t);return N.asymmetricMatch(this)&&s===void 0?n:(Array.isArray(r)?s==="-"?r.push(n):r.splice(Number(s),0,n):s!==void 0&&(r[s]=n),t)}set(t,n){if(N.asymmetricMatch(this))return n;const[r,s]=this.evaluatePointer(t);return s!==void 0&&(r instanceof Map?r.set(s,n):r[s]=n),t}toBSON(){return this.toString()}toJSON(){return this.toString()}toString(){return this.tokens.length?`/${this.tokens.map(se).join("/")}`:""}asymmetricMatch(t){const n=h.from(t);return this.tokens.length===n.tokens.length&&this.tokens.every((r,s)=>n.tokens[s]===String(r))}}const N=new h([]);function se(e){return typeof e=="number"&&(e=`${e}`),e.toString().replace(/~/g,"~0").replace(/\//g,"~1")}function ie(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function oe(e){return e.map(ae)}function ae(e){if(ce(e))return e;if(!fe(e))throw new re(e);switch(e.op){case"add":return["+",e.path,e.value];case"remove":return["-",e.path];case"replace":return["~",e.path,e.value];case"move":return[">",e.from,e.path];case"copy":return["^",e.from,e.path];case"test":return["?",e.path,e.value]}}function A(e){return e==null?!1:typeof e=="string"||e instanceof h||e instanceof Uint8Array||typeof e=="object"&&"buffer"in e&&e.buffer instanceof Uint8Array}function ce(e){if(!e||!Array.isArray(e)||!e.length)return!1;switch(e[0]){case"+":case"~":case"?":return e.length>=3&&A(e[1]);case"-":return e.length>=2&&A(e[1]);case">":case"^":return e.length>=3&&A(e[1])&&A(e[2]);default:return!1}}function fe(e){if(!e||typeof e!="object"||!("op"in e)||!("path"in e))return!1;switch(e.op){case"add":case"replace":case"test":return A(e.path)&&"value"in e;case"remove":return A(e.path);case"move":case"copy":return A(e.path)&&"from"in e&&A(e.from);default:return!1}}const P=Symbol("skip");function q(){throw P}const ue=[le,me,de,he,pe,ge,ve],U=Symbol("refs");function y(e,t){if(t!=null&&t.clone)try{return t.clone(e,T(I({},t),{skip:q}))}catch(n){if(n!==P)throw n}for(const n of ue)try{return n(e,T(I({},t),{skip:q}))}catch(r){if(r!==P)throw r}return e}function le(e,t){if(e===null)return null;if(e!==void 0)return e instanceof Function||e instanceof Error||typeof e=="object"&&t.skip(),e}function de(e,t){return Array.isArray(e)||t.skip(),e.map(n=>y(n,t))}function he(e,t){return(!("clone"in e)||typeof e.clone!="function")&&t.skip(),e.clone()}function me(e,t){return!(e instanceof String)&&!(e instanceof Number)&&!(e instanceof Boolean)&&!(e instanceof BigInt)&&!(e instanceof Symbol)&&!(e instanceof Date)&&!(e instanceof RegExp)&&!(e instanceof Uint8Array)&&!(e instanceof Uint16Array)&&!(e instanceof Uint32Array)&&!(e instanceof Float32Array)&&!(e instanceof Float64Array)&&!(e instanceof DataView)&&t.skip(),structuredClone(e)}function pe(e,t){return e instanceof Set||t.skip(),new Set([...e].map(n=>y(n,t)))}function ge(e,t){return e instanceof Map||t.skip(),new Map([...e].map(([n,r])=>[y(n,t),y(r,t)]))}function ve(e,t){var n;typeof e!="object"&&t.skip(),t[U]||(t[U]=new Map);const r=(n=t[U])==null?void 0:n.get(e);if(typeof r<"u")return r;const s=Object.assign({},e);return Object.setPrototypeOf(s,Object.getPrototypeOf(e)),t[U].set(e,s),Object.getOwnPropertyNames(e).forEach(a=>{s[a]=y(e[a],t)}),Object.getOwnPropertySymbols(e).forEach(a=>{s[a]=y(e[a],t)}),s}const ye=[we,Se,Oe,Ae,Ee,_e,Me];function E(e,t,n){if(Object.is(e,t))return!0;try{return be(e,t,T(I({},n),{skip:q}))}catch(r){if(r!==P)throw r}if(n.eq)try{return n.eq(e,t,T(I({},n),{skip:q}))}catch(r){if(r!==P)throw r}for(const r of ye)try{return r(e,t,T(I({},n),{skip:q}))}catch(s){if(s!==P)throw s}return!1}function be(e,t,n){return e===void 0&&t===void 0?!0:e===void 0&&t!==void 0||e!==void 0&&t===void 0?!1:e===null&&t===null?!0:(e===null&&t!==null||e!==null&&t===null||n.skip(),!1)}function we(e,t,n){if(e&&typeof e=="object"){if("eq"in e&&typeof e.eq=="function")return e.eq(t);if("isEqual"in e&&typeof e.isEqual=="function")return e.isEqual(t);if("equal"in e&&typeof e.equal=="function")return e.equal(t);if("equals"in e&&typeof e.equals=="function")return e.equals(t)}const r=!!e&&typeof e=="object"&&"asymmetricMatch"in e&&typeof e.asymmetricMatch=="function";if(r&&e.asymmetricMatch(t))return!0;const s=!!t&&typeof t=="object"&&"asymmetricMatch"in t&&typeof t.asymmetricMatch=="function";return s&&t.asymmetricMatch(e)?!0:(!r&&!s&&n.skip(),!1)}function Se(e,t,n){return typeof e!=typeof t?!1:(typeof e=="object"&&n.skip(),Object.is(e,t))}function Oe(e,t,n){return!Array.isArray(e)&&!Array.isArray(t)&&n.skip(),Array.isArray(e)&&Array.isArray(t)?e.length===t.length&&e.every((r,s)=>E(r,t[s],n)):!1}function Ae(e,t,n){if(e instanceof Error&&t instanceof Error)return e.message===t.message;if(e instanceof String&&t instanceof String||e instanceof Number&&t instanceof Number||e instanceof Boolean&&t instanceof Boolean)return e.valueOf()===t.valueOf();if(e instanceof Date&&t instanceof Date)return e.getTime()===t.getTime();if(e instanceof RegExp&&t instanceof RegExp)return e.source===t.source&&e.flags===t.flags;if(e instanceof Int8Array&&t instanceof Int8Array)return e.length===t.length&&!e.some((r,s)=>r!==t[s]);if(e instanceof Int16Array&&t instanceof Int16Array)return e.length===t.length&&!e.some((r,s)=>r!==t[s]);if(e instanceof Int32Array&&t instanceof Int32Array)return e.length===t.length&&!e.some((r,s)=>r!==t[s]);if(e instanceof Uint8Array&&t instanceof Uint8Array)return e.length===t.length&&!e.some((r,s)=>r!==t[s]);if(e instanceof Uint8ClampedArray&&t instanceof Uint8ClampedArray)return e.length===t.length&&!e.some((r,s)=>r!==t[s]);if(e instanceof Uint16Array&&t instanceof Uint16Array)return e.length===t.length&&!e.some((r,s)=>r!==t[s]);if(e instanceof Uint32Array&&t instanceof Uint32Array)return e.length===t.length&&!e.some((r,s)=>r!==t[s]);if(e instanceof Float32Array&&t instanceof Float32Array)return e.length===t.length&&!e.some((r,s)=>r!==t[s]);if(e instanceof Float64Array&&t instanceof Float64Array)return e.length===t.length&&!e.some((r,s)=>r!==t[s]);if(e instanceof ArrayBuffer&&t instanceof ArrayBuffer){if(e.byteLength!==t.byteLength)return!1;const r=new Int8Array(e),s=new Int8Array(t);return!r.some((a,i)=>a!==s[i])}if(e instanceof DataView&&t instanceof DataView){if(e.byteLength!==t.byteLength||e.byteOffset!==t.byteOffset)return!1;const r=new Int8Array(e.buffer),s=new Int8Array(t.buffer);return!r.some((a,i)=>a!==s[i])}return n.skip(),!1}function Ee(e,t,n){if(e instanceof Set&&t instanceof Set){if(e.size!==t.size)return!1;const r=[...e.values()],s=[...t.values()];return r.every(a=>s.some(i=>E(a,i,n)))}return!(e instanceof Set)&&!(t instanceof Set)&&n.skip(),!1}function _e(e,t,n){return e instanceof Map&&t instanceof Map?e.size!==t.size?!1:[...e.entries()].every(([r,s])=>E(s,t.get(r),n)):(!(e instanceof Map)&&!(t instanceof Map)&&n.skip(),!1)}const k=Symbol("x-seen"),j=Symbol("y-seen");function Me(e,t,n){var r,s;Object.getPrototypeOf(e)!==Object.getPrototypeOf(t)&&n.skip();let a=(s=(r=n[k])==null?void 0:r.length)!=null?s:0;for(;n[k]&&n[j]&&a--;){if(n[k][a]===e)return n[j][a]===t;if(n[j][a]===t)return!1}n[k]||(n[k]=[]),n[k].push(e),n[j]||(n[j]=[]),n[j].push(t);let i=!0;const f=Object.keys(e);if(E(new Set(f),new Set(Object.keys(t)),n)||(i=!1),i&&f.some(o=>!E(e[o],t[o],n))&&(i=!1),i){const o=Object.getOwnPropertySymbols(e);E(new Set(o),new Set(Object.getOwnPropertySymbols(t)),n)||(i=!1),o.some(c=>!E(e[c],t[c],n))&&(i=!1)}return n[k].pop(),n[j].pop(),i}function V(e,t,n={}){let r=y(e,n);if(!t)return r;for(const s of oe(t))switch(s[0]){case"+":r=ke(r,s,n);break;case"-":r=je(r,s);break;case"~":r=Pe(r,s,n);break;case">":r=Ie(r,s,n);break;case"^":r=Te(r,s,n);break;case"?":r=qe(r,s,n);break}return r}function ke(e,[,t,n],r={}){return h.from(t).push(e,y(n,r))}function je(e,[,t]){return h.from(t).delete(e)}function Pe(e,[,t,n],r={}){return h.from(t).set(e,y(n,r))}function Ie(e,[,t,n],r={}){const s=h.from(t).get(e);return h.from(n).push(h.from(t).delete(e),y(s,r))}function Te(e,[,t,n],r={}){return h.from(n).push(e,y(h.from(t).get(e),r))}function qe(e,[,t,n],r={}){const s=h.from(t).get(e);if(!E(s,n,r))throw new ne(s,n);return e}async function Ce(e,t){const n=e.getReader();let r;for(;!(r=await n.read()).done;)t(r.value)}function Ue(e){let t,n,r,s=!1;return function(i){t===void 0?(t=i,n=0,r=-1):t=Ne(t,i);const f=t.length;let o=0;for(;n<f;){s&&(t[n]===10&&(o=++n),s=!1);let c=-1;for(;n<f&&c===-1;++n)switch(t[n]){case 58:r===-1&&(r=n-o);break;case 13:s=!0;case 10:c=n;break}if(c===-1)break;e(t.subarray(o,c),r),o=n,r=-1}o===f?t=void 0:o!==0&&(t=t.subarray(o),n-=o)}}function Re(e,t,n){let r=J();const s=new TextDecoder;return function(i,f){if(i.length===0)n==null||n(r),r=J();else if(f>0){const o=s.decode(i.subarray(0,f)),c=f+(i[f+1]===32?2:1),u=s.decode(i.subarray(c));switch(o){case"data":r.data=r.data?r.data+`
`+u:u;break;case"event":r.event=u;break;case"id":e(r.id=u);break;case"retry":const d=parseInt(u,10);isNaN(d)||t(r.retry=d);break}}}}function Ne(e,t){const n=new Uint8Array(e.length+t.length);return n.set(e),n.set(t,e.length),n}function J(){return{data:"",event:"",id:"",retry:void 0}}var De=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,r=Object.getOwnPropertySymbols(e);s<r.length;s++)t.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(e,r[s])&&(n[r[s]]=e[r[s]]);return n};const F="text/event-stream",Fe=1e3,z="last-event-id";function Le(e,t){var{signal:n,headers:r,onopen:s,onmessage:a,onclose:i,onerror:f,openWhenHidden:o,fetch:c}=t,u=De(t,["signal","headers","onopen","onmessage","onclose","onerror","openWhenHidden","fetch"]);return new Promise((d,_)=>{const m=Object.assign({},r);m.accept||(m.accept=F);let v;function w(){v.abort(),document.hidden||p()}o||document.addEventListener("visibilitychange",w);let g=Fe,b=0;function M(){document.removeEventListener("visibilitychange",w),window.clearTimeout(b),v.abort()}n==null||n.addEventListener("abort",()=>{M(),d()});const $=c??window.fetch,R=s??$e;async function p(){var S;v=new AbortController;try{const C=await $(e,Object.assign(Object.assign({},u),{headers:m,signal:v.signal}));await R(C),await Ce(C.body,Ue(Re(O=>{O?m[z]=O:delete m[z]},O=>{g=O},a))),i==null||i(),M(),d()}catch(C){if(!v.signal.aborted)try{const O=(S=f==null?void 0:f(C))!==null&&S!==void 0?S:g;window.clearTimeout(b),b=window.setTimeout(p,O)}catch(O){M(),_(O)}}}p()})}function $e(e){const t=e.headers.get("content-type");if(!(t!=null&&t.startsWith(F)))throw new Error(`Expected content-type to be ${F}, Actual: ${t}`)}function Be(e){return e.event==="chunk"}function We(e){return e.event==="status"}function Ve(e){return e.type==="status"}function Je(e){return e.type==="message"}function ze(e){return e.type==="tool"}function He(e){const t=e,n=t.data.parts[0];return{id:t.id,source:t.source,content:n&&n.type==="content"?n.content:void 0,reasoning:n&&n.type==="reasoning"?n.reasoning:void 0,tool_calls:t.data.parts.filter(s=>s.type==="tool_call").map(s=>({...s,result:void 0})),metadata:t.metadata}}function Ke(e,t){const n=e;for(const r of n.data.tool_calls){const{tool_call_id:s,result:a}=r;for(const[i,f]of t){const o=f.tool_calls.map(c=>c.tool_call_id===s?{...c,result:a?a.data:void 0}:c);t.set(i,{...f,tool_calls:o})}}return t}function Qe(e,t,n){var r;if(We(t)){const s=t.data.data;return s.status==="processing"?n(t.data.data.data.detail||"thinking"):s.status==="typing"&&n(void 0),e}if(Be(t)){const{event_id:s,patches:a,metadata:i}=t.data;if(!s)return console.error("Missing event_id on chunk event:",t),e;const f=new Map(e);if(a&&a.length>0){for(const o of a){if(o.op==="add"&&o.path==="/tool_call_results")continue;if(o.path.startsWith("/tool_call_results/")){const d=(r=o.value)==null?void 0:r.tool_call_id;for(const[_,m]of f){const v=m.tool_calls.map(w=>{var g,b;return w.tool_call_id===d?{...w,result:(b=(g=o.value)==null?void 0:g.data)==null?void 0:b.result}:w});f.set(_,{...m,tool_calls:v})}continue}const c=f.get(s)||{id:s,source:"ai_agent",content:void 0,reasoning:void 0,tool_calls:[],metadata:{}};i&&(c.metadata={...c.metadata||{},...i});let u={...c};u.content||(o.path==="/-"||/\/\d+$/.test(o.path)?u.content=[]:o.path.startsWith("/tool_calls")||(u.content={})),o.path.startsWith("/tool_calls")?u=V(u,[o]):u.content=V(u.content,[o]),f.set(s,u)}return f}return f}return e}function Xe(e,t){if(Ve(t))return e;if(Je(t)){const n=He(t);return e.set(t.id,n),e}return ze(t)?Ke(t,e):(console.warn("Unhandled event type:",t.type),e)}function Ye({events:e}){const[t,n]=l.useState(new Map);return l.useEffect(()=>{n(()=>e.reduce((r,s)=>Xe(r,s),new Map))},[e]),{messages:Array.from(t.values())}}function Ge({correlationId:e,sessionStream:t}){const[n,r]=l.useState(new Map),[s,a]=l.useState(),i=l.useRef(0);l.useEffect(()=>{e&&(i.current=0,r(new Map))},[e]),l.useEffect(()=>{if(!(t!=null&&t.length)||i.current>=t.length)return;const o=t.slice(i.current);o.length&&(r(c=>o.reduce((u,d)=>Qe(u,d,a),c)),i.current=t.length)},[t]);const f=()=>{r(new Map),i.current=0};return{messages:Array.from(n.values()),processing:s,resetMessages:f}}var H="/api/sessions/{sessionId}/events/stream";function K(e={serverTemplateUrl:H}){const[t,n]=l.useState(""),[r,s]=l.useState([]),[a,i]=l.useState(!1),[f,o]=l.useState(null),c=l.useRef(null),u=l.useRef(null),d=l.useRef([]),_=l.useCallback(()=>{s([]),d.current=[]},[]),m=l.useCallback(()=>{if(d.current.length>0){const g=d.current.shift();if(!g)return;s(b=>[...b,g]),setTimeout(m,0)}},[]),v=l.useCallback((g,b)=>{if(!g){console.error("Session ID is required");return}u.current=g,s([]),d.current=[],c.current&&c.current.abort();const M=new AbortController;c.current=M,i(!0),o(null);const R=(e.serverTemplateUrl||H).replace("{sessionId}",g);Le(R,{method:"POST",headers:{"Content-Type":"application/json",Accept:"text/event-stream"},body:JSON.stringify({type:"message",content:b,source:"user"}),signal:M.signal,openWhenHidden:!1,onmessage(p){if(p.event!=="chunk"&&p.event!=="status"){console.error("Invalid event type:",p.event);return}try{const S={id:p.id,event:p.event,data:JSON.parse(p.data)};n(S.data.correlation_id),d.current.push(S),m()}catch(S){console.error("Invalid JSON from SSE:",p.data,S)}},onclose(){i(!1)},onerror(p){throw console.error("SSE error:",p),o(p),i(!1),M.abort(),p}})},[e.serverTemplateUrl,m]),w=l.useCallback(()=>{c.current&&(c.current.abort(),c.current=null,i(!1))},[]);return{events:r,correlationId:t,streaming:a,error:f,resetEvents:_,startStreaming:v,stopStreaming:w}}var Q=l.createContext(void 0),et=({children:e,options:t})=>{const n=K(t);return X.jsx(Q.Provider,{value:{stream:n},children:e})},Ze=e=>{const t=l.useContext(Q);return t?t.stream:K(e)};function tt({serverTemplateUrl:e,events:t}){const n=l.useMemo(()=>({serverTemplateUrl:e}),[e]),{events:r,correlationId:s,streaming:a,resetEvents:i,startStreaming:f,stopStreaming:o,error:c}=Ze(n),{messages:u,processing:d,resetMessages:_}=Ge({correlationId:s,sessionStream:r}),{messages:m}=Ye({events:t}),v=l.useMemo(()=>[...m,...u],[m,u]);return{messages:Array.from(v.values()),emittedEvents:r,processing:d,streaming:a,resetEvents:i,startStreaming:f,stopStreaming:o,error:c,resetMessages:_}}export{et as S,tt as u};
