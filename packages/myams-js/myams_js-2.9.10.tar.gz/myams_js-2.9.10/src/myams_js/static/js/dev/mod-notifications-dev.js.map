{"version":3,"file":"mod-notifications-dev.js","names":["$","MyAMS","templates","jsrender","require","ITEM_TEMPLATE_STRING","ITEM_TEMPLATE","markup","allowCode","LIST_TEMPLATE_STRING","LIST_TEMPLATE","NotificationsList","constructor","values","options","arguments","length","undefined","render","parent","html","itemTemplate","timestamp","localTimestamp","Date","useLocalTime","notifications","_exports","checkPermission","checkNotificationPromise","Notification","requestPermission","then","e","Promise","resolve","reject","window","console","debug","permission","checkUserPermission","getNotifications","evt","data","extend","target","current","currentTarget","remote","parents","ajax","get","result","tab","attr","text","localStorage","setItem","toISOString","getNotificationsBadge","source","lastRefreshStorage","getItem","lastRefresh","parse","newItems","filter","item","addNotification","message","showDesktop","pane","notification","badge","count","parseInt","prepend","showDesktopNotification","status","title","body","icon","avatar","url","onclick","open","env","bundle","config","modules","push"],"sources":["mod-notifications.js"],"sourcesContent":["/* global MyAMS */\n/**\n * MyAMS notifications handlers\n */\n\nconst $ = MyAMS.$;\n\nif (!$.templates) {\n\tconst jsrender = require('jsrender');\n\t$.templates = jsrender.templates;\n}\n\n\n/**\n * Notifications list template string\n */\n\nconst ITEM_TEMPLATE_STRING = `\n\t<li class=\"p-1 my-1{{if status}} alert-{{:status}}{{/if}}\">\n\t\t<a class=\"d-flex flex-row\"{{if url}} href=\"{{:url}}\"{{/if}}{{if modal}} data-toggle=\"modal\"{{/if}}>\n\t\t\t{{if source.avatar}}\n\t\t\t<img class=\"avatar mx-1 mt-1\" src=\"{{:source.avatar}}\"\n\t\t\t\t alt=\"{{:source.title}}\" title=\"{{:source.title}}\" />\n\t\t\t{{else}}\n\t\t\t<i class=\"avatar fa fa-fw fa-2x fa-user mx-1 mt-1\"\n\t\t\t   title=\"{{:source.title}}\"></i>\n\t\t\t{{/if}}\n\t\t\t<div class=\"flex-grow-1 ml-2\">\n\t\t\t\t<small class=\"timestamp float-right text-muted\">\n\t\t\t\t\t{{*: new Date(data.timestamp).toLocaleString()}}\n\t\t\t\t</small>\n\t\t\t\t<strong class=\"title d-block\">\n\t\t\t\t\t{{:title}}\n\t\t\t\t</strong>\n\t\t\t\t<p class=\"text-muted mb-2\">{{:message}}</p>\n\t\t\t</div>\n\t\t</a>\n\t</li>`;\n\nconst ITEM_TEMPLATE = $.templates({\n\tmarkup: ITEM_TEMPLATE_STRING,\n\tallowCode: true\n});\n\n\nconst LIST_TEMPLATE_STRING = `\n\t<ul class=\"list-style-none flex-grow-1 overflow-auto m-0 p-0\">\n\t\t{{for notifications tmpl=~itemTemplate /}}\n\t</ul>\n\t{{if !~options.hideTimestamp}}\n\t<div class=\"timestamp border-top pt-1\">\n\t\t<span>{{*: MyAMS.i18n.LAST_UPDATE }}{{: ~timestamp.toLocaleString() }}</span>\n\t\t<i class=\"fa fa-fw fa-sync float-right\"\n\t\t   data-ams-click-handler=\"MyAMS.notifications.getNotifications\"\n\t\t   data-ams-click-handler-options='{\"localTimestamp\": \"{{: ~useLocalTime }}\"}'></i>\n\t</div>\n\t{{/if}}`;\n\nconst LIST_TEMPLATE = $.templates({\n\tmarkup: LIST_TEMPLATE_STRING,\n\tallowCode: true\n});\n\n\nclass NotificationsList {\n\n\t/**\n\t * List constructor\n\t *\n\t * @param values: notifications data (may be loaded from JSON)\n\t * @param options: list rendering options\n\t */\n\tconstructor(values, options={}) {\n\t\tthis.values = values;\n\t\tthis.options = options;\n\t}\n\n\t/**\n\t * Render list into given parent\n\t *\n\t * @param parent: JQuery parent object into which the list must be rendered\n\t */\n\trender(parent) {\n\t\t$(parent).html(LIST_TEMPLATE.render(this.values, {\n\t\t\titemTemplate: ITEM_TEMPLATE,\n\t\t\ttimestamp: this.options.localTimestamp ?\n\t\t\t\tnew Date() : new Date(this.values.timestamp),\n\t\t\tuseLocalTime: this.options.localTimestamp ? 'true' : 'false',\n\t\t\toptions: this.options\n\t\t}));\n\t}\n}\n\n\nexport const notifications = {\n\n\t/**\n\t * Check permission to display desktop notifications\n\t */\n\tcheckPermission: () => {\n\n\t\tconst checkNotificationPromise = () => {\n\t\t\ttry {\n\t\t\t\tNotification.requestPermission().then();\n\t\t\t} catch (e) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\treturn true;\n\t\t};\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tif (!('Notification' in window)) {\n\t\t\t\tconsole.debug(\"Notifications are not supported by this browser!\");\n\t\t\t\tresolve(false);\n\t\t\t} else if (Notification.permission !== 'denied') {\n\t\t\t\tif (Notification.permission === 'default') {\n\t\t\t\t\tif (checkNotificationPromise()) {\n\t\t\t\t\t\tNotification.requestPermission().then((permission) => {\n\t\t\t\t\t\t\tresolve(permission === 'granted');\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tNotification.requestPermission((permission) => {\n\t\t\t\t\t\t\tresolve(permission === 'granted');\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tresolve(true);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tresolve(false);\n\t\t\t}\n\t\t});\n\t},\n\n\tcheckUserPermission: () => {\n\t\tMyAMS.notifications.checkPermission().then(() => {});\n\t},\n\n\t/**\n\t * Load user notifications\n\t *\n\t * @param evt: source event\n\t * @param options: notifications options (which can also be extracted from event data)\n\t */\n\tgetNotifications: (evt, options) => {\n\n\t\tconst\n\t\t\tdata = $.extend({}, options, evt.data),\n\t\t\ttarget = $(evt.target),\n\t\t\tcurrent = $(evt.currentTarget),\n\t\t\tremote = current.data('ams-notifications-source') ||\n\t\t\t\tcurrent.parents('[data-ams-notifications-source]').data('ams-notifications-source');\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tMyAMS.require('ajax').then(() => {\n\t\t\t\tMyAMS.ajax.get(remote, current.data('ams-notifications-params') || '',\n\t\t\t\t\tcurrent.data('ams-notifications-options') || {}).then((result) => {\n\t\t\t\t\tconst\n\t\t\t\t\t\ttab = $(target.data('ams-notifications-target') ||\n\t\t\t\t\t\ttarget.parents('[data-ams-notifications-target]').data('ams-notifications-target') ||\n\t\t\t\t\t\tcurrent.attr('href'));\n\t\t\t\t\tnew NotificationsList(result, data).render(tab);\n\t\t\t\t\t$('#notifications-count').text('');\n\t\t\t\t\tnotifications.checkUserPermission();\n\t\t\t\t\tlocalStorage.setItem('notifications-timestamp', new Date().toISOString());\n\t\t\t\t\tresolve();\n\t\t\t\t}, reject);\n\t\t\t}, reject);\n\t\t});\n\t},\n\n\t/**\n\t * Load new notifications badge\n\t */\n\tgetNotificationsBadge: () => {\n\t\tconst\n\t\t\tsource = $('#user-notifications'),\n\t\t\tremote = source.data('ams-notifications-source');\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst lastRefreshStorage = localStorage.getItem('notifications-timestamp');\n\t\t\tif (lastRefreshStorage === null) {\n\t\t\t\tlocalStorage.setItem('notifications-timestamp', new Date().toISOString());\n\t\t\t} else {\n\t\t\t\tMyAMS.require('ajax').then(() => {\n\t\t\t\t\tMyAMS.ajax.get(remote).then((result) => {\n\t\t\t\t\t\tconst\n\t\t\t\t\t\t\tlastRefresh = new Date(Date.parse(lastRefreshStorage)),\n\t\t\t\t\t\t\tnewItems = (result.notifications || []).filter((item) => new Date(typeof(item.timestamp) === 'number' ? item.timestamp : Date.parse(item.timestamp)) > lastRefresh);\n\t\t\t\t\t\t$('#notifications-count').text(newItems.length || '');\n\t\t\t\t\t\tresolve();\n\t\t\t\t\t}, reject);\n\t\t\t\t}, reject);\n\t\t\t}\n\t\t});\n\t},\n\n\t/**\n\t * Add new notification to notifications list\n\t *\n\t * @param message: notification element\n\t * @param showDesktop: if true, also try to display desktop notification\n\t */\n\taddNotification: (message, showDesktop) => {\n\n\t\tconst\n\t\t\tpane = $('ul', '#notifications-pane'),\n\t\t\tnotification = $(ITEM_TEMPLATE.render(message)),\n\t\t\tbadge = $('#notifications-count'),\n\t\t\tcount = parseInt(badge.text()) || 0;\n\n\t\tpane.prepend(notification);\n\t\tbadge.text(count + 1);\n\n\t\tif (showDesktop) {\n\t\t\tnotifications.showDesktopNotification(message);\n\t\t}\n\t},\n\n\t/**\n\t * Show new desktop notification\n\t *\n\t * @param message: notification elements\n\t */\n\tshowDesktopNotification: (message) => {\n\n\t\tnotifications.checkPermission().then((status) => {\n\t\t\tif (!status) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst\n\t\t\t\toptions = {\n\t\t\t\t\ttitle: message.title,\n\t\t\t\t\tbody: message.message,\n\t\t\t\t\ticon: message.source.avatar\n\t\t\t\t},\n\t\t\t\tnotification = new Notification(options.title, options);\n\n\t\t\tif (message.url) {\n\t\t\t\tnotification.onclick = () => {\n\t\t\t\t\twindow.open(message.url);\n\t\t\t\t};\n\t\t\t}\n\t\t});\n\t}\n}\n\n\n/**\n * Global module initialization\n */\nif (MyAMS.env.bundle) {\n\tMyAMS.config.modules.push('notifications');\n} else {\n\tMyAMS.notifications = notifications;\n\tconsole.debug(\"MyAMS: notifications module loaded...\");\n}\n"],"mappings":"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","ignoreList":[]}