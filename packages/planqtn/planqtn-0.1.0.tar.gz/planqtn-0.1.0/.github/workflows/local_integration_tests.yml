name: Local Integration Tests
run-name: ${{ github.actor }} is running local integration tests ðŸš€
concurrency:
  group: local-integration-tests-${{ github.ref }}
  cancel-in-progress: true
on:
  pull_request:
    branches:
      - main
    paths:
      - "planqtn/**"
      - "requirements.txt"
      - "requirements.dev.txt"
      - "app/conftest.py"

      - "app/supabase/**"
      - "app/migrations/**"
      - "app/planqtn_types/**"
      - "app/planqtn_api/**"
      - "app/planqtn_jobs/**"
      - "app/planqtn_cli/**"
      - "app/planqtn_fixtures/**"
      - "hack/*build*"

      - "check/**integration"
      - ".github/workflows/local_integration_tests.yml"

  push:
    paths:
      - "planqtn/**"
      - "requirements.txt"
      - "requirements.dev.txt"
      - "app/conftest.py"

      - "app/supabase/**"
      - "app/migrations/**"
      - "app/planqtn_types/**"
      - "app/planqtn_api/**"
      - "app/planqtn_jobs/**"
      - "app/planqtn_cli/**"
      - "app/planqtn_fixtures/**"
      - "hack/*build*"

      - "check/**integration"
      - ".github/workflows/local_integration_tests.yml"

jobs:
  Local-Integration-Tests:
    permissions:
      statuses: write
      checks: write
      contents: write
      pull-requests: write
      actions: write
    runs-on: ubuntu-latest
    steps:
      - name: Workflow Telemetry
        uses: catchpoint/workflow-telemetry-action@v2.0.0
      - name: Check out repository code
        uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            jobs: 
              - "app/planqtn_jobs/**"
            api:
              - "app/planqtn_api/**"                    
            common: 
              - "planqtn/**"
              - "pyproject.toml"

              - "app/conftest.py"
              - "app/supabase/**"
              - "app/migrations/**"
              - "app/planqtn_types/**"
              - "app/planqtn_fixtures/**"
              - ".github/workflows/local_integration_tests.yml"
              - "app/planqtn_cli/**"
              - "hack/*build*"
      - name: Display disk space
        run: |
          cat <<EOF >> $GITHUB_STEP_SUMMARY
          ## Disk space changes

          Before: 
          \`\`\`
          `df -h /dev/root`
          \`\`\` 
          EOF
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: 3.12
      - name: Install shared dependencies
        run: |
          pip install --upgrade uv
          uv pip install -r pyproject.toml --all-extras --system
      - name: Install planqtn cli
        run: |
          hack/cli_build.sh --install
      - name: build and load api image
        env:
          DOCKER_REPO: planqtn
        run: |
          hack/htn images api --build --quiet
      - name: Start planqtn
        run: |
          htn kernel start --verbose
      - name: build and load jobs image
        env:
          DOCKER_REPO: planqtn
        run: |
          hack/htn images job --build --load-no-restart --k3d-cluster local --quiet
      - name: Run jobs integration tests
        env:
          KERNEL_ENV: local
        if: steps.changes.outputs.jobs == 'true' || steps.changes.outputs.common == 'true'
        run: |
          uv pip install -r app/planqtn_jobs/requirements.txt -r app/planqtn_jobs/requirements.dev.txt --system
          check/jobs-integration

      - name: Run api integration tests
        env:
          KERNEL_ENV: local
        if: steps.changes.outputs.api == 'true' || steps.changes.outputs.common == 'true'
        run: |
          uv pip install -r app/planqtn_api/requirements.txt -r app/planqtn_api/requirements.dev.txt --system
          check/api-integration
      - name: Display disk space
        run: |
          cat <<EOF >> $GITHUB_STEP_SUMMARY

          After: 
          \`\`\` 
          `df -h /dev/root`
          \`\`\` 
          EOF

      - name: cleanup env
        run: |
          htn kernel stop
          htn kernel remove 
          htn purge --force
