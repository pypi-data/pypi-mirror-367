---
# tasks file for sing_box_config
- name: ensure proxy group exists
  ansible.builtin.group:
    name: "{{ proxy_group.name }}"
    gid: "{{ proxy_group.gid | int }}"
    state: present

- name: ensure proxy user exists
  ansible.builtin.user:
    name: "{{ proxy_user.name }}"
    uid: "{{ proxy_user.uid | int }}"
    home: "{{ proxy_user.home }}"
    shell: "{{ proxy_user.shell }}"
    group: "{{ proxy_group.name }}"
    state: present

- name: create drop-in directory
  ansible.builtin.file:
    path: "{{ directory }}"
    owner: "{{ proxy_user.name }}"
    group: "{{ proxy_group.name }}"
    mode: "0700"
    state: directory
  loop:
    - "{{ sing_box_etc_dir }}"
    - "{{ sing_box_log_dir }}"
    - "{{ sing_box_state_dir }}"
    - "{{ sing_box_config_dir }}"
  loop_control:
    loop_var: directory

- name: install sing-box-config from pdm_wheel
  when:
    - sing_box_config_install_source == 'local'
  ansible.builtin.include_tasks: pdm_wheel.yml

- name: install sing-box-config from PyPI
  when:
    - sing_box_config_install_source in ['pypi', 'testpypi']
  ansible.builtin.pip:
    name: sing-box-config
    state: latest
    virtualenv: "{{ sing_box_venv_dir }}"
    virtualenv_command: python3 -m venv
    extra_args: "{{ sing_box_config_pip_extra_args[sing_box_config_install_source] }}"
  notify:
    - ensure sing-box working directory ownership

- name: template sing-box-config base.json and subscriptions.json on remote
  vars:
    basename: "{{ template | ansible.builtin.basename | ansible.builtin.splitext | first }}"
  ansible.builtin.template:
    src: "{{ template }}"
    dest: "{{ [sing_box_config_dir, basename] | ansible.builtin.path_join }}"
    owner: "{{ proxy_user.name }}"
    group: "{{ proxy_group.name }}"
    mode: "0600"
  loop:
    - "{{ [playbook_dir, 'config/base.json.j2'] | ansible.builtin.path_join }}"
    - "{{ [playbook_dir, 'config/subscriptions.json.j2'] | ansible.builtin.path_join }}"
  loop_control:
    loop_var: template

- name: template systemd timer on remote
  ansible.builtin.template:
    src: "{{ template }}"
    dest: "{{ ['/', template] | ansible.builtin.path_join | ansible.builtin.splitext | first }}"
  loop:
    - etc/systemd/system/sing-box-config-updater.service.j2
    - etc/systemd/system/sing-box-config-updater.timer.j2
  loop_control:
    loop_var: template

- name: ensure sing-box-config-updater.timer enabled
  ansible.builtin.systemd_service:
    name: sing-box-config-updater.timer
    state: "{{ sing_box_config_updater_timer_state }}"
    enabled: "{{ sing_box_config_updater_timer_enabled }}"
  notify:
    - systemctl daemon-reload

# FATAL[0000] initialize outbound[14]: missing tags
# 我们在 config/subscriptions.json 的 outbounds 中预先定义了 "欧洲节点" 和 "韩国节点" filter
# 并非所有订阅源都有该地区节点, 而订阅源可能因为网络错误, 未能成功获取订阅节点, 使得对应地区的 outbounds 为空
# 从而使得 sing-box.service:ExecStartPre= 校验配置文件失败, 导致 sing-box.service 启动失败
- name: ensure /etc/sing-box/config.json generated
  ansible.builtin.systemd_service:
    name: sing-box-config-updater.service
    state: "{{ sing_box_config_updater_timer_state }}"
