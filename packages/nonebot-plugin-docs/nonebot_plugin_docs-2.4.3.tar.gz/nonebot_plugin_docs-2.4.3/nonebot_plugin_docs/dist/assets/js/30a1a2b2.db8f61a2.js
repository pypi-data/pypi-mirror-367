"use strict";(self.webpackChunknonebot=self.webpackChunknonebot||[]).push([["9058"],{25354:function(e,t,n){n.r(t),n.d(t,{default:()=>l,frontMatter:()=>c,metadata:()=>s,assets:()=>a,toc:()=>d,contentTitle:()=>i});var s=JSON.parse('{"id":"best-practice/testing/mock-network","title":"\u6A21\u62DF\u7F51\u7EDC\u901A\u4FE1","description":"\u6A21\u62DF\u7F51\u7EDC\u901A\u4FE1\u4EE5\u8FDB\u884C\u6D4B\u8BD5","source":"@site/versioned_docs/version-2.4.2/best-practice/testing/mock-network.md","sourceDirName":"best-practice/testing","slug":"/best-practice/testing/mock-network","permalink":"/website/docs/2.4.2/best-practice/testing/mock-network","draft":false,"unlisted":false,"editUrl":"https://github.com/nonebot/nonebot2/edit/master/website/versioned_docs/version-2.4.2/best-practice/testing/mock-network.md","tags":[],"version":"2.4.2","lastUpdatedBy":"noneflow[bot]","lastUpdatedAt":1754561629000,"sidebarPosition":3,"frontMatter":{"sidebar_position":3,"description":"\u6A21\u62DF\u7F51\u7EDC\u901A\u4FE1\u4EE5\u8FDB\u884C\u6D4B\u8BD5"},"sidebar":"tutorial","previous":{"title":"\u6D4B\u8BD5\u4E8B\u4EF6\u54CD\u5E94\u4E0E\u4F1A\u8BDD\u64CD\u4F5C","permalink":"/website/docs/2.4.2/best-practice/testing/behavior"},"next":{"title":"Alconna \u63D2\u4EF6","permalink":"/website/docs/2.4.2/best-practice/alconna/"}}'),o=n("24246"),r=n("80980");let c={sidebar_position:3,description:"\u6A21\u62DF\u7F51\u7EDC\u901A\u4FE1\u4EE5\u8FDB\u884C\u6D4B\u8BD5"},i="\u6A21\u62DF\u7F51\u7EDC\u901A\u4FE1",a={},d=[{value:"\u6D4B\u8BD5 HTTP \u670D\u52A1\u7AEF",id:"\u6D4B\u8BD5-http-\u670D\u52A1\u7AEF",level:2},{value:"\u6D4B\u8BD5 WebSocket \u670D\u52A1\u7AEF",id:"\u6D4B\u8BD5-websocket-\u670D\u52A1\u7AEF",level:2},{value:"\u6D4B\u8BD5 HTTP \u5BA2\u6237\u7AEF",id:"\u6D4B\u8BD5-http-\u5BA2\u6237\u7AEF",level:2},{value:"\u6D4B\u8BD5 WebSocket \u5BA2\u6237\u7AEF",id:"\u6D4B\u8BD5-websocket-\u5BA2\u6237\u7AEF",level:2}];function p(e){let t={code:"code",del:"del",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.header,{children:(0,o.jsx)(t.h1,{id:"\u6A21\u62DF\u7F51\u7EDC\u901A\u4FE1",children:"\u6A21\u62DF\u7F51\u7EDC\u901A\u4FE1"})}),"\n",(0,o.jsx)(t.p,{children:"NoneBot \u9A71\u52A8\u5668\u63D0\u4F9B\u4E86\u591A\u79CD\u65B9\u6CD5\u6765\u5E2E\u52A9\u9002\u914D\u5668\u8FDB\u884C\u7F51\u7EDC\u901A\u4FE1\uFF0C\u4E3B\u8981\u5305\u62EC\u5BA2\u6237\u7AEF\u548C\u670D\u52A1\u7AEF\u4E24\u79CD\u7C7B\u578B\u3002\u6A21\u62DF\u7F51\u7EDC\u901A\u4FE1\u53EF\u4EE5\u5E2E\u52A9\u6211\u4EEC\u66F4\u52A0\u63A5\u8FD1\u5B9E\u9645\u673A\u5668\u4EBA\u5E94\u7528\u573A\u666F\uFF0C\u8FDB\u884C\u66F4\u52A0\u771F\u5B9E\u7684\u96C6\u6210\u6D4B\u8BD5\u3002\u540C\u65F6\uFF0C\u901A\u8FC7\u8FD9\u79CD\u9014\u5F84\uFF0C\u6211\u4EEC\u8FD8\u53EF\u4EE5\u5B8C\u6210\u5BF9\u9002\u914D\u5668\u7684\u6D4B\u8BD5\u3002"}),"\n",(0,o.jsx)(t.p,{children:"NoneBot \u4E2D\u7684\u7F51\u7EDC\u901A\u4FE1\u4E3B\u8981\u5305\u62EC\u4EE5\u4E0B\u51E0\u79CD\uFF1A"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:"HTTP \u670D\u52A1\u7AEF\uFF08WebHook\uFF09"}),"\n",(0,o.jsx)(t.li,{children:"WebSocket \u670D\u52A1\u7AEF"}),"\n",(0,o.jsx)(t.li,{children:"HTTP \u5BA2\u6237\u7AEF"}),"\n",(0,o.jsx)(t.li,{children:"WebSocket \u5BA2\u6237\u7AEF"}),"\n"]}),"\n",(0,o.jsx)(t.p,{children:"\u4E0B\u9762\u6211\u4EEC\u5C06\u5206\u522B\u4ECB\u7ECD\u5982\u4F55\u4F7F\u7528 NoneBug \u6765\u6A21\u62DF\u8FD9\u51E0\u79CD\u901A\u4FE1\u65B9\u5F0F\u3002"}),"\n",(0,o.jsx)(t.h2,{id:"\u6D4B\u8BD5-http-\u670D\u52A1\u7AEF",children:"\u6D4B\u8BD5 HTTP \u670D\u52A1\u7AEF"}),"\n",(0,o.jsxs)(t.p,{children:["\u5F53 NoneBot \u4F5C\u4E3A ASGI \u670D\u52A1\u7AEF\u5E94\u7528\u65F6\uFF0C\u6211\u4EEC\u53EF\u4EE5\u5B9A\u4E49\u4E00\u7CFB\u5217\u7684\u8DEF\u7531\u6765\u5904\u7406 HTTP \u8BF7\u6C42\uFF0C\u9002\u914D\u5668\u540C\u6837\u4E5F\u53EF\u4EE5\u901A\u8FC7\u5B9A\u4E49\u8DEF\u7531\u6765\u54CD\u5E94\u673A\u5668\u4EBA\u76F8\u5173\u7684\u7F51\u7EDC\u901A\u4FE1\u3002\u4E0B\u9762\u5047\u8BBE\u6211\u4EEC\u4F7F\u7528\u4E86\u4E00\u4E2A\u9002\u914D\u5668 ",(0,o.jsx)(t.code,{children:"fake"})," \uFF0C\u5B83\u5B9A\u4E49\u4E86\u4E00\u4E2A\u8DEF\u7531 ",(0,o.jsx)(t.code,{children:"/fake/http"})," \uFF0C\u7528\u4E8E\u63A5\u6536\u5E73\u53F0 WebHook \u5E76\u5904\u7406\u3002\u5B9E\u9645\u5E94\u7528\u6D4B\u8BD5\u65F6\uFF0C\u5E94\u5C06\u8BE5\u8DEF\u7531\u5730\u5740\u66FF\u6362\u4E3A",(0,o.jsx)(t.strong,{children:"\u771F\u5B9E\u9002\u914D\u5668\u6CE8\u518C\u7684\u8DEF\u7531\u5730\u5740"}),"\u3002"]}),"\n",(0,o.jsx)(t.p,{children:"\u6211\u4EEC\u9996\u5148\u9700\u8981\u83B7\u53D6\u6D4B\u8BD5\u7528\u6A21\u62DF\u5BA2\u6237\u7AEF\uFF1A"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",metastring:"{5,6} title=tests/test_http_server.py",children:"from nonebug import App\n\n@pytest.mark.asyncio\nasync def test_http_server(app: App):\n    async with app.test_server() as ctx:\n        client = ctx.get_client()\n"})}),"\n",(0,o.jsxs)(t.p,{children:["\u9ED8\u8BA4\u60C5\u51B5\u4E0B\uFF0C",(0,o.jsx)(t.code,{children:"app.test_server()"})," \u4F1A\u901A\u8FC7 ",(0,o.jsx)(t.code,{children:"nonebot.get_asgi"})," \u83B7\u53D6\u6D4B\u8BD5\u5BF9\u8C61\uFF0C\u6211\u4EEC\u4E5F\u53EF\u4EE5\u901A\u8FC7\u53C2\u6570\u6307\u5B9A ASGI \u5E94\u7528\uFF1A"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",children:"async with app.test_server(asgi=asgi_app) as ctx:\n    ...\n"})}),"\n",(0,o.jsxs)(t.p,{children:["\u83B7\u53D6\u5230\u6A21\u62DF\u5BA2\u6237\u7AEF\u540E\uFF0C\u5373\u53EF\u50CF ",(0,o.jsx)(t.code,{children:"requests"}),"\u3001",(0,o.jsx)(t.code,{children:"httpx"})," \u7B49\u5E93\u7C7B\u4F3C\u7684\u65B9\u6CD5\u8FDB\u884C\u4F7F\u7528\uFF1A"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",metastring:"{3,11-14,16} title=tests/test_http_server.py",children:'import nonebot\nfrom nonebug import App\nfrom nonebot.adapters.fake import Adapter\n\n@pytest.mark.asyncio\nasync def test_http_server(app: App):\n    adapter = nonebot.get_adapter(Adapter)\n\n    async with app.test_server() as ctx:\n        client = ctx.get_client()\n        response = await client.post("/fake/http", json={"bot_id": "fake"})\n        assert response.status_code == 200\n        assert response.json() == {"status": "success"}\n        assert "fake" in nonebot.get_bots()\n\n    adapter.bot_disconnect(nonebot.get_bot("fake"))\n'})}),"\n",(0,o.jsxs)(t.p,{children:["\u5728\u4E0A\u9762\u7684\u6D4B\u8BD5\u4E2D\uFF0C\u6211\u4EEC\u5411 ",(0,o.jsx)(t.code,{children:"/fake/http"})," \u53D1\u9001\u4E86\u4E00\u4E2A\u6A21\u62DF POST \u8BF7\u6C42\uFF0C\u9002\u914D\u5668\u5C06\u4F1A\u5BF9\u8BE5\u8BF7\u6C42\u8FDB\u884C\u5904\u7406\uFF0C\u6211\u4EEC\u53EF\u4EE5\u901A\u8FC7\u68C0\u67E5\u8BF7\u6C42\u8FD4\u56DE\u662F\u5426\u6B63\u786E\u3001Bot \u5BF9\u8C61\u662F\u5426\u521B\u5EFA\u7B49\u9014\u5F84\u6765\u9A8C\u8BC1\u673A\u5668\u4EBA\u662F\u5426\u6B63\u786E\u8FD0\u884C\u3002\u5728\u5B8C\u6210\u6D4B\u8BD5\u540E\uFF0C\u6211\u4EEC\u901A\u5E38\u9700\u8981\u5BF9 Bot \u5BF9\u8C61\u8FDB\u884C\u6E05\u7406\uFF0C\u4EE5\u907F\u514D\u5BF9\u5176\u4ED6\u6D4B\u8BD5\u4EA7\u751F\u5F71\u54CD\u3002"]}),"\n",(0,o.jsx)(t.h2,{id:"\u6D4B\u8BD5-websocket-\u670D\u52A1\u7AEF",children:"\u6D4B\u8BD5 WebSocket \u670D\u52A1\u7AEF"}),"\n",(0,o.jsxs)(t.p,{children:["\u5F53 NoneBot \u4F5C\u4E3A ASGI \u670D\u52A1\u7AEF\u5E94\u7528\u65F6\uFF0C\u6211\u4EEC\u8FD8\u53EF\u4EE5\u5B9A\u4E49\u4E00\u7CFB\u5217\u7684\u8DEF\u7531\u6765\u5904\u7406 WebSocket \u901A\u4FE1\u3002\u4E0B\u9762\u5047\u8BBE\u6211\u4EEC\u4F7F\u7528\u4E86\u4E00\u4E2A\u9002\u914D\u5668 ",(0,o.jsx)(t.code,{children:"fake"})," \uFF0C\u5B83\u5B9A\u4E49\u4E86\u4E00\u4E2A\u8DEF\u7531 ",(0,o.jsx)(t.code,{children:"/fake/ws"})," \uFF0C\u7528\u4E8E\u5904\u7406\u5E73\u53F0 WebSocket \u8FDE\u63A5\u4FE1\u606F\u3002\u5B9E\u9645\u5E94\u7528\u6D4B\u8BD5\u65F6\uFF0C\u5E94\u5C06\u8BE5\u8DEF\u7531\u5730\u5740\u66FF\u6362\u4E3A",(0,o.jsx)(t.strong,{children:"\u771F\u5B9E\u9002\u914D\u5668\u6CE8\u518C\u7684\u8DEF\u7531\u5730\u5740"}),"\u3002"]}),"\n",(0,o.jsxs)(t.p,{children:["\u6211\u4EEC\u540C\u6837\u9700\u8981\u901A\u8FC7 ",(0,o.jsx)(t.code,{children:"app.test_server()"})," \u83B7\u53D6\u6D4B\u8BD5\u7528\u6A21\u62DF\u5BA2\u6237\u7AEF\uFF0C\u8FD9\u91CC\u5C31\u4E0D\u518D\u8D58\u8FF0\u3002\u5728\u83B7\u53D6\u5230\u6A21\u62DF\u5BA2\u6237\u7AEF\u540E\uFF0C\u6211\u4EEC\u53EF\u4EE5\u901A\u8FC7 ",(0,o.jsx)(t.code,{children:"client.websocket_connect"})," \u65B9\u6CD5\u6765\u6A21\u62DF WebSocket \u8FDE\u63A5\uFF1A"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",metastring:"{3,11-15} title=tests/test_ws_server.py",children:'import nonebot\nfrom nonebug import App\nfrom nonebot.adapters.fake import Adapter\n\n@pytest.mark.asyncio\nasync def test_ws_server(app: App):\n    adapter = nonebot.get_adapter(Adapter)\n\n    async with app.test_server() as ctx:\n        client = ctx.get_client()\n        async with client.websocket_connect("/fake/ws") as ws:\n            await ws.send_json({"bot_id": "fake"})\n            response = await ws.receive_json()\n            assert response == {"status": "success"}\n            assert "fake" in nonebot.get_bots()\n'})}),"\n",(0,o.jsxs)(t.p,{children:["\u5728\u4E0A\u9762\u7684\u6D4B\u8BD5\u4E2D\uFF0C\u6211\u4EEC\u5411 ",(0,o.jsx)(t.code,{children:"/fake/ws"})," \u8FDB\u884C\u4E86 WebSocket \u6A21\u62DF\u901A\u4FE1\uFF0C\u901A\u8FC7\u53D1\u9001\u6D88\u606F\u4E0E\u673A\u5668\u4EBA\u8FDB\u884C\u4EA4\u4E92\uFF0C\u7136\u540E\u68C0\u67E5\u673A\u5668\u4EBA\u53D1\u9001\u7684\u4FE1\u606F\u662F\u5426\u6B63\u786E\u3002"]}),"\n",(0,o.jsx)(t.h2,{id:"\u6D4B\u8BD5-http-\u5BA2\u6237\u7AEF",children:"\u6D4B\u8BD5 HTTP \u5BA2\u6237\u7AEF"}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.del,{children:"\u6682\u4E0D\u652F\u6301"})}),"\n",(0,o.jsx)(t.h2,{id:"\u6D4B\u8BD5-websocket-\u5BA2\u6237\u7AEF",children:"\u6D4B\u8BD5 WebSocket \u5BA2\u6237\u7AEF"}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.del,{children:"\u6682\u4E0D\u652F\u6301"})})]})}function l(e={}){let{wrapper:t}={...(0,r.a)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(p,{...e})}):p(e)}},80980:function(e,t,n){n.d(t,{Z:function(){return i},a:function(){return c}});var s=n(27378);let o={},r=s.createContext(o);function c(e){let t=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:c(e.components),s.createElement(r.Provider,{value:t},e.children)}}}]);