"use strict";(self.webpackChunknonebot=self.webpackChunknonebot||[]).push([["3479"],{89297:function(e,n,s){s.r(n),s.d(n,{default:()=>p,frontMatter:()=>r,metadata:()=>o,assets:()=>d,toc:()=>l,contentTitle:()=>t});var o=JSON.parse('{"id":"best-practice/database/developer/dependency","title":"\u4F9D\u8D56\u6CE8\u5165","description":"\u4F9D\u8D56\u6CE8\u5165","source":"@site/versioned_docs/version-2.4.3/best-practice/database/developer/dependency.md","sourceDirName":"best-practice/database/developer","slug":"/best-practice/database/developer/dependency","permalink":"/website/docs/best-practice/database/developer/dependency","draft":false,"unlisted":false,"editUrl":"https://github.com/nonebot/nonebot2/edit/master/website/versioned_docs/version-2.4.3/best-practice/database/developer/dependency.md","tags":[],"version":"2.4.3","lastUpdatedBy":"noneflow[bot]","lastUpdatedAt":1754561629000,"sidebarPosition":3,"frontMatter":{"sidebar_position":3,"description":"\u4F9D\u8D56\u6CE8\u5165"},"sidebar":"tutorial","previous":{"title":"\u6D4B\u8BD5","permalink":"/website/docs/best-practice/database/developer/test"},"next":{"title":"\u53D1\u5E03\u63D2\u4EF6","permalink":"/website/docs/developer/plugin-publishing"}}'),i=s("24246"),a=s("80980");let r={sidebar_position:3,description:"\u4F9D\u8D56\u6CE8\u5165"},t="\u4F9D\u8D56\u6CE8\u5165",d={},l=[{value:"\u6570\u636E\u5E93\u4F1A\u8BDD",id:"\u6570\u636E\u5E93\u4F1A\u8BDD",level:2},{value:"AsyncSession",id:"asyncsession",level:3},{value:"async_scoped_session",id:"async_scoped_session",level:3},{value:"\u67E5\u8BE2\u6570\u636E",id:"\u67E5\u8BE2\u6570\u636E",level:2},{value:"Model",id:"model",level:3},{value:"SQLDepends",id:"sqldepends",level:3},{value:"\u7C7B\u578B\u6807\u6CE8",id:"\u7C7B\u578B\u6807\u6CE8",level:3}];function c(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"\u4F9D\u8D56\u6CE8\u5165",children:"\u4F9D\u8D56\u6CE8\u5165"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"nonebot-plugin-orm"})," \u63D0\u4F9B\u4E86\u5F3A\u5927\u4E14\u7075\u6D3B\u7684\u4F9D\u8D56\u6CE8\u5165\uFF0C\u53EF\u4EE5\u65B9\u4FBF\u5730\u5E2E\u52A9\u4F60\u83B7\u53D6\u6570\u636E\u5E93\u4F1A\u8BDD\u548C\u67E5\u8BE2\u6570\u636E\u3002"]}),"\n",(0,i.jsx)(n.h2,{id:"\u6570\u636E\u5E93\u4F1A\u8BDD",children:"\u6570\u636E\u5E93\u4F1A\u8BDD"}),"\n",(0,i.jsx)(n.h3,{id:"asyncsession",children:"AsyncSession"}),"\n",(0,i.jsx)(n.p,{children:"\u65B0\u6570\u636E\u5E93\u4F1A\u8BDD\uFF0C\u5E38\u7528\u4E8E\u6709\u72EC\u7ACB\u7684\u6570\u636E\u5E93\u64CD\u4F5C\u903B\u8F91\u7684\u63D2\u4EF6\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",metastring:"{13,26}",children:"from nonebot import on_message\nfrom nonebot.params import Depends\nfrom nonebot_plugin_orm import AsyncSession, Model, async_scoped_session\nfrom sqlalchemy.orm import Mapped, mapped_column\n\nmessage = on_message()\n\n\nclass Message(Model):\n    id: Mapped[int] = mapped_column(primary_key=True, autoincrement=True)\n\n\nasync def get_message(session: AsyncSession) -> Message:\n    # \u7B49\u4EF7\u4E8E session = get_session()\n    async with session:\n        msg = Message()\n\n        session.add(msg)\n        await session.commit()\n        await session.refresh(msg)\n\n        return msg\n\n\n@message.handle()\nasync def _(session: async_scoped_session, msg: Message = Depends(get_message)):\n    await session.rollback()  # \u65E0\u6CD5\u56DE\u9000 get_message() \u4E2D\u7684\u66F4\u6539\n    await message.send(str(msg.id))  # msg \u88AB\u5B58\u50A8\uFF0Cmsg.id \u9012\u589E\n"})}),"\n",(0,i.jsx)(n.h3,{id:"async_scoped_session",children:"async_scoped_session"}),"\n",(0,i.jsx)(n.p,{children:"\u6570\u636E\u5E93\u4F5C\u7528\u57DF\u4F1A\u8BDD\uFF0C\u5E38\u7528\u4E8E\u4E8B\u4EF6\u54CD\u5E94\u5668\u548C\u6709\u4E0E\u54CD\u5E94\u903B\u8F91\u76F8\u5173\u7684\u6570\u636E\u5E93\u64CD\u4F5C\u903B\u8F91\u7684\u63D2\u4EF6\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",metastring:"{13\uFF0C26}",children:"from nonebot import on_message\nfrom nonebot.params import Depends\nfrom nonebot_plugin_orm import Model, async_scoped_session\nfrom sqlalchemy.orm import Mapped, mapped_column\n\nmessage = on_message()\n\n\nclass Message(Model):\n    id: Mapped[int] = mapped_column(primary_key=True, autoincrement=True)\n\n\nasync def get_message(session: async_scoped_session) -> Message:\n    # \u7B49\u4EF7\u4E8E session = get_scoped_session()\n    msg = Message()\n\n    session.add(msg)\n    await session.flush()\n    await session.refresh(msg)\n\n    return msg\n\n\n@message.handle()\nasync def _(session: async_scoped_session, msg: Message = Depends(get_message)):\n    await session.rollback()  # \u53EF\u4EE5\u56DE\u9000 get_message() \u4E2D\u7684\u66F4\u6539\n    await message.send(str(msg.id))  # msg \u6CA1\u6709\u88AB\u5B58\u50A8\uFF0Cmsg.id \u4E0D\u53D8\n"})}),"\n",(0,i.jsx)(n.h2,{id:"\u67E5\u8BE2\u6570\u636E",children:"\u67E5\u8BE2\u6570\u636E"}),"\n",(0,i.jsx)(n.h3,{id:"model",children:"Model"}),"\n",(0,i.jsx)(n.p,{children:"\u652F\u6301\u7C7B\u4F5C\u4E3A\u4F9D\u8D56\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"from typing import Annotated\n\nfrom nonebot.params import Depends\nfrom nonebot_plugin_orm import Model\nfrom sqlalchemy.orm import Mapped, mapped_column\n\n\ndef get_id() -> int: ...\n\n\nclass Message(Model):\n    id: Annotated[Mapped[int], Depends(get_id)] = mapped_column(\n        primary_key=True, autoincrement=True\n    )\n\n\nasync def _(msg: Message):\n    # \u7B49\u4EF7\u4E8E msg = (\n    #     await (await session.stream(select(Message).where(Message.id == get_id())))\n    #     .scalars()\n    #     .one_or_none()\n    # )\n    ...\n"})}),"\n",(0,i.jsx)(n.h3,{id:"sqldepends",children:"SQLDepends"}),"\n",(0,i.jsx)(n.p,{children:"\u53C2\u6570\u4E3A\u4E00\u4E2A SQL \u8BED\u53E5\uFF0C\u51B3\u5B9A\u4F9D\u8D56\u6CE8\u5165\u7684\u5185\u5BB9\uFF0CSQL \u8BED\u53E5\u4E2D\u53EF\u4EE5\u4F7F\u7528\u5B50\u4F9D\u8D56\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",metastring:"{11-13}",children:"from nonebot.params import Depends\nfrom nonebot_plugin_orm import Model, SQLDepends\nfrom sqlalchemy import select\n\n\ndef get_id() -> int: ...\n\n\nasync def _(\n    model: Model = SQLDepends(select(Model).where(Model.id == Depends(get_id))),\n): ...\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u53C2\u6570\u53EF\u4EE5\u662F\u4EFB\u610F SQL \u8BED\u53E5\uFF0C\u4F46\u4E0D\u5EFA\u8BAE\u4F7F\u7528 ",(0,i.jsx)(n.code,{children:"select"})," \u4EE5\u5916\u7684\u8BED\u53E5\uFF0C\u56E0\u4E3A\u8BED\u53E5\u53EF\u80FD\u6CA1\u6709\u8FD4\u56DE\u503C\uFF08",(0,i.jsx)(n.code,{children:"returning"})," \u9664\u5916\uFF09\uFF0C\u800C\u4E14\u4EE3\u7801\u4E0D\u6E05\u6670\u3002"]}),"\n",(0,i.jsx)(n.h3,{id:"\u7C7B\u578B\u6807\u6CE8",children:"\u7C7B\u578B\u6807\u6CE8"}),"\n",(0,i.jsx)(n.p,{children:"\u7C7B\u578B\u6807\u6CE8\u51B3\u5B9A\u4F9D\u8D56\u6CE8\u5165\u7684\u6570\u636E\u7ED3\u6784\uFF0C\u4E3B\u8981\u5F71\u54CD\u4EE5\u4E0B\u51E0\u4E2A\u5C42\u9762\uFF1A"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u8FED\u4EE3\u5668\uFF08",(0,i.jsx)(n.code,{children:"session.execute()"}),"\uFF09\u6216\u5F02\u6B65\u8FED\u4EE3\u5668\uFF08",(0,i.jsx)(n.code,{children:"session.stream()"}),"\uFF09"]}),"\n",(0,i.jsxs)(n.li,{children:["\u6807\u91CF\uFF08",(0,i.jsx)(n.code,{children:"session.execute().scalars()"}),"\uFF09\u6216\u5143\u7EC4\uFF08",(0,i.jsx)(n.code,{children:"session.execute()"}),"\uFF09"]}),"\n",(0,i.jsxs)(n.li,{children:["\u4E00\u4E2A\uFF08",(0,i.jsx)(n.code,{children:"session.execute().one_or_none()"}),"\uFF0C\u6CE8\u610F ",(0,i.jsx)(n.code,{children:"None"})," \u65F6\u53EF\u80FD\u89E6\u53D1 ",(0,i.jsx)(n.a,{href:"../../../appendices/overload#%E9%87%8D%E8%BD%BD",children:"\u91CD\u8F7D"}),"\uFF09\u6216\u5168\u90E8\uFF08",(0,i.jsx)(n.code,{children:"session.execute()"})," / ",(0,i.jsx)(n.code,{children:"session.execute().all()"}),"\uFF09"]}),"\n",(0,i.jsxs)(n.li,{children:["\u8FDE\u7EED\uFF08",(0,i.jsx)(n.code,{children:"session().execute()"}),"\uFF09\u6216\u5206\u5757\uFF08",(0,i.jsx)(n.code,{children:"session.execute().partitions()"}),"\uFF09"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u5177\u4F53\u5982\u4E0B\uFF08\u53EF\u4EE5\u4F7F\u7528\u7236\u7C7B\u578B\u4F5C\u4E3A\u7C7B\u578B\u6807\u6CE8\uFF09\uFF1A"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"async def _(rows_partitions: AsyncIterator[Sequence[Tuple[Model, ...]]]):\n    # \u7B49\u4EF7\u4E8E rows_partitions = await (await session.stream(sql).partitions())\n\n    async for partition in rows_partitions:\n        for row in partition:\n            print(row[0], row[1], ...)\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"async def _(model_partitions: AsyncIterator[Sequence[Model]]):\n    # \u7B49\u4EF7\u4E8E model_partitions = await (await session.stream(sql).scalars().partitions())\n\n    async for partition in model_partitions:\n        for model in partition:\n            print(model)\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"async def _(row_partitions: Iterator[Sequence[Tuple[Model, ...]]]):\n    # \u7B49\u4EF7\u4E8E row_partitions = await session.execute(sql).partitions()\n\n    for partition in rows_partitions:\n        for row in partition:\n            print(row[0], row[1], ...)\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"async def _(model_partitions: Iterator[Sequence[Model]]):\n    # \u7B49\u4EF7\u4E8E model_partitions = await (await session.execute(sql).scalars().partitions())\n\n    for partition in model_partitions:\n        for model in partition:\n            print(model)\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"async def _(rows: sa_async.AsyncResult[Tuple[Model, ...]]):\n    # \u7B49\u4EF7\u4E8E rows = await session.stream(sql)\n\n    async for row in rows:\n        print(row[0], row[1], ...)\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"async def _(models: sa_async.AsyncScalarResult[Model]):\n    # \u7B49\u4EF7\u4E8E models = await session.stream(sql).scalars()\n\n    async for model in models:\n        print(model)\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"async def _(rows: sa.Result[Tuple[Model, ...]]):\n    # \u7B49\u4EF7\u4E8E rows = await session.execute(sql)\n\n    for row in rows:\n        print(row[0], row[1], ...)\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"async def _(models: sa.ScalarResult[Model]):\n    # \u7B49\u4EF7\u4E8E models = await session.execute(sql).scalars()\n\n    for model in models:\n        print(model)\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"async def _(rows: Sequence[Tuple[Model, ...]]):\n    # \u7B49\u4EF7\u4E8E rows = await (await session.stream(sql).all())\n\n    for row in rows:\n          print(row[0], row[1], ...)\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"async def _(models: Sequence[Model]):\n    # \u7B49\u4EF7\u4E8E models = await (await session.stream(sql).scalars().all())\n\n    for model in models:\n        print(model)\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"async def _(row: Tuple[Model, ...]):\n    # \u7B49\u4EF7\u4E8E row = await (await session.stream(sql).one_or_none())\n\n    print(row[0], row[1], ...)\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"async def _(model: Model):\n    # \u7B49\u4EF7\u4E8E model = await (await session.stream(sql).scalars().one_or_none())\n\n    print(model)\n"})}),"\n"]}),"\n"]})]})}function p(e={}){let{wrapper:n}={...(0,a.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},80980:function(e,n,s){s.d(n,{Z:function(){return t},a:function(){return r}});var o=s(27378);let i={},a=o.createContext(i);function r(e){let n=o.useContext(a);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),o.createElement(a.Provider,{value:n},e.children)}}}]);