<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Analysing Data Files &#8212; Stoner Pacakge API Documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/better.css?v=58ad701a" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=0b74bb8b" />
    <script src="../_static/documentation_options.js?v=29a6c3e3"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Working with Lots of Files" href="datafolder.html" />
    <link rel="prev" title="Curve Fitting in the Stoner Package" href="curve_fitting.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  </head><body>
    <header id="pageheader"><h1><a href="../index.html ">
        Stoner Pacakge API Documentation
    </a></h1></header>
  <div class="related top">
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="curve_fitting.html" title="Previous document">Curve Fitting in the Stoner Package</a>
        </li>
        <li>
          <a href="datafolder.html" title="Next document">Working with Lots of Files</a>
          &rarr;
        </li>
    </ul>
  </nav>
  <nav id="breadcrumbs">
    <ul>
      <li><a href="../index.html">Stoner Package</a></li>
      <li>
        <a href="ugindex.html">The Stoner Python Package User Guide</a>
      </li> 
    </ul>
  </nav>
  </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="analysing-data-files">
<h1>Analysing Data Files<a class="headerlink" href="#analysing-data-files" title="Link to this heading">¶</a></h1>
<section id="normalising-and-basic-maths-operations">
<span id="channel-maths-guide"></span><h2>Normalising and Basic Maths Operations<a class="headerlink" href="#normalising-and-basic-maths-operations" title="Link to this heading">¶</a></h2>
<p>Several methods are provided to assist with common data fitting and preparation tasks, such as normalising columns,
adding and subtracting columns.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">.</span><span class="n">normalise</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="s1">&#39;reference&#39;</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="s1">&#39;Normalised Data&#39;</span><span class="p">,</span><span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">normalise</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">normalise</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">3.141592654</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">normalise</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">a2</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="../classes/Stoner.Analysis.AnalysisMixin.html#Stoner.Analysis.AnalysisMixin.normalise" title="Stoner.Analysis.AnalysisMixin.normalise"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.normalise()</span></code></a> method simply divides the data column by the reference column. By default the normalise method
replaces the data column with the new (normalised) data and appends ‘(norm)’ to the column header. The keyword arguments
<em>header</em> and <em>replace</em> can override this behaviour. The third variant illustrates normalising to a constant
(note, however, that if the second argument is an integer it is treated as a column index and not a constant).
The final variant takes a 1D array with the same number of elements as rows and uses that to normalise to.
A typical example might be to have some baseline scan that one is normalising to.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;B&#39;</span><span class="n">m</span> <span class="n">header</span><span class="o">=</span><span class="s2">&quot;A-B&quot;</span><span class="p">,</span><span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">3.141592654</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">a2</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
<p>As one might expect form the name, the <code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.subtract()</span></code> method subtracts the second column form the first.
Unlike <a class="reference internal" href="../classes/Stoner.Analysis.AnalysisMixin.html#Stoner.Analysis.AnalysisMixin.normalise" title="Stoner.Analysis.AnalysisMixin.normalise"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.normalise()</span></code></a> the first data column will not be replaced but a new column inserted and a new header
(defaulting to ‘column header 1 - column header 2’) will be created. This can be overridden with the <em>header</em> and <em>replace</em>
keyword arguments. The next two variants of the <code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.subtract()</span></code> method work in an analogous manner to the
<a class="reference internal" href="../classes/Stoner.Analysis.AnalysisMixin.html#Stoner.Analysis.AnalysisMixin.normalise" title="Stoner.Analysis.AnalysisMixin.normalise"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.normalise()</span></code></a> methods. Finally the <code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.add()</span></code> method allows one to add two columns in a
similar fashion:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="s1">&#39;A plus B&#39;</span><span class="p">,</span><span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">3.141592654</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">a2</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
<p>For completeness we also have:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="s1">&#39;A/B&#39;</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="s1">&#39;A*B&#39;</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>with variants that take either a 1D array of data or a constant instead of the B column index.</p>
<p>The final variant for these channel operations is the <code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.diffsum()</span></code> which takes the ratio of the difference over the sum of two channels.
This is typically used to calculate asymmetry parameters.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">.</span><span class="n">diffsum</span><span class="p">(</span><span class="s1">&#39;I+&#39;</span><span class="p">,</span><span class="s1">&#39;I-&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Of course, these elementary operations might look rather pointless given how easy it is to extract single columns of data and then add them to a
<code class="xref py py-class docutils literal notranslate"><span class="pre">Stoner.Core.Data</span></code> object, however if the channels are specified as a <strong>tuple</strong> of two elements, then it is taken as a channel of data and a
second channel of uncertainties. The uncertainty calculation is then propagated correctly for the maths operations. This is particularly useful for the
<code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.diffsum()</span></code> method where the error propagation is not entirely trivial.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Demonstrate Channel math operations.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">linspace</span><span class="p">,</span> <span class="n">ones_like</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">pi</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy.random</span><span class="w"> </span><span class="kn">import</span> <span class="n">normal</span><span class="p">,</span> <span class="n">seed</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">Stoner</span><span class="w"> </span><span class="kn">import</span> <span class="n">Data</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">Stoner.plot.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">errorfill</span>

<span class="n">seed</span><span class="p">(</span><span class="mi">12345</span><span class="p">)</span>  <span class="c1"># Ensure consistent random numbers!</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">pi</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-9</span>
<span class="n">e</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span>
<span class="n">e2</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">y2</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">Data</span><span class="p">(</span>
    <span class="n">x</span><span class="p">,</span>
    <span class="n">y</span><span class="p">,</span>
    <span class="n">e</span><span class="p">,</span>
    <span class="n">y2</span><span class="p">,</span>
    <span class="n">e2</span><span class="p">,</span>
    <span class="n">column_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;$X$&quot;</span><span class="p">,</span> <span class="s2">&quot;$Y_+$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\delta Y_+$&quot;</span><span class="p">,</span> <span class="s2">&quot;$Y_-$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\delta Y_-$&quot;</span><span class="p">],</span>
    <span class="n">setas</span><span class="o">=</span><span class="s2">&quot;xyeye&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">a</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">column_headers</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
<span class="n">b</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">column_headers</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>

<span class="n">d</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">diffsum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">setas</span> <span class="o">=</span> <span class="s2">&quot;xyeyeyeyeyeyeye&quot;</span>
<span class="n">d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">multiple</span><span class="o">=</span><span class="s2">&quot;panels&quot;</span><span class="p">,</span>
    <span class="n">plotter</span><span class="o">=</span><span class="n">errorfill</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
    <span class="n">alpha_fill</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>(<a class="reference external" href="../samples/channel_math.png">png</a>, <a class="reference external" href="../samples/channel_math.hires.png">hires.png</a>, <a class="reference external" href="../samples/channel_math.pdf">pdf</a>)</p>
<figure class="align-default">
<img alt="../_images/channel_math.png" src="../_images/channel_math.png" />
</figure>
</section>
<section id="splitting-data-up">
<h2>Splitting Data Up<a class="headerlink" href="#splitting-data-up" title="Link to this heading">¶</a></h2>
<p>One might wish to split a single data file into several different data files each with the rows of the original
that have a common unique value in one data column, or for which some function of the complete row determines which datafile
each row belongs in. The <code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.split()</span></code> method is useful for this case.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;Polarisation&#39;</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;Temperature&#39;</span><span class="p">,</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">r</span><span class="p">:</span><span class="n">x</span><span class="o">&gt;</span><span class="mi">100</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">([</span><span class="s1">&#39;Temperature&#39;</span><span class="p">,</span><span class="s1">&#39;Polarisation&#39;</span><span class="p">],[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">r</span><span class="p">:</span><span class="n">x</span><span class="o">&gt;</span><span class="mi">100</span><span class="p">,</span><span class="kc">None</span><span class="p">])</span>
</pre></div>
</div>
<p>In these examples we assume the <a class="reference internal" href="../classes/Stoner.Analysis.AnalysisMixin.html#Stoner.Analysis.AnalysisMixin" title="Stoner.Analysis.AnalysisMixin"><code class="xref py py-class docutils literal notranslate"><span class="pre">AnalysisMixin</span></code></a> has a data column ‘Polarisation’ that takes two (or more) discrete values
and a column ‘Temperature’ that contains numbers above and below 100.</p>
<p>The first example would return a <a class="reference internal" href="../classes/Stoner.Folders.DataFolder.html#Stoner.Folders.DataFolder" title="Stoner.Folders.DataFolder"><code class="xref py py-class docutils literal notranslate"><span class="pre">Stoner.Folders.DataFolder</span></code></a> object  containing two separate instances of <a class="reference internal" href="../classes/Stoner.Analysis.AnalysisMixin.html#Stoner.Analysis.AnalysisMixin" title="Stoner.Analysis.AnalysisMixin"><code class="xref py py-class docutils literal notranslate"><span class="pre">AnalysisMixin</span></code></a>  which
would each contain the rows from the original data that had each unique value of the polarisation data. The second example would
produce a <a class="reference internal" href="../classes/Stoner.Folders.DataFolder.html#Stoner.Folders.DataFolder" title="Stoner.Folders.DataFolder"><code class="xref py py-class docutils literal notranslate"><span class="pre">Stoner.Folders.DataFolder</span></code></a> object containing two <a class="reference internal" href="../classes/Stoner.Analysis.AnalysisMixin.html#Stoner.Analysis.AnalysisMixin" title="Stoner.Analysis.AnalysisMixin"><code class="xref py py-class docutils literal notranslate"><span class="pre">AnalysisMixin</span></code></a> objects for the rows with temperature above and below 100.
The final example will result in a <a class="reference internal" href="../classes/Stoner.Folders.DataFolder.html#Stoner.Folders.DataFolder" title="Stoner.Folders.DataFolder"><code class="xref py py-class docutils literal notranslate"><span class="pre">Stoner.Folders.DataFolder</span></code></a> object that has two groups each of which contains
<a class="reference internal" href="../classes/Stoner.Analysis.AnalysisMixin.html#Stoner.Analysis.AnalysisMixin" title="Stoner.Analysis.AnalysisMixin"><code class="xref py py-class docutils literal notranslate"><span class="pre">AnalysisMixin</span></code></a> objects for each polarisation value.</p>
</section>
<section id="more-analysismixin-functions">
<h2>More AnalysisMixin Functions<a class="headerlink" href="#more-analysismixin-functions" title="Link to this heading">¶</a></h2>
<section id="applying-an-arbitrary-function-through-the-data">
<h3>Applying an arbitrary function through the data<a class="headerlink" href="#applying-an-arbitrary-function-through-the-data" title="Link to this heading">¶</a></h3>
<p><a class="reference internal" href="../classes/Stoner.Analysis.AnalysisMixin.html#Stoner.Analysis.AnalysisMixin.apply" title="Stoner.Analysis.AnalysisMixin.apply"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.apply()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">replace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>Here <em>func</em> is an arbitrary function that will take a complete row in the form of a numpy 1D array, <em>col</em>
is the index of a column at which the resulting data is to be inserted or overwrite the
existing data (depending on the values of <em>replace</em> and <em>header</em>).</p>
</section>
<section id="basic-data-inspection">
<h3>Basic Data Inspection<a class="headerlink" href="#basic-data-inspection" title="Link to this heading">¶</a></h3>
<p><code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.max()</span></code> and <code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.min()</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">column</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="n">labda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">column</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="n">labda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>Hopefully all of the above are fairly obvious ! In the last two cases, one can use a function
to limit the search to particular rows (eg to search for the maximum y value subject to some constraint
in x). One important point to note is that the routines return a tuple of two numbers, the maximum (or
minimum) and the row number where the maximum or minimum was found.</p>
<p>There are a couple of related functions to help here:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">100</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">column</span><span class="p">,(</span><span class="n">max_v</span><span class="p">,</span><span class="n">min_v</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">column</span><span class="p">,</span><span class="n">b</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="n">column</span><span class="p">))</span>
</pre></div>
</div>
<p>The <code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.span()</span></code> method simply returns a tuple of minimum and maximum values within either the whole column or
bounded data. Internally this is just calling the <code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.max()</span></code> and <code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.min()</span></code> methods.
The <a class="reference internal" href="../classes/Stoner.Analysis.AnalysisMixin.html#Stoner.Analysis.AnalysisMixin.clip" title="Stoner.Analysis.AnalysisMixin.clip"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.clip()</span></code></a> method deletes rows for which the specified column as a value that is either larger or
smaller than the maximum or minimum value within the second argument. This allows one to specify either a tuple –
eg the result of the <code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.span()</span></code> method, or a complete list as in the last example above. Specifying a single
float would have the effect of removing all rows where the column didn’t equal the float value. This is probably not a good idea…</p>
<p>It is worth pointing out that these functions will respect the existing mask on the data unless the bounds parameter is set,
in which case the mask is temporarily discarded in favour of one generated from the bounds expression. This can be worked around,
however, as the parameter passed to the bounds function is itself a masked array and thus one can include a test of the mask in the
bounds function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="n">column</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">10</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">mask</span><span class="p">))</span>
</pre></div>
</div>
</section>
</section>
<section id="data-reduction-methods">
<h2>Data Reduction Methods<a class="headerlink" href="#data-reduction-methods" title="Link to this heading">¶</a></h2>
<p><a class="reference internal" href="../classes/Stoner.Analysis.AnalysisMixin.html#Stoner.Analysis.AnalysisMixin" title="Stoner.Analysis.AnalysisMixin"><code class="xref py py-class docutils literal notranslate"><span class="pre">AnalysisMixin</span></code></a> offers a number of methods to assist in data reduction and data processing.</p>
<section id="re-binning-data">
<span id="binning-guide"></span><h3>(Re)Binning Data<a class="headerlink" href="#re-binning-data" title="Link to this heading">¶</a></h3>
<p>Data binning is the process of taking approximately continuous (x,y) data and grouping them into “bins” of specified x, and average y. Since
this is a data averaging process, the statistical variation in y values is reduced, at the expense of a loss of resolution in x.</p>
<p><a class="reference internal" href="../classes/Stoner.Analysis.AnalysisMixin.html#Stoner.Analysis.AnalysisMixin" title="Stoner.Analysis.AnalysisMixin"><code class="xref py py-class docutils literal notranslate"><span class="pre">AnalysisMixin</span></code></a> provides a simple <code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.bin()</span></code> method that can re-bin data:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">x_bin</span><span class="p">,</span><span class="n">y_bin</span><span class="p">,</span><span class="n">dy</span><span class="p">)</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">bin</span><span class="p">(</span><span class="n">xcol</span><span class="o">=</span><span class="s2">&quot;Q&quot;</span><span class="p">,</span><span class="n">ycol</span><span class="o">=</span><span class="s2">&quot;Counts&quot;</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lin&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">x_bin</span><span class="p">,</span><span class="n">y_bin</span><span class="p">,</span><span class="n">dy</span><span class="p">)</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">bin</span><span class="p">(</span><span class="n">xcol</span><span class="o">=</span><span class="s2">&quot;Q&quot;</span><span class="p">,</span><span class="n">ycol</span><span class="o">=</span><span class="s2">&quot;Counts&quot;</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="s2">&quot;dCounts&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">x_bin</span><span class="p">,</span><span class="n">y_bin</span><span class="p">,</span><span class="n">dy</span><span class="p">)</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">bin</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span><span class="n">bin_start</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">bin_stop</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
<p>The mode parameter controls whether linear binning or logarithmic binning is used. The bins parameter is either an integer
in which case it specifies the number of bins to be used, or a float in which case it specifies the bin width. For logarithmic binning
the bin width for bin n is defined as <span class="math notranslate nohighlight">\(x_n * w\)</span> with <span class="math notranslate nohighlight">\(w\)</span> being the bin width parameter. Thus the bin boundaries are at
<span class="math notranslate nohighlight">\(x_n\)</span> and <span class="math notranslate nohighlight">\(x_{n+1}=x_n(1+w)\)</span> whilst the bin centre is at <span class="math notranslate nohighlight">\(x_n(1+\frac{w}{2})\)</span>. If a number of bins is specified in logarithmic mode
then the bin boundaries are set from equal logspace boundaries.</p>
<p>If the keyword <strong>yerr</strong> is supplied then the y values in each bin are weighted by their respective error bars when calculating the mean. In this case the
error bar on the bin bceomes the quadrature sum of the individual error bars on each point included in the bin. If <strong>yerr</strong> is nopt specified, then the error bar
is the standard error in the y points in the bin and the y value is the simple mean of the data.</p>
<p>If <strong>xcol</strong> and/or <strong>ycol</strong> are not specified, then they are looked up from the <code class="xref py py-attr docutils literal notranslate"><span class="pre">Stoner.Core.DataFile.setas</span></code> attribute. In this case, the <strong>yerr</strong>
is also taken from this attribute if not specified separately.</p>
<p>IF the keyword <em>clone</em> is supplied and is False, four 1D numpy arrays are returned, representing the x, y and y-errors for the new bins and the number of
points averaged into each bin.. If <em>clone</em> is True or not provided, <code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.bin()</span></code> returns a clone of the current data file with its data
(and column headers) replaced with the newly binned data.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Re-binning data example.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">Stoner</span><span class="w"> </span><span class="kn">import</span> <span class="n">Data</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">Stoner.plot.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">errorfill</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">Data</span><span class="p">(</span><span class="s2">&quot;Noisy_Data.txt&quot;</span><span class="p">,</span> <span class="n">setas</span><span class="o">=</span><span class="s2">&quot;xy&quot;</span><span class="p">)</span>

<span class="n">d</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">fig_height</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">d</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">fig_width</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">d</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">no_axes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">411</span><span class="p">)</span>

<span class="n">e</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">bin</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lin&quot;</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">bin</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lin&quot;</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">setas</span> <span class="o">=</span> <span class="s2">&quot;xye&quot;</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">bin</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">bin</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">binned</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
    <span class="nb">zip</span><span class="p">([</span><span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;0.05 Linear&quot;</span><span class="p">,</span> <span class="s2">&quot;0.25 Linear&quot;</span><span class="p">,</span> <span class="s2">&quot;0.05 Log&quot;</span><span class="p">,</span> <span class="s2">&quot;50 log&quot;</span><span class="p">])</span>
<span class="p">):</span>
    <span class="n">binned</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">411</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;k,&quot;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
    <span class="n">binned</span><span class="o">.</span><span class="n">fig</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">fig</span>
    <span class="n">binned</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plotter</span><span class="o">=</span><span class="n">errorfill</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>

    <span class="n">d</span><span class="o">.</span><span class="n">xlim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">100.0</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Bin demo&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</pre></div>
</div>
<p>(<a class="reference external" href="../samples/bins.png">png</a>, <a class="reference external" href="../samples/bins.hires.png">hires.png</a>, <a class="reference external" href="../samples/bins.pdf">pdf</a>)</p>
<figure class="align-default">
<img alt="../_images/bins.png" src="../_images/bins.png" />
</figure>
</section>
<section id="smoothing-and-filtering-data">
<span id="smoothing-guide"></span><h3>Smoothing and Filtering Data<a class="headerlink" href="#smoothing-and-filtering-data" title="Link to this heading">¶</a></h3>
<p>As experimental data normally includes noise in some form, it is useful to be able to filter and smooth data to better see
underlying trends. The Stoner package offers a  number of approaches to filtering data.</p>
<blockquote>
<div><ul>
<li><p>Smoothing by convoluting with a window</p>
<blockquote>
<div><p>This is a powerful method of smoothing data by constructing an appropriate length and shape of ‘window function’ that
is then convulted with the data so that every point becomes some form of weighted average of surrounding points as
defined by the window function. This is handled by the <code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.smooth()</span></code> method.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="s2">&quot;boxcar&quot;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">smooth</span><span class="p">((</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span><span class="mf">1.5</span><span class="p">),</span><span class="n">size</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span><span class="n">result</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="s2">&quot;Smoothed data&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>In both these examples, the data to be smoothed is determined from the <code class="xref py py-attr docutils literal notranslate"><span class="pre">Stoner.Core.DataFile.setas</span></code> attribute.
The first argument is passed to <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.get_window.html#scipy.signal.get_window" title="(in SciPy v1.15.2)"><code class="xref py py-func docutils literal notranslate"><span class="pre">scipy.signal.get_window()</span></code></a> to define the window function. The <em>size</em> argument
can either be an integer to specify the number of rows in the window, or a float to specify the size of the window in
terms of the x data. In the latter case, the data is first reinterpolated to an evenly space set in terms of the x-column
and then smoothed and then reinterpolated back to the original x data coordinates.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This will fail for hysteretic data. In this case it would be better to use an integer size argument and to ensure
the data is evenly spaced to start with.</p>
</div>
<p>The <em>result</em> and <em>replace</em> arguments are passed through to <code class="xref py py-meth docutils literal notranslate"><span class="pre">Stoner.Core.DataFile.add_column()</span></code> unless <em>replace</em>
is <strong>False</strong> in which case, the smoothed data is passed back as the return value and the current <a class="reference internal" href="../classes/Stoner.Analysis.AnalysisMixin.html#Stoner.Analysis.AnalysisMixin" title="Stoner.Analysis.AnalysisMixin"><code class="xref py py-class docutils literal notranslate"><span class="pre">AnalysisMixin</span></code></a>
is left unmodified.</p>
</div></blockquote>
</li>
<li><p>Savitzky-Golay filtering</p>
<blockquote>
<div><p>This is a common filtering technique, particularly for spectroscopic data as it is good at keeping major peak locations
and widths. In essence it is equivalent to least-squares fitting a low order polynomial to a window of the data and using
the co-effienicents of the fitting polynomail to determine the smoothed (or differentiated) data. This is impletemented as
<code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.SG_Filter()</span></code> method.</p>
</div></blockquote>
</li>
<li><p>Spline</p>
<blockquote>
<div><p>An alternative approach is to use a smoothing spline to fit the data locally. Depending on the spline smoothing setting
this will create a function that is continuous in both value and derivative that approaches the data. Unlike Savotzky-
Golay filtering it cannot be used to calculate a derivative easily, but it can handle y data with uncertainties. It is
implemented as the <code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.spline()</span></code> method.</p>
</div></blockquote>
</li>
<li><p>Rebinning</p>
<blockquote>
<div><p>As ullustrated above, rebinning the data is a common way for reducing noise by combining several data points. This is simple
and effective, but does reduce the length of the data !</p>
</div></blockquote>
</li>
</ul>
</div></blockquote>
<p>All three approaches are illustrated in the excample below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Smoothing Data methods example.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">Stoner</span><span class="w"> </span><span class="kn">import</span> <span class="n">Data</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">Data</span><span class="p">(</span><span class="s2">&quot;Noisy_Data.txt&quot;</span><span class="p">,</span> <span class="n">setas</span><span class="o">=</span><span class="s2">&quot;xy&quot;</span><span class="p">)</span>

<span class="n">d</span><span class="o">.</span><span class="n">fig</span> <span class="o">=</span> <span class="n">fig</span>
<span class="n">d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">)</span>
<span class="c1"># Filter with Savitsky-Golay filter, linear over 7 ppoints</span>
<span class="n">d</span><span class="o">.</span><span class="n">SG_Filter</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="s2">&quot;S-G Filtered&quot;</span><span class="p">)</span>
<span class="c1"># Filter with cubic splines</span>
<span class="n">d</span><span class="o">.</span><span class="n">spline</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="s2">&quot;Spline&quot;</span><span class="p">)</span>
<span class="c1"># Rebin data</span>
<span class="n">d</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="s2">&quot;hamming&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="s2">&quot;Smoothed&quot;</span><span class="p">)</span>

<span class="n">d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;S-G Filtered&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;SG Filter&quot;</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Spline&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Spline&quot;</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Smooth&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Smoooth&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">)</span>

<span class="n">d2</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">bin</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lin&quot;</span><span class="p">)</span>
<span class="n">d2</span><span class="o">.</span><span class="n">fig</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">fig</span>
<span class="n">d2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Re-binned&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>
<span class="n">d2</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">)</span>
<span class="n">d2</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">200.0</span><span class="p">,</span> <span class="mf">400.0</span><span class="p">)</span>
</pre></div>
</div>
<p>(<a class="reference external" href="../samples/smooth.png">png</a>, <a class="reference external" href="../samples/smooth.hires.png">hires.png</a>, <a class="reference external" href="../samples/smooth.pdf">pdf</a>)</p>
<figure class="align-default">
<img alt="../_images/smooth.png" src="../_images/smooth.png" />
</figure>
</section>
<section id="stitching-datasets-together">
<span id="stitch-guide"></span><h3>Stitching Datasets together<a class="headerlink" href="#stitching-datasets-together" title="Link to this heading">¶</a></h3>
<p>Sometimes a data set is obtained by joing together several separate sets of data,
for example, joinging several scans over different angular or energy ranges to make a single
combinaed scan. In the ideal world, these scans could simple be joing together (e.g. by using the +
operator), in practise one often finds that there are systematic changes in scaling or offsets
between individual scans. The task of stitching data sets together then becomes one of finding the
best mapping between two sets of (x,y) points that are nominally the same. <a class="reference internal" href="../classes/Stoner.Analysis.AnalysisMixin.html#Stoner.Analysis.AnalysisMixin" title="Stoner.Analysis.AnalysisMixin"><code class="xref py py-class docutils literal notranslate"><span class="pre">AnalysisMixin</span></code></a> provides
a <a class="reference internal" href="../classes/Stoner.Analysis.AnalysisMixin.html#Stoner.Analysis.AnalysisMixin.stitch" title="Stoner.Analysis.AnalysisMixin.stitch"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.stitch()</span></code></a> method to facilitate this.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Scale data to stitch it together.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">Stoner</span><span class="w"> </span><span class="kn">import</span> <span class="n">Data</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">Stoner.Util</span><span class="w"> </span><span class="kn">import</span> <span class="n">format_error</span>

<span class="c1"># Load and plot two sets of data</span>
<span class="n">s1</span> <span class="o">=</span> <span class="n">Data</span><span class="p">(</span><span class="s2">&quot;Stitch-scan1.txt&quot;</span><span class="p">,</span> <span class="n">setas</span><span class="o">=</span><span class="s2">&quot;xy&quot;</span><span class="p">)</span>
<span class="n">s2</span> <span class="o">=</span> <span class="n">Data</span><span class="p">(</span><span class="s2">&quot;Stitch-scan2.txt&quot;</span><span class="p">,</span> <span class="n">setas</span><span class="o">=</span><span class="s2">&quot;xy&quot;</span><span class="p">)</span>
<span class="n">s1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Set 1&quot;</span><span class="p">)</span>
<span class="n">s2</span><span class="o">.</span><span class="n">fig</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">fig</span>
<span class="n">s2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Set 2&quot;</span><span class="p">)</span>
<span class="c1"># Stitch scan 2 onto scan 1</span>
<span class="n">s2</span><span class="o">.</span><span class="n">stitch</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span>

<span class="n">s2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Stictched&quot;</span><span class="p">)</span>
<span class="n">s2</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Stictching Example&quot;</span>

<span class="c1"># Tidy up the plot by adding annotation fo the stirching co-efficients</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">]</span>
<span class="n">txt</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">lead</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$x&#39;\rightarrow x+A$&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;$y&#39;=\rightarrow By+C$&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
    <span class="n">labels</span><span class="p">,</span> <span class="n">s2</span><span class="p">[</span><span class="s2">&quot;Stitching Coefficients&quot;</span><span class="p">],</span> <span class="n">s2</span><span class="p">[</span><span class="s2">&quot;Stitching Coefficient Errors&quot;</span><span class="p">]</span>
<span class="p">):</span>
    <span class="n">txt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format_error</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">l</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.65</span><span class="p">,</span> <span class="n">lead</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">txt</span><span class="p">),</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="s2">&quot;x-small&quot;</span><span class="p">})</span>
<span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</pre></div>
</div>
<p>(<a class="reference external" href="../samples/stitch.png">png</a>, <a class="reference external" href="../samples/stitch.hires.png">hires.png</a>, <a class="reference external" href="../samples/stitch.pdf">pdf</a>)</p>
<figure class="align-default">
<img alt="../_images/stitch.png" src="../_images/stitch.png" />
</figure>
<p>The stitch method can be fine tuned by specifying the possible scaling and shifting operations, overlap
region to use or even a custom stiching transofmration function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">s2</span><span class="o">.</span><span class="n">stitch</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;shift x&quot;</span><span class="p">)</span>
<span class="n">s2</span><span class="o">.</span><span class="n">stitch</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;scale y, shift x&quot;</span><span class="p">,</span><span class="n">overlap</span><span class="o">=</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span><span class="mf">5.0</span><span class="p">))</span>
<span class="n">s2</span><span class="o">.</span><span class="n">stitch</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">func</span><span class="o">=</span><span class="n">my_stitcher</span><span class="p">,</span><span class="n">p0</span><span class="o">=</span><span class="p">[</span><span class="mf">3.14</span><span class="p">,</span><span class="mf">2.54</span><span class="p">,</span><span class="mf">2.0</span><span class="p">])</span>
</pre></div>
</div>
<p>In these examples, the x and y columns of <em>scan2</em> are modified to give the best
possible match to <em>scan1</em>. If <em>xcol</em> or <em>ycol</em> are not given then the default x and y columns as set py the
<code class="xref py py-attr docutils literal notranslate"><span class="pre">Stoner.Core.DataFile.setas</span></code> attribute.</p>
<p>The <em>mode</em> keyword can be used to specify the types of scaling operations that are
to be allowed. The defaults are to shoft both x and y by an offset value and to rescale
the y data by some factor. If even more control of the transformation is needed,
the <em>func</em> keyword and <em>p0</em> keyword can be used to provide an alternative transformation
function and initial guesses to its parameters. The profotype for the transformation
function should be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">my_stitcher</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="n">p3</span><span class="o">...</span><span class="p">,</span><span class="n">pn</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">mapped_x</span><span class="p">,</span><span class="n">mapped_y</span><span class="p">)</span>
</pre></div>
</div>
<p>In addition to changing the X and Y data in the current <a class="reference internal" href="../classes/Stoner.Analysis.AnalysisMixin.html#Stoner.Analysis.AnalysisMixin" title="Stoner.Analysis.AnalysisMixin"><code class="xref py py-class docutils literal notranslate"><span class="pre">AnalysisMixin</span></code></a>
instance, two new metadata keys, <em>Stitching Coefficient</em> and <em>Stitching Coefficient Errors</em>,
with the co-efficients used to modify the scan data.</p>
</section>
<section id="thresholding-interpolating-and-extrapolation-of-data">
<h3>Thresholding, Interpolating and Extrapolation of Data<a class="headerlink" href="#thresholding-interpolating-and-extrapolation-of-data" title="Link to this heading">¶</a></h3>
<p>Thresholding data is the process of identifying points where y data values cross a given limit (equivalently, finding roots for
<span class="math notranslate nohighlight">\(y=f(x)-y_{threshold}\)</span>). This is carried out by the <a class="reference internal" href="../classes/Stoner.Analysis.AnalysisMixin.html#Stoner.Analysis.AnalysisMixin.threshold" title="Stoner.Analysis.AnalysisMixin.threshold"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.threshold()</span></code></a> method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;Y-data&quot;</span><span class="p">,</span> <span class="n">rising</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">falling</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">all_vals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">xcol</span><span class="o">=</span><span class="s2">&quot;X-data&quot;</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span>
</pre></div>
</div>
<p>If the parameters <strong>col</strong> and <strong>xcol</strong> are not given, they are determined by the <code class="xref py py-attr docutils literal notranslate"><span class="pre">Stoner.Core.DataFile.setas</span></code> attribute. The <strong>rising</strong> and <strong>falling</strong>
parameters control whether the y values are rising or falling with row number as they pass the threshold and <strong>all_vals</strong> determines whether the method returns
just the first threshold or all thresholds it can find. The values returned are mapped to the x-column data if it is specified. The thresholding uses just a simple
two point linear fit to find the thresholds.</p>
<p>Interpolating data finds values of y for points x that lie between data points. The <code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.interpolate()</span></code> provides a simple pass-through to the
scipy routine <code class="xref py py-func docutils literal notranslate"><span class="pre">scipy.optimize.interp1d()</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">newX</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">xcol</span><span class="o">=</span><span class="s2">&quot;X-Data&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The new values of X are set from the mandatory first argument. <strong>kind</strong> can be either “linear” or “cubic” whilst the xcol data can be omitted in which case the
<code class="xref py py-attr docutils literal notranslate"><span class="pre">Stoner.Core.DataFile.setas</span></code> attribute is used. The method will return a new set of data where all columns are interpolated against the new values of X.</p>
<p>The <code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.interpolate()</span></code> method will return values that are obtained from ‘joining the dots’ - which is
appropriate if the uncertainties (and hence scatter) in the data is small. With more scatter in the data, it is better to
use some locally fitted spline function to interpolate with. The <code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.spline()</span></code> function can be used for this.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="o">.</span><span class="n">spline</span><span class="p">(</span><span class="s2">&quot;X-Data&quot;</span><span class="p">,</span><span class="s2">&quot;Y-Data&quot;</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="s2">&quot;Spline Data&quot;</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">smoothing</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span><span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">spline</span><span class="p">(</span><span class="s2">&quot;X-Data&quot;</span><span class="p">,</span><span class="s2">&quot;Y-Data&quot;</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="s2">&quot;Spline Data&quot;</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">smoothing</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span><span class="n">replace</span><span class="o">=</span><span class="s2">&quot;Extra&quot;</span><span class="p">)</span>
<span class="n">new_y</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">spline</span><span class="p">(</span><span class="s2">&quot;X-Data&quot;</span><span class="p">,</span><span class="s2">&quot;Y-Data&quot;</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">smoothing</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span><span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">spline</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">spline</span><span class="p">(</span><span class="s2">&quot;X-Data&quot;</span><span class="p">,</span><span class="s2">&quot;Y-Data&quot;</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">smoothing</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span><span class="n">replace</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>The <em>order</em> keyword gives the polynomial order of the spline function being fitted. The <em>smoothing</em> factor determines how
closely the spline follows the data points, with a <em>smoothing*=0.0 being a strict interpolation. The *repalce</em> argument
controls what the return value from the <code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.spline()</span></code> method returns. IF <em>replace</em> is True or a column
index, then the new data is added as a column of the Data, possibly replacing the current y-data. If <em>replace</em> is False, then
the new y-data is returned, but the existing data is unmodified. Finally, if <em>replace</em> is None, then the
<code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.spline()</span></code> method returns a <code class="xref py py-class docutils literal notranslate"><span class="pre">scipy.interpolate.UnivararateSpline</span></code> object that can be used to
evaluate the spline at arbitrary locations, including extrapolating outside the range of the original x data.</p>
<p>Extrapolation is, of course, a dangerous, operation when applied to data as it is essentially ‘inventing’ new data.
Extrapolating fromt he spline function, whislt possible, is a little tricky and in many cases the <code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.extrapolate()</span></code>
method is likely to be more successful. <code class="xref py py-meth docutils literal notranslate"><span class="pre">AbnalyseFile.extrapolate()</span></code> works by fitting a function over a window in the
data and using the fit function to predict nearby values. Where the new values lie within the range of data, this is strictly
a form of interpolation and the window of data fitted to the extrpolation function is centred around the new x-data point. As
the new x-data point  approaches and passes the limits of the existing data, the window used to provide the fit function
runs up to and stops at the limit of the supplied data. Thus when extrapolating, the new values of data are increasingly less certain
as one moves further from the end of the data.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Extrapolate data example.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">linspace</span><span class="p">,</span> <span class="n">ones_like</span><span class="p">,</span> <span class="n">column_stack</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">sqrt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy.random</span><span class="w"> </span><span class="kn">import</span> <span class="n">normal</span><span class="p">,</span> <span class="n">seed</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">Stoner</span><span class="w"> </span><span class="kn">import</span> <span class="n">Data</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">Stoner.plot.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">errorfill</span>

<span class="n">seed</span><span class="p">(</span><span class="mi">1245</span><span class="p">)</span>  <span class="c1"># Ensure consistent random numbers</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">Data</span><span class="p">(</span>
    <span class="n">column_stack</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">x</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="mf">2.0</span><span class="p">),</span>
            <span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">),</span>
    <span class="n">setas</span><span class="o">=</span><span class="s2">&quot;xye&quot;</span><span class="p">,</span>
    <span class="n">column_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;errors&quot;</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">extra_x</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>

<span class="n">y4</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">extrapolate</span><span class="p">(</span>
    <span class="n">extra_x</span><span class="p">,</span>
    <span class="n">overlap</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">kind</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span> <span class="n">A</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="n">C</span><span class="p">,</span>
    <span class="n">errors</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">Aerr</span><span class="p">,</span> <span class="n">Cerr</span><span class="p">,</span> <span class="n">popt</span><span class="p">:</span> <span class="n">sqrt</span><span class="p">(</span>
        <span class="p">(</span><span class="n">Aerr</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">Cerr</span><span class="o">**</span><span class="mi">2</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="n">y3</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">extrapolate</span><span class="p">(</span><span class="n">extra_x</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;cubic&quot;</span><span class="p">)</span>
<span class="n">y2</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">extrapolate</span><span class="p">(</span><span class="n">extra_x</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;quadratic&quot;</span><span class="p">)</span>
<span class="n">y1</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">extrapolate</span><span class="p">(</span><span class="n">extra_x</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>

<span class="n">d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;k.&quot;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Extrapolation Demo&quot;</span>

<span class="n">errorfill</span><span class="p">(</span>
    <span class="n">extra_x</span><span class="p">,</span> <span class="n">y4</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">y4</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Arg. Function&quot;</span>
<span class="p">)</span>

<span class="n">errorfill</span><span class="p">(</span>
    <span class="n">extra_x</span><span class="p">,</span> <span class="n">y3</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">y3</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cubic Extrapolation&quot;</span>
<span class="p">)</span>

<span class="n">errorfill</span><span class="p">(</span>
    <span class="n">extra_x</span><span class="p">,</span>
    <span class="n">y2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
    <span class="n">yerr</span><span class="o">=</span><span class="n">y2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Quadratic Extrapolation&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">errorfill</span><span class="p">(</span>
    <span class="n">extra_x</span><span class="p">,</span> <span class="n">y1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">y1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Linear Extrapolation&quot;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>(<a class="reference external" href="../samples/extrapolate-demo.png">png</a>, <a class="reference external" href="../samples/extrapolate-demo.hires.png">hires.png</a>, <a class="reference external" href="../samples/extrapolate-demo.pdf">pdf</a>)</p>
<figure class="align-default">
<img alt="../_images/extrapolate-demo.png" src="../_images/extrapolate-demo.png" />
</figure>
<p>Extrapolation is of course most successful if one has a physical model that should describe the data.
To allow for this, you can pass an arbitrary fitting function as the <em>kind</em> parameter.</p>
<p>Whilst interpolation will tell you the</p>
</section>
<section id="smoothing-and-differentiating-data">
<h3>Smoothing and Differentiating Data<a class="headerlink" href="#smoothing-and-differentiating-data" title="Link to this heading">¶</a></h3>
<p>Smoothing and numerical differentation are carried out using the Savitsky-Golay filtering function.
Whilst not the most sophisticated algorithm it is reasonably easy to implement and simple to use.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SG_Filter</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="o">.</span><span class="s2">&quot;Y&quot;</span><span class="p">),</span> <span class="n">points</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">poly</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">result</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>If col is a tuple then it is taken to be specifying both x and y data column indices. Otherwise the data
indexed by col is differentiated with respect to the row. <em>order</em> specifies the order of differentiation, where 0
means simply smoothing the data. The algorithm works by locally fitting a polynomial over a certain window of points.
The parameters for this fitting are controlled by the <em>points</em> and <em>poly</em> parameters. <em>points</em>&gt;*poly*&gt;*order* for
the algorithm to work. <em>result;t</em>, <em>replace</em> and <em>header</em> specify that the calculated data should also be added to
the <a class="reference internal" href="../classes/Stoner.Analysis.AnalysisMixin.html#Stoner.Analysis.AnalysisMixin" title="Stoner.Analysis.AnalysisMixin"><code class="xref py py-class docutils literal notranslate"><span class="pre">AnalysisMixin</span></code></a> instance, optionally replacing an existing column indexed by <em>result</em> and given a new header
<em>header</em>. The nature of the local fitting means that the first and last <em>poly</em>/2 points are not valid.</p>
</section>
<section id="peak-finding">
<span id="id1"></span><h3>Peak Finding<a class="headerlink" href="#peak-finding" title="Link to this heading">¶</a></h3>
<p>Peak finding is a tricky and often required task in experimental data analysis. When a functional form is known,
it is possible to fit the data to this functional form. However, often a more numerical approach is required.
The <code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.peaks()</span></code> provides a relatively simple and effective method for doing this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">peak_data</span><span class="o">=</span><span class="n">peaks</span><span class="p">()</span>
<span class="n">peak_data</span><span class="o">=</span><span class="n">peaks</span><span class="p">(</span><span class="n">ycol</span><span class="o">=</span><span class="s2">&quot;Y Data&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">significance</span><span class="o">=</span><span class="mf">0.001</span> <span class="p">,</span> <span class="n">xcol</span><span class="o">=</span><span class="s2">&quot;X Data&quot;</span><span class="p">,</span> <span class="n">peaks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">troughs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">poly</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>  <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The <em>xcol</em> and <em>ycol</em> arguments index the columns with the relevant data. If <em>xcol</em> is not provided then the row number is used instead.
If <em>ycol</em> is not provided then both x and y data is taken from the <em>setas</em> attribute.</p>
<p>The algorithm used is to differentiate the data with a Savitsky-Golay filter - which in effect fits a polynomial locally over the data.
Zero crossing values in the derivative are located and then the second derivative is found for these points and are used to identify
peaks and troughs in the data. The <em>width</em> and <em>poly</em> keywords are used to control the order of polynomial and the width of the window
used for calculating the derivative - a lower order  of polynomial and wider width will make the algroithm less sensitive to narrow peaks.
The <em>significance</em> parameter controls which peaks and troughs are returned. If <em>significance</em> is a float, then only peaks and troughs whose
second derivatives are larger than <em>significance</em> are returned. If <em>significance</em> is an integer, then maximum snd derivative in the data is divided
by the supplied significance and used as the threshold on which peaks and troughs to return. If <em>significance</em> is not provided then a value of 20 is used.
Finally, if <em>sort</em> is True, the peaks are returned in order of their significance. <em>peaks</em> and <em>troughs</em> select whether to return peaks or troughs.</p>
<p>The default values of width and saignificance are set on the assumption that a data set will have less than about 10 peaks of more or
less equal significance. By default, only peaks are returned in order of x position.</p>
<p>The example below shows how to use <code class="xref py py-meth docutils literal notranslate"><span class="pre">AnalysisMixin.peaks()</span></code> to filter out just the peak positions in a set of data.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Detect peaks in a dataset.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.cm</span><span class="w"> </span><span class="kn">import</span> <span class="n">jet</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">linspace</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">Stoner</span><span class="w"> </span><span class="kn">import</span> <span class="n">Data</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">Data</span><span class="p">(</span><span class="s2">&quot;../../sample-data/New-XRay-Data.dql&quot;</span><span class="p">)</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">clone</span>
<span class="n">d</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">d</span><span class="o">.</span><span class="n">peaks</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span> <span class="n">poly</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">significance</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">modify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Peaks&quot;</span>
<span class="n">d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;ro&quot;</span><span class="p">)</span>
<span class="n">e</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">modify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prominence</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">e</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Find_Peaks&quot;</span>
<span class="n">e</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figure</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Finding peaks with peaks() and find_peaks()&quot;</span>

<span class="c1"># Use the metadata that find_peaks produces</span>
<span class="n">colors</span> <span class="o">=</span> <span class="n">jet</span><span class="p">(</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s2">&quot;left_ips&quot;</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="s2">&quot;right_ips&quot;</span><span class="p">],</span> <span class="n">colors</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">ax</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
<p>(<a class="reference external" href="../samples/peaks.png">png</a>, <a class="reference external" href="../samples/peaks.hires.png">hires.png</a>, <a class="reference external" href="../samples/peaks.pdf">pdf</a>)</p>
<figure class="align-default">
<img alt="../_images/peaks.png" src="../_images/peaks.png" />
</figure>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/StonerLogo2.png" alt="Logo of Stoner Package"/>
            </a></p>
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Analysing Data Files</a><ul>
<li><a class="reference internal" href="#normalising-and-basic-maths-operations">Normalising and Basic Maths Operations</a></li>
<li><a class="reference internal" href="#splitting-data-up">Splitting Data Up</a></li>
<li><a class="reference internal" href="#more-analysismixin-functions">More AnalysisMixin Functions</a><ul>
<li><a class="reference internal" href="#applying-an-arbitrary-function-through-the-data">Applying an arbitrary function through the data</a></li>
<li><a class="reference internal" href="#basic-data-inspection">Basic Data Inspection</a></li>
</ul>
</li>
<li><a class="reference internal" href="#data-reduction-methods">Data Reduction Methods</a><ul>
<li><a class="reference internal" href="#re-binning-data">(Re)Binning Data</a></li>
<li><a class="reference internal" href="#smoothing-and-filtering-data">Smoothing and Filtering Data</a></li>
<li><a class="reference internal" href="#stitching-datasets-together">Stitching Datasets together</a></li>
<li><a class="reference internal" href="#thresholding-interpolating-and-extrapolation-of-data">Thresholding, Interpolating and Extrapolation of Data</a></li>
<li><a class="reference internal" href="#smoothing-and-differentiating-data">Smoothing and Differentiating Data</a></li>
<li><a class="reference internal" href="#peak-finding">Peak Finding</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="curve_fitting.html"
                          title="previous chapter">Curve Fitting in the Stoner Package</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="datafolder.html"
                          title="next chapter">Working with Lots of Files</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/UserGuide/analysisfile.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<form class="search" action="../search.html" method="get">
  <input type="text" name="q"
   placeholder="type to search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="related bottom">
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="curve_fitting.html" title="Previous document">Curve Fitting in the Stoner Package</a>
        </li>
        <li>
          <a href="datafolder.html" title="Next document">Working with Lots of Files</a>
          &rarr;
        </li>
    </ul>
  </nav>
  <nav id="breadcrumbs">
    <ul>
      <li><a href="../index.html">Stoner Package</a></li>
      <li>
        <a href="ugindex.html">The Stoner Python Package User Guide</a>
      </li> 
    </ul>
  </nav>
  </div>
  <footer id="pagefooter">&copy; 2013-15, Gavin Burnell et al.Last updated on Apr 16, 2025.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a>
      8.2.3
        with the <a href="http://github.com/irskep/sphinx-better-theme">
          better</a> theme.

  </footer>

  
  </body>
</html>