<!DOCTYPE html>

<html lang="en" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stoner.analysis.fitting.classes &#8212; Stoner Pacakge API Documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/better.css?v=58ad701a" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/custom.css?v=0b74bb8b" />
    <script src="../../../../_static/documentation_options.js?v=29a6c3e3"></script>
    <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  </head><body>
    <header id="pageheader"><h1><a href="../../../../index.html ">
        Stoner Pacakge API Documentation
    </a></h1></header>
  <div class="related top">
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
  <nav id="breadcrumbs">
    <ul>
      <li><a href="../../../../index.html">Stoner Package</a></li>
      <li>
        <a href="../../../index.html">Module code</a>
      </li> 
    </ul>
  </nav>
  </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for Stoner.analysis.fitting.classes</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Classes to support data fitting.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span> <span class="k">as</span> <span class="n">copy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">inspect</span><span class="w"> </span><span class="kn">import</span> <span class="n">isclass</span><span class="p">,</span> <span class="n">getfullargspec</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.odr</span><span class="w"> </span><span class="kn">import</span> <span class="n">Model</span> <span class="k">as</span> <span class="n">odrModel</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">lmfit</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">lmfit_mod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lmfit.model</span><span class="w"> </span><span class="kn">import</span> <span class="n">Model</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">...compat</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_func_params</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">...tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">AttributeStore</span>

<span class="n">_lmfit</span> <span class="o">=</span> <span class="kc">True</span>


<div class="viewcode-block" id="ODR_Model">
<a class="viewcode-back" href="../../../../classes/Stoner.analysis.fitting.ODR_Model.html#Stoner.analysis.fitting.ODR_Model">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ODR_Model</span><span class="p">(</span><span class="n">odrModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A wrapper for converting lmfit models to odr models.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialise with lmfit_mod.Models.Model or callable.&quot;&quot;&quot;</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">kargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;meta&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())</span>
        <span class="n">kargs</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">kargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;replace&quot;</span><span class="p">,</span> <span class="s2">&quot;header&quot;</span><span class="p">,</span> <span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="s2">&quot;residuals&quot;</span><span class="p">,</span> <span class="s2">&quot;prefix&quot;</span><span class="p">]:</span>
                <span class="k">del</span> <span class="n">kargs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">kargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;p0&quot;</span><span class="p">,</span> <span class="n">kargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;estimate&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Need at least one argument to make a fitting model.&quot;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">isclass</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>  <span class="c1"># Instantiate if only a class passed in</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">isclass</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">odrModel</span><span class="p">):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">func</span>
            <span class="n">modelfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">beta</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">beta</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>
            <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;param_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span>
            <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;param_hints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">param_hints</span>
            <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">odrModel</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span>
            <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;param_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;param_names&quot;</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Param_</span><span class="si">{</span><span class="n">ix</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p0</span><span class="p">)])</span>
            <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fcn</span><span class="o">.</span><span class="vm">__name__</span>

            <span class="n">modelfunc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fcn</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">arguments</span> <span class="o">=</span> <span class="n">getfullargspec</span><span class="p">(</span><span class="n">model</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># pylint: disable=W1505</span>
            <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;param_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;param_hints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">:]}</span>
            <span class="c1"># print(arguments,carargs,jeywords,defaults)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">model</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">modelfunc</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>  <span class="c1"># pylint: disable=E0102</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Warapper for model function.&quot;&quot;&quot;</span>
                <span class="k">return</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">beta</span><span class="p">)</span>

            <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;__name__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">f</span><span class="s2">&quot;Cannot construct a model instance from a </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2"> - &quot;</span><span class="p">,</span>
                        <span class="s2">&quot;need a callable, lmfit_mod.Model or scipy.odr.Model&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">lmfit_mod</span><span class="o">.</span><span class="n">Parameters</span><span class="p">):</span>  <span class="c1"># This can happen if we are creating an ODR_Model in advance.</span>
            <span class="n">tmp_model</span> <span class="o">=</span> <span class="n">AttributeStore</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">_prep_lmfit_p0</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">kargs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">p_new</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p0</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">p_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">p_new</span>
        <span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p0</span>

        <span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">modelfunc</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">p0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert an estimate attribute as p0.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;estimate&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">param_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert the meta parameter key param_names to an attribute.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;param_names&quot;</span><span class="p">]</span></div>



<span class="k">class</span><span class="w"> </span><span class="nc">MimizerAdaptor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Work with an lmfit_mod.Model or generic callable to use with scipy.optimize global minimization functions.</span>

<span class="sd">    The :pymod:`scipy.optimize` module&#39;s minimizers generally expect functions  which take an array like parameter</span>
<span class="sd">    space variable and then other arguments. This class will produce a suitable wrapper function and bounds</span>
<span class="sd">    variables from information int he lmfit_mod.Model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>  <span class="c1"># pylint: disable=unused-argument</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare the wrapper from the minimuzer.</span>

<span class="sd">        Args:</span>
<span class="sd">            modelower (lmfit):</span>
<span class="sd">                The model that has been fitted.</span>
<span class="sd">            *args (tuple):</span>
<span class="sd">                Positional parameters to initialise class.</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">            params (lmfit:parameter or dict):</span>
<span class="sd">                Parameters used to fit model.</span>
<span class="sd">            **kargs (dict):</span>
<span class="sd">                Keyword arguments to initialise the result object/.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError:</span>
<span class="sd">                Fails if a *params* Parameter does not supply a fitted value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">func</span>
        <span class="n">hints</span> <span class="o">=</span> <span class="n">kargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;params&quot;</span><span class="p">)</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">hint</span> <span class="ow">in</span> <span class="n">hints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hint</span><span class="p">,</span> <span class="n">lmfit_mod</span><span class="o">.</span><span class="n">Parameter</span><span class="p">):</span>
                <span class="n">hint</span> <span class="o">=</span> <span class="n">lmfit_mod</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="o">**</span><span class="n">hint</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hint</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;At the very least we need a starting value for the </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> parameter&quot;</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">hint</span><span class="o">.</span><span class="n">value</span>
            <span class="n">p0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">limits</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="n">v</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">]</span>
            <span class="n">hint_upper</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">hint</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">limits</span><span class="p">))</span>
            <span class="n">hint_lower</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">hint</span><span class="p">,</span> <span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">limits</span><span class="p">))</span>
            <span class="n">upper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hint_upper</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">hint_upper</span><span class="p">)</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="n">limits</span><span class="p">))</span>
            <span class="n">lower</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hint_lower</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">hint_lower</span><span class="p">)</span> <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="n">limits</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p0</span> <span class="o">=</span> <span class="n">p0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">ix</span> <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Calculate a least-squares goodness from the model functiuon.&quot;&quot;&quot;</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">/</span> <span class="n">sigma</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># normalise uncertainties</span>
            <span class="n">sigma</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">variance</span> <span class="o">=</span> <span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">beta</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">weights</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">beta</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">minimize_func</span> <span class="o">=</span> <span class="n">wrapper</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_curve_fit_result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represent a result from fitting using :py:func:`scipy.optimize.curve_fit`</span>
<span class="sd">    as a class to make handling easier.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span><span class="p">,</span> <span class="n">infodict</span><span class="p">,</span> <span class="n">mesg</span><span class="p">,</span> <span class="n">ier</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Store the results of the curve fit full_output fit.</span>

<span class="sd">        Args:</span>
<span class="sd">            popt (1D array):</span>
<span class="sd">                Optimal parameters for fit.</span>
<span class="sd">            pcov (2D array):</span>
<span class="sd">                Variance-co-variance matrix.</span>
<span class="sd">            infodict (dict):</span>
<span class="sd">                Additional information from curve_fit.</span>
<span class="sd">            mesg (str):</span>
<span class="sd">                Descriptive information from curve_fit.</span>
<span class="sd">            ier (int):</span>
<span class="sd">                Numerical error message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">popt</span> <span class="o">=</span> <span class="n">popt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pcov</span> <span class="o">=</span> <span class="n">pcov</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">pcov</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesg</span> <span class="o">=</span> <span class="n">mesg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ier</span> <span class="o">=</span> <span class="n">ier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nfev</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fvec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fjac</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ipvt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qtf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p0</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residual_vals</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chisq</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nfree</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">infodict</span> <span class="o">=</span> <span class="n">infodict</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">infodict</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">infodict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

    <span class="c1"># Following properties used to return desired information</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Name of the model fitted.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optimal parameters and errors as a Dictionary.&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">perr</span><span class="p">):</span>
            <span class="n">ret</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;d_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span> <span class="o">=</span> <span class="n">e</span>
        <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;chi-square&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chisqr</span>
        <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;red. chi-sqr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redchi</span>
        <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;nfev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfev</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">full</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the same as :py:attr:`_curve_fit_result.row`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">row</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optimal parameters and errors as a single row.&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">popt</span>
        <span class="n">ret</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perr</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy of the fit report and optimal parameters and covariance.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcov</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the data that was fitted.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_data&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>

    <span class="nd">@data</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the data that was fitted.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy of the fit report.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">N</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return th number of data points in dataset.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">n_p</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the number of parameters in model.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">redchi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Reduced $\chi^2$ Statistic.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">chisq</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">chisqr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;$\chi^2$ Statistic.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">chisq</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_p</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">aic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the Akaike Information Criterion statistic.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chisqr</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_p</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the Bayesian Information Criterion statistic.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chisqr</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_p</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List the parameter class objects.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">get_func_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a Fit report like lmfit does.&quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;[[ Model ]]</span>
<span class="s2">    </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span>
<span class="s2">[[ Fit Statistics ]]</span>
<span class="s2">    # function evals   = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nfev</span><span class="si">}</span>
<span class="s2">    # data points      = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="si">}</span>
<span class="s2">    # variables        = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_p</span><span class="si">}</span>
<span class="s2">    chi-square         = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">chisqr</span><span class="si">}</span>
<span class="s2">    reduced chi-square = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">redchi</span><span class="si">}</span>
<span class="s2">    Akaike info crit   = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">aic</span><span class="si">}</span>
<span class="s2">    Bayesian info crit = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bic</span><span class="si">}</span>
<span class="s2">[[ Variables ]]</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">p0</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">perr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p0</span><span class="p">):</span>
            <span class="n">template</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">%) (init </span><span class="si">{</span><span class="n">p0</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;[[Correlations]] (unreported correlations are &lt;  0.100)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pcov</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
                    <span class="n">template</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">(</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2">)</span><span class="se">\t\t</span><span class="s2">=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pcov</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">template</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_prep_lmfit_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">kargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare an lmfit model instance.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        model (lmfit Model class or instance, or callable): the model to be fitted to the data.</span>
<span class="sd">        p0 (iterable or floats): The initial values of the fitting parameters.</span>
<span class="sd">        kargs (dict):Other keyword arguments passed to the fitting function</span>

<span class="sd">    Returns:</span>
<span class="sd">        model,p0, prefix (lmfit_mod.Model instance, iterable, str)</span>

<span class="sd">    Converts the model parameter into an instance of lmfit_mod.Model - either by instantiating the class or wrapping a</span>
<span class="sd">    callable into an lmfit_mod.Model class and establishes a prefix string from the model if not provided in the</span>
<span class="sd">    keyword arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">Model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Will be the case if lmfit is not imported.</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;To use the lmfit function you need to be able to import the lmfit module\n Try pip install lmfit\nat</span>
<span class="sd">            a command prompt.&quot;&quot;&quot;</span>
        <span class="p">)</span>
    <span class="c1"># Enure that model is an instance of an lmfit_mod.Model() class</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">isclass</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">nan_policy</span><span class="o">=</span><span class="s2">&quot;propagate&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2"> must be an instance of lmfit_mod.Model or a cllable function!&quot;</span><span class="p">)</span>
    <span class="c1"># Nprmalise p0 to be lmfit_mod.Parameters</span>
    <span class="c1"># Get a default prefix for the model</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">kargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;prefix&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">prefix</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_prep_lmfit_p0</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">kargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare the initial start vector for an lmfit.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        model (lmfit_mod.Model instance): model to fit with</span>
<span class="sd">        ydata,xdata (array): y and x data ppoints for fitting</span>
<span class="sd">        p0 (iterable of float): Existing p0 vector if defined</span>
<span class="sd">        kargs (dict): Other keyword arguments for the lmfit method.</span>

<span class="sd">    Returns:</span>
<span class="sd">        p0,single_fit (iterable of floats, bool): The revised initial starting vector and whether this is a single</span>
<span class="sd">        fit operation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">single_fit</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">p0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># First guess the p0 values using the model</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">odrModel</span><span class="p">):</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">estimate</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">kargs</span><span class="p">:</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">set_param_hint</span><span class="p">(</span><span class="n">p_name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">kargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p_name</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p0</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">guess</span><span class="p">(</span><span class="n">ydata</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">xdata</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=W0703  Don&#39;t be fussy here</span>
                <span class="n">p0</span> <span class="o">=</span> <span class="n">lmfit_mod</span><span class="o">.</span><span class="n">Parameters</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">kargs</span><span class="p">:</span>
                        <span class="n">p0</span><span class="p">[</span><span class="n">p_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">lmfit_mod</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">p_name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">kargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p_name</span><span class="p">))</span>
        <span class="n">single_fit</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">p0</span><span class="p">):</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">p0</span><span class="p">(</span><span class="n">ydata</span><span class="p">,</span> <span class="n">xdata</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="n">p0</span><span class="o">.</span><span class="n">size</span><span class="p">)):</span>
        <span class="n">single_fit</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">p_new</span> <span class="o">=</span> <span class="n">lmfit_mod</span><span class="o">.</span><span class="n">Parameters</span><span class="p">()</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">p0</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">,</span> <span class="n">p0</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;param_hints&quot;</span><span class="p">):</span>
                <span class="n">hint</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">param_hints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hint</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">hint</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">hint</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
            <span class="n">p_new</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">lmfit_mod</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="o">**</span><span class="n">hint</span><span class="p">)</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">p_new</span>
        <span class="k">for</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">kargs</span><span class="p">:</span>
                <span class="n">p0</span><span class="p">[</span><span class="n">p_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">lmfit_mod</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">p_name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">kargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">p_name</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p0</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># chi^2 mapping</span>
        <span class="n">single_fit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">p0</span><span class="p">,</span> <span class="n">single_fit</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">lmfit_mod</span><span class="o">.</span><span class="n">Parameters</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown data type for initial guess vector p0: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&lt;</span> <span class="nb">set</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Missing some values from the initial guess vector p0: </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">set</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">p0</span><span class="p">,</span> <span class="n">single_fit</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/StonerLogo2.png" alt="Logo of Stoner Package"/>
            </a></p>
<form class="search" action="../../../../search.html" method="get">
  <input type="text" name="q"
   placeholder="type to search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="related bottom">
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
  <nav id="breadcrumbs">
    <ul>
      <li><a href="../../../../index.html">Stoner Package</a></li>
      <li>
        <a href="../../../index.html">Module code</a>
      </li> 
    </ul>
  </nav>
  </div>
  <footer id="pagefooter">&copy; 2013-15, Gavin Burnell et al.Last updated on Apr 16, 2025.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a>
      8.2.3
        with the <a href="http://github.com/irskep/sphinx-better-theme">
          better</a> theme.

  </footer>

  
  </body>
</html>