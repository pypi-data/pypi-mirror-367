<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Code Log Dashboard</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', monospace;
            background: #1a1a1a;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .header {
            background: #2d2d30;
            padding: 1rem;
            border-bottom: 2px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff4444;
        }

        .status-dot.connected {
            background: #44ff44;
        }

        .controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        button {
            background: #404040;
            color: #e0e0e0;
            border: 1px solid #606060;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
        }

        button:hover {
            background: #505050;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .main {
            display: flex;
            height: calc(100vh - 70px);
        }

        .sidebar {
            width: 300px;
            background: #252526;
            border-right: 1px solid #404040;
            overflow-y: auto;
        }

        .log-feed {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .session-item {
            padding: 0.75rem;
            border-bottom: 1px solid #404040;
            cursor: pointer;
        }

        .session-item:hover {
            background: #2d2d30;
        }

        .session-item.active {
            background: #094771;
        }

        .session-id {
            font-weight: bold;
            color: #4fc3f7;
            font-size: 0.9rem;
        }

        .session-info {
            font-size: 0.8rem;
            color: #999;
            margin-top: 0.25rem;
        }

        .log-entry {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-left: 3px solid #606060;
            background: #252526;
            border-radius: 0 4px 4px 0;
        }

        .log-entry.user {
            border-left-color: #4fc3f7;
        }

        .log-entry.assistant {
            border-left-color: #81c784;
        }

        .log-entry.system {
            border-left-color: #ffb74d;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .log-role {
            font-weight: bold;
        }

        .log-role.user {
            color: #4fc3f7;
        }

        .log-role.assistant {
            color: #81c784;
        }

        .log-role.system {
            color: #ffb74d;
        }

        .log-timestamp {
            color: #999;
            font-size: 0.8rem;
        }

        .log-content {
            font-size: 0.9rem;
            word-wrap: break-word;
        }

        .tool-use {
            background: #2d2d30;
            padding: 0.5rem;
            border-radius: 4px;
            margin: 0.5rem 0;
            border-left: 2px solid #ff9800;
        }

        .stats {
            padding: 1rem;
            background: #2d2d30;
            border-bottom: 1px solid #404040;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            font-size: 0.9rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #4fc3f7;
        }

        .stat-label {
            color: #999;
            font-size: 0.8rem;
        }

        input[type="text"] {
            background: #404040;
            color: #e0e0e0;
            border: 1px solid #606060;
            padding: 0.5rem;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.9rem;
        }

        .auto-scroll {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #404040;
            border: 1px solid #606060;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .auto-scroll.active {
            background: #094771;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ü§ñ Claude Code Log Dashboard</h1>
        <div class="controls">
            <div class="status">
                <div class="status-dot" id="connectionStatus"></div>
                <span id="connectionText">Disconnected</span>
            </div>
            <input type="text" id="serverUri" placeholder="ws://localhost:8765" value="ws://localhost:8765">
            <button id="connectBtn">Connect</button>
            <button id="clearBtn">Clear</button>
            <button id="pauseBtn">Pause</button>
        </div>
    </div>

    <div class="main">
        <div class="sidebar">
            <div class="stats">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalEntries">0</div>
                        <div class="stat-label">Entries</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="activeSessions">0</div>
                        <div class="stat-label">Sessions</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="toolUses">0</div>
                        <div class="stat-label">Tools</div>
                    </div>
                </div>
            </div>
            <div id="sessionList"></div>
        </div>

        <div class="log-feed" id="logFeed">
            <p style="color: #999; text-align: center; margin-top: 2rem;">
                üì° Connect to start streaming Claude Code logs...
            </p>
        </div>
    </div>

    <div class="auto-scroll active" id="autoScrollBtn" title="Auto-scroll">
        ‚¨áÔ∏è
    </div>

    <script>
        class ClaudeLogDashboard {
            constructor() {
                this.websocket = null;
                this.sessions = new Map();
                this.entries = [];
                this.paused = false;
                this.autoScroll = true;
                this.selectedSession = null;
                
                this.initElements();
                this.bindEvents();
            }
            
            initElements() {
                this.connectBtn = document.getElementById('connectBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.pauseBtn = document.getElementById('pauseBtn');
                this.serverUri = document.getElementById('serverUri');
                this.connectionStatus = document.getElementById('connectionStatus');
                this.connectionText = document.getElementById('connectionText');
                this.logFeed = document.getElementById('logFeed');
                this.sessionList = document.getElementById('sessionList');
                this.autoScrollBtn = document.getElementById('autoScrollBtn');
                this.totalEntries = document.getElementById('totalEntries');
                this.activeSessions = document.getElementById('activeSessions');
                this.toolUses = document.getElementById('toolUses');
            }
            
            bindEvents() {
                this.connectBtn.addEventListener('click', () => this.toggleConnection());
                this.clearBtn.addEventListener('click', () => this.clearLogs());
                this.pauseBtn.addEventListener('click', () => this.togglePause());
                this.autoScrollBtn.addEventListener('click', () => this.toggleAutoScroll());
                
                this.serverUri.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.toggleConnection();
                });
            }
            
            async toggleConnection() {
                if (this.websocket) {
                    this.disconnect();
                } else {
                    await this.connect();
                }
            }
            
            async connect() {
                const uri = this.serverUri.value.trim();
                if (!uri) return;
                
                this.updateConnectionStatus('connecting', 'Connecting...');
                this.connectBtn.disabled = true;
                
                try {
                    this.websocket = new WebSocket(uri);
                    
                    this.websocket.onopen = () => {
                        this.updateConnectionStatus('connected', 'Connected');
                        this.connectBtn.textContent = 'Disconnect';
                        this.connectBtn.disabled = false;
                        
                        // Send ping
                        this.send({ type: 'ping' });
                    };
                    
                    this.websocket.onmessage = (event) => {
                        if (!this.paused) {
                            this.handleMessage(JSON.parse(event.data));
                        }
                    };
                    
                    this.websocket.onclose = () => {
                        this.updateConnectionStatus('disconnected', 'Disconnected');
                        this.connectBtn.textContent = 'Connect';
                        this.connectBtn.disabled = false;
                        this.websocket = null;
                    };
                    
                    this.websocket.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.updateConnectionStatus('error', 'Error');
                    };
                    
                } catch (error) {
                    this.updateConnectionStatus('error', 'Failed to connect');
                    this.connectBtn.disabled = false;
                    console.error('Connection error:', error);
                }
            }
            
            disconnect() {
                if (this.websocket) {
                    this.websocket.close();
                }
            }
            
            send(data) {
                if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
                    this.websocket.send(JSON.stringify(data));
                }
            }
            
            updateConnectionStatus(status, text) {
                this.connectionStatus.className = `status-dot ${status === 'connected' ? 'connected' : ''}`;
                this.connectionText.textContent = text;
            }
            
            handleMessage(data) {
                switch (data.type) {
                    case 'pong':
                        console.log('Server pong received');
                        break;
                        
                    case 'history':
                        data.data.forEach(entry => this.addLogEntry(entry, false));
                        this.updateStats();
                        this.renderSessions();
                        break;
                        
                    case 'log_entry':
                        this.addLogEntry(data.data, true);
                        this.updateStats();
                        this.renderSessions();
                        break;
                }
            }
            
            addLogEntry(entryData, isNew = true) {
                // Skip if filtering by session and doesn't match
                if (this.selectedSession && entryData.session_id !== this.selectedSession) {
                    return;
                }
                
                this.entries.push(entryData);
                
                // Track session
                const sessionId = entryData.session_id || 'unknown';
                if (!this.sessions.has(sessionId)) {
                    this.sessions.set(sessionId, {
                        id: sessionId,
                        entries: [],
                        lastActivity: entryData.timestamp
                    });
                }
                this.sessions.get(sessionId).entries.push(entryData);
                
                // Render entry
                this.renderLogEntry(entryData, isNew);
            }
            
            renderLogEntry(entryData, isNew = true) {
                const entry = document.createElement('div');
                entry.className = `log-entry ${entryData.type || 'unknown'}`;
                
                const timestamp = entryData.timestamp ? 
                    new Date(entryData.timestamp).toLocaleTimeString() : '';
                
                const message = entryData.message || {};
                const role = message.role || entryData.type || 'unknown';
                
                let content = '';
                if (typeof message.content === 'string') {
                    content = message.content;
                } else if (Array.isArray(message.content)) {
                    for (const block of message.content) {
                        if (block.type === 'text') {
                            content = block.text;
                            break;
                        } else if (block.type === 'tool_use') {
                            content = `<div class="tool-use">üõ†Ô∏è Tool: ${block.name}</div>`;
                            break;
                        }
                    }
                }
                
                entry.innerHTML = `
                    <div class="log-header">
                        <span class="log-role ${role}">${role.toUpperCase()}</span>
                        <span class="log-timestamp">${timestamp}</span>
                    </div>
                    <div class="log-content">${content}</div>
                `;
                
                this.logFeed.appendChild(entry);
                
                if (isNew && this.autoScroll) {
                    entry.scrollIntoView({ behavior: 'smooth' });
                }
            }
            
            renderSessions() {
                const sortedSessions = Array.from(this.sessions.values())
                    .sort((a, b) => new Date(b.lastActivity) - new Date(a.lastActivity));
                
                this.sessionList.innerHTML = sortedSessions.map(session => `
                    <div class="session-item ${session.id === this.selectedSession ? 'active' : ''}" 
                         data-session="${session.id}">
                        <div class="session-id">${session.id.substring(0, 8)}...</div>
                        <div class="session-info">${session.entries.length} entries</div>
                    </div>
                `).join('');
                
                // Bind session click events
                this.sessionList.querySelectorAll('.session-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const sessionId = item.dataset.session;
                        this.selectSession(sessionId);
                    });
                });
            }
            
            selectSession(sessionId) {
                if (this.selectedSession === sessionId) {
                    this.selectedSession = null; // Deselect
                } else {
                    this.selectedSession = sessionId;
                }
                
                this.filterLogs();
                this.renderSessions();
            }
            
            filterLogs() {
                this.logFeed.innerHTML = '';
                
                const filteredEntries = this.selectedSession ? 
                    this.entries.filter(e => e.session_id === this.selectedSession) :
                    this.entries;
                
                filteredEntries.forEach(entry => this.renderLogEntry(entry, false));
                
                if (filteredEntries.length === 0) {
                    this.logFeed.innerHTML = '<p style="color: #999; text-align: center; margin-top: 2rem;">No entries for selected session</p>';
                }
            }
            
            updateStats() {
                this.totalEntries.textContent = this.entries.length;
                this.activeSessions.textContent = this.sessions.size;
                
                const toolUses = this.entries.filter(e => 
                    e.message && Array.isArray(e.message.content) &&
                    e.message.content.some(block => block.type === 'tool_use')
                ).length;
                this.toolUses.textContent = toolUses;
            }
            
            clearLogs() {
                this.entries = [];
                this.sessions.clear();
                this.selectedSession = null;
                this.logFeed.innerHTML = '<p style="color: #999; text-align: center; margin-top: 2rem;">Logs cleared</p>';
                this.sessionList.innerHTML = '';
                this.updateStats();
            }
            
            togglePause() {
                this.paused = !this.paused;
                this.pauseBtn.textContent = this.paused ? 'Resume' : 'Pause';
                this.pauseBtn.style.background = this.paused ? '#ff9800' : '#404040';
            }
            
            toggleAutoScroll() {
                this.autoScroll = !this.autoScroll;
                this.autoScrollBtn.className = `auto-scroll ${this.autoScroll ? 'active' : ''}`;
            }
        }
        
        // Initialize dashboard
        const dashboard = new ClaudeLogDashboard();
    </script>
</body>
</html>