"""
MCP –°–µ—Ä–≤–µ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ü–µ–Ω –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö.

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Ä–µ–∞–ª–∏–∑—É–µ—Ç MCP (Model Context Protocol) —Å–µ—Ä–≤–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç
–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ü–µ–Ω –Ω–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö
—Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö.

–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ (SQLite)
- –ü–æ–∏—Å–∫ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ü–µ–Ω —Å –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤
- –û–±—Ä–∞–±–æ—Ç–∫–∞ Excel —Ñ–∞–π–ª–æ–≤ —Å —Ç–æ–≤–∞—Ä–∞–º–∏
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- –õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MCP Playwright –¥–ª—è –≤–µ–±-—Å–∫—Ä–∞–ø–∏–Ω–≥–∞

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã:
- komus.ru (–ö–æ–º—É—Å) - –æ—Ñ–∏—Å–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –∏ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—è
- vseinstrumenti.ru (–í—Å–µ–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã) - –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
- ozon.ru (–û–∑–æ–Ω) - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å
- wildberries.ru (Wildberries) - —Ç–æ–≤–∞—Ä—ã —à–∏—Ä–æ–∫–æ–≥–æ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è
- officemag.ru (–û—Ñ–∏—Å–º–∞–≥) - –æ—Ñ–∏—Å–Ω—ã–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏
- yandex_market (–Ø–Ω–¥–µ–∫—Å.–ú–∞—Ä–∫–µ—Ç) - –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä —Ç–æ–≤–∞—Ä–æ–≤

–î–æ—Å—Ç—É–ø–Ω—ã–µ MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:
- get_product_details: –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–µ
- get_product_list: —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
- save_product_prices: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ü–µ–Ω (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç 5 —Ñ–æ—Ä–º–∞—Ç–æ–≤)
- get_statistics: –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º —Ç–æ–≤–∞—Ä–∞–º
- parse_excel_and_save_to_database: –∑–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ Excel
- parse_excel_file: –ø–∞—Ä—Å–∏–Ω–≥ Excel —Ñ–∞–π–ª–æ–≤
- get_excel_info: –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ Excel —Ñ–∞–π–ª–æ–≤
- export_to_excel: —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ Excel —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- filter_excel_data: —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º
- transform_excel_data: —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º
- check_license_status: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏
- set_license_key: —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º asyncio
- –ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
- –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö

–§–æ—Ä–º–∞—Ç—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è save_product_prices:
1. –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º–∞—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):
   {"marketplaces": {"komus.ru": {"price": "1250 —Ä—É–±", "availability": "–≤ –Ω–∞–ª–∏—á–∏–∏", "url": "..."}}}
2. –ú–∞—Å—Å–∏–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:
   {"results": [{"marketplace": "ozon.ru", "price": 890.5, "currency": "RUB", ...}]}
3. –ú–∞—Å—Å–∏–≤ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π:
   {"found_offers": [{"marketplace": "officemag.ru", "price": 567.0, ...}]}
4. –û–¥–∏–Ω–æ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
   {"marketplace": "komus.ru", "price": 1250.0, "currency": "RUB", ...}
5. –ü—Ä—è–º–æ–π –º–∞—Å—Å–∏–≤:
   [{"marketplace": "vseinstrumenti.ru", "price": 1320.0, ...}]

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
- STDIO —Ä–µ–∂–∏–º: –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å MCP –∫–ª–∏–µ–Ω—Ç–∞–º–∏ (Kiro, Cursor)
- SSE —Ä–µ–∂–∏–º: –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏ –æ—Ç–ª–∞–¥–∫–∏
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã

–ü—Ä–∏–º–µ—Ä—ã –≤—ã–∑–æ–≤–æ–≤:
- offers-check-marketplaces (STDIO —Ä–µ–∂–∏–º)
- offers-check-marketplaces --sse --host 0.0.0.0 --port 8000 (SSE —Ä–µ–∂–∏–º)

–õ–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–∏–µ:
–°–∏—Å—Ç–µ–º–∞ —Ç—Ä–µ–±—É–µ—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á –¥–ª—è —Ä–∞–±–æ—Ç—ã.
–ö–ª—é—á –º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è LICENSE_KEY –∏–ª–∏
—Å –ø–æ–º–æ—â—å—é –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ set_license_key.

–ê–≤—Ç–æ—Ä: –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –ø–æ–∏—Å–∫–∞ —Ü–µ–Ω –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö
–í–µ—Ä—Å–∏—è: 1.0.0
"""

import os
import sys
import anyio
import click
import uvicorn
import logging
import asyncio
from datetime import datetime
from pathlib import Path
from typing import Optional, Dict, List, Any
from starlette.applications import Starlette
from starlette.routing import Mount
from mcp.server.fastmcp import FastMCP, Context

from .data_processor import DataProcessor
from .database_manager import DatabaseManager
from .search_engine import SearchEngine
from .statistics import StatisticsGenerator
from .marketplace_client import MarketplaceClient
from .marketplace_config import get_marketplace_config, get_all_marketplaces
from .license_manager import LicenseManager, check_license
from .excel_tools import ExcelTools
from .user_data_manager import UserDataManager
from .error_handling import (
    handle_errors,
    ErrorCategory,
    ErrorSeverity,
    create_user_friendly_error,
    get_error_summary,
    log_recovery_attempt
)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å–∏—Å—Ç–µ–º—ã
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä MCP –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ MCP –∫–ª–∏–µ–Ω—Ç–∞—Ö
APP_ID = "offers-check-marketplaces"

# –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ FastMCP —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ MCP –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
mcp = FastMCP(APP_ID)

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞ –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤—Å–µ–º–∏ MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏
user_data_manager: Optional[UserDataManager] = None      # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è–º–∏
data_processor: Optional[DataProcessor] = None           # –û–±—Ä–∞–±–æ—Ç–∫–∞ Excel –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
database_manager: Optional[DatabaseManager] = None       # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ SQLite –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∏ —Ü–µ–Ω
search_engine: Optional[SearchEngine] = None             # –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö
statistics_generator: Optional[StatisticsGenerator] = None # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
marketplace_client: Optional[MarketplaceClient] = None   # –ö–ª–∏–µ–Ω—Ç –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞–º–∏
excel_tools: Optional[ExcelTools] = None                 # –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Excel —Ñ–∞–π–ª–∞–º–∏

async def initialize_components():
    """
    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã.
    
    –°–æ–∑–¥–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –≤—Å–µ—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç
    –∏—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ. –¢–∞–∫–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
    """
    global user_data_manager, data_processor, database_manager, search_engine, statistics_generator, marketplace_client, excel_tools
    
    try:
        logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã...")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏ –ø–µ—Ä–µ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
        logger.info("–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞...")
        is_valid, license_info = check_license()
        
        if not is_valid:
            error_msg = f"–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏—Ü–µ–Ω–∑–∏—è: {license_info.get('message', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')}"
            logger.error(error_msg)
            logger.error("–ü—Ä–æ–≥—Ä–∞–º–º–∞ –±—É–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏–∑-–∑–∞ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–π –ª–∏—Ü–µ–Ω–∑–∏–∏")
            print(f"–û–®–ò–ë–ö–ê: {error_msg}")
            print("–ü—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á.")
            sys.exit(1)
        
        logger.info("–õ–∏—Ü–µ–Ω–∑–∏—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é...")
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
        logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö...")
        user_data_manager = UserDataManager()
        user_data_manager.initialize_directories()
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö...")
        data_processor = DataProcessor()
        
        logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")
        database_manager = DatabaseManager(user_data_manager)
        await database_manager.init_database()
        
        logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤...")
        marketplace_client = MarketplaceClient()
        
        logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –¥–≤–∏–∂–∫–∞...")
        search_engine = SearchEngine()
        
        logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...")
        statistics_generator = StatisticsGenerator(database_manager)
        
        logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Excel –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤...")
        excel_tools = ExcelTools()
        
        logger.info("–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã")
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤: {e}")
        raise

# –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ Starlette –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è SSE —Ä–µ–∂–∏–º–∞
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏ –æ—Ç–ª–∞–¥–∫–∏ MCP —Å–µ—Ä–≤–µ—Ä–∞ —á–µ—Ä–µ–∑ HTTP
starlette_app = Starlette(routes=[Mount("/", app=mcp.sse_app())])

# System prompt for AI agent
# –í–ê–ñ–ù–û: –≠—Ç–æ—Ç –ø—Ä–æ–º—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ò–ò-–∞–≥–µ–Ω—Ç–∞
# –æ —Ç–æ–º, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–ª—É—á–∞—Ç—å —Ü–µ–Ω—ã —Å –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤. –ù–ï –£–î–ê–õ–Ø–ô–¢–ï –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
# –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–æ–≤–∞—Ä–æ–≤, –∞ –Ω–µ –±—Ä–∞—Ç—å —Ü–µ–Ω—ã –∏–∑ –ø–æ–∏—Å–∫–æ–≤–æ–π –≤—ã–¥–∞—á–∏!
SYSTEM_PROMPT = """
# MCP –°–µ—Ä–≤–µ—Ä "offers-check-marketplaces"

–í—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ —Å MCP —Å–µ—Ä–≤–µ—Ä–æ–º offers-check-marketplaces, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ 
–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ–Ω –Ω–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö. –≠—Ç–æ—Ç —Å–µ—Ä–≤–µ—Ä —è–≤–ª—è–µ—Ç—Å—è –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É—é—â–∏–º —Ü–µ–Ω—Ç—Ä–æ–º –¥–ª—è 
–∞–Ω–∞–ª–∏–∑–∞ —Ä—ã–Ω–æ—á–Ω—ã—Ö —Ü–µ–Ω –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤.

## –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ü–†–ê–í–ò–õ–ê –ü–û–õ–£–ß–ï–ù–ò–Ø –¶–ï–ù

‚ö†Ô∏è **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –¢–†–ï–ë–û–í–ê–ù–ò–ï**: –¶–µ–Ω—ã –î–û–õ–ñ–ù–´ –±—ã—Ç—å –ø–æ–ª—É—á–µ–Ω—ã –¢–û–õ–¨–ö–û —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö, –ù–ï –∏–∑ –ø–æ–∏—Å–∫–æ–≤–æ–π –≤—ã–¥–∞—á–∏!

### –ó–ê–ü–†–ï–©–ï–ù–û:
- ‚ùå –ë—Ä–∞—Ç—å —Ü–µ–Ω—ã –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ Google/Yandex
- ‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ü–µ–Ω—ã –∏–∑ –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Å–Ω–∏–ø–ø–µ—Ç–æ–≤
- ‚ùå –ü–æ–ª–∞–≥–∞—Ç—å—Å—è –Ω–∞ –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä—ã —Ü–µ–Ω
- ‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º

### –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:
- ‚úÖ –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç–æ–≤–∞—Ä–∞ –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ
- ‚úÖ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å HTML-—Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–æ–≤–∞—Ä–∞
- ‚úÖ –ò–∑–≤–ª–µ–∫–∞—Ç—å —Ü–µ–Ω—É –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–æ–≤–∞—Ä–∞
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞
- ‚úÖ –£—á–∏—Ç—ã–≤–∞—Ç—å —Å–∫–∏–¥–∫–∏, –∞–∫—Ü–∏–∏ –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –∏—Å–∫–æ–º–æ–º—É

### –ê–õ–ì–û–†–ò–¢–ú –ü–û–ò–°–ö–ê –¶–ï–ù:

1. **–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ**:
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ–∏—Å–∫ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞
   - –ù–∞–π–¥–∏—Ç–µ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ç–æ–≤–∞—Ä –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é/–∞—Ä—Ç–∏–∫—É–ª—É
   - –£–±–µ–¥–∏—Ç–µ—Å—å –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫

2. **–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç–æ–≤–∞—Ä–∞**:
   - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
   - –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ü–µ–Ω—ã –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –Ω–∞ —Å–∞–π—Ç–µ
   - –î–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

3. **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ü–µ–Ω—ã**:
   - –ù–∞–π–¥–∏—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ç–æ–≤–∞—Ä–∞
   - –£—á—Ç–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–∫–∏–¥–∫–∏ –∏ –∞–∫—Ü–∏–∏
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ç–æ–≤–∞—Ä–∞ –≤ –ø—Ä–æ–¥–∞–∂–µ
   - –ó–∞—Ñ–∏–∫—Å–∏—Ä—É–π—Ç–µ –≤–∞–ª—é—Ç—É —Ü–µ–Ω—ã

4. **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**:
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–∞–π–¥–µ–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∏—Å–∫–æ–º–æ–º—É
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—É–º–Ω–æ—Å—Ç—å —Ü–µ–Ω—ã (–Ω–µ –¥–æ–ª–∂–Ω–∞ –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç –æ–∂–∏–¥–∞–µ–º–æ–π)
   - –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏

### –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:

- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ MCP Playwright –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —Å–∞–π—Ç–∞–º
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç (JavaScript)
- –£—á–∏—Ç—ã–≤–∞–π—Ç–µ –∞–Ω—Ç–∏–±–æ—Ç-–∑–∞—â–∏—Ç—É —Å–∞–π—Ç–æ–≤
- –°–æ–±–ª—é–¥–∞–π—Ç–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
- –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã —Å—Ç—Ä–∞–Ω–∏—Ü –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

## –î–û–°–¢–£–ü–ù–´–ï –ò–ù–°–¢–†–£–ú–ï–ù–¢–´

### 1. get_product_details(product_code: float)
–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–µ –ø–æ –∫–æ–¥—É –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
- **–ü—Ä–∏–Ω–∏–º–∞–µ—Ç**: –∫–æ–¥ —Ç–æ–≤–∞—Ä–∞ (—á–∏—Å–ª–æ)
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**: –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–µ, —Ç–µ–∫—É—â–∏–µ —Ü–µ–Ω—ã, –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–µ –¥–µ–ª—å—Ç—ã
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
  - –í–∫–ª—é—á–∞–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é, –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
  - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ–Ω –º–µ–∂–¥—É –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞–º–∏
  - –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–µ –¥–µ–ª—å—Ç—ã –º–µ–∂–¥—É —Ü–µ–Ω–∞–º–∏
  - –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**:
```
get_product_details(195385.0)
```

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞**:
```json
{
  "status": "success",
  "product": {
    "code": 195385.0,
    "model_name": "–ü–æ–ª–æ—Ç–Ω–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –ë–Ø–ó–¨ –û–¢–ë–ï–õ–ï–ù–ù–ê–Ø –ì–û–°–¢, —Ä—É–ª–æ–Ω 1,5—Ö50 –º",
    "category": "–•–æ–∑—Ç–æ–≤–∞—Ä—ã –∏ –ø–æ—Å—É–¥–∞",
    "unit": "–º",
    "priority_1_source": "–ö–æ–º—É—Å",
    "priority_2_source": "–í—Å–µ–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã"
  },
  "prices": [
    {
      "marketplace": "komus.ru",
      "price": 1250.0,
      "currency": "RUB",
      "availability": "–≤ –Ω–∞–ª–∏—á–∏–∏",
      "product_url": "https://www.komus.ru/product/12345",
      "scraped_at": "2023-07-21T15:30:45"
    },
    {
      "marketplace": "vseinstrumenti.ru",
      "price": 1320.0,
      "currency": "RUB",
      "availability": "–≤ –Ω–∞–ª–∏—á–∏–∏",
      "product_url": "https://www.vseinstrumenti.ru/product/67890",
      "scraped_at": "2023-07-21T15:30:50"
    }
  ],
  "price_analysis": {
    "min_price": {
      "value": 1250.0,
      "marketplace": "komus.ru"
    },
    "max_price": {
      "value": 1320.0,
      "marketplace": "vseinstrumenti.ru"
    },
    "delta_percent": 5.6
  }
}
```

### 2. get_product_list()
–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö SKU —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
- **–ü—Ä–∏–Ω–∏–º–∞–µ—Ç**: –Ω–∏—á–µ–≥–æ
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**: —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ —Å –∏—Ö SKU –∏ –±–∞–∑–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
  - –í–∫–ª—é—á–∞–µ—Ç SKU, –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏, –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è
  - –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
  - –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–∏—Å–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**:
```
get_product_list()
```

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞**:
```json
{
  "status": "success",
  "products": [
    {
      "sku": 195385.0,
      "model_name": "–ü–æ–ª–æ—Ç–Ω–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –ë–Ø–ó–¨ –û–¢–ë–ï–õ–ï–ù–ù–ê–Ø –ì–û–°–¢, —Ä—É–ª–æ–Ω 1,5—Ö50 –º",
      "category": "–•–æ–∑—Ç–æ–≤–∞—Ä—ã –∏ –ø–æ—Å—É–¥–∞",
      "unit": "–º"
    },
    {
      "sku": 195386.0,
      "model_name": "–ë—É–º–∞–≥–∞ –æ—Ñ–∏—Å–Ω–∞—è –ê4 80–≥/–º2",
      "category": "–ö–∞–Ω—Ü–µ–ª—è—Ä—Å–∫–∏–µ —Ç–æ–≤–∞—Ä—ã",
      "unit": "–ø–∞—á–∫–∞"
    }
  ],
  "total_count": 150,
  "timestamp": "2023-07-21T16:45:30"
}
```

### 3. get_statistics()
–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –≤—Å–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º —Ç–æ–≤–∞—Ä–∞–º.
- **–ü—Ä–∏–Ω–∏–º–∞–µ—Ç**: –Ω–∏—á–µ–≥–æ
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**: –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º —Ç–æ–≤–∞—Ä–∞–º
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
  - –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
  - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ —Å —É—Å–ø–µ—à–Ω—ã–º–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è–º–∏ —Ü–µ–Ω
  - –°—Ä–µ–¥–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–µ –¥–µ–ª—å—Ç—ã —Ü–µ–Ω
  - –†–∞–∑–±–∏–≤–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º —Ç–æ–≤–∞—Ä–æ–≤
  - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**:
```
get_statistics()
```

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞**:
```json
{
  "status": "success",
  "statistics": {
    "total_products": 150,
    "products_with_prices": 132,
    "average_delta_percent": 7.8,
    "category_breakdown": {
      "–•–æ–∑—Ç–æ–≤–∞—Ä—ã –∏ –ø–æ—Å—É–¥–∞": 45,
      "–ö–∞–Ω—Ü–µ–ª—è—Ä—Å–∫–∏–µ —Ç–æ–≤–∞—Ä—ã": 38,
      "–û—Ñ–∏—Å–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞": 27,
      "–ú–µ–±–µ–ª—å": 22,
      "–ü—Ä–æ—á–µ–µ": 18
    },
    "marketplace_coverage": {
      "komus.ru": 128,
      "vseinstrumenti.ru": 95,
      "ozon.ru": 112,
      "wildberries.ru": 87,
      "officemag.ru": 76
    }
  },
  "timestamp": "2023-07-21T16:45:30"
}
```

## –ü–û–î–î–ï–†–ñ–ò–í–ê–ï–ú–´–ï –ú–ê–†–ö–ï–¢–ü–õ–ï–ô–°–´

### –û–°–ù–û–í–ù–´–ï –ú–ê–†–ö–ï–¢–ü–õ–ï–ô–°–´:

1. **komus.ru** (–ö–æ–º—É—Å) - –æ—Ñ–∏—Å–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –∏ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—è
   - URL –ø–æ–∏—Å–∫–∞: `https://www.komus.ru/search/?q={query}`
   - –°–µ–ª–µ–∫—Ç–æ—Ä —Ü–µ–Ω—ã: `.price-current, .product-price`
   - –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏: —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç–æ–≤–∞—Ä–∞

2. **vseinstrumenti.ru** (–í—Å–µ–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã) - –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
   - URL –ø–æ–∏—Å–∫–∞: `https://www.vseinstrumenti.ru/search/?what={query}`
   - –°–µ–ª–µ–∫—Ç–æ—Ä —Ü–µ–Ω—ã: `.ui-price-current, .product-buy__price`
   - –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏: –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–Ω

3. **ozon.ru** (–û–∑–æ–Ω) - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å
   - URL –ø–æ–∏—Å–∫–∞: `https://www.ozon.ru/search/?text={query}`
   - –°–µ–ª–µ–∫—Ç–æ—Ä —Ü–µ–Ω—ã: `[data-widget="webPrice"], .price-current`
   - –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏: —Å–∏–ª—å–Ω–∞—è –∞–Ω—Ç–∏–±–æ—Ç-–∑–∞—â–∏—Ç–∞, —Ç—Ä–µ–±—É–µ—Ç –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏

4. **wildberries.ru** (Wildberries) - —Ç–æ–≤–∞—Ä—ã —à–∏—Ä–æ–∫–æ–≥–æ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è
   - URL –ø–æ–∏—Å–∫–∞: `https://www.wildberries.ru/catalog/0/search.aspx?search={query}`
   - –°–µ–ª–µ–∫—Ç–æ—Ä —Ü–µ–Ω—ã: `.price-block__final-price, .product-page__price`
   - –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏: —Ü–µ–Ω—ã –º–æ–≥—É—Ç —Ä–∞–∑–ª–∏—á–∞—Ç—å—Å—è –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º

5. **officemag.ru** (–û—Ñ–∏—Å–º–∞–≥) - –æ—Ñ–∏—Å–Ω—ã–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏
   - URL –ø–æ–∏—Å–∫–∞: `https://www.officemag.ru/search/?q={query}`
   - –°–µ–ª–µ–∫—Ç–æ—Ä —Ü–µ–Ω—ã: `.price, .product-price__current`
   - –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏: –ø—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –Ω–∞–¥–µ–∂–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥

### –í–ê–ñ–ù–´–ï –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò:

- **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ User-Agent**: `Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36`
- **–°–æ–±–ª—é–¥–∞–π—Ç–µ –∑–∞–¥–µ—Ä–∂–∫–∏**: –º–∏–Ω–∏–º—É–º 2-3 —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
- **–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∫–∞–ø—á–∏**: –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ - —Å–æ–æ–±—â–∞–π—Ç–µ –æ–± –æ—à–∏–±–∫–µ
- **–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ cookies**: –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å —Å–µ—Å—Å–∏—è–º–∏

### –î–ï–¢–ê–õ–¨–ù–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –ú–ê–†–ö–ï–¢–ü–õ–ï–ô–°–ê–ú:

#### KOMUS.RU - –ü–æ—à–∞–≥–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º:
```
1. –û—Ç–∫—Ä—ã—Ç—å https://www.komus.ru
2. –ù–∞–π—Ç–∏ –ø–æ–∏—Å–∫–æ–≤—É—é —Å—Ç—Ä–æ–∫—É (–æ–±—ã—á–Ω–æ –≤ —à–∞–ø–∫–µ —Å–∞–π—Ç–∞)
3. –í–≤–µ—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
4. –î–æ–∂–¥–∞—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
5. –ö–ª–∏–∫–Ω—É—Ç—å –Ω–∞ –ü–ï–†–í–´–ô –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ç–æ–≤–∞—Ä
6. –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ç–æ–≤–∞—Ä–∞ –Ω–∞–π—Ç–∏ —Ü–µ–Ω—É (—Å–µ–ª–µ–∫—Ç–æ—Ä—ã: .price-current, .product-price)
7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Ç–æ–≤–∞—Ä–∞
8. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–æ–≤–∞—Ä–∞
```

#### VSEINSTRUMENTI.RU - –ü–æ—à–∞–≥–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º:
```
1. –û—Ç–∫—Ä—ã—Ç—å https://www.vseinstrumenti.ru
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫ –≤ —à–∞–ø–∫–µ —Å–∞–π—Ç–∞
3. –í–≤–µ—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
4. –í—ã–±—Ä–∞—Ç—å –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ç–æ–≤–∞—Ä –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
5. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç–æ–≤–∞—Ä–∞
6. –î–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ü–µ–Ω—ã (–º–æ–∂–µ—Ç –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏)
7. –ò–∑–≤–ª–µ—á—å —Ü–µ–Ω—É (.ui-price-current, .product-buy__price)
8. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–ª—è –∑–∞–∫–∞–∑–∞
```

#### OZON.RU - –û—Å–æ–±—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
```
‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –°–∏–ª—å–Ω–∞—è –∞–Ω—Ç–∏–±–æ—Ç-–∑–∞—â–∏—Ç–∞!
1. –û—Ç–∫—Ä—ã—Ç—å https://www.ozon.ru
2. –ü–æ–¥–æ–∂–¥–∞—Ç—å 3-5 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
3. –ù–∞–π—Ç–∏ –ø–æ–∏—Å–∫–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
4. –ú–µ–¥–ª–µ–Ω–Ω–æ –≤–≤–µ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å (–∏–º–∏—Ç–∞—Ü–∏—è —á–µ–ª–æ–≤–µ–∫–∞)
5. –ü–æ–¥–æ–∂–¥–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
6. –û—Å—Ç–æ—Ä–æ–∂–Ω–æ –∫–ª–∏–∫–Ω—É—Ç—å –Ω–∞ —Ç–æ–≤–∞—Ä
7. –î–æ–∂–¥–∞—Ç—å—Å—è –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–æ–≤–∞—Ä–∞
8. –ò–∑–≤–ª–µ—á—å —Ü–µ–Ω—É ([data-widget="webPrice"], .price-current)
```

#### WILDBERRIES.RU - –†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
```
1. –û—Ç–∫—Ä—ã—Ç—å https://www.wildberries.ru
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–≥–∏–æ–Ω (–º–æ–∂–µ—Ç –≤–ª–∏—è—Ç—å –Ω–∞ —Ü–µ–Ω—É)
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫
4. –í—ã–±—Ä–∞—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
5. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É —Ç–æ–≤–∞—Ä–∞
6. –£—á–µ—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–∫–∏–¥–∫–∏ –∏ –∞–∫—Ü–∏–∏
7. –ò–∑–≤–ª–µ—á—å —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ü–µ–Ω—É (.price-block__final-price)
```

#### OFFICEMAG.RU - –ü—Ä–æ—Å—Ç–æ–π –∞–ª–≥–æ—Ä–∏—Ç–º:
```
1. –û—Ç–∫—Ä—ã—Ç—å https://www.officemag.ru
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫
3. –í—ã–±—Ä–∞—Ç—å —Ç–æ–≤–∞—Ä
4. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç–æ–≤–∞—Ä–∞
5. –ò–∑–≤–ª–µ—á—å —Ü–µ–Ω—É (.price, .product-price__current)
6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –Ω–∞ —Å–∫–ª–∞–¥–µ
```

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–º—Ç–∞–º–∏, –ø—Ä–∞–≤–∏–ª–∞–º–∏ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –≤ —á–∞—Ç–µ.

## –†–ê–ë–û–ß–ò–ô –ü–†–û–¶–ï–°–°

### –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
- –°–∏—Å—Ç–µ–º–∞ —á–∏—Ç–∞–µ—Ç –≤—Ö–æ–¥–Ω–æ–π Excel —Ñ–∞–π–ª `–¢–∞–±–ª–∏—Ü–∞ –Ω–∞ –≤—Ö–æ–¥.xlsx`
- –î–∞–Ω–Ω—ã–µ –ø–∞—Ä—Å—è—Ç—Å—è –≤ JSON —Ñ–æ—Ä–º–∞—Ç —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–æ–ª–µ–π
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ SQLite –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### –≠—Ç–∞–ø 2: –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ –ù–ê –ú–ê–†–ö–ï–¢–ü–õ–ï–ô–°–ê–•
‚ö†Ô∏è **–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û**: –ü–æ–∏—Å–∫ —Ü–µ–Ω –¢–û–õ–¨–ö–û –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∞–π—Ç–∞—Ö –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤!

**–ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–∏—Å–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞:**

1. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤** –∏–∑ Excel —Ñ–∞–π–ª–∞
2. **–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å** —á–µ—Ä–µ–∑ MCP Playwright:
   ```
   - –û—Ç–∫—Ä—ã—Ç—å –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ–∏—Å–∫ —Å–∞–π—Ç–∞
   - –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Google/Yandex –ø–æ–∏—Å–∫!
   ```

3. **–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∞–π—Ç–µ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞**:
   ```
   - –í–≤–µ—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –≤ –ø–æ–∏—Å–∫–æ–≤—É—é —Å—Ç—Ä–æ–∫—É —Å–∞–π—Ç–∞
   - –ù–∞–π—Ç–∏ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ç–æ–≤–∞—Ä –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
   ```

4. **–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç–æ–≤–∞—Ä–∞**:
   ```
   - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∫–ª–∏–∫–Ω—É—Ç—å –Ω–∞ —Ç–æ–≤–∞—Ä –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
   - –î–æ–∂–¥–∞—Ç—å—Å—è –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–æ–≤–∞—Ä–∞
   - –ù–ï –±—Ä–∞—Ç—å —Ü–µ–Ω—É –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞!
   ```

5. **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–æ—á–Ω–æ–π —Ü–µ–Ω—ã**:
   ```
   - –ù–∞–π—Ç–∏ –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ç–æ–≤–∞—Ä–∞
   - –£—á–µ—Å—Ç—å —Å–∫–∏–¥–∫–∏ –∏ –∞–∫—Ü–∏–∏
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Ç–æ–≤–∞—Ä–∞
   - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–æ–≤–∞—Ä–∞
   ```

6. **–í–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ**:
   ```
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑—É–º–Ω–æ—Å—Ç—å —Ü–µ–Ω—ã
   - –£–±–µ–¥–∏—Ç—å—Å—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Ç–æ–≤–∞—Ä–∞
   - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
   ```

### –≠—Ç–∞–ø 3: –ê–Ω–∞–ª–∏–∑ –∏ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `get_product_details` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- –°–∏—Å—Ç–µ–º–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–µ –¥–µ–ª—å—Ç—ã –º–µ–∂–¥—É —Ü–µ–Ω–∞–º–∏
- –û–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∫–∞—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### –≠—Ç–∞–ø 4: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –æ—Ç—á–µ—Ç—ã
- `get_statistics` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ–±—â—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –≤—ã—Ö–æ–¥–Ω–æ–π Excel —Ñ–∞–π–ª `data/–¢–∞–±–ª–∏—Ü–∞ –Ω–∞ –≤—ã—Ö–æ–¥ (–æ—Ç—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è).xlsx`
- –§–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–ª—é—Å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ü–µ–Ω—ã –∏ —Ä–∞—Å—á–µ—Ç—ã
- –í–∫–ª—é—á–∞—é—Ç—Å—è —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏

## –ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –ò –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û–ì–û –ü–û–ò–°–ö–ê

### ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –ù–ï –î–ï–õ–ê–ô–¢–ï –¢–ê–ö:
```
1. –ü–æ–∏—Å–∫ –≤ Google: "–ü–æ–ª–æ—Ç–Ω–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –ë–Ø–ó–¨ site:komus.ru"
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã –∏–∑ –ø–æ–∏—Å–∫–æ–≤–æ–π –≤—ã–¥–∞—á–∏: "1250 —Ä—É–±."
3. –ü–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ –∏–∑ Google –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏
4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä–æ–≤ —Ü–µ–Ω —Ç–∏–ø–∞ –Ø–Ω–¥–µ–∫—Å.–ú–∞—Ä–∫–µ—Ç
```

### ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –î–ï–õ–ê–ô–¢–ï –¢–ê–ö:
```
1. –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ komus.ru
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ–∏—Å–∫–∞ –Ω–∞ —Å–∞–π—Ç–µ: –ø–æ–∏—Å–∫ "–ü–æ–ª–æ—Ç–Ω–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –ë–Ø–ó–¨"
3. –ö–ª–∏–∫ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
4. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ü–µ–Ω—ã —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–æ–≤–∞—Ä–∞: "1250,00 ‚ÇΩ"
5. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
```

### –ü–†–ò–ú–ï–† –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –ê–õ–ì–û–†–ò–¢–ú–ê:
```python
# –ü—Å–µ–≤–¥–æ–∫–æ–¥ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
1. browser.navigate("https://www.komus.ru")
2. search_input = browser.find_element("input[name='q']")
3. search_input.type("–ü–æ–ª–æ—Ç–Ω–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –ë–Ø–ó–¨ –û–¢–ë–ï–õ–ï–ù–ù–ê–Ø")
4. search_input.press("Enter")
5. # –ñ–¥–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
6. first_product = browser.find_element(".product-item:first-child a")
7. product_url = first_product.get_attribute("href")
8. browser.navigate(product_url)  # –ü–ï–†–ï–•–û–î–ò–ú –ù–ê –°–¢–†–ê–ù–ò–¶–£ –¢–û–í–ê–†–ê!
9. # –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–æ–≤–∞—Ä–∞
10. price = browser.find_element(".price-current").text
11. availability = browser.find_element(".availability").text
12. # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
```

## –û–°–û–ë–ï–ù–ù–û–°–¢–ò –ê–†–•–ò–¢–ï–ö–¢–£–†–´

- **–ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É—é—â–∞—è —Ä–æ–ª—å**: –°–µ—Ä–≤–µ—Ä –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤–µ–±-—Å–∫—Ä–∞–ø–∏–Ω–≥ –Ω–∞–ø—Ä—è–º—É—é, –∞ –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É —á–µ—Ä–µ–∑ MCP Playwright
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: Graceful degradation –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤
- **Rate limiting**: –°–æ–±–ª—é–¥–µ–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π —Å–∫–æ—Ä–æ—Å—Ç–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞
- **–ö–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö**: –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –∏—Å–∫–æ–º–æ–º—É
- **–¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ URL —Å—Ç—Ä–∞–Ω–∏—Ü —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏

## –§–û–†–ú–ê–¢–´ –î–ê–ù–ù–´–•

### –í—Ö–æ–¥–Ω–æ–π Excel
–°–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª—è —Å —Å–∏–º–≤–æ–ª–∞–º–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞ —Å—Ç—Ä–æ–∫:
- "–ö–æ–¥\n–º–æ–¥–µ–ª–∏" - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ —Ç–æ–≤–∞—Ä–∞
- "model_name" - –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ —Ç–æ–≤–∞—Ä–∞
- "–ö–∞—Ç–µ–≥–æ—Ä–∏—è" - –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞
- "–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è" - –µ–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
- "–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç \n1 –ò—Å—Ç–æ—á–Ω–∏–∫–∏" - –ø–µ—Ä–≤–∏—á–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø–æ–∏—Å–∫–∞
- "–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç \n2 –ò—Å—Ç–æ—á–Ω–∏–∫–∏" - –≤—Ç–æ—Ä–∏—á–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø–æ–∏—Å–∫–∞
- "–¶–µ–Ω–∞ –ø–æ–∑–∏—Ü–∏–∏\n–ú–ü c –ù–î–°" - –ø—É—Å—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
- "–¶–µ–Ω–∞ –ø–æ–∑–∏—Ü–∏–∏\nB2C c –ù–î–°" - –ø—É—Å—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
- "–î–µ–ª—å—Ç–∞ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö" - –ø—É—Å—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
- "–°—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫" - –ø—É—Å—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
- "–¶–µ–Ω–∞ 2 –ø–æ–∑–∏—Ü–∏–∏\nB2C c –ù–î–°" - –ø—É—Å—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è

### –í—ã—Ö–æ–¥–Ω–æ–π Excel
–î–æ–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏:
- "–¶–µ–Ω–∞ –ø–æ–∑–∏—Ü–∏–∏\n–ú–ü c –ù–î–°" - —Ü–µ–Ω–∞ –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ
- "–¶–µ–Ω–∞ –ø–æ–∑–∏—Ü–∏–∏\nB2C c –ù–î–°" - B2C —Ü–µ–Ω–∞
- "–î–µ–ª—å—Ç–∞ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö" - –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Ä–∞–∑–Ω–∏—Ü–∞ —Ü–µ–Ω
- "–°—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫" - URL —Ç–æ–≤–∞—Ä–∞ –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ
- "–¶–µ–Ω–∞ 2 –ø–æ–∑–∏—Ü–∏–∏\nB2C c –ù–î–°" - —Ü–µ–Ω–∞ –Ω–∞ –≤—Ç–æ—Ä–æ–º –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ

## –ö–û–ù–¢–†–û–õ–¨ –ö–ê–ß–ï–°–¢–í–ê –î–ê–ù–ù–´–•

### –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –ü–†–û–í–ï–†–ö–ò –ü–ï–†–ï–î –°–û–•–†–ê–ù–ï–ù–ò–ï–ú –¶–ï–ù–´:

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ç–æ–≤–∞—Ä–∞**:
   - –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
   - –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞ –¥–æ–ª–∂–Ω–∞ –ø—Ä–∏–º–µ—Ä–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –æ–∂–∏–¥–∞–µ–º–æ–π
   - –ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è –¥–æ–ª–∂–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—Ç—å (—à—Ç, –º, –∫–≥ –∏ —Ç.–¥.)

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—É–º–Ω–æ—Å—Ç–∏ —Ü–µ–Ω—ã**:
   - –¶–µ–Ω–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω—É–ª–µ–≤–æ–π –∏–ª–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π
   - –¶–µ–Ω–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç –æ–∂–∏–¥–∞–µ–º–æ–π (–±–æ–ª–µ–µ —á–µ–º –≤ 10 —Ä–∞–∑)
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞–ª—é—Ç—É (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å RUB –¥–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤)

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–∞**:
   - –¢–æ–≤–∞—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –Ω–∞–ª–∏—á–∏–∏ –∏–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∑–∞–∫–∞–∑–∞
   - –ù–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ü–µ–Ω—ã —Ç–æ–≤–∞—Ä–æ–≤ "–Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏" –∏–ª–∏ "—Å–Ω—è—Ç —Å –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞"

4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö**:
   - URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–æ–≤–∞—Ä–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–∞–±–æ—á–∏–º
   - –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
   - –¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ç–µ–∫—É—â–µ–π, –∞ –Ω–µ –∞—Ä—Ö–∏–≤–Ω–æ–π

### –ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–´–• –ò –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–• –î–ê–ù–ù–´–•:

#### ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
```json
{
  "marketplace": "komus.ru",
  "price": 1250.0,
  "currency": "RUB",
  "availability": "–≤ –Ω–∞–ª–∏—á–∏–∏",
  "product_url": "https://www.komus.ru/catalog/office/paper/12345",
  "product_match_confidence": "high"
}
```

#### ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
```json
{
  "marketplace": "komus.ru",
  "price": 0.0,  // –ù—É–ª–µ–≤–∞—è —Ü–µ–Ω–∞
  "currency": "USD",  // –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –≤–∞–ª—é—Ç–∞
  "availability": "–Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏",  // –¢–æ–≤–∞—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
  "product_url": "https://google.com/search?q=...",  // –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–∏—Å–∫
  "product_match_confidence": "low"  // –ù–∏–∑–∫–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
}
```

## –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–ê–Ø –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–°–¢–¨ –î–ï–ô–°–¢–í–ò–ô

1. –ü–æ–ª—É—á–∏—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–∞—Ö —á–µ—Ä–µ–∑ `get_product_details`
2. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —á–µ—Ä–µ–∑ `get_statistics`
3. –î–ª—è –ø–æ–∏—Å–∫–∞ –Ω–æ–≤—ã—Ö —Ü–µ–Ω –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ MCP Playwright —Å —Å–æ–±–ª—é–¥–µ–Ω–∏–µ–º –≤—Å–µ—Ö –ø—Ä–∞–≤–∏–ª
4. –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ü–µ–Ω—ã —á–µ—Ä–µ–∑ `save_product_prices` —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞
5. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–∏—Å–∫ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤

## –ü–†–ò–ú–ï–†–´ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø

### –ü—Ä–∏–º–µ—Ä 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–µ
```
get_product_details(195385.0)
```

### –ü—Ä–∏–º–µ—Ä 2: –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
```
get_statistics()
```

## EXCEL –ò–ù–°–¢–†–£–ú–ï–ù–¢–´

### 1. parse_excel_file(file_path: str, sheet_name: Optional[str] = None, header_row: int = 0, max_rows: Optional[int] = None)
–ü–∞—Ä—Å–∏–Ω–≥ Excel —Ñ–∞–π–ª–∞ –∏ –≤–æ–∑–≤—Ä–∞—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
- **–ü—Ä–∏–Ω–∏–º–∞–µ—Ç**: –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É, –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ), –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**: —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Excel —Ñ–∞–π–ª–∞
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ª–∏—Å—Ç–æ–≤ Excel —Ñ–∞–π–ª–∞
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
  - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —á–∏—Ç–∞–µ–º—ã—Ö —Å—Ç—Ä–æ–∫

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**:
```
parse_excel_file("data/input.xlsx", sheet_name="–î–∞–Ω–Ω—ã–µ", header_row=0, max_rows=100)
```

### 2. get_excel_info(file_path: str)
–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ Excel —Ñ–∞–π–ª–∞ –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.
- **–ü—Ä–∏–Ω–∏–º–∞–µ—Ç**: –ø—É—Ç—å –∫ Excel —Ñ–∞–π–ª—É
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**: –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ª–∏—Å—Ç–∞—Ö, –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö, —Ä–∞–∑–º–µ—Ä–∞—Ö
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
  - –ë—ã—Å—Ç—Ä–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞
  - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Å–µ—Ö –ª–∏—Å—Ç–∞—Ö –≤ —Ñ–∞–π–ª–µ
  - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∏ —Ä–∞–∑–º–µ—Ä–æ–≤ –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**:
```
get_excel_info("data/input.xlsx")
```

### 3. export_to_excel(data: List[Dict], file_path: str, sheet_name: str = "Data", include_index: bool = False, auto_adjust_columns: bool = True, apply_formatting: bool = True)
–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ Excel —Ñ–∞–π–ª —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º.
- **–ü—Ä–∏–Ω–∏–º–∞–µ—Ç**: –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞, –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**: —Ä–µ–∑—É–ª—å—Ç–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
  - –ü–æ–¥–≥–æ–Ω–∫–∞ —à–∏—Ä–∏–Ω—ã –∫–æ–ª–æ–Ω–æ–∫
  - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π –∫ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º
  - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —ç–∫—Å–ø–æ—Ä—Ç–∞

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**:
```
export_to_excel(data, "data/output.xlsx", sheet_name="–†–µ–∑—É–ª—å—Ç–∞—Ç—ã", apply_formatting=True)
```

### 4. filter_excel_data(data: List[Dict], filters: Dict)
–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö Excel –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º.
- **–ü—Ä–∏–Ω–∏–º–∞–µ—Ç**: –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏, –∫—Ä–∏—Ç–µ—Ä–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**: –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–ª–æ–∂–Ω—ã—Ö –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
  - –ß–∏—Å–ª–æ–≤—ã–µ –∏ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
  - –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —É—Å–ª–æ–≤–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**:
```
filter_excel_data(data, {"–ö–∞—Ç–µ–≥–æ—Ä–∏—è": "–•–æ–∑—Ç–æ–≤–∞—Ä—ã", "–¶–µ–Ω–∞": {"greater_than": 1000}})
```

### 5. transform_excel_data(data: List[Dict], transformations: Dict)
–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö Excel —Å–æ–≥–ª–∞—Å–Ω–æ –∑–∞–¥–∞–Ω–Ω—ã–º –ø—Ä–∞–≤–∏–ª–∞–º.
- **–ü—Ä–∏–Ω–∏–º–∞–µ—Ç**: –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø—Ä–∞–≤–∏–ª–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**: —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
  - –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
  - –°—Ç—Ä–æ–∫–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–∑–∞–º–µ–Ω–∞, –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞)
  - –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —á–∏—Å–ª–∞–º–∏
  - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ø—Ä–∞–≤–∏–ª–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**:
```
transform_excel_data(data, {"model_name": {"to_upper": true}, "price": {"multiply": 1.2}})
```

### 6. parse_excel_and_save_to_database(file_path: str, sheet_name: Optional[str] = None, header_row: int = 0, start_row: Optional[int] = None, max_rows: Optional[int] = None)
**–£–õ–£–ß–®–ï–ù–ù–´–ô –ò–ù–°–¢–†–£–ú–ï–ù–¢** - –ü–∞—Ä—Å–∏–Ω–≥ Excel —Ñ–∞–π–ª–∞ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤.
- **–ü—Ä–∏–Ω–∏–º–∞–µ—Ç**: –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É, –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ), –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, –Ω–∞—á–∞–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**: —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∞—Ä—Å–∏—Ç Excel —Ñ–∞–π–ª —Å —Ç–æ–≤–∞—Ä–∞–º–∏
  - **–ù–û–í–û–ï**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —á—Ç–µ–Ω–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ —Å—Ç—Ä–æ–∫ (start_row, max_rows)
  - **–ù–û–í–û–ï**: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∂–∞—Ç—å –±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã —á–∞—Å—Ç—è–º–∏
  - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö SQLite
  - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–æ–≤–∞—Ä—ã –ø—Ä–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏ –∫–æ–¥–∞
  - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç Excel —Å –ø–æ–ª—è–º–∏: "–ö–æ–¥\n–º–æ–¥–µ–ª–∏", "model_name", "–ö–∞—Ç–µ–≥–æ—Ä–∏—è", "–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è", "–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç \n1 –ò—Å—Ç–æ—á–Ω–∏–∫–∏", "–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç \n2 –ò—Å—Ç–æ—á–Ω–∏–∫–∏"
  - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–∞—Ö

**–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**:
```
# –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã
parse_excel_and_save_to_database("data/–¢–∞–±–ª–∏—Ü–∞ –Ω–∞ –≤—Ö–æ–¥.xlsx", sheet_name="–õ–∏—Å—Ç1", header_row=0)

# –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä—ã —Å 151 –ø–æ 300 —Å—Ç—Ä–æ–∫—É
parse_excel_and_save_to_database("data/–¢–∞–±–ª–∏—Ü–∞ –Ω–∞ –≤—Ö–æ–¥.xlsx", sheet_name="–õ–∏—Å—Ç1", header_row=0, start_row=150, max_rows=150)

# –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ 100 —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞—á–∏–Ω–∞—è —Å 301 —Å—Ç—Ä–æ–∫–∏
parse_excel_and_save_to_database("data/–¢–∞–±–ª–∏—Ü–∞ –Ω–∞ –≤—Ö–æ–¥.xlsx", sheet_name="–õ–∏—Å—Ç1", header_row=0, start_row=300, max_rows=100)
```

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞**:
```json
{
  "status": "success",
  "message": "–£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ 150 —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ Excel —Ñ–∞–π–ª–∞",
  "file_path": "data/–¢–∞–±–ª–∏—Ü–∞ –Ω–∞ –≤—Ö–æ–¥.xlsx",
  "start_row": 150,
  "rows_requested": 150,
  "total_rows_parsed": 150,
  "products_created": 120,
  "products_updated": 30,
  "total_processed": 150,
  "products_saved": [
    {
      "code": 195385.0,
      "model_name": "–ü–æ–ª–æ—Ç–Ω–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –ë–Ø–ó–¨ –û–¢–ë–ï–õ–ï–ù–ù–ê–Ø –ì–û–°–¢",
      "action": "created",
      "id": 1
    }
  ],
  "parse_info": {
    "sheet_name": "–õ–∏—Å—Ç1",
    "columns": ["–ö–æ–¥\n–º–æ–¥–µ–ª–∏", "model_name", "–ö–∞—Ç–µ–≥–æ—Ä–∏—è"],
    "available_sheets": ["–õ–∏—Å—Ç1", "–õ–∏—Å—Ç2"],
    "data_range": "—Å—Ç—Ä–æ–∫–∏ 150-299"
  },
  "timestamp": "2023-07-21T15:30:45"
}
```

## –†–ê–ë–û–ß–ò–ô –ü–†–û–¶–ï–°–° –° EXCEL

### –ë–´–°–¢–†–´–ô –°–ü–û–°–û–ë (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)
**–î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ Excel –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö:**
1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `parse_excel_and_save_to_database` –¥–ª—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
2. –§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã –∏ –æ–±–Ω–æ–≤–∏—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
3. –ü–æ–ª—É—á–∏—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º —Ç–æ–≤–∞—Ä–∞–º

### –ü–û–®–ê–ì–û–í–´–ô –°–ü–û–°–û–ë (–î–õ–Ø –°–õ–û–ñ–ù–û–ô –û–ë–†–ê–ë–û–¢–ö–ò)

#### –≠—Ç–∞–ø 1: –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ñ–∞–π–ª–∞
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `get_excel_info` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ Excel —Ñ–∞–π–ª–∞
- –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –ª–∏—Å—Ç—ã, –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ —Ä–∞–∑–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö

#### –≠—Ç–∞–ø 2: –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `parse_excel_file` –¥–ª—è —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ Excel —Ñ–∞–π–ª–∞
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —á—Ç–µ–Ω–∏—è (–ª–∏—Å—Ç, –∑–∞–≥–æ–ª–æ–≤–∫–∏, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫)

#### –≠—Ç–∞–ø 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–∏–º–µ–Ω—è–π—Ç–µ `filter_excel_data` –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `transform_excel_data` –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

#### –≠—Ç–∞–ø 4: –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –ø–æ–º–æ—â—å—é `export_to_excel`
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å—Ç–∏–ª–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è

### –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° –û–°–ù–û–í–ù–û–ô –°–ò–°–¢–ï–ú–û–ô
–ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ `parse_excel_and_save_to_database`:
1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `get_product_list` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤
2. –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ü–µ–Ω—ã —á–µ—Ä–µ–∑ `save_product_prices`
3. –ü–æ–ª—É—á–∞–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —á–µ—Ä–µ–∑ `get_statistics`

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–æ–≤.

---
## –†–ï–ó–Æ–ú–ï –ö–õ–Æ–ß–ï–í–´–• –¢–†–ï–ë–û–í–ê–ù–ò–ô:

üî¥ **–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û**: 
- –ù–ï –±—Ä–∞—Ç—å —Ü–µ–Ω—ã –∏–∑ Google/Yandex –ø–æ–∏—Å–∫–∞
- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –∏—Å–∫–æ–º–æ–º—É
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å URL —Å—Ç—Ä–∞–Ω–∏—Ü —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏

üü° **–¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø**:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MCP Playwright –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
- –°–æ–±–ª—é–¥–∞—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (2-3 —Å–µ–∫)
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∞–Ω—Ç–∏–±–æ—Ç-–∑–∞—â–∏—Ç—É
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º

üü¢ **–†–ï–ó–£–õ–¨–¢–ê–¢**: –¢–æ—á–Ω—ã–µ, –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü —Ç–æ–≤–∞—Ä–æ–≤ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤
---
"""

@mcp.prompt("system")
def get_system_prompt() -> str:
    """Get system prompt for AI agent"""
    return SYSTEM_PROMPT

# MCP Tools implementations

@handle_errors(
    category=ErrorCategory.DATABASE,
    severity=ErrorSeverity.MEDIUM,
    component="mcp_server",
    recovery_action="–í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"
)
@mcp.tool()
async def get_product_details(product_code: float, ctx: Context = None) -> dict:
    """
    Get detailed information about a product including price comparison
    
    Args:
        product_code: Unique product code from the database
        ctx: MCP context object
        
    Returns:
        Dictionary with detailed product information and price data
    """
    from .error_handling import (
        create_user_friendly_error,
        ValidationError,
        error_handler,
        ErrorCategory,
        ErrorSeverity,
        log_recovery_attempt
    )
    
    logger.info(f"–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–µ —Å –∫–æ–¥–æ–º: {product_code}")
    
    try:
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        if not isinstance(product_code, (int, float)):
            error = ValidationError("–ö–æ–¥ —Ç–æ–≤–∞—Ä–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º", field="product_code", value=product_code)
            return create_user_friendly_error(error, "–ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–µ")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        if database_manager is None:
            logger.error("–ú–µ–Ω–µ–¥–∂–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            return {
                "status": "error",
                "message": "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞: –º–µ–Ω–µ–¥–∂–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω",
                "error_code": "COMPONENT_NOT_INITIALIZED",
                "user_message": "–°–∏—Å—Ç–µ–º–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ",
                "recoverable": True,
                "retry_suggested": True
            }
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–¥—É–∫—Ç–µ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        product = await database_manager.get_product_by_code(product_code)
        
        if not product:
            logger.warning(f"–ü—Ä–æ–¥—É–∫—Ç —Å –∫–æ–¥–æ–º {product_code} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö")
            log_recovery_attempt(
                component="server",
                action=f"–ü—Ä–æ–¥—É–∫—Ç —Å –∫–æ–¥–æ–º {product_code} –Ω–µ –Ω–∞–π–¥–µ–Ω",
                success=False
            )
            return {
                "status": "not_found",
                "message": f"–ü—Ä–æ–¥—É–∫—Ç —Å –∫–æ–¥–æ–º {product_code} –Ω–µ –Ω–∞–π–¥–µ–Ω",
                "error_code": "PRODUCT_NOT_FOUND",
                "user_message": "–¢–æ–≤–∞—Ä —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –∫–æ–¥–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö",
                "recoverable": False,
                "retry_suggested": False
            }
        
        # –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—ã –ø—Ä–æ–¥—É–∫—Ç–∞ —Å —Ä–∞–∑–Ω—ã—Ö –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤
        prices = await database_manager.get_product_prices(product["id"])
        
        # –ï—Å–ª–∏ —Ü–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–¥—É–∫—Ç–µ
        if not prices:
            logger.info(f"–î–ª—è –ø—Ä–æ–¥—É–∫—Ç–∞ —Å –∫–æ–¥–æ–º {product_code} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã —Ü–µ–Ω—ã")
            log_recovery_attempt(
                component="server",
                action="–í–æ–∑–≤—Ä–∞—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–µ –±–µ–∑ —Ü–µ–Ω",
                success=True
            )
            return {
                "status": "success",
                "product": {
                    "code": product["code"],
                    "model_name": product["model_name"],
                    "category": product["category"],
                    "unit": product["unit"],
                    "priority_1_source": product["priority_1_source"],
                    "priority_2_source": product["priority_2_source"]
                },
                "prices": [],
                "price_analysis": {
                    "min_price": None,
                    "max_price": None,
                    "delta_percent": None
                },
                "message": "–î–ª—è –¥–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã —Ü–µ–Ω—ã –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö"
            }
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ü–µ–Ω—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∏ –¥–µ–ª—å—Ç—ã
        valid_prices = [p for p in prices if p["price"] is not None and p["price"] > 0]
        
        price_analysis = {
            "min_price": None,
            "max_price": None,
            "delta_percent": None
        }
        
        if valid_prices:
            # –ù–∞—Ö–æ–¥–∏–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Ü–µ–Ω—É
            min_price_item = min(valid_prices, key=lambda x: x["price"])
            price_analysis["min_price"] = {
                "value": min_price_item["price"],
                "marketplace": min_price_item["marketplace"]
            }
            
            # –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Ü–µ–Ω—É
            max_price_item = max(valid_prices, key=lambda x: x["price"])
            price_analysis["max_price"] = {
                "value": max_price_item["price"],
                "marketplace": max_price_item["marketplace"]
            }
            
            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—É—é –¥–µ–ª—å—Ç—É –º–µ–∂–¥—É –º–∏–Ω –∏ –º–∞–∫—Å —Ü–µ–Ω–∞–º–∏
            if min_price_item["price"] > 0:
                delta = ((max_price_item["price"] - min_price_item["price"]) / min_price_item["price"]) * 100
                price_analysis["delta_percent"] = round(delta, 2)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç
        response = {
            "status": "success",
            "product": {
                "code": product["code"],
                "model_name": product["model_name"],
                "category": product["category"],
                "unit": product["unit"],
                "priority_1_source": product["priority_1_source"],
                "priority_2_source": product["priority_2_source"]
            },
            "prices": prices,
            "price_analysis": price_analysis
        }
        
        logger.info(f"–£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ —Å –∫–æ–¥–æ–º {product_code}")
        log_recovery_attempt(
            component="server",
            action=f"–£—Å–ø–µ—à–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–µ {product_code}",
            success=True
        )
        return response
        
    except Exception as e:
        error_handler.log_error(
            error=e,
            category=ErrorCategory.DATABASE,
            severity=ErrorSeverity.HIGH,
            component="server",
            details={"tool": "get_product_details", "product_code": product_code},
            recovery_action="–í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"
        )
        return create_user_friendly_error(e, "–ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–µ")

@handle_errors(
    category=ErrorCategory.DATABASE,
    severity=ErrorSeverity.MEDIUM,
    component="mcp_server",
    recovery_action="–í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"
)
@mcp.tool()
async def get_product_list(offset: int = 0, limit: int = 150, filter_status: str = "all", ctx: Context = None) -> dict:
    """
    Get list of all product SKUs from the database with pagination support
    
    Args:
        offset: Starting position (0-based index) for pagination
        limit: Maximum number of products to return (default: 150, if None, returns all from offset)
        filter_status: Filter by processing status ("all", "processed", "not_processed")
        ctx: MCP context object
        
    Returns:
        Dictionary with list of product codes (SKUs) and basic info with pagination info
        Each product includes processing status (processed/not_processed)
        
    Usage Examples:
        - Get first 150 products (recommended): offset=0, limit=150
        - Get products 151-300: offset=150, limit=150
        - Get products 301-450: offset=300, limit=150
        - Get all products from position 100: offset=99, limit=None
        - Get all products: offset=0, limit=None
        - Get only processed products: filter_status="processed"
        - Get only unprocessed products: filter_status="not_processed"
        
    Recommendation: Use limit=150 for optimal performance and memory usage
    """
    from .error_handling import (
        create_user_friendly_error,
        error_handler,
        ErrorCategory,
        ErrorSeverity,
        log_recovery_attempt
    )
    
    logger.info("–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ SKU —Ç–æ–≤–∞—Ä–æ–≤")
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        if database_manager is None:
            logger.error("–ú–µ–Ω–µ–¥–∂–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            return {
                "status": "error",
                "message": "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞: –º–µ–Ω–µ–¥–∂–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω",
                "error_code": "COMPONENT_NOT_INITIALIZED",
                "user_message": "–°–∏—Å—Ç–µ–º–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ",
                "recoverable": True,
                "retry_suggested": True
            }
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        products = await database_manager.get_all_products()
        
        if not products:
            logger.info("–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤")
            return {
                "status": "no_data",
                "message": "–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤",
                "user_message": "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–≤–∞—Ä–æ–≤",
                "products": [],
                "total_count": 0,
                "recoverable": True,
                "retry_suggested": False
            }
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ SKU —Å –±–∞–∑–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏ —Å—Ç–∞—Ç—É—Å–æ–º –æ–±—Ä–∞–±–æ—Ç–∫–∏
        product_list = []
        for product in products:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É —Ç–æ–≤–∞—Ä–∞ —Ü–µ–Ω—ã (–æ–±—Ä–∞–±–æ—Ç–∞–Ω –ª–∏ –æ–Ω)
            has_prices = await database_manager.has_product_prices(product["id"])
            
            product_info = {
                "sku": product["code"],
                "model_name": product["model_name"],
                "category": product["category"],
                "unit": product["unit"],
                "processed": has_prices,
                "status": "processed" if has_prices else "not_processed"
            }
            
            # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É –æ–±—Ä–∞–±–æ—Ç–∫–∏
            if filter_status == "all":
                product_list.append(product_info)
            elif filter_status == "processed" and has_prices:
                product_list.append(product_info)
            elif filter_status == "not_processed" and not has_prices:
                product_list.append(product_info)
        
        total_count = len(product_list)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
        if offset < 0:
            offset = 0
        
        if offset >= total_count:
            logger.info(f"Offset {offset} –ø—Ä–µ–≤—ã—à–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ {total_count}")
            return {
                "status": "success",
                "products": [],
                "total_count": total_count,
                "offset": offset,
                "limit": limit,
                "filter_status": filter_status,
                "returned_count": 0,
                "has_more": False,
                "timestamp": datetime.now().isoformat()
            }
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ä–µ–∑ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
        if limit is None:
            paginated_products = product_list[offset:]
        else:
            if limit <= 0:
                limit = 150  # –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            paginated_products = product_list[offset:offset + limit]
        
        returned_count = len(paginated_products)
        has_more = (offset + returned_count) < total_count
        
        logger.info(f"–ü–æ–ª—É—á–µ–Ω —Å–ø–∏—Å–æ–∫ –∏–∑ {returned_count} —Ç–æ–≤–∞—Ä–æ–≤ (offset: {offset}, limit: {limit}, total: {total_count})")
        
        log_recovery_attempt(
            component="server",
            action=f"–£—Å–ø–µ—à–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ {returned_count} —Ç–æ–≤–∞—Ä–æ–≤ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π",
            success=True
        )
        
        return {
            "status": "success",
            "products": paginated_products,
            "total_count": total_count,
            "offset": offset,
            "limit": limit,
            "filter_status": filter_status,
            "returned_count": returned_count,
            "has_more": has_more,
            "timestamp": datetime.now().isoformat()
        }
        
    except Exception as e:
        error_handler.log_error(
            error=e,
            category=ErrorCategory.DATABASE,
            severity=ErrorSeverity.HIGH,
            component="server",
            details={"tool": "get_product_list"},
            recovery_action="–í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"
        )
        return create_user_friendly_error(e, "–ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤")

@handle_errors(
    category=ErrorCategory.SYSTEM,
    severity=ErrorSeverity.MEDIUM,
    component="mcp_server",
    recovery_action="–í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"
)
@mcp.tool()
async def get_statistics(ctx: Context = None) -> dict:
    """
    Get statistics about processed products and price comparisons
    
    Args:
        ctx: MCP context object
        
    Returns:
        Dictionary with comprehensive statistics about the processed data
    """
    from .error_handling import (
        create_user_friendly_error,
        error_handler,
        ErrorCategory,
        ErrorSeverity,
        log_recovery_attempt
    )
    
    logger.info("–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏")
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        if statistics_generator is None:
            logger.error("–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            return {
                "status": "error",
                "message": "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞: –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω",
                "error_code": "COMPONENT_NOT_INITIALIZED",
                "user_message": "–°–∏—Å—Ç–µ–º–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ",
                "recoverable": True,
                "retry_suggested": True
            }
        
        if database_manager is None:
            logger.error("–ú–µ–Ω–µ–¥–∂–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            return {
                "status": "error",
                "message": "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞: –º–µ–Ω–µ–¥–∂–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω",
                "error_code": "COMPONENT_NOT_INITIALIZED",
                "user_message": "–°–∏—Å—Ç–µ–º–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ",
                "recoverable": True,
                "retry_suggested": True
            }
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–ª–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —á–µ—Ä–µ–∑ StatisticsGenerator
        logger.info("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —á–µ—Ä–µ–∑ StatisticsGenerator...")
        full_statistics = await statistics_generator.generate_full_statistics()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞
        if not full_statistics:
            logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É")
            log_recovery_attempt(
                component="server",
                action="–í–æ–∑–≤—Ä–∞—Ç –ø—É—Å—Ç–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏",
                success=True
            )
            return {
                "status": "no_data",
                "message": "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏",
                "user_message": "–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞",
                "statistics": {
                    "total_products": 0,
                    "products_with_prices": 0,
                    "average_delta_percent": 0.0,
                    "category_breakdown": {},
                    "marketplace_coverage": {}
                },
                "timestamp": datetime.now().isoformat(),
                "recoverable": True,
                "retry_suggested": False
            }
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏
        response = {
            "status": "success",
            "statistics": {
                "total_products": full_statistics.total_products,
                "products_with_prices": full_statistics.products_with_prices,
                "average_delta_percent": round(full_statistics.average_delta_percent, 2),
                "category_breakdown": full_statistics.category_breakdown,
                "marketplace_coverage": full_statistics.marketplace_coverage
            },
            "timestamp": full_statistics.processing_timestamp.isoformat() if hasattr(full_statistics, 'processing_timestamp') and full_statistics.processing_timestamp else datetime.now().isoformat()
        }
        
        # –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        logger.info(
            f"–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω–∞: {full_statistics.total_products} —Ç–æ–≤–∞—Ä–æ–≤, "
            f"{full_statistics.products_with_prices} —Å —Ü–µ–Ω–∞–º–∏, "
            f"—Å—Ä–µ–¥–Ω—è—è –¥–µ–ª—å—Ç–∞: {full_statistics.average_delta_percent:.2f}%"
        )
        
        log_recovery_attempt(
            component="server",
            action=f"–£—Å–ø–µ—à–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è {full_statistics.total_products} —Ç–æ–≤–∞—Ä–æ–≤",
            success=True
        )
        
        return response
        
    except Exception as e:
        error_handler.log_error(
            error=e,
            category=ErrorCategory.SYSTEM,
            severity=ErrorSeverity.HIGH,
            component="server",
            details={"tool": "get_statistics"},
            recovery_action="–í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"
        )
        return create_user_friendly_error(e, "–ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏")

@handle_errors(
    category=ErrorCategory.DATABASE,
    severity=ErrorSeverity.MEDIUM,
    component="mcp_server",
    recovery_action="–í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"
)
@mcp.tool()
async def save_product_prices(product_code: float, search_results: dict, ctx: Context = None) -> dict:
    """
    Save found prices for a specific product to the database
    
    Args:
        product_code: Unique product code from the database
        search_results: Dictionary with search results. Supports multiple formats:
            
            Format 1 - Results array:
            {
                "results": [
                    {
                        "marketplace": "ozon",
                        "price": 299.0,
                        "currency": "RUB",
                        "availability": "–í –Ω–∞–ª–∏—á–∏–∏",
                        "product_url": "https://...",
                        "rating": 4.5,
                        "reviews_count": 100,
                        "product_found": true
                    }
                ]
            }
            
            Format 2 - Found offers array:
            {
                "found_offers": [
                    {
                        "marketplace": "wildberries",
                        "price": 280.0,
                        "currency": "RUB",
                        "availability": "–í –Ω–∞–ª–∏—á–∏–∏"
                    }
                ]
            }
            
            Format 3 - Single product (direct fields):
            {
                "marketplace": "yandex_market",
                "price": 320.0,
                "currency": "RUB",
                "availability": "–í –Ω–∞–ª–∏—á–∏–∏",
                "product_url": "https://..."
            }
            
            Format 4 - Array in root:
            [
                {
                    "marketplace": "ozon",
                    "price": 299.0,
                    "currency": "RUB"
                }
            ]
            
            Format 5 - Marketplaces object (recommended):
            {
                "marketplaces": {
                    "ozon": {
                        "price": "299 —Ä—É–±",
                        "availability": "–í –Ω–∞–ª–∏—á–∏–∏",
                        "url": "https://...",
                        "rating": 4.5,
                        "reviews_count": 100
                    },
                    "wildberries": {
                        "price": "–æ—Ç 280 —Ä—É–±",
                        "availability": "–í –Ω–∞–ª–∏—á–∏–∏"
                    }
                }
            }
            
            Required fields for each offer:
            - marketplace: string (marketplace name)
            - price: number or string with price (e.g., "299 —Ä—É–±", "–æ—Ç 280 —Ä—É–±")
            
            Optional fields:
            - currency: string (default: "RUB")
            - availability: string
            - product_url: string
            - rating: number
            - reviews_count: number
            - product_found: boolean (auto-set to true if price exists)
            
        ctx: MCP context object
        
    Returns:
        Dictionary with save operation results:
        {
            "status": "success" | "error" | "not_found" | "no_data",
            "message": "Description of the result",
            "saved_count": number,
            "total_results": number,
            "saved_prices": [...],
            "errors": [...] (if any)
        }
    """
    from .error_handling import (
        create_user_friendly_error,
        ValidationError,
        error_handler,
        ErrorCategory,
        ErrorSeverity,
        log_recovery_attempt
    )
    
    logger.info(f"–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ü–µ–Ω –¥–ª—è —Ç–æ–≤–∞—Ä–∞ —Å –∫–æ–¥–æ–º: {product_code}")
    logger.debug(f"–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ: {search_results}")
    
    try:
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        if not isinstance(product_code, (int, float)):
            error = ValidationError("–ö–æ–¥ —Ç–æ–≤–∞—Ä–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º", field="product_code", value=product_code)
            return create_user_friendly_error(error, "—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ü–µ–Ω —Ç–æ–≤–∞—Ä–∞")
        
        if not search_results or not isinstance(search_results, dict):
            error = ValidationError("–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–ª–æ–≤–∞—Ä–µ–º", field="search_results", value=search_results)
            return create_user_friendly_error(error, "—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ü–µ–Ω —Ç–æ–≤–∞—Ä–∞")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        if database_manager is None:
            logger.error("–ú–µ–Ω–µ–¥–∂–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            return {
                "status": "error",
                "message": "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞: –º–µ–Ω–µ–¥–∂–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω",
                "error_code": "COMPONENT_NOT_INITIALIZED",
                "user_message": "–°–∏—Å—Ç–µ–º–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ",
                "recoverable": True,
                "retry_suggested": True
            }
        
        # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        product = await database_manager.get_product_by_code(product_code)
        if not product:
            logger.warning(f"–ü—Ä–æ–¥—É–∫—Ç —Å –∫–æ–¥–æ–º {product_code} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö")
            return {
                "status": "not_found",
                "message": f"–ü—Ä–æ–¥—É–∫—Ç —Å –∫–æ–¥–æ–º {product_code} –Ω–µ –Ω–∞–π–¥–µ–Ω",
                "error_code": "PRODUCT_NOT_FOUND",
                "user_message": "–¢–æ–≤–∞—Ä —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –∫–æ–¥–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö",
                "recoverable": False,
                "retry_suggested": False
            }
        
        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
        results = []
        
        # –§–æ—Ä–º–∞—Ç 1: {"results": [...]}
        if "results" in search_results and isinstance(search_results["results"], list):
            results = search_results["results"]
            logger.debug(f"–û–±–Ω–∞—Ä—É–∂–µ–Ω —Ñ–æ—Ä–º–∞—Ç 1: results array —Å {len(results)} —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏")
        
        # –§–æ—Ä–º–∞—Ç 2: {"found_offers": [...]}
        elif "found_offers" in search_results and isinstance(search_results["found_offers"], list):
            results = search_results["found_offers"]
            logger.debug(f"–û–±–Ω–∞—Ä—É–∂–µ–Ω —Ñ–æ—Ä–º–∞—Ç 2: found_offers array —Å {len(results)} —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏")
            # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è found_offers
            for result in results:
                if "product_found" not in result:
                    result["product_found"] = True  # –ï—Å–ª–∏ —Ü–µ–Ω–∞ –µ—Å—Ç—å, –∑–Ω–∞—á–∏—Ç —Ç–æ–≤–∞—Ä –Ω–∞–π–¥–µ–Ω
        
        # –§–æ—Ä–º–∞—Ç 3: –ü—Ä—è–º—ã–µ –ø–æ–ª—è –≤ –∫–æ—Ä–Ω–µ (–æ–¥–∏–Ω —Ç–æ–≤–∞—Ä)
        elif "marketplace" in search_results and "price" in search_results:
            results = [search_results]
            search_results["product_found"] = True
            logger.debug("–û–±–Ω–∞—Ä—É–∂–µ–Ω —Ñ–æ—Ä–º–∞—Ç 3: –ø—Ä—è–º—ã–µ –ø–æ–ª—è –≤ –∫–æ—Ä–Ω–µ")
        
        # –§–æ—Ä–º–∞—Ç 4: –ú–∞—Å—Å–∏–≤ –≤ –∫–æ—Ä–Ω–µ
        elif isinstance(search_results, list):
            results = search_results
            logger.debug(f"–û–±–Ω–∞—Ä—É–∂–µ–Ω —Ñ–æ—Ä–º–∞—Ç 4: –º–∞—Å—Å–∏–≤ –≤ –∫–æ—Ä–Ω–µ —Å {len(results)} —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏")
            # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
            for result in results:
                if "product_found" not in result:
                    result["product_found"] = True
        
        # –§–æ—Ä–º–∞—Ç 5: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ —Å marketplaces (–æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º–∞—Ç —Å–∏—Å—Ç–µ–º—ã)
        elif "marketplaces" in search_results and isinstance(search_results["marketplaces"], dict):
            results = []
            marketplaces = search_results["marketplaces"]
            logger.debug(f"–û–±–Ω–∞—Ä—É–∂–µ–Ω —Ñ–æ—Ä–º–∞—Ç 5: marketplaces —Å {len(marketplaces)} –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞–º–∏")
            
            for marketplace_name, marketplace_data in marketplaces.items():
                if isinstance(marketplace_data, dict) and "price" in marketplace_data:
                    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ü–µ–Ω—É –∏–∑ —Å—Ç—Ä–æ–∫–∏ –≤ —á–∏—Å–ª–æ
                    price_str = marketplace_data.get("price", "")
                    price_value = None
                    
                    if price_str:
                        # –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Å—Ç—Ä–æ–∫–∏ —Ç–∏–ø–∞ "299 —Ä—É–±" –∏–ª–∏ "–æ—Ç 280 —Ä—É–±"
                        import re
                        price_match = re.search(r'(\d+(?:\.\d+)?)', str(price_str))
                        if price_match:
                            price_value = float(price_match.group(1))
                    
                    if price_value and price_value > 0:
                        result_item = {
                            "marketplace": marketplace_name,
                            "price": price_value,
                            "currency": "RUB",
                            "availability": marketplace_data.get("availability", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"),
                            "product_url": marketplace_data.get("url"),
                            "rating": marketplace_data.get("rating"),
                            "reviews_count": marketplace_data.get("reviews_count"),
                            "product_found": True
                        }
                        results.append(result_item)
                        logger.debug(f"–î–æ–±–∞–≤–ª–µ–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è {marketplace_name}: {price_value} —Ä—É–±")
                    else:
                        logger.debug(f"–ü—Ä–æ–ø—É—â–µ–Ω {marketplace_name}: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ü–µ–Ω–∞ '{price_str}'")
        
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        if not results:
            logger.warning(f"–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è")
            logger.debug(f"–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: {list(search_results.keys())}")
            logger.debug(f"–ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: {search_results}")
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
            diagnostic_info = {
                "received_keys": list(search_results.keys()),
                "has_marketplaces": "marketplaces" in search_results,
                "has_results": "results" in search_results,
                "has_found_offers": "found_offers" in search_results,
                "is_list": isinstance(search_results, list),
                "has_direct_fields": "marketplace" in search_results and "price" in search_results
            }
            
            if "marketplaces" in search_results:
                marketplaces = search_results["marketplaces"]
                diagnostic_info["marketplaces_type"] = type(marketplaces).__name__
                if isinstance(marketplaces, dict):
                    diagnostic_info["marketplaces_keys"] = list(marketplaces.keys())
                    diagnostic_info["marketplaces_count"] = len(marketplaces)
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å
                    for mp_name, mp_data in marketplaces.items():
                        diagnostic_info[f"{mp_name}_has_price"] = "price" in mp_data if isinstance(mp_data, dict) else False
                        if isinstance(mp_data, dict) and "price" in mp_data:
                            diagnostic_info[f"{mp_name}_price_value"] = mp_data["price"]
            
            return {
                "status": "no_data",
                "message": "–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è",
                "user_message": "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø—É—Å—Ç—ã, –Ω–µ—á–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å",
                "diagnostic_info": diagnostic_info,
                "recoverable": True,
                "retry_suggested": False
            }
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–µ–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞
        saved_count = 0
        errors = []
        saved_prices = []
        
        for i, result in enumerate(results):
            logger.debug(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ {i+1}: {result}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ü–µ–Ω—ã (–≥–∏–±–∫–æ)
            price = result.get("price")
            if not price:
                logger.debug(f"–†–µ–∑—É–ª—å—Ç–∞—Ç {i+1}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ü–µ–Ω–∞, –∫–ª—é—á–∏: {list(result.keys())}")
                errors.append(f"–†–µ–∑—É–ª—å—Ç–∞—Ç {i+1}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ 'price'")
                continue
                
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–æ–≤–∞—Ä –Ω–∞–π–¥–µ–Ω (–µ—Å–ª–∏ –ø–æ–ª–µ –µ—Å—Ç—å)
            if "product_found" in result and not result.get("product_found"):
                logger.debug(f"–†–µ–∑—É–ª—å—Ç–∞—Ç {i+1}: —Ç–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω (product_found=False)")
                errors.append(f"–†–µ–∑—É–ª—å—Ç–∞—Ç {i+1}: —Ç–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ")
                continue
                
            try:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ü–µ–Ω–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∞ –≤ —á–∏—Å–ª–æ
                try:
                    price_float = float(price)
                    if price_float <= 0:
                        raise ValueError(f"–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º, –ø–æ–ª—É—á–µ–Ω–æ: {price_float}")
                except (ValueError, TypeError) as e:
                    error_msg = f"–†–µ–∑—É–ª—å—Ç–∞—Ç {i+1}: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ü–µ–Ω–∞ '{price}': {e}"
                    errors.append(error_msg)
                    logger.warning(error_msg)
                    continue
                
                price_data = {
                    "marketplace": result.get("marketplace", "unknown"),
                    "price": price_float,
                    "currency": result.get("currency", "RUB"),
                    "availability": result.get("availability", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"),
                    "product_url": result.get("product_url") or result.get("url")
                }
                
                logger.debug(f"–ü–æ–ø—ã—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã: {price_data}")
                await database_manager.save_price(product["id"], price_data)
                saved_count += 1
                saved_prices.append({
                    "marketplace": price_data["marketplace"],
                    "price": price_data["price"],
                    "currency": price_data["currency"],
                    "availability": price_data["availability"]
                })
                logger.info(f"–°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —Ü–µ–Ω–∞ –¥–ª—è {price_data['marketplace']}: {price_data['price']} {price_data['currency']}")
                
            except Exception as price_error:
                error_msg = f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã –¥–ª—è {result.get('marketplace', 'unknown')}: {price_error}"
                errors.append(error_msg)
                logger.error(error_msg)
                logger.debug(f"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: —Ä–µ–∑—É–ª—å—Ç–∞—Ç={result}, –æ—à–∏–±–∫–∞={type(price_error).__name__}: {price_error}")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
        if saved_count > 0:
            logger.info(f"–£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ {saved_count} —Ü–µ–Ω –¥–ª—è —Ç–æ–≤–∞—Ä–∞ {product_code}")
            log_recovery_attempt(
                component="server",
                action=f"–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ {saved_count} —Ü–µ–Ω –¥–ª—è —Ç–æ–≤–∞—Ä–∞ {product_code}",
                success=True
            )
            
            response = {
                "status": "success",
                "message": f"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ {saved_count} —Ü–µ–Ω –¥–ª—è —Ç–æ–≤–∞—Ä–∞ {product_code}",
                "product_code": product_code,
                "product_name": product["model_name"],
                "saved_prices": saved_count,
                "total_results": len(results),
                "prices_saved": saved_prices,
                "timestamp": datetime.now().isoformat()
            }
            
            if errors:
                response["warnings"] = errors
                
            return response
        else:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∏ –æ–¥–Ω–æ–π —Ü–µ–Ω—ã –¥–ª—è —Ç–æ–≤–∞—Ä–∞ {product_code}")
            return {
                "status": "no_data",
                "message": "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∏ –æ–¥–Ω–æ–π —Ü–µ–Ω—ã",
                "user_message": "–í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –ø–æ–∏—Å–∫–∞ –Ω–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö —Ü–µ–Ω –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è",
                "product_code": product_code,
                "total_results": len(results),
                "errors": errors,
                "recoverable": True,
                "retry_suggested": True
            }
        
    except Exception as e:
        error_handler.log_error(
            error=e,
            category=ErrorCategory.DATABASE,
            severity=ErrorSeverity.HIGH,
            component="server",
            details={"tool": "save_product_prices", "product_code": product_code},
            recovery_action="–í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"
        )
        return create_user_friendly_error(e, "—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ü–µ–Ω —Ç–æ–≤–∞—Ä–∞")


@handle_errors(
    category=ErrorCategory.SYSTEM,
    severity=ErrorSeverity.LOW,
    component="mcp_server",
    recovery_action="–í–æ–∑–≤—Ä–∞—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ª–∏—Ü–µ–Ω–∑–∏–∏"
)
@mcp.tool()
async def check_license_status(ctx: Context = None) -> dict:
    """
    Check the current license status and information
    
    Args:
        ctx: MCP context object
        
    Returns:
        Dictionary with license status and information
    """
    from .error_handling import (
        create_user_friendly_error,
        error_handler,
        ErrorCategory,
        ErrorSeverity,
        log_recovery_attempt
    )
    
    logger.info("–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏")
    
    try:
        # –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ª–∏—Ü–µ–Ω–∑–∏–π
        license_manager = LicenseManager()
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ª–∏—Ü–µ–Ω–∑–∏–∏
        license_info = license_manager.get_license_info()
        
        is_valid = license_info["is_valid"]
        license_data = license_info["license_data"]
        
        if is_valid:
            logger.info("–õ–∏—Ü–µ–Ω–∑–∏—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞")
            log_recovery_attempt(
                component="server",
                action="–£—Å–ø–µ—à–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏",
                success=True
            )
            
            return {
                "status": "valid",
                "message": "–õ–∏—Ü–µ–Ω–∑–∏—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞",
                "license_key": license_info["license_key"],
                "license_info": {
                    "valid": license_data.get("valid", False),
                    "checked_at": license_data.get("checked_at"),
                    "expires_at": license_data.get("expires_at"),
                    "plan": license_data.get("plan"),
                    "features": license_data.get("features", [])
                },
                "api_url": license_info["api_url"]
            }
        else:
            logger.warning("–õ–∏—Ü–µ–Ω–∑–∏—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞")
            log_recovery_attempt(
                component="server",
                action="–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏—Ü–µ–Ω–∑–∏—è",
                success=False
            )
            
            return {
                "status": "invalid",
                "message": "–õ–∏—Ü–µ–Ω–∑–∏—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞",
                "license_key": license_info["license_key"],
                "error": license_data.get("error", "UNKNOWN_ERROR"),
                "error_message": license_data.get("message", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"),
                "user_message": license_data.get("user_message", "–õ–∏—Ü–µ–Ω–∑–∏—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞"),
                "api_url": license_info["api_url"]
            }
            
    except Exception as e:
        error_handler.log_error(
            error=e,
            category=ErrorCategory.SYSTEM,
            severity=ErrorSeverity.MEDIUM,
            component="server",
            details={"tool": "check_license_status"},
            recovery_action="–í–æ–∑–≤—Ä–∞—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ—à–∏–±–∫–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏—Ü–µ–Ω–∑–∏–∏"
        )
        return create_user_friendly_error(e, "–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏")

@handle_errors(
    category=ErrorCategory.SYSTEM,
    severity=ErrorSeverity.MEDIUM,
    component="mcp_server",
    recovery_action="–í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ª–∏—Ü–µ–Ω–∑–∏–∏"
)
@mcp.tool()
async def set_license_key(license_key: str, ctx: Context = None) -> dict:
    """
    Set a new license key for the system
    
    Args:
        license_key: New license key to set
        ctx: MCP context object
        
    Returns:
        Dictionary with result of license key setting
    """
    from .error_handling import (
        create_user_friendly_error,
        ValidationError,
        error_handler,
        ErrorCategory,
        ErrorSeverity,
        log_recovery_attempt
    )
    
    logger.info("–ó–∞–ø—Ä–æ—Å –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É –Ω–æ–≤–æ–≥–æ –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞")
    
    try:
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        if not license_key or not isinstance(license_key, str) or len(license_key.strip()) == 0:
            error = ValidationError("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –Ω–µ–ø—É—Å—Ç–æ–π –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á", field="license_key", value=license_key)
            return create_user_friendly_error(error, "—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞")
        
        license_key = license_key.strip()
        
        # –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ª–∏—Ü–µ–Ω–∑–∏–π
        license_manager = LicenseManager()
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π –∫–ª—é—á
        success = license_manager.set_license_key(license_key, save_to_config=True)
        
        if success:
            logger.info("–ù–æ–≤—ã–π –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
            log_recovery_attempt(
                component="server",
                action="–£—Å–ø–µ—à–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤–æ–≥–æ –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞",
                success=True
            )
            
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–æ–≤–æ–π –ª–∏—Ü–µ–Ω–∑–∏–∏
            license_info = license_manager.get_license_info()
            
            return {
                "status": "success",
                "message": "–õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω",
                "license_key": license_key,
                "license_info": license_info["license_data"],
                "saved_to_config": True
            }
        else:
            logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–π –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á")
            log_recovery_attempt(
                component="server",
                action="–ù–µ—É–¥–∞—á–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞",
                success=False
            )
            
            return {
                "status": "error",
                "message": "–õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω",
                "error_code": "INVALID_LICENSE_KEY",
                "user_message": "–£–∫–∞–∑–∞–Ω–Ω—ã–π –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω",
                "license_key": license_key,
                "recoverable": True,
                "retry_suggested": True
            }
            
    except Exception as e:
        error_handler.log_error(
            error=e,
            category=ErrorCategory.SYSTEM,
            severity=ErrorSeverity.HIGH,
            component="server",
            details={"tool": "set_license_key", "license_key": license_key[:8] + "..." if license_key else "None"},
            recovery_action="–í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"
        )
        return create_user_friendly_error(e, "—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞")

# Excel Tools MCP Functions

@handle_errors(
    category=ErrorCategory.PARSING,
    severity=ErrorSeverity.MEDIUM,
    component="mcp_server",
    recovery_action="–í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"
)
@mcp.tool()
async def parse_excel_file(file_path: str, sheet_name: Optional[str] = None, 
                          header_row: int = 0, max_rows: Optional[int] = None, 
                          ctx: Context = None) -> dict:
    """
    Parse Excel file and return structured data
    
    Args:
        file_path: Path to Excel file
        sheet_name: Sheet name (if None, uses first sheet)
        header_row: Header row number (0-based)
        max_rows: Maximum number of rows to read
        ctx: MCP context object
        
    Returns:
        Dictionary with parsed Excel data
    """
    from .error_handling import (
        create_user_friendly_error,
        ValidationError,
        error_handler,
        ErrorCategory,
        ErrorSeverity,
        log_recovery_attempt
    )
    
    logger.info(f"–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–∞—Ä—Å–∏–Ω–≥ Excel —Ñ–∞–π–ª–∞: {file_path}")
    
    try:
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        if not file_path or not isinstance(file_path, str):
            error = ValidationError("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –∫ Excel —Ñ–∞–π–ª—É", field="file_path", value=file_path)
            return create_user_friendly_error(error, "–ø–∞—Ä—Å–∏–Ω–≥ Excel —Ñ–∞–π–ª–∞")
        
        if header_row < 0:
            error = ValidationError("–ù–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º", field="header_row", value=header_row)
            return create_user_friendly_error(error, "–ø–∞—Ä—Å–∏–Ω–≥ Excel —Ñ–∞–π–ª–∞")
        
        if max_rows is not None and max_rows <= 0:
            error = ValidationError("–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º", field="max_rows", value=max_rows)
            return create_user_friendly_error(error, "–ø–∞—Ä—Å–∏–Ω–≥ Excel —Ñ–∞–π–ª–∞")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        if excel_tools is None:
            logger.error("Excel –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã")
            return {
                "status": "error",
                "message": "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞: Excel –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã",
                "error_code": "COMPONENT_NOT_INITIALIZED",
                "user_message": "–°–∏—Å—Ç–µ–º–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ",
                "recoverable": True,
                "retry_suggested": True
            }
        
        # –ü–∞—Ä—Å–∏–º Excel —Ñ–∞–π–ª
        result = await excel_tools.parse_excel_file(
            file_path=file_path,
            sheet_name=sheet_name,
            header_row=header_row,
            max_rows=max_rows
        )
        
        logger.info(f"–£—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω Excel —Ñ–∞–π–ª: {result.get('total_rows', 0)} —Å—Ç—Ä–æ–∫")
        
        log_recovery_attempt(
            component="server",
            action=f"–£—Å–ø–µ—à–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ Excel —Ñ–∞–π–ª–∞ {file_path}",
            success=True
        )
        
        return result
        
    except Exception as e:
        error_handler.log_error(
            error=e,
            category=ErrorCategory.PARSING,
            severity=ErrorSeverity.HIGH,
            component="server",
            details={"tool": "parse_excel_file", "file_path": file_path},
            recovery_action="–í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"
        )
        return create_user_friendly_error(e, "–ø–∞—Ä—Å–∏–Ω–≥ Excel —Ñ–∞–π–ª–∞")

@handle_errors(
    category=ErrorCategory.PARSING,
    severity=ErrorSeverity.MEDIUM,
    component="mcp_server",
    recovery_action="–í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"
)
@mcp.tool()
async def get_excel_info(file_path: str, ctx: Context = None) -> dict:
    """
    Get information about Excel file structure without reading all data
    
    Args:
        file_path: Path to Excel file
        ctx: MCP context object
        
    Returns:
        Dictionary with Excel file structure information
    """
    from .error_handling import (
        create_user_friendly_error,
        ValidationError,
        error_handler,
        ErrorCategory,
        ErrorSeverity,
        log_recovery_attempt
    )
    
    logger.info(f"–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ Excel —Ñ–∞–π–ª–µ: {file_path}")
    
    try:
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        if not file_path or not isinstance(file_path, str):
            error = ValidationError("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –∫ Excel —Ñ–∞–π–ª—É", field="file_path", value=file_path)
            return create_user_friendly_error(error, "–ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ Excel —Ñ–∞–π–ª–µ")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        if excel_tools is None:
            logger.error("Excel –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã")
            return {
                "status": "error",
                "message": "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞: Excel –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã",
                "error_code": "COMPONENT_NOT_INITIALIZED",
                "user_message": "–°–∏—Å—Ç–µ–º–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ",
                "recoverable": True,
                "retry_suggested": True
            }
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
        result = await excel_tools.get_excel_info(file_path)
        
        logger.info(f"–ü–æ–ª—É—á–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ Excel —Ñ–∞–π–ª–µ: {result.get('total_sheets', 0)} –ª–∏—Å—Ç–æ–≤")
        
        log_recovery_attempt(
            component="server",
            action=f"–£—Å–ø–µ—à–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ Excel —Ñ–∞–π–ª–µ {file_path}",
            success=True
        )
        
        return result
        
    except Exception as e:
        error_handler.log_error(
            error=e,
            category=ErrorCategory.PARSING,
            severity=ErrorSeverity.HIGH,
            component="server",
            details={"tool": "get_excel_info", "file_path": file_path},
            recovery_action="–í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"
        )
        return create_user_friendly_error(e, "–ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ Excel —Ñ–∞–π–ª–µ")

@handle_errors(
    category=ErrorCategory.PARSING,
    severity=ErrorSeverity.MEDIUM,
    component="mcp_server",
    recovery_action="–í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"
)
@mcp.tool()
async def export_to_excel(data: List[Dict[str, Any]], file_path: str,
                         sheet_name: str = "Data", include_index: bool = False,
                         auto_adjust_columns: bool = True, apply_formatting: bool = True,
                         ctx: Context = None) -> dict:
    """
    Export data to Excel file with formatting
    
    Args:
        data: List of dictionaries with data to export
        file_path: Path to save Excel file
        sheet_name: Sheet name
        include_index: Whether to include row index
        auto_adjust_columns: Auto-adjust column widths
        apply_formatting: Apply formatting to the file
        ctx: MCP context object
        
    Returns:
        Dictionary with export result
    """
    from .error_handling import (
        create_user_friendly_error,
        ValidationError,
        error_handler,
        ErrorCategory,
        ErrorSeverity,
        log_recovery_attempt
    )
    
    logger.info(f"–ó–∞–ø—Ä–æ—Å –Ω–∞ —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ Excel —Ñ–∞–π–ª: {file_path}")
    
    try:
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        if not file_path or not isinstance(file_path, str):
            error = ValidationError("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è Excel —Ñ–∞–π–ª–∞", field="file_path", value=file_path)
            return create_user_friendly_error(error, "—ç–∫—Å–ø–æ—Ä—Ç –≤ Excel —Ñ–∞–π–ª")
        
        if not data or not isinstance(data, list):
            error = ValidationError("–î–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–ø–∏—Å–∫–æ–º —Å–ª–æ–≤–∞—Ä–µ–π", field="data", value=type(data).__name__)
            return create_user_friendly_error(error, "—ç–∫—Å–ø–æ—Ä—Ç –≤ Excel —Ñ–∞–π–ª")
        
        if not sheet_name or not isinstance(sheet_name, str):
            error = ValidationError("–ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ–ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π", field="sheet_name", value=sheet_name)
            return create_user_friendly_error(error, "—ç–∫—Å–ø–æ—Ä—Ç –≤ Excel —Ñ–∞–π–ª")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        if excel_tools is None:
            logger.error("Excel –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã")
            return {
                "status": "error",
                "message": "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞: Excel –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã",
                "error_code": "COMPONENT_NOT_INITIALIZED",
                "user_message": "–°–∏—Å—Ç–µ–º–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ",
                "recoverable": True,
                "retry_suggested": True
            }
        
        # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        result = await excel_tools.export_to_excel(
            data=data,
            file_path=file_path,
            sheet_name=sheet_name,
            include_index=include_index,
            auto_adjust_columns=auto_adjust_columns,
            apply_formatting=apply_formatting
        )
        
        logger.info(f"–£—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –¥–∞–Ω–Ω—ã–µ –≤ Excel —Ñ–∞–π–ª: {result.get('rows_exported', 0)} —Å—Ç—Ä–æ–∫")
        
        log_recovery_attempt(
            component="server",
            action=f"–£—Å–ø–µ—à–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ Excel —Ñ–∞–π–ª {file_path}",
            success=True
        )
        
        return result
        
    except Exception as e:
        error_handler.log_error(
            error=e,
            category=ErrorCategory.PARSING,
            severity=ErrorSeverity.HIGH,
            component="server",
            details={"tool": "export_to_excel", "file_path": file_path},
            recovery_action="–í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"
        )
        return create_user_friendly_error(e, "—ç–∫—Å–ø–æ—Ä—Ç –≤ Excel —Ñ–∞–π–ª")

@handle_errors(
    category=ErrorCategory.PARSING,
    severity=ErrorSeverity.MEDIUM,
    component="mcp_server",
    recovery_action="–í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"
)
@mcp.tool()
async def filter_excel_data(data: List[Dict[str, Any]], filters: Dict[str, Any], 
                           ctx: Context = None) -> dict:
    """
    Filter Excel data by specified criteria
    
    Args:
        data: Source data to filter
        filters: Dictionary with filter criteria
        ctx: MCP context object
        
    Returns:
        Filtered data
    """
    from .error_handling import (
        create_user_friendly_error,
        ValidationError,
        error_handler,
        ErrorCategory,
        ErrorSeverity,
        log_recovery_attempt
    )
    
    logger.info(f"–ó–∞–ø—Ä–æ—Å –Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º: {filters}")
    
    try:
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        if not data or not isinstance(data, list):
            error = ValidationError("–î–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–ø–∏—Å–∫–æ–º —Å–ª–æ–≤–∞—Ä–µ–π", field="data", value=type(data).__name__)
            return create_user_friendly_error(error, "—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö")
        
        if not filters or not isinstance(filters, dict):
            error = ValidationError("–§–∏–ª—å—Ç—Ä—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–ª–æ–≤–∞—Ä–µ–º", field="filters", value=type(filters).__name__)
            return create_user_friendly_error(error, "—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        if excel_tools is None:
            logger.error("Excel –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã")
            return {
                "status": "error",
                "message": "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞: Excel –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã",
                "error_code": "COMPONENT_NOT_INITIALIZED",
                "user_message": "–°–∏—Å—Ç–µ–º–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ",
                "recoverable": True,
                "retry_suggested": True
            }
        
        # –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        result = await excel_tools.filter_excel_data(data, filters)
        
        logger.info(f"–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: {result.get('filtered_count', 0)} –∏–∑ {result.get('original_count', 0)} —Å—Ç—Ä–æ–∫")
        
        log_recovery_attempt(
            component="server",
            action=f"–£—Å–ø–µ—à–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö",
            success=True
        )
        
        return result
        
    except Exception as e:
        error_handler.log_error(
            error=e,
            category=ErrorCategory.PARSING,
            severity=ErrorSeverity.HIGH,
            component="server",
            details={"tool": "filter_excel_data", "filters": filters},
            recovery_action="–í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"
        )
        return create_user_friendly_error(e, "—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö")

@handle_errors(
    category=ErrorCategory.PARSING,
    severity=ErrorSeverity.MEDIUM,
    component="mcp_server",
    recovery_action="–í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"
)
@mcp.tool()
async def transform_excel_data(data: List[Dict[str, Any]], transformations: Dict[str, Any], 
                              ctx: Context = None) -> dict:
    """
    Transform Excel data according to specified rules
    
    Args:
        data: Source data to transform
        transformations: Dictionary with transformation rules
        ctx: MCP context object
        
    Returns:
        Transformed data
    """
    from .error_handling import (
        create_user_friendly_error,
        ValidationError,
        error_handler,
        ErrorCategory,
        ErrorSeverity,
        log_recovery_attempt
    )
    
    logger.info(f"–ó–∞–ø—Ä–æ—Å –Ω–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º: {transformations}")
    
    try:
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        if not data or not isinstance(data, list):
            error = ValidationError("–î–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–ø–∏—Å–∫–æ–º —Å–ª–æ–≤–∞—Ä–µ–π", field="data", value=type(data).__name__)
            return create_user_friendly_error(error, "—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö")
        
        if not transformations or not isinstance(transformations, dict):
            error = ValidationError("–ü—Ä–∞–≤–∏–ª–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–ª–æ–≤–∞—Ä–µ–º", field="transformations", value=type(transformations).__name__)
            return create_user_friendly_error(error, "—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        if excel_tools is None:
            logger.error("Excel –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã")
            return {
                "status": "error",
                "message": "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞: Excel –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã",
                "error_code": "COMPONENT_NOT_INITIALIZED",
                "user_message": "–°–∏—Å—Ç–µ–º–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ",
                "recoverable": True,
                "retry_suggested": True
            }
        
        # –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        result = await excel_tools.transform_excel_data(data, transformations)
        
        logger.info(f"–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: {result.get('transformed_count', 0)} —Å—Ç—Ä–æ–∫")
        
        log_recovery_attempt(
            component="server",
            action=f"–£—Å–ø–µ—à–Ω–∞—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö",
            success=True
        )
        
        return result
        
    except Exception as e:
        error_handler.log_error(
            error=e,
            category=ErrorCategory.PARSING,
            severity=ErrorSeverity.HIGH,
            component="server",
            details={"tool": "transform_excel_data", "transformations": transformations},
            recovery_action="–í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"
        )
        return create_user_friendly_error(e, "—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö")

@handle_errors(
    category=ErrorCategory.DATABASE,
    severity=ErrorSeverity.HIGH,
    component="mcp_server",
    recovery_action="–í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"
)
@mcp.tool()
async def parse_excel_and_save_to_database(file_path: str, sheet_name: Optional[str] = None, 
                                          header_row: int = 0, start_row: Optional[int] = None,
                                          max_rows: Optional[int] = None,
                                          ctx: Context = None) -> dict:
    """
    Parse Excel file and automatically save products to database
    
    Args:
        file_path: Path to Excel file
        sheet_name: Sheet name (if None, uses first sheet)
        header_row: Header row number (0-based)
        start_row: Starting row number for data reading (0-based, after header). If None, starts from header_row + 1
        max_rows: Maximum number of rows to read from start_row. If None, reads all remaining rows
        ctx: MCP context object
        
    Returns:
        Dictionary with parsing and saving results
    """
    from .error_handling import (
        create_user_friendly_error,
        ValidationError,
        error_handler,
        ErrorCategory,
        ErrorSeverity,
        log_recovery_attempt
    )
    
    logger.info(f"–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–∞—Ä—Å–∏–Ω–≥ Excel —Ñ–∞–π–ª–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î: {file_path}")
    
    try:
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        if not file_path or not isinstance(file_path, str):
            error = ValidationError("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –∫ Excel —Ñ–∞–π–ª—É", field="file_path", value=file_path)
            return create_user_friendly_error(error, "–ø–∞—Ä—Å–∏–Ω–≥ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Excel —Ñ–∞–π–ª–∞")
        
        if start_row is not None and start_row < 0:
            error = ValidationError("–ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π", field="start_row", value=start_row)
            return create_user_friendly_error(error, "–ø–∞—Ä—Å–∏–Ω–≥ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Excel —Ñ–∞–π–ª–∞")
        
        if max_rows is not None and max_rows <= 0:
            error = ValidationError("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º", field="max_rows", value=max_rows)
            return create_user_friendly_error(error, "–ø–∞—Ä—Å–∏–Ω–≥ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Excel —Ñ–∞–π–ª–∞")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        if excel_tools is None:
            logger.error("Excel –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã")
            return {
                "status": "error",
                "message": "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞: Excel –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã",
                "error_code": "COMPONENT_NOT_INITIALIZED",
                "user_message": "–°–∏—Å—Ç–µ–º–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ",
                "recoverable": True,
                "retry_suggested": True
            }
        
        if database_manager is None:
            logger.error("–ú–µ–Ω–µ–¥–∂–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            return {
                "status": "error",
                "message": "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞: –º–µ–Ω–µ–¥–∂–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω",
                "error_code": "COMPONENT_NOT_INITIALIZED",
                "user_message": "–°–∏—Å—Ç–µ–º–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ",
                "recoverable": True,
                "retry_suggested": True
            }
        
        # –®–∞–≥ 1: –ü–∞—Ä—Å–∏–º Excel —Ñ–∞–π–ª
        logger.info("–®–∞–≥ 1: –ü–∞—Ä—Å–∏–Ω–≥ Excel —Ñ–∞–π–ª–∞...")
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —á—Ç–µ–Ω–∏—è Excel
        if start_row is not None:
            # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞ –Ω–∞—á–∞–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞, –Ω—É–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ –¥–æ –Ω–µ—ë
            skip_rows = start_row
            # –ß–∏—Ç–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Ç–¥–µ–ª—å–Ω–æ
            header_result = await excel_tools.parse_excel_file(
                file_path=file_path,
                sheet_name=sheet_name,
                header_row=header_row,
                max_rows=1  # –ß–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏
            )
            
            if header_result.get("status") != "success":
                logger.error(f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ Excel —Ñ–∞–π–ª–∞: {header_result}")
                return {
                    "status": "error",
                    "message": "–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ Excel —Ñ–∞–π–ª–∞",
                    "parse_result": header_result,
                    "user_message": "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ Excel —Ñ–∞–π–ª–∞",
                    "recoverable": True,
                    "retry_suggested": True
                }
            
            # –¢–µ–ø–µ—Ä—å —á–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞—á–∏–Ω–∞—è —Å —É–∫–∞–∑–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
            # –ù—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π –ø–æ–¥—Ö–æ–¥ –¥–ª—è —á—Ç–µ–Ω–∏—è —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
            logger.info(f"–ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—á–∏–Ω–∞—è —Å–æ —Å—Ç—Ä–æ–∫–∏ {start_row}, –º–∞–∫—Å–∏–º—É–º {max_rows or '–≤—Å–µ'} —Å—Ç—Ä–æ–∫")
            
            # –î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è, –ø–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ —Å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–æ–π
            total_rows_to_read = (start_row + max_rows) if max_rows else None
            parse_result = await excel_tools.parse_excel_file(
                file_path=file_path,
                sheet_name=sheet_name,
                header_row=header_row,
                max_rows=total_rows_to_read
            )
            
            if parse_result.get("status") == "success":
                # –û–±—Ä–µ–∑–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–æ –Ω—É–∂–Ω–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
                all_data = parse_result.get("data", [])
                if start_row < len(all_data):
                    end_row = start_row + max_rows if max_rows else len(all_data)
                    parse_result["data"] = all_data[start_row:end_row]
                    parse_result["total_rows"] = len(parse_result["data"])
                    logger.info(f"–í—ã–±—Ä–∞–Ω –¥–∏–∞–ø–∞–∑–æ–Ω —Å—Ç—Ä–æ–∫ {start_row}-{min(end_row, len(all_data))}, –ø–æ–ª—É—á–µ–Ω–æ {len(parse_result['data'])} —Å—Ç—Ä–æ–∫")
                else:
                    parse_result["data"] = []
                    parse_result["total_rows"] = 0
                    logger.warning(f"–ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ {start_row} –ø—Ä–µ–≤—ã—à–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–∞–π–ª–µ ({len(all_data)})")
        else:
            # –û–±—ã—á–Ω–æ–µ —á—Ç–µ–Ω–∏–µ —Å –Ω–∞—á–∞–ª–∞
            parse_result = await excel_tools.parse_excel_file(
                file_path=file_path,
                sheet_name=sheet_name,
                header_row=header_row,
                max_rows=max_rows
            )
        
        if parse_result.get("status") != "success":
            logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ Excel —Ñ–∞–π–ª–∞: {parse_result}")
            return {
                "status": "error",
                "message": "–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ Excel —Ñ–∞–π–ª–∞",
                "parse_result": parse_result,
                "user_message": "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å Excel —Ñ–∞–π–ª, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∏ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É",
                "recoverable": True,
                "retry_suggested": True
            }
        
        data = parse_result.get("data", [])
        if not data:
            logger.warning("Excel —Ñ–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö")
            return {
                "status": "no_data",
                "message": "Excel —Ñ–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö",
                "user_message": "Excel —Ñ–∞–π–ª –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏",
                "parse_result": parse_result,
                "recoverable": False,
                "retry_suggested": False
            }
        
        range_info = f" (—Å—Ç—Ä–æ–∫–∏ {start_row}-{start_row + len(data) - 1})" if start_row is not None else ""
        logger.info(f"–£—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–æ {len(data)} —Å—Ç—Ä–æ–∫ –∏–∑ Excel —Ñ–∞–π–ª–∞{range_info}")
        
        # –®–∞–≥ 2: –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–≤–∞—Ä—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        logger.info("–®–∞–≥ 2: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...")
        saved_count = 0
        updated_count = 0
        errors = []
        saved_products = []
        
        for i, row_data in enumerate(data):
            try:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
                code = row_data.get("–ö–æ–¥\n–º–æ–¥–µ–ª–∏") or row_data.get("code")
                model_name = row_data.get("model_name")
                
                if not code or not model_name:
                    error_msg = f"–°—Ç—Ä–æ–∫–∞ {i+1}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (–∫–æ–¥ –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏)"
                    errors.append(error_msg)
                    logger.warning(error_msg)
                    continue
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç–æ–≤–∞—Ä –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                existing_product = await database_manager.get_product_by_code(float(code))
                
                if existing_product:
                    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–æ–≤–∞—Ä
                    product_data = {
                        "code": float(code),
                        "model_name": model_name,
                        "category": row_data.get("–ö–∞—Ç–µ–≥–æ—Ä–∏—è") or row_data.get("category", ""),
                        "unit": row_data.get("–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è") or row_data.get("unit", ""),
                        "priority_1_source": row_data.get("–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç \n1 –ò—Å—Ç–æ—á–Ω–∏–∫–∏") or row_data.get("priority_1_source", ""),
                        "priority_2_source": row_data.get("–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç \n2 –ò—Å—Ç–æ—á–Ω–∏–∫–∏") or row_data.get("priority_2_source", "")
                    }
                    
                    success = await database_manager.update_product(product_data)
                    if success:
                        updated_count += 1
                        saved_products.append({
                            "code": code,
                            "model_name": model_name,
                            "action": "updated"
                        })
                        logger.info(f"–û–±–Ω–æ–≤–ª–µ–Ω —Ç–æ–≤–∞—Ä —Å –∫–æ–¥–æ–º {code}")
                    else:
                        error_msg = f"–°—Ç—Ä–æ–∫–∞ {i+1}: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä —Å –∫–æ–¥–æ–º {code}"
                        errors.append(error_msg)
                        logger.warning(error_msg)
                else:
                    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä
                    try:
                        product_id = await database_manager.save_product(row_data)
                        saved_count += 1
                        saved_products.append({
                            "code": code,
                            "model_name": model_name,
                            "action": "created",
                            "id": product_id
                        })
                        logger.info(f"–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä —Å –∫–æ–¥–æ–º {code}, ID: {product_id}")
                    except Exception as save_error:
                        error_msg = f"–°—Ç—Ä–æ–∫–∞ {i+1}: –æ—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ —Å –∫–æ–¥–æ–º {code}: {save_error}"
                        errors.append(error_msg)
                        logger.error(error_msg)
                        
            except Exception as row_error:
                error_msg = f"–°—Ç—Ä–æ–∫–∞ {i+1}: –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: {row_error}"
                errors.append(error_msg)
                logger.error(error_msg)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç
        total_processed = saved_count + updated_count
        
        if total_processed > 0:
            logger.info(f"–£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ {total_processed} —Ç–æ–≤–∞—Ä–æ–≤: {saved_count} –Ω–æ–≤—ã—Ö, {updated_count} –æ–±–Ω–æ–≤–ª–µ–Ω–æ")
            log_recovery_attempt(
                component="server",
                action=f"–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ {total_processed} —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ Excel –≤ –ë–î",
                success=True
            )
            
            response = {
                "status": "success",
                "message": f"–£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ {total_processed} —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ Excel —Ñ–∞–π–ª–∞",
                "file_path": file_path,
                "start_row": start_row,
                "rows_requested": max_rows,
                "total_rows_parsed": len(data),
                "products_created": saved_count,
                "products_updated": updated_count,
                "total_processed": total_processed,
                "products_saved": saved_products,
                "parse_info": {
                    "sheet_name": parse_result.get("sheet_name"),
                    "columns": parse_result.get("columns"),
                    "available_sheets": parse_result.get("available_sheets"),
                    "data_range": f"—Å—Ç—Ä–æ–∫–∏ {start_row}-{start_row + len(data) - 1}" if start_row is not None else "–≤—Å–µ —Å—Ç—Ä–æ–∫–∏"
                },
                "timestamp": datetime.now().isoformat()
            }
            
            if errors:
                response["warnings"] = errors
                response["errors_count"] = len(errors)
                
            return response
        else:
            logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞")
            return {
                "status": "no_data",
                "message": "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞",
                "user_message": "–í—Å–µ —Å—Ç—Ä–æ–∫–∏ Excel —Ñ–∞–π–ª–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç –æ—à–∏–±–∫–∏ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è",
                "file_path": file_path,
                "start_row": start_row,
                "rows_requested": max_rows,
                "total_rows_parsed": len(data),
                "errors": errors,
                "errors_count": len(errors),
                "recoverable": True,
                "retry_suggested": True
            }
        
    except Exception as e:
        error_handler.log_error(
            error=e,
            category=ErrorCategory.DATABASE,
            severity=ErrorSeverity.HIGH,
            component="server",
            details={"tool": "parse_excel_and_save_to_database", "file_path": file_path},
            recovery_action="–í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"
        )
        return create_user_friendly_error(e, "–ø–∞—Ä—Å–∏–Ω–≥ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Excel —Ñ–∞–π–ª–∞")

# –§—É–Ω–∫—Ü–∏–∏ –∑–∞–ø—É—Å–∫–∞ MCP —Å–µ—Ä–≤–µ—Ä–∞ –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ä–µ–∂–∏–º–∞—Ö

async def run_stdio():
    """
    –ó–∞–ø—É—Å–∫ MCP —Å–µ—Ä–≤–µ—Ä–∞ –≤ STDIO —Ä–µ–∂–∏–º–µ.
    
    STDIO —Ä–µ–∂–∏–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å MCP –∫–ª–∏–µ–Ω—Ç–∞–º–∏ (Kiro, Cursor –∏ –¥—Ä.).
    –í —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ —Å–µ—Ä–≤–µ—Ä –æ–±—â–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ—Ç–æ–∫–∏ –≤–≤–æ–¥–∞/–≤—ã–≤–æ–¥–∞,
    —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç MCP –∫–ª–∏–µ–Ω—Ç–∞–º –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–µ—Ä–≤–µ—Ä –∫–∞–∫ –ø–æ–¥–ø—Ä–æ—Ü–µ—Å—Å.
    
    –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—Å–∫–∞:
    1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏
    2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã
    3. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
    4. –û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –æ—Ç MCP –∫–ª–∏–µ–Ω—Ç–∞
    """
    print("üöÄ –ó–∞–ø—É—Å–∫ MCP —Å–µ—Ä–≤–µ—Ä–∞ offers-check-marketplaces –≤ —Ä–µ–∂–∏–º–µ STDIO")
    print(f"üìã ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: {APP_ID}")
    print(f"üêç –í–µ—Ä—Å–∏—è Python: {sys.version}")
    print(f"üìÅ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {os.getcwd()}")
    print(f"üîß –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:")
    for key in ['HOST', 'PORT', 'DEBUG', 'LICENSE_KEY']:
        value = os.getenv(key, '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ')
        # –°–∫—Ä—ã–≤–∞–µ–º –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        if key == 'LICENSE_KEY' and value != '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ':
            value = value[:8] + "..." if len(value) > 8 else "***"
        print(f"   {key}: {value}")
    
    print("=" * 70)
    print("üè™ –°–ò–°–¢–ï–ú–ê –°–†–ê–í–ù–ï–ù–ò–Ø –¶–ï–ù –ù–ê –ú–ê–†–ö–ï–¢–ü–õ–ï–ô–°–ê–•")
    print("=" * 70)
    print("üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ü–µ–Ω")
    print("üõí –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã:")
    print("   ‚Ä¢ komus.ru (–ö–æ–º—É—Å) - –æ—Ñ–∏—Å–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã")
    print("   ‚Ä¢ vseinstrumenti.ru (–í—Å–µ–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã) - –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã")
    print("   ‚Ä¢ ozon.ru (–û–∑–æ–Ω) - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å")
    print("   ‚Ä¢ wildberries.ru (Wildberries) - —Ç–æ–≤–∞—Ä—ã —à–∏—Ä–æ–∫–æ–≥–æ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è")
    print("   ‚Ä¢ officemag.ru (–û—Ñ–∏—Å–º–∞–≥) - –æ—Ñ–∏—Å–Ω—ã–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏")
    print("=" * 70)
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã
    print("‚öôÔ∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã...")
    try:
        await initialize_components()
        print("‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: {e}")
        print("üí• –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏")
        sys.exit(1)
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
    print("üõ†Ô∏è –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:")
    print("   üìä –û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:")
    print("     1. get_product_details - –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ")
    print("     2. get_product_list - —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π")
    print("     3. save_product_prices - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ü–µ–Ω (5 —Ñ–æ—Ä–º–∞—Ç–æ–≤)")
    print("     4. get_statistics - –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
    print("   üìã Excel –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:")
    print("     5. parse_excel_and_save_to_database - –∑–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ Excel")
    print("     6. parse_excel_file - –ø–∞—Ä—Å–∏–Ω–≥ Excel —Ñ–∞–π–ª–æ–≤")
    print("     7. get_excel_info - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ Excel")
    print("     8. export_to_excel - —ç–∫—Å–ø–æ—Ä—Ç –≤ Excel —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º")
    print("     9. filter_excel_data - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö")
    print("     10. transform_excel_data - —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö")
    print("   üîê –õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:")
    print("     11. check_license_status - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏")
    print("     12. set_license_key - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞")
    print("=" * 70)
    
    print("üì° –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è MCP –∫–ª–∏–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ STDIO...")
    print("üí° –ì–æ—Ç–æ–≤ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–º–∞–Ω–¥ –æ—Ç –ò–ò-–∞–≥–µ–Ω—Ç–æ–≤!")
    await mcp.run_stdio_async()

async def run_sse_async(host: str, port: int):
    """
    –ó–∞–ø—É—Å–∫ MCP —Å–µ—Ä–≤–µ—Ä–∞ –≤ SSE (Server-Sent Events) —Ä–µ–∂–∏–º–µ.
    
    SSE —Ä–µ–∂–∏–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏ –æ—Ç–ª–∞–¥–∫–∏ MCP —Å–µ—Ä–≤–µ—Ä–∞.
    –í —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ HTTP —Å–µ—Ä–≤–µ—Ä –∏ –º–æ–∂–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å
    –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏–ª–∏ REST API.
    
    –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è:
    - –û—Ç–ª–∞–¥–∫–∏ MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
    - –í–µ–±-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
    - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
    - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞
    
    Args:
        host: IP –∞–¥—Ä–µ—Å –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
        port: –ü–æ—Ä—Ç –¥–ª—è HTTP —Å–µ—Ä–≤–µ—Ä–∞
    """
    print("üöÄ –ó–∞–ø—É—Å–∫ MCP —Å–µ—Ä–≤–µ—Ä–∞ offers-check-marketplaces –≤ —Ä–µ–∂–∏–º–µ SSE")
    print(f"üìã ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: {APP_ID}")
    print(f"üêç –í–µ—Ä—Å–∏—è Python: {sys.version}")
    print(f"üìÅ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {os.getcwd()}")
    print(f"üåê –•–æ—Å—Ç: {host}")
    print(f"üîå –ü–æ—Ä—Ç: {port}")
    print(f"üîó URL —Å–µ—Ä–≤–µ—Ä–∞: http://{host}:{port}")
    print(f"üîß –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:")
    for key in ['HOST', 'PORT', 'DEBUG', 'LICENSE_KEY']:
        value = os.getenv(key, '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ')
        # –°–∫—Ä—ã–≤–∞–µ–º –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        if key == 'LICENSE_KEY' and value != '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ':
            value = value[:8] + "..." if len(value) > 8 else "***"
        print(f"   {key}: {value}")
    
    print("=" * 70)
    print("üè™ –°–ò–°–¢–ï–ú–ê –°–†–ê–í–ù–ï–ù–ò–Ø –¶–ï–ù –ù–ê –ú–ê–†–ö–ï–¢–ü–õ–ï–ô–°–ê–• (SSE –†–ï–ñ–ò–ú)")
    print("=" * 70)
    print("üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –í–µ–±-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ –æ—Ç–ª–∞–¥–∫–∞ MCP —Å–µ—Ä–≤–µ—Ä–∞")
    print("üåê –î–æ—Å—Ç—É–ø: HTTP API –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤")
    print("üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è")
    print("=" * 70)
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã
    print("‚öôÔ∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã...")
    try:
        await initialize_components()
        print("‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: {e}")
        print("üí• –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏")
        sys.exit(1)
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
    print("üõ†Ô∏è –î–æ—Å—Ç—É–ø–Ω—ã–µ MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —á–µ—Ä–µ–∑ HTTP API:")
    print("   üìä –û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:")
    print("     ‚Ä¢ get_product_details - –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ")
    print("     ‚Ä¢ get_product_list - —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π")
    print("     ‚Ä¢ save_product_prices - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ü–µ–Ω (5 —Ñ–æ—Ä–º–∞—Ç–æ–≤)")
    print("     ‚Ä¢ get_statistics - –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
    print("   üìã Excel –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:")
    print("     ‚Ä¢ parse_excel_and_save_to_database - –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ Excel")
    print("     ‚Ä¢ parse_excel_file, get_excel_info, export_to_excel")
    print("     ‚Ä¢ filter_excel_data, transform_excel_data")
    print("   üîê –õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:")
    print("     ‚Ä¢ check_license_status, set_license_key")
    print("=" * 70)
    
    print("‚ö° –ó–∞–ø—É—Å–∫ Uvicorn HTTP —Å–µ—Ä–≤–µ—Ä–∞...")
    print(f"üåç –°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://{host}:{port}")
    print("üì° –ì–æ—Ç–æ–≤ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤!")
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ —Å–µ—Ä–≤–µ—Ä–∞ Uvicorn
    config = uvicorn.Config(starlette_app, host=host, port=port, log_level="info")
    server = uvicorn.Server(config)
    
    # –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –≤ —Ç–µ–∫—É—â–µ–º event loop
    await server.serve()

def run_sse(host: str, port: int):
    """
    –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ SSE —Å–µ—Ä–≤–µ—Ä–∞.
    
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç anyio –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ run_sse_async
    –≤ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ CLI –∫–æ–º–∞–Ω–¥—ã.
    """
    anyio.run(run_sse_async, host, port)

# –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ (CLI) –¥–ª—è –∑–∞–ø—É—Å–∫–∞ MCP —Å–µ—Ä–≤–µ—Ä–∞

@click.command()
@click.option("--sse", is_flag=True, 
              help="–ó–∞–ø—É—Å–∫ –≤ SSE —Ä–µ–∂–∏–º–µ –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é STDIO –¥–ª—è MCP –∫–ª–∏–µ–Ω—Ç–æ–≤)")
@click.option("--host", default=lambda: os.getenv("HOST", "0.0.0.0"),
              show_default=True, 
              help="IP –∞–¥—Ä–µ—Å –¥–ª—è SSE —Ä–µ–∂–∏–º–∞ (–º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é HOST)")
@click.option("--port", type=int, default=lambda: int(os.getenv("PORT", 8000)),
              show_default=True, 
              help="–ü–æ—Ä—Ç –¥–ª—è SSE —Ä–µ–∂–∏–º–∞ (–º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é PORT)")
def main(sse: bool, host: str, port: int):
    """
    MCP –°–µ—Ä–≤–µ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ü–µ–Ω –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö.
    
    –°–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è:
    ‚Ä¢ –ü–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö
    ‚Ä¢ –°—Ä–∞–≤–Ω–µ–Ω–∏—è —Ü–µ–Ω –º–µ–∂–¥—É —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏  
    ‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∫–∏ Excel —Ñ–∞–π–ª–æ–≤ —Å —Ç–æ–≤–∞—Ä–∞–º–∏
    ‚Ä¢ –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    ‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∏ —Ü–µ–Ω
    
    –†–µ–∂–∏–º—ã –∑–∞–ø—É—Å–∫–∞:
    ‚Ä¢ STDIO (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é): –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å MCP –∫–ª–∏–µ–Ω—Ç–∞–º–∏ (Kiro, Cursor)
    ‚Ä¢ SSE (--sse): –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏ –æ—Ç–ª–∞–¥–∫–∏ —á–µ—Ä–µ–∑ HTTP API
    
    –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
    ‚Ä¢ offers-check-marketplaces
    ‚Ä¢ offers-check-marketplaces --sse
    ‚Ä¢ offers-check-marketplaces --sse --host 127.0.0.1 --port 9000
    
    –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
    ‚Ä¢ LICENSE_KEY: –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
    ‚Ä¢ HOST: IP –∞–¥—Ä–µ—Å –¥–ª—è SSE —Ä–µ–∂–∏–º–∞
    ‚Ä¢ PORT: –ø–æ—Ä—Ç –¥–ª—è SSE —Ä–µ–∂–∏–º–∞
    ‚Ä¢ DEBUG: —É—Ä–æ–≤–µ–Ω—å –æ—Ç–ª–∞–¥–∫–∏
    """
    print("=" * 80)
    print("üöÄ –ó–ê–ü–£–°–ö MCP –°–ï–†–í–ï–†–ê –°–†–ê–í–ù–ï–ù–ò–Ø –¶–ï–ù –ù–ê –ú–ê–†–ö–ï–¢–ü–õ–ï–ô–°–ê–•")
    print("=" * 80)
    print(f"‚öôÔ∏è –†–µ–∂–∏–º –∑–∞–ø—É—Å–∫–∞: {'üåê SSE (Server-Sent Events)' if sse else 'üì° STDIO (MCP Protocol)'}")
    print(f"‚è∞ –í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"üñ•Ô∏è –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: {sys.platform}")
    print(f"üè† –î–æ–º–∞—à–Ω—è—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {os.path.expanduser('~')}")
    print(f"üì¶ –í–µ—Ä—Å–∏—è Python: {sys.version.split()[0]}")
    
    if sse:
        print(f"üåê –°–µ—Ç–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: {host}:{port}")
        print(f"üîó URL –¥–æ—Å—Ç—É–ø–∞: http://{host}:{port}")
    
    print("=" * 80)
    print("üéØ –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ü–µ–Ω —Ç–æ–≤–∞—Ä–æ–≤")
    print("üõí –ú–ê–†–ö–ï–¢–ü–õ–ï–ô–°–´: –ö–æ–º—É—Å, –í—Å–µ–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –û–∑–æ–Ω, Wildberries, –û—Ñ–∏—Å–º–∞–≥")
    print("ü§ñ –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø: MCP Protocol –¥–ª—è –ò–ò-–∞–≥–µ–Ω—Ç–æ–≤")
    print("=" * 80)
    
    # –ó–∞–ø—É—Å–∫ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º —Ä–µ–∂–∏–º–µ
    if sse:
        print("üåê –ó–∞–ø—É—Å–∫ –≤ SSE —Ä–µ–∂–∏–º–µ –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏...")
        run_sse(host, port)
    else:
        print("üì° –ó–∞–ø—É—Å–∫ –≤ STDIO —Ä–µ–∂–∏–º–µ –¥–ª—è MCP –∫–ª–∏–µ–Ω—Ç–æ–≤...")
        anyio.run(run_stdio)

if __name__ == "__main__":
    main()