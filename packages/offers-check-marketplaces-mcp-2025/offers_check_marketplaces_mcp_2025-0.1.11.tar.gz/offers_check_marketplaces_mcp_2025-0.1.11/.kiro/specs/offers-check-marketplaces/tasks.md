# План реализации

- [x] 1. Настройка структуры проекта и базовой конфигурации

  - Создать новую директорию `offers_check_marketplaces` на основе существующего `hello_mcp_server`
  - Скопировать базовую структуру MCP сервера и адаптировать для нового проекта
  - Обновить `pyproject.toml` с новым названием проекта и добавить зависимости для Excel, SQLite и pandas
  - Создать базовый `server.py` с FastMCP сервером и ID "offers-check-marketplaces"
  - Настроить `__init__.py` и `__main__.py` файлы для корректной инициализации нового пакета
  - _Требования: 1.1, 1.2_

- [x] 2. Реализация моделей данных и конфигурации

  - [x] 2.1 Создать модели данных в `models.py`

    - Реализовать dataclass Product с полной структурой полей из Excel
    - Создать dataclass SearchResult для результатов поиска на маркетплейсах
    - Реализовать dataclass Statistics для агрегированной статистики
    - _Требования: 2.1, 2.3_

  - [x] 2.2 Создать конфигурацию маркетплейсов в `marketplace_config.py`

    - Определить MARKETPLACE_CONFIGS с настройками для komus.ru, vseinstrumenti.ru, ozon.ru, wildberries.ru, officemag.ru
    - Включить URL, селекторы для цен и наличия, настройки rate limiting
    - Создать функции для получения конфигурации по названию маркетплейса
    - _Требования: 8.1, 8.6_

- [x] 3. Реализация менеджера базы данных

  - [x] 3.1 Создать `database_manager.py` с базовой функциональностью

    - Реализовать класс DatabaseManager с методами инициализации SQLite базы
    - Создать схему таблиц products и prices согласно проектированию
    - Реализовать методы создания индексов для оптимизации запросов
    - _Требования: 2.4_

  - [x] 3.2 Реализовать CRUD операции для продуктов

    - Создать методы save_product, update_product, get_product_by_code
    - Реализовать методы для работы с ценами: save_price, update_product_prices
    - Добавить обработку исключений SQLite с корректными сообщениями об ошибках
    - _Требования: 4.1, 7.4_

  - [x] 3.3 Реализовать методы для статистики

    - Создать метод get_statistics с агрегированными запросами
    - Реализовать подсчет товаров по категориям и покрытию маркетплейсов
    - Добавить расчет средних значений дельты цен
    - _Требования: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 4. Создание обработчика Excel данных

  - [x] 4.1 Реализовать `data_processor.py` для чтения Excel

    - Создать класс DataProcessor с методом load_excel_data
    - Реализовать парсинг Excel в JSON с точной структурой полей включая символы переноса строк
    - Добавить валидацию данных и обработку пустых ячеек
    - _Требования: 2.1, 2.2, 2.3_

  - [x] 4.2 Реализовать генерацию выходного Excel файла

    - Создать метод save_excel_data для записи результатов в Excel
    - Реализовать заполнение полей цен и расчет процентных дельт
    - Обеспечить сохранение исходной структуры с добавлением ценовых данных
    - _Требования: 6.1, 6.2, 6.3, 6.4, 6.5_

  - [x] 4.3 Добавить вспомогательные методы обработки данных

    - Реализовать calculate_price_delta для расчета процентных различий
    - Создать методы валидации структуры продуктов
    - Добавить обработку ошибок чтения/записи Excel файлов
    - _Требования: 7.3_

- [x] 5. Реализация клиента для взаимодействия с MCP Playwright

  - [x] 5.1 Создать `marketplace_client.py` для интеграции с Playwright

    - Реализовать класс MarketplaceClient для формирования запросов к MCP Playwright
    - Создать методы scrape_marketplace и extract_price_info
    - Реализовать format_playwright_request для корректной передачи параметров
    - _Требования: 3.2, 8.4, 8.7_

  - [x] 5.2 Реализовать обработку результатов веб-скрапинга

    - Создать методы парсинга HTML ответов от MCP Playwright
    - Реализовать извлечение цен, наличия и ссылок на товары
    - Добавить обработку ошибок скрапинга и недоступности маркетплейсов
    - _Требования: 3.3, 3.4, 7.1, 7.2_

- [x] 6. Создание поискового движка

  - [x] 6.1 Реализовать `search_engine.py` с основной логикой поиска

    - Создать класс SearchEngine с методом search_product
    - Реализовать определение приоритетных источников из данных продукта
    - Создать логику параллельного поиска на нескольких маркетплейсах
    - _Требования: 3.1, 3.5_

  - [x] 6.2 Интегрировать поисковый движок с клиентом маркетплейсов

    - Реализовать метод get_marketplace_price с использованием MarketplaceClient
    - Создать агрегацию результатов поиска с разных маркетплейсов
    - Добавить rate limiting для соблюдения ограничений маркетплейсов
    - _Требования: 8.4_

- [ ] 7. Реализация модуля статистики

  - [x] 7.1 Создать `statistics.py` для генерации отчетов

    - Реализовать класс StatisticsGenerator с методами расчета статистики
    - Создать методы для подсчета успешных совпадений и покрытия маркетплейсов
    - Реализовать расчет средних значений и разбивку по категориям
    - _Требования: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 8. Создание основного MCP сервера

  - [x] 8.1 Реализовать `server.py` с базовой структурой MCP сервера

    - Создать FastMCP сервер с ID "offers-check-marketplaces"
    - Настроить инициализацию всех компонентов системы
    - Реализовать системные промпты для ИИ-агента с описанием инструментов
    - _Требования: 1.1, 1.2, 9.1, 9.2_

  - [x] 8.2 Реализовать MCP инструмент search_products

    - Создать инструмент с декоратором @mcp.tool() для поиска товаров
    - Интегрировать с SearchEngine для выполнения поиска на маркетплейсах
    - Реализовать возврат структурированных данных с результатами поиска
    - _Требования: 3.1, 3.4_

  - [x] 8.3 Реализовать MCP инструмент get_product_details

    - Создать инструмент для получения детальной информации о товаре

    - Интегрировать с DatabaseManager для извлечения

данных продукта

- [x] 8.4 Реализовать MCP инструмент get_statistics

  - Создать инструмент для генерации статистики обработанных товаров

  - Интегрировать с StatisticsGenerator для расчета метрик
  - Реализовать возврат полной статистической информации
  - _Требования: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 9. Финальная интеграция и тестирование системы

  - [x] 9.1 Провести end-to-end тестирование с реальными данными

    - Протестировать полный цикл работы с файлом `data/Таблица на вход.xlsx`
    - Проверить генерацию корректного выходного файла с ценовыми данными
    - Убедиться в корректности работы всех MCP инструментов
    - _Требования: 2.1, 6.1, 6.5_
