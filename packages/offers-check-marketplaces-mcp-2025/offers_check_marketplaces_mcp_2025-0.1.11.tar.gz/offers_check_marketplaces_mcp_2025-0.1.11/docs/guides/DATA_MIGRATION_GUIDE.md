# Руководство по миграции данных

## Обзор

Система автоматически мигрирует пользовательские данные из старой директории `./data` в новое стандартное расположение, соответствующее операционной системе.

## Поведение по умолчанию

При первом запуске система:

1. Проверяет наличие директории `./data`
2. Анализирует её содержимое
3. Проверяет, не используются ли файлы в данный момент
4. Копирует данные в новое расположение
5. Переименовывает старую директорию в `data.migrated`

## Управление миграцией

### Отключение автоматической миграции

Чтобы отключить автоматическую миграцию, установите переменную окружения:

```bash
# Windows (CMD)
set OFFERS_CHECK_DISABLE_MIGRATION=true

# Windows (PowerShell)
$env:OFFERS_CHECK_DISABLE_MIGRATION="true"

# Linux/macOS
export OFFERS_CHECK_DISABLE_MIGRATION=true
```

### Кастомное расположение данных

Для использования собственного расположения данных:

```bash
# Windows (CMD)
set OFFERS_CHECK_DATA_DIR=C:\MyData\offers-check

# Windows (PowerShell)
$env:OFFERS_CHECK_DATA_DIR="C:\MyData\offers-check"

# Linux/macOS
export OFFERS_CHECK_DATA_DIR=/home/user/my-offers-data
```

## Защита от потери данных

### Проверка использования файлов

Система автоматически проверяет:

- Открыты ли Excel файлы (_.xlsx, _.xls, \*.xlsm)
- Используются ли файлы базы данных (_.db, _.sqlite)
- Присутствуют ли временные файлы (~$_, .~lock_, \*.tmp)

Если файлы используются, миграция откладывается.

### Безопасная миграция

- Данные копируются, а не перемещаются
- Исходные файлы сохраняются до завершения проверки целостности
- При ошибках выполняется автоматический откат
- Старая директория переименовывается только после успешной миграции

## Стандартные расположения

### Windows

```
%APPDATA%\offers-check-marketplaces\
├── database\     # Файлы базы данных
├── cache\        # Кеш и временные данные
├── logs\         # Файлы логов
└── temp\         # Временные файлы
```

### macOS

```
~/Library/Application Support/offers-check-marketplaces/
├── database\
└── temp\

~/Library/Caches/offers-check-marketplaces/
└── cache\

~/Library/Logs/offers-check-marketplaces/
└── logs\
```

### Linux

```
~/.local/share/offers-check-marketplaces/
├── database\
├── logs\
└── temp\

~/.cache/offers-check-marketplaces/
└── cache\
```

## Устранение проблем

### Миграция не выполняется

1. Проверьте, не открыты ли файлы в Excel или других программах
2. Закройте все программы, использующие файлы из директории `./data`
3. Удалите временные файлы (~$_, _.tmp)
4. Перезапустите программу

### Принудительная миграция

Если нужно выполнить миграцию принудительно:

1. Закройте все программы, использующие файлы
2. Удалите переменную `OFFERS_CHECK_DISABLE_MIGRATION`
3. Перезапустите программу

### Ручная миграция

Если автоматическая миграция не работает:

1. Скопируйте содержимое `./data` в новое расположение
2. Переименуйте `./data` в `data.migrated`
3. Перезапустите программу

## Восстановление данных

В случае проблем данные можно восстановить из:

- `data.migrated` - исходные файлы после миграции
- Нового расположения - мигрированные данные

Просто скопируйте нужные файлы обратно в рабочую директорию.
