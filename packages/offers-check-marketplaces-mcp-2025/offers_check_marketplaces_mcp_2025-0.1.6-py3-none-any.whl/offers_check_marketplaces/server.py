import os
import sys
import anyio
import click
import uvicorn
import logging
import asyncio
from datetime import datetime
from pathlib import Path
from typing import Optional, Dict, List, Any
from starlette.applications import Starlette
from starlette.routing import Mount
from mcp.server.fastmcp import FastMCP, Context

from .data_processor import DataProcessor
from .database_manager import DatabaseManager
from .search_engine import SearchEngine
from .statistics import StatisticsGenerator
from .marketplace_client import MarketplaceClient
from .marketplace_config import get_marketplace_config, get_all_marketplaces
from .license_manager import LicenseManager, check_license
from .excel_tools import ExcelTools
from .user_data_manager import UserDataManager
from .error_handling import (
    handle_errors,
    ErrorCategory,
    ErrorSeverity,
    create_user_friendly_error,
    get_error_summary,
    log_recovery_attempt
)

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

APP_ID = "offers-check-marketplaces"
mcp = FastMCP(APP_ID)

# Global component instances
user_data_manager: Optional[UserDataManager] = None
data_processor: Optional[DataProcessor] = None
database_manager: Optional[DatabaseManager] = None
search_engine: Optional[SearchEngine] = None
statistics_generator: Optional[StatisticsGenerator] = None
marketplace_client: Optional[MarketplaceClient] = None
excel_tools: Optional[ExcelTools] = None

async def initialize_components():
    """
    Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ Ð²ÑÐµ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹.
    
    Ð¡Ð¾Ð·Ð´Ð°ÐµÑ‚ ÑÐºÐ·ÐµÐ¼Ð¿Ð»ÑÑ€Ñ‹ Ð²ÑÐµÑ… Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ñ… ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð² Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÑ‚
    Ð¸Ñ… Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ. Ð¢Ð°ÐºÐ¶Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ….
    """
    global user_data_manager, data_processor, database_manager, search_engine, statistics_generator, marketplace_client, excel_tools
    
    try:
        logger.info("Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹...")
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¸ Ð¿ÐµÑ€ÐµÐ´ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÐµÐ¹
        logger.info("ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¾Ð½Ð½Ð¾Ð³Ð¾ ÐºÐ»ÑŽÑ‡Ð°...")
        is_valid, license_info = check_license()
        
        if not is_valid:
            error_msg = f"ÐÐµÐ´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ñ: {license_info.get('message', 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°')}"
            logger.error(error_msg)
            logger.error("ÐŸÑ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð° Ð±ÑƒÐ´ÐµÑ‚ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° Ð¸Ð·-Ð·Ð° Ð½ÐµÐ´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¹ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¸")
            print(f"ÐžÐ¨Ð˜Ð‘ÐšÐ: {error_msg}")
            print("ÐŸÑ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡.")
            sys.exit(1)
        
        logger.info("Ð›Ð¸Ñ†ÐµÐ½Ð·Ð¸Ñ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°, Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÐ¼ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ...")
        
        # Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
        logger.info("Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…...")
        user_data_manager = UserDataManager()
        user_data_manager.initialize_directories()
        
        # Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
        logger.info("Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…...")
        data_processor = DataProcessor()
        
        logger.info("Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ð° Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…...")
        database_manager = DatabaseManager(user_data_manager)
        await database_manager.init_database()
        
        logger.info("Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ¾Ð²...")
        marketplace_client = MarketplaceClient()
        
        logger.info("Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ð¾Ð¸ÑÐºÐ¾Ð²Ð¾Ð³Ð¾ Ð´Ð²Ð¸Ð¶ÐºÐ°...")
        search_engine = SearchEngine()
        
        logger.info("Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸...")
        statistics_generator = StatisticsGenerator(database_manager)
        
        logger.info("Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Excel Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²...")
        excel_tools = ExcelTools()
        
        logger.info("Ð’ÑÐµ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹")
        
    except Exception as e:
        logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²: {e}")
        raise

# Minimal Starlette app for SSE
starlette_app = Starlette(routes=[Mount("/", app=mcp.sse_app())])

# System prompt for AI agent
# Ð’ÐÐ–ÐÐž: Ð­Ñ‚Ð¾Ñ‚ Ð¿Ñ€Ð¾Ð¼Ñ‚ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð²Ð°Ð¶Ð½Ñ‹Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ð˜Ð˜-Ð°Ð³ÐµÐ½Ñ‚Ð°
# Ð¾ Ñ‚Ð¾Ð¼, ÐºÐ°Ðº Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÑŒ Ñ†ÐµÐ½Ñ‹ Ñ Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ¾Ð². ÐÐ• Ð£Ð”ÐÐ›Ð¯Ð™Ð¢Ð• Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ñ
# Ð¾ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ñ‚ÑŒ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð², Ð° Ð½Ðµ Ð±Ñ€Ð°Ñ‚ÑŒ Ñ†ÐµÐ½Ñ‹ Ð¸Ð· Ð¿Ð¾Ð¸ÑÐºÐ¾Ð²Ð¾Ð¹ Ð²Ñ‹Ð´Ð°Ñ‡Ð¸!
SYSTEM_PROMPT = """
# MCP Ð¡ÐµÑ€Ð²ÐµÑ€ "offers-check-marketplaces"

Ð’Ñ‹ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚Ðµ Ñ MCP ÑÐµÑ€Ð²ÐµÑ€Ð¾Ð¼ offers-check-marketplaces, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ Ð¿Ð¾Ð¸ÑÐº Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² 
Ð¸ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ Ñ†ÐµÐ½ Ð½Ð° Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð½Ñ‹Ñ… Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ°Ñ…. Ð­Ñ‚Ð¾Ñ‚ ÑÐµÑ€Ð²ÐµÑ€ ÑÐ²Ð»ÑÐµÑ‚ÑÑ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð¸Ñ€ÑƒÑŽÑ‰Ð¸Ð¼ Ñ†ÐµÐ½Ñ‚Ñ€Ð¾Ð¼ Ð´Ð»Ñ 
Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ñ€Ñ‹Ð½Ð¾Ñ‡Ð½Ñ‹Ñ… Ñ†ÐµÐ½ Ð¸ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑÐ½Ñ‹Ñ… Ð¾Ñ‚Ñ‡ÐµÑ‚Ð¾Ð².

## ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜ Ð’ÐÐ–ÐÐž: ÐŸÐ ÐÐ’Ð˜Ð›Ð ÐŸÐžÐ›Ð£Ð§Ð•ÐÐ˜Ð¯ Ð¦Ð•Ð

âš ï¸ **ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐžÐ• Ð¢Ð Ð•Ð‘ÐžÐ’ÐÐÐ˜Ð•**: Ð¦ÐµÐ½Ñ‹ Ð”ÐžÐ›Ð–ÐÐ« Ð±Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ñ‹ Ð¢ÐžÐ›Ð¬ÐšÐž Ñ Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ñ… ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ† Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð½Ð° Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ°Ñ…, ÐÐ• Ð¸Ð· Ð¿Ð¾Ð¸ÑÐºÐ¾Ð²Ð¾Ð¹ Ð²Ñ‹Ð´Ð°Ñ‡Ð¸!

### Ð—ÐÐŸÐ Ð•Ð©Ð•ÐÐž:
- âŒ Ð‘Ñ€Ð°Ñ‚ÑŒ Ñ†ÐµÐ½Ñ‹ Ð¸Ð· Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² Ð¿Ð¾Ð¸ÑÐºÐ° Google/Yandex
- âŒ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ñ†ÐµÐ½Ñ‹ Ð¸Ð· Ð¿Ð¾Ð¸ÑÐºÐ¾Ð²Ñ‹Ñ… ÑÐ½Ð¸Ð¿Ð¿ÐµÑ‚Ð¾Ð²
- âŒ ÐŸÐ¾Ð»Ð°Ð³Ð°Ñ‚ÑŒÑÑ Ð½Ð° Ð°Ð³Ñ€ÐµÐ³Ð°Ñ‚Ð¾Ñ€Ñ‹ Ñ†ÐµÐ½
- âŒ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð¸ÑÐºÐ¾Ð²Ñ‹Ñ… ÑÐ¸ÑÑ‚ÐµÐ¼

### ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐž:
- âœ… ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ñ‚ÑŒ Ð½Ð° ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½ÑƒÑŽ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð½Ð° Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐµ
- âœ… ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ HTML-ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
- âœ… Ð˜Ð·Ð²Ð»ÐµÐºÐ°Ñ‚ÑŒ Ñ†ÐµÐ½Ñƒ Ð½ÐµÐ¿Ð¾ÑÑ€ÐµÐ´ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ ÑÐ¾ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
- âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑ‚ÑŒ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
- âœ… Ð£Ñ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ñ‚ÑŒ ÑÐºÐ¸Ð´ÐºÐ¸, Ð°ÐºÑ†Ð¸Ð¸ Ð¸ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
- âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑ‚ÑŒ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ð¾Ð³Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð¸ÑÐºÐ¾Ð¼Ð¾Ð¼Ñƒ

### ÐÐ›Ð“ÐžÐ Ð˜Ð¢Ðœ ÐŸÐžÐ˜Ð¡ÐšÐ Ð¦Ð•Ð:

1. **ÐŸÐ¾Ð¸ÑÐº Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð½Ð° Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐµ**:
   - Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ð²Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½Ð¸Ð¹ Ð¿Ð¾Ð¸ÑÐº Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ°
   - ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ Ð½Ð°Ð¸Ð±Ð¾Ð»ÐµÐµ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ÑÑ‰Ð¸Ð¹ Ñ‚Ð¾Ð²Ð°Ñ€ Ð¿Ð¾ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÑŽ/Ð°Ñ€Ñ‚Ð¸ÐºÑƒÐ»Ñƒ
   - Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ Ð² ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ð¸ Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¸ÑÑ‚Ð¸Ðº

2. **ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ Ñ‚Ð¾Ð²Ð°Ñ€Ð°**:
   - ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¿ÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
   - ÐÐ• Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ñ†ÐµÐ½Ñ‹ Ð¸Ð· Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² Ð¿Ð¾Ð¸ÑÐºÐ° Ð½Ð° ÑÐ°Ð¹Ñ‚Ðµ
   - Ð”Ð¾Ð¶Ð´Ð¸Ñ‚ÐµÑÑŒ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹

3. **Ð˜Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ Ñ†ÐµÐ½Ñ‹**:
   - ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½ÑƒÑŽ Ñ†ÐµÐ½Ñƒ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
   - Ð£Ñ‡Ñ‚Ð¸Ñ‚Ðµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ ÑÐºÐ¸Ð´ÐºÐ¸ Ð¸ Ð°ÐºÑ†Ð¸Ð¸
   - ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð² Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ðµ
   - Ð—Ð°Ñ„Ð¸ÐºÑÐ¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð²Ð°Ð»ÑŽÑ‚Ñƒ Ñ†ÐµÐ½Ñ‹

4. **Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…**:
   - Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ð¹ Ñ‚Ð¾Ð²Ð°Ñ€ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð¸ÑÐºÐ¾Ð¼Ð¾Ð¼Ñƒ
   - ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ€Ð°Ð·ÑƒÐ¼Ð½Ð¾ÑÑ‚ÑŒ Ñ†ÐµÐ½Ñ‹ (Ð½Ðµ Ð´Ð¾Ð»Ð¶Ð½Ð° ÐºÐ°Ñ€Ð´Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾ Ð¾Ñ‚Ð»Ð¸Ñ‡Ð°Ñ‚ÑŒÑÑ Ð¾Ñ‚ Ð¾Ð¶Ð¸Ð´Ð°ÐµÐ¼Ð¾Ð¹)
   - Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚Ðµ URL ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð´Ð»Ñ Ð²ÐµÑ€Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸

### Ð¢Ð•Ð¥ÐÐ˜Ð§Ð•Ð¡ÐšÐ˜Ð• Ð¢Ð Ð•Ð‘ÐžÐ’ÐÐÐ˜Ð¯:

- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ MCP Playwright Ð´Ð»Ñ Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ ÑÐ°Ð¹Ñ‚Ð°Ð¼
- ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°Ð¹Ñ‚Ðµ Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ (JavaScript)
- Ð£Ñ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ð¹Ñ‚Ðµ Ð°Ð½Ñ‚Ð¸Ð±Ð¾Ñ‚-Ð·Ð°Ñ‰Ð¸Ñ‚Ñƒ ÑÐ°Ð¹Ñ‚Ð¾Ð²
- Ð¡Ð¾Ð±Ð»ÑŽÐ´Ð°Ð¹Ñ‚Ðµ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ¸ Ð¼ÐµÐ¶Ð´Ñƒ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°Ð¼Ð¸
- Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐ¹Ñ‚Ðµ ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚Ñ‹ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ† Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸

## Ð”ÐžÐ¡Ð¢Ð£ÐŸÐÐ«Ð• Ð˜ÐÐ¡Ð¢Ð Ð£ÐœÐ•ÐÐ¢Ð«

### 1. get_product_details(product_code: float)
ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ðµ Ð¿Ð¾ ÐºÐ¾Ð´Ñƒ Ð¸Ð· Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ….
- **ÐŸÑ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÑ‚**: ÐºÐ¾Ð´ Ñ‚Ð¾Ð²Ð°Ñ€Ð° (Ñ‡Ð¸ÑÐ»Ð¾)
- **Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚**: Ð¿Ð¾Ð»Ð½ÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ðµ, Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ Ñ†ÐµÐ½Ñ‹, Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð½Ñ‹Ðµ Ð´ÐµÐ»ÑŒÑ‚Ñ‹
- **ÐžÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸**:
  - Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ, ÐµÐ´Ð¸Ð½Ð¸Ñ†Ñƒ Ð¸Ð·Ð¼ÐµÑ€ÐµÐ½Ð¸Ñ, Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ð½Ñ‹Ðµ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ¸
  - ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ Ñ†ÐµÐ½ Ð¼ÐµÐ¶Ð´Ñƒ Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ°Ð¼Ð¸
  - Ð Ð°ÑÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð½Ñ‹Ðµ Ð´ÐµÐ»ÑŒÑ‚Ñ‹ Ð¼ÐµÐ¶Ð´Ñƒ Ñ†ÐµÐ½Ð°Ð¼Ð¸
  - ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÑ‚ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¸ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ñ†ÐµÐ½Ñ‹

**ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ**:
```
get_product_details(195385.0)
```

**ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¾Ñ‚Ð²ÐµÑ‚Ð°**:
```json
{
  "status": "success",
  "product": {
    "code": 195385.0,
    "model_name": "ÐŸÐ¾Ð»Ð¾Ñ‚Ð½Ð¾ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð‘Ð¯Ð—Ð¬ ÐžÐ¢Ð‘Ð•Ð›Ð•ÐÐÐÐ¯ Ð“ÐžÐ¡Ð¢, Ñ€ÑƒÐ»Ð¾Ð½ 1,5Ñ…50 Ð¼",
    "category": "Ð¥Ð¾Ð·Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ Ð¸ Ð¿Ð¾ÑÑƒÐ´Ð°",
    "unit": "Ð¼",
    "priority_1_source": "ÐšÐ¾Ð¼ÑƒÑ",
    "priority_2_source": "Ð’ÑÐµÐ˜Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹"
  },
  "prices": [
    {
      "marketplace": "komus.ru",
      "price": 1250.0,
      "currency": "RUB",
      "availability": "Ð² Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ð¸",
      "product_url": "https://www.komus.ru/product/12345",
      "scraped_at": "2023-07-21T15:30:45"
    },
    {
      "marketplace": "vseinstrumenti.ru",
      "price": 1320.0,
      "currency": "RUB",
      "availability": "Ð² Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ð¸",
      "product_url": "https://www.vseinstrumenti.ru/product/67890",
      "scraped_at": "2023-07-21T15:30:50"
    }
  ],
  "price_analysis": {
    "min_price": {
      "value": 1250.0,
      "marketplace": "komus.ru"
    },
    "max_price": {
      "value": 1320.0,
      "marketplace": "vseinstrumenti.ru"
    },
    "delta_percent": 5.6
  }
}
```

### 2. get_product_list()
ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÐ¿Ð¸ÑÐºÐ° Ð²ÑÐµÑ… SKU Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð¸Ð· Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ….
- **ÐŸÑ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÑ‚**: Ð½Ð¸Ñ‡ÐµÐ³Ð¾
- **Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚**: ÑÐ¿Ð¸ÑÐ¾Ðº Ð²ÑÐµÑ… Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ñ Ð¸Ñ… SKU Ð¸ Ð±Ð°Ð·Ð¾Ð²Ð¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹
- **ÐžÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸**:
  - Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð²ÑÐµ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ Ð¸Ð· Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
  - Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ SKU, Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð¼Ð¾Ð´ÐµÐ»Ð¸, ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ Ð¸ ÐµÐ´Ð¸Ð½Ð¸Ñ†Ñƒ Ð¸Ð·Ð¼ÐµÑ€ÐµÐ½Ð¸Ñ
  - ÐŸÐ¾Ð»ÐµÐ·Ð½Ð¾ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾ ÑÐ¿Ð¸ÑÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²
  - ÐœÐ¾Ð¶Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð´Ð»Ñ Ð¿Ð¾ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ð¿Ð¾Ð¸ÑÐºÐ° ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ñ… Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²

**ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ**:
```
get_product_list()
```

**ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¾Ñ‚Ð²ÐµÑ‚Ð°**:
```json
{
  "status": "success",
  "products": [
    {
      "sku": 195385.0,
      "model_name": "ÐŸÐ¾Ð»Ð¾Ñ‚Ð½Ð¾ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð‘Ð¯Ð—Ð¬ ÐžÐ¢Ð‘Ð•Ð›Ð•ÐÐÐÐ¯ Ð“ÐžÐ¡Ð¢, Ñ€ÑƒÐ»Ð¾Ð½ 1,5Ñ…50 Ð¼",
      "category": "Ð¥Ð¾Ð·Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ Ð¸ Ð¿Ð¾ÑÑƒÐ´Ð°",
      "unit": "Ð¼"
    },
    {
      "sku": 195386.0,
      "model_name": "Ð‘ÑƒÐ¼Ð°Ð³Ð° Ð¾Ñ„Ð¸ÑÐ½Ð°Ñ Ð4 80Ð³/Ð¼2",
      "category": "ÐšÐ°Ð½Ñ†ÐµÐ»ÑÑ€ÑÐºÐ¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹",
      "unit": "Ð¿Ð°Ñ‡ÐºÐ°"
    }
  ],
  "total_count": 150,
  "timestamp": "2023-07-21T16:45:30"
}
```

### 3. get_statistics()
ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ð¿Ð¾ Ð²ÑÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ð¼ Ñ‚Ð¾Ð²Ð°Ñ€Ð°Ð¼.
- **ÐŸÑ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÑ‚**: Ð½Ð¸Ñ‡ÐµÐ³Ð¾
- **Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚**: ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑÐ½ÑƒÑŽ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ Ð¿Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ð¼ Ñ‚Ð¾Ð²Ð°Ñ€Ð°Ð¼
- **ÐžÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸**:
  - ÐžÐ±Ñ‰ÐµÐµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ñ… Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²
  - ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ð¼Ð¸ ÑÐ¾Ð²Ð¿Ð°Ð´ÐµÐ½Ð¸ÑÐ¼Ð¸ Ñ†ÐµÐ½
  - Ð¡Ñ€ÐµÐ´Ð½Ð¸Ðµ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð½Ñ‹Ðµ Ð´ÐµÐ»ÑŒÑ‚Ñ‹ Ñ†ÐµÐ½
  - Ð Ð°Ð·Ð±Ð¸Ð²ÐºÐ° Ð¿Ð¾ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑÐ¼ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²
  - Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ð¸ Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ¾Ð²

**ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ**:
```
get_statistics()
```

**ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¾Ñ‚Ð²ÐµÑ‚Ð°**:
```json
{
  "status": "success",
  "statistics": {
    "total_products": 150,
    "products_with_prices": 132,
    "average_delta_percent": 7.8,
    "category_breakdown": {
      "Ð¥Ð¾Ð·Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ Ð¸ Ð¿Ð¾ÑÑƒÐ´Ð°": 45,
      "ÐšÐ°Ð½Ñ†ÐµÐ»ÑÑ€ÑÐºÐ¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹": 38,
      "ÐžÑ„Ð¸ÑÐ½Ð°Ñ Ñ‚ÐµÑ…Ð½Ð¸ÐºÐ°": 27,
      "ÐœÐµÐ±ÐµÐ»ÑŒ": 22,
      "ÐŸÑ€Ð¾Ñ‡ÐµÐµ": 18
    },
    "marketplace_coverage": {
      "komus.ru": 128,
      "vseinstrumenti.ru": 95,
      "ozon.ru": 112,
      "wildberries.ru": 87,
      "officemag.ru": 76
    }
  },
  "timestamp": "2023-07-21T16:45:30"
}
```

## ÐŸÐžÐ”Ð”Ð•Ð Ð–Ð˜Ð’ÐÐ•ÐœÐ«Ð• ÐœÐÐ ÐšÐ•Ð¢ÐŸÐ›Ð•Ð™Ð¡Ð«

### ÐžÐ¡ÐÐžÐ’ÐÐ«Ð• ÐœÐÐ ÐšÐ•Ð¢ÐŸÐ›Ð•Ð™Ð¡Ð«:

1. **komus.ru** (ÐšÐ¾Ð¼ÑƒÑ) - Ð¾Ñ„Ð¸ÑÐ½Ñ‹Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ Ð¸ ÐºÐ°Ð½Ñ†ÐµÐ»ÑÑ€Ð¸Ñ
   - URL Ð¿Ð¾Ð¸ÑÐºÐ°: `https://www.komus.ru/search/?q={query}`
   - Ð¡ÐµÐ»ÐµÐºÑ‚Ð¾Ñ€ Ñ†ÐµÐ½Ñ‹: `.price-current, .product-price`
   - ÐžÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸: Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ Ñ‚Ð¾Ð²Ð°Ñ€Ð°

2. **vseinstrumenti.ru** (Ð’ÑÐµÐ˜Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹) - Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð¸ Ð¾Ð±Ð¾Ñ€ÑƒÐ´Ð¾Ð²Ð°Ð½Ð¸Ðµ
   - URL Ð¿Ð¾Ð¸ÑÐºÐ°: `https://www.vseinstrumenti.ru/search/?what={query}`
   - Ð¡ÐµÐ»ÐµÐºÑ‚Ð¾Ñ€ Ñ†ÐµÐ½Ñ‹: `.ui-price-current, .product-buy__price`
   - ÐžÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸: Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ†ÐµÐ½

3. **ozon.ru** (ÐžÐ·Ð¾Ð½) - ÑƒÐ½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹Ñ
   - URL Ð¿Ð¾Ð¸ÑÐºÐ°: `https://www.ozon.ru/search/?text={query}`
   - Ð¡ÐµÐ»ÐµÐºÑ‚Ð¾Ñ€ Ñ†ÐµÐ½Ñ‹: `[data-widget="webPrice"], .price-current`
   - ÐžÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸: ÑÐ¸Ð»ÑŒÐ½Ð°Ñ Ð°Ð½Ñ‚Ð¸Ð±Ð¾Ñ‚-Ð·Ð°Ñ‰Ð¸Ñ‚Ð°, Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð¾ÑÑ‚Ð¾Ñ€Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸

4. **wildberries.ru** (Wildberries) - Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ ÑˆÐ¸Ñ€Ð¾ÐºÐ¾Ð³Ð¾ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð»ÐµÐ½Ð¸Ñ
   - URL Ð¿Ð¾Ð¸ÑÐºÐ°: `https://www.wildberries.ru/catalog/0/search.aspx?search={query}`
   - Ð¡ÐµÐ»ÐµÐºÑ‚Ð¾Ñ€ Ñ†ÐµÐ½Ñ‹: `.price-block__final-price, .product-page__price`
   - ÐžÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸: Ñ†ÐµÐ½Ñ‹ Ð¼Ð¾Ð³ÑƒÑ‚ Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð°Ñ‚ÑŒÑÑ Ð¿Ð¾ Ñ€ÐµÐ³Ð¸Ð¾Ð½Ð°Ð¼

5. **officemag.ru** (ÐžÑ„Ð¸ÑÐ¼Ð°Ð³) - Ð¾Ñ„Ð¸ÑÐ½Ñ‹Ðµ Ð¿Ñ€Ð¸Ð½Ð°Ð´Ð»ÐµÐ¶Ð½Ð¾ÑÑ‚Ð¸
   - URL Ð¿Ð¾Ð¸ÑÐºÐ°: `https://www.officemag.ru/search/?q={query}`
   - Ð¡ÐµÐ»ÐµÐºÑ‚Ð¾Ñ€ Ñ†ÐµÐ½Ñ‹: `.price, .product-price__current`
   - ÐžÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸: Ð¿Ñ€Ð¾ÑÑ‚Ð°Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°, Ð½Ð°Ð´ÐµÐ¶Ð½Ñ‹Ð¹ Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³

### Ð’ÐÐ–ÐÐ«Ð• Ð¢Ð•Ð¥ÐÐ˜Ð§Ð•Ð¡ÐšÐ˜Ð• Ð”Ð•Ð¢ÐÐ›Ð˜:

- **ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ User-Agent**: `Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36`
- **Ð¡Ð¾Ð±Ð»ÑŽÐ´Ð°Ð¹Ñ‚Ðµ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ¸**: Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ 2-3 ÑÐµÐºÑƒÐ½Ð´Ñ‹ Ð¼ÐµÐ¶Ð´Ñƒ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°Ð¼Ð¸
- **ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐ¹Ñ‚Ðµ ÐºÐ°Ð¿Ñ‡Ð¸**: Ð¿Ñ€Ð¸ Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð¸Ð¸ - ÑÐ¾Ð¾Ð±Ñ‰Ð°Ð¹Ñ‚Ðµ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ
- **Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐ¹Ñ‚Ðµ cookies**: Ð´Ð»Ñ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ð¹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ ÑÐµÑÑÐ¸ÑÐ¼Ð¸

### Ð”Ð•Ð¢ÐÐ›Ð¬ÐÐ«Ð• Ð˜ÐÐ¡Ð¢Ð Ð£ÐšÐ¦Ð˜Ð˜ ÐŸÐž ÐœÐÐ ÐšÐ•Ð¢ÐŸÐ›Ð•Ð™Ð¡ÐÐœ:

#### KOMUS.RU - ÐŸÐ¾ÑˆÐ°Ð³Ð¾Ð²Ñ‹Ð¹ Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼:
```
1. ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ https://www.komus.ru
2. ÐÐ°Ð¹Ñ‚Ð¸ Ð¿Ð¾Ð¸ÑÐºÐ¾Ð²ÑƒÑŽ ÑÑ‚Ñ€Ð¾ÐºÑƒ (Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ Ð² ÑˆÐ°Ð¿ÐºÐµ ÑÐ°Ð¹Ñ‚Ð°)
3. Ð’Ð²ÐµÑÑ‚Ð¸ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
4. Ð”Ð¾Ð¶Ð´Ð°Ñ‚ÑŒÑÑ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² Ð¿Ð¾Ð¸ÑÐºÐ°
5. ÐšÐ»Ð¸ÐºÐ½ÑƒÑ‚ÑŒ Ð½Ð° ÐŸÐ•Ð Ð’Ð«Ð™ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ÑÑ‰Ð¸Ð¹ Ñ‚Ð¾Ð²Ð°Ñ€
6. ÐÐ° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð½Ð°Ð¹Ñ‚Ð¸ Ñ†ÐµÐ½Ñƒ (ÑÐµÐ»ÐµÐºÑ‚Ð¾Ñ€Ñ‹: .price-current, .product-price)
7. ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
8. Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ URL ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
```

#### VSEINSTRUMENTI.RU - ÐŸÐ¾ÑˆÐ°Ð³Ð¾Ð²Ñ‹Ð¹ Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼:
```
1. ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ https://www.vseinstrumenti.ru
2. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾Ð¸ÑÐº Ð² ÑˆÐ°Ð¿ÐºÐµ ÑÐ°Ð¹Ñ‚Ð°
3. Ð’Ð²ÐµÑÑ‚Ð¸ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
4. Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð½Ð°Ð¸Ð±Ð¾Ð»ÐµÐµ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ÑÑ‰Ð¸Ð¹ Ñ‚Ð¾Ð²Ð°Ñ€ Ð¸Ð· Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²
5. ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
6. Ð”Ð¾Ð¶Ð´Ð°Ñ‚ÑŒÑÑ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ†ÐµÐ½Ñ‹ (Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿Ð¾Ð´Ð³Ñ€ÑƒÐ¶Ð°Ñ‚ÑŒÑÑ Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸)
7. Ð˜Ð·Ð²Ð»ÐµÑ‡ÑŒ Ñ†ÐµÐ½Ñƒ (.ui-price-current, .product-buy__price)
8. ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ Ð´Ð»Ñ Ð·Ð°ÐºÐ°Ð·Ð°
```

#### OZON.RU - ÐžÑÐ¾Ð±Ñ‹Ðµ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ:
```
âš ï¸ Ð’ÐÐ˜ÐœÐÐÐ˜Ð•: Ð¡Ð¸Ð»ÑŒÐ½Ð°Ñ Ð°Ð½Ñ‚Ð¸Ð±Ð¾Ñ‚-Ð·Ð°Ñ‰Ð¸Ñ‚Ð°!
1. ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ https://www.ozon.ru
2. ÐŸÐ¾Ð´Ð¾Ð¶Ð´Ð°Ñ‚ÑŒ 3-5 ÑÐµÐºÑƒÐ½Ð´ Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸
3. ÐÐ°Ð¹Ñ‚Ð¸ Ð¿Ð¾Ð¸ÑÐºÐ¾Ð²ÑƒÑŽ ÑÑ‚Ñ€Ð¾ÐºÑƒ
4. ÐœÐµÐ´Ð»ÐµÐ½Ð½Ð¾ Ð²Ð²ÐµÑÑ‚Ð¸ Ð·Ð°Ð¿Ñ€Ð¾Ñ (Ð¸Ð¼Ð¸Ñ‚Ð°Ñ†Ð¸Ñ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ°)
5. ÐŸÐ¾Ð´Ð¾Ð¶Ð´Ð°Ñ‚ÑŒ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð¿Ð¾Ð¸ÑÐºÐ°
6. ÐžÑÑ‚Ð¾Ñ€Ð¾Ð¶Ð½Ð¾ ÐºÐ»Ð¸ÐºÐ½ÑƒÑ‚ÑŒ Ð½Ð° Ñ‚Ð¾Ð²Ð°Ñ€
7. Ð”Ð¾Ð¶Ð´Ð°Ñ‚ÑŒÑÑ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
8. Ð˜Ð·Ð²Ð»ÐµÑ‡ÑŒ Ñ†ÐµÐ½Ñƒ ([data-widget="webPrice"], .price-current)
```

#### WILDBERRIES.RU - Ð ÐµÐ³Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸:
```
1. ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ https://www.wildberries.ru
2. ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ñ€ÐµÐ³Ð¸Ð¾Ð½ (Ð¼Ð¾Ð¶ÐµÑ‚ Ð²Ð»Ð¸ÑÑ‚ÑŒ Ð½Ð° Ñ†ÐµÐ½Ñƒ)
3. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾Ð¸ÑÐº
4. Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€ Ð¸Ð· Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²
5. ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð½Ð° ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÑƒ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
6. Ð£Ñ‡ÐµÑÑ‚ÑŒ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ ÑÐºÐ¸Ð´ÐºÐ¸ Ð¸ Ð°ÐºÑ†Ð¸Ð¸
7. Ð˜Ð·Ð²Ð»ÐµÑ‡ÑŒ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½ÑƒÑŽ Ñ†ÐµÐ½Ñƒ (.price-block__final-price)
```

#### OFFICEMAG.RU - ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼:
```
1. ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ https://www.officemag.ru
2. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾Ð¸ÑÐº
3. Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€
4. ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
5. Ð˜Ð·Ð²Ð»ÐµÑ‡ÑŒ Ñ†ÐµÐ½Ñƒ (.price, .product-price__current)
6. ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð½Ð° ÑÐºÐ»Ð°Ð´Ðµ
```

ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¼Ð¾Ð¶ÐµÑ‚ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¿Ñ€Ð¾Ð¼Ñ‚Ð°Ð¼Ð¸, Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°Ð¼Ð¸ Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð¾Ð¼ Ð² Ñ‡Ð°Ñ‚Ðµ.

## Ð ÐÐ‘ÐžÐ§Ð˜Ð™ ÐŸÐ ÐžÐ¦Ð•Ð¡Ð¡

### Ð­Ñ‚Ð°Ð¿ 1: ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…
- Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ñ‡Ð¸Ñ‚Ð°ÐµÑ‚ Ð²Ñ…Ð¾Ð´Ð½Ð¾Ð¹ Excel Ñ„Ð°Ð¹Ð» `Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð½Ð° Ð²Ñ…Ð¾Ð´.xlsx`
- Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð°Ñ€ÑÑÑ‚ÑÑ Ð² JSON Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸ÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ð¿Ð¾Ð»ÐµÐ¹
- Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ÑÑ Ð² SQLite Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ ÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²

### Ð­Ñ‚Ð°Ð¿ 2: ÐŸÐ¾Ð¸ÑÐº Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² ÐÐ ÐœÐÐ ÐšÐ•Ð¢ÐŸÐ›Ð•Ð™Ð¡ÐÐ¥
âš ï¸ **ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜ Ð’ÐÐ–ÐÐž**: ÐŸÐ¾Ð¸ÑÐº Ñ†ÐµÐ½ Ð¢ÐžÐ›Ð¬ÐšÐž Ð½Ð° Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ñ… ÑÐ°Ð¹Ñ‚Ð°Ñ… Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ¾Ð²!

**ÐÐ»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼ Ð¿Ð¾Ð¸ÑÐºÐ° Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð°:**

1. **ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ð½Ñ‹Ñ… Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ¾Ð²** Ð¸Ð· Excel Ñ„Ð°Ð¹Ð»Ð°
2. **ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð½Ð° Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹Ñ** Ñ‡ÐµÑ€ÐµÐ· MCP Playwright:
   ```
   - ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð³Ð»Ð°Ð²Ð½ÑƒÑŽ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ°
   - Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð²Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½Ð¸Ð¹ Ð¿Ð¾Ð¸ÑÐº ÑÐ°Ð¹Ñ‚Ð°
   - ÐÐ• Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Google/Yandex Ð¿Ð¾Ð¸ÑÐº!
   ```

3. **ÐŸÐ¾Ð¸ÑÐº Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð½Ð° ÑÐ°Ð¹Ñ‚Ðµ Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ°**:
   ```
   - Ð’Ð²ÐµÑÑ‚Ð¸ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð² Ð¿Ð¾Ð¸ÑÐºÐ¾Ð²ÑƒÑŽ ÑÑ‚Ñ€Ð¾ÐºÑƒ ÑÐ°Ð¹Ñ‚Ð°
   - ÐÐ°Ð¹Ñ‚Ð¸ Ð½Ð°Ð¸Ð±Ð¾Ð»ÐµÐµ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ÑÑ‰Ð¸Ð¹ Ñ‚Ð¾Ð²Ð°Ñ€ Ð² Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°Ñ…
   - ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¸ÑÑ‚Ð¸Ðº
   ```

4. **ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ Ñ‚Ð¾Ð²Ð°Ñ€Ð°**:
   ```
   - ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐž ÐºÐ»Ð¸ÐºÐ½ÑƒÑ‚ÑŒ Ð½Ð° Ñ‚Ð¾Ð²Ð°Ñ€ Ð¸Ð· Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² Ð¿Ð¾Ð¸ÑÐºÐ°
   - Ð”Ð¾Ð¶Ð´Ð°Ñ‚ÑŒÑÑ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
   - ÐÐ• Ð±Ñ€Ð°Ñ‚ÑŒ Ñ†ÐµÐ½Ñƒ Ð¸Ð· Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² Ð¿Ð¾Ð¸ÑÐºÐ°!
   ```

5. **Ð˜Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ Ñ‚Ð¾Ñ‡Ð½Ð¾Ð¹ Ñ†ÐµÐ½Ñ‹**:
   ```
   - ÐÐ°Ð¹Ñ‚Ð¸ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½ÑƒÑŽ Ñ†ÐµÐ½Ñƒ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
   - Ð£Ñ‡ÐµÑÑ‚ÑŒ ÑÐºÐ¸Ð´ÐºÐ¸ Ð¸ Ð°ÐºÑ†Ð¸Ð¸
   - ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
   - Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ URL ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
   ```

6. **Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ**:
   ```
   - ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ñ€Ð°Ð·ÑƒÐ¼Ð½Ð¾ÑÑ‚ÑŒ Ñ†ÐµÐ½Ñ‹
   - Ð£Ð±ÐµÐ´Ð¸Ñ‚ÑŒÑÑ Ð² ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ð¸ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
   - Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð² Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…
   ```

### Ð­Ñ‚Ð°Ð¿ 3: ÐÐ½Ð°Ð»Ð¸Ð· Ð¸ Ð´ÐµÑ‚Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ `get_product_details` Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ð¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸
- Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ñ€Ð°ÑÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð½Ñ‹Ðµ Ð´ÐµÐ»ÑŒÑ‚Ñ‹ Ð¼ÐµÐ¶Ð´Ñƒ Ñ†ÐµÐ½Ð°Ð¼Ð¸
- ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÑŽÑ‚ÑÑ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¸ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ñ†ÐµÐ½Ñ‹ Ð¿Ð¾ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ°Ð¼
- ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ÑÑ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…

### Ð­Ñ‚Ð°Ð¿ 4: Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¸ Ð¾Ñ‚Ñ‡ÐµÑ‚Ñ‹
- `get_statistics` Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ Ð¾Ð±Ñ‰ÑƒÑŽ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÑƒ
- Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ð²Ñ‹Ñ…Ð¾Ð´Ð½Ð¾Ð¹ Excel Ñ„Ð°Ð¹Ð» `data/Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð½Ð° Ð²Ñ‹Ñ…Ð¾Ð´ (Ð¾Ñ‚Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ð°Ñ).xlsx`
- Ð¤Ð°Ð¹Ð» ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð¸ÑÑ…Ð¾Ð´Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð»ÑŽÑ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ðµ Ñ†ÐµÐ½Ñ‹ Ð¸ Ñ€Ð°ÑÑ‡ÐµÑ‚Ñ‹
- Ð’ÐºÐ»ÑŽÑ‡Ð°ÑŽÑ‚ÑÑ ÑÑÑ‹Ð»ÐºÐ¸ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð´Ð»Ñ Ð²ÐµÑ€Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸

## ÐŸÐ Ð˜ÐœÐ•Ð Ð« ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐžÐ“Ðž Ð˜ ÐÐ•ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐžÐ“Ðž ÐŸÐžÐ˜Ð¡ÐšÐ

### âŒ ÐÐ•ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐž - ÐÐ• Ð”Ð•Ð›ÐÐ™Ð¢Ð• Ð¢ÐÐš:
```
1. ÐŸÐ¾Ð¸ÑÐº Ð² Google: "ÐŸÐ¾Ð»Ð¾Ñ‚Ð½Ð¾ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð‘Ð¯Ð—Ð¬ site:komus.ru"
2. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ†ÐµÐ½Ñ‹ Ð¸Ð· Ð¿Ð¾Ð¸ÑÐºÐ¾Ð²Ð¾Ð¹ Ð²Ñ‹Ð´Ð°Ñ‡Ð¸: "1250 Ñ€ÑƒÐ±."
3. ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð¿Ð¾ ÑÑÑ‹Ð»ÐºÐµ Ð¸Ð· Google Ð±ÐµÐ· Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸
4. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð°Ð³Ñ€ÐµÐ³Ð°Ñ‚Ð¾Ñ€Ð¾Ð² Ñ†ÐµÐ½ Ñ‚Ð¸Ð¿Ð° Ð¯Ð½Ð´ÐµÐºÑ.ÐœÐ°Ñ€ÐºÐµÑ‚
```

### âœ… ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐž - Ð”Ð•Ð›ÐÐ™Ð¢Ð• Ð¢ÐÐš:
```
1. ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð½Ð° komus.ru
2. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð¸ÑÐºÐ° Ð½Ð° ÑÐ°Ð¹Ñ‚Ðµ: Ð¿Ð¾Ð¸ÑÐº "ÐŸÐ¾Ð»Ð¾Ñ‚Ð½Ð¾ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð‘Ð¯Ð—Ð¬"
3. ÐšÐ»Ð¸Ðº Ð½Ð° ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‚Ð¾Ð²Ð°Ñ€ Ð¸Ð· Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² Ð¿Ð¾Ð¸ÑÐºÐ°
4. Ð˜Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ Ñ†ÐµÐ½Ñ‹ ÑÐ¾ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ñ‚Ð¾Ð²Ð°Ñ€Ð°: "1250,00 â‚½"
5. Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ URL ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð´Ð»Ñ Ð²ÐµÑ€Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸
```

### ÐŸÐ Ð˜ÐœÐ•Ð  ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐžÐ“Ðž ÐÐ›Ð“ÐžÐ Ð˜Ð¢ÐœÐ:
```python
# ÐŸÑÐµÐ²Ð´Ð¾ÐºÐ¾Ð´ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¿Ð¾Ð¸ÑÐºÐ°
1. browser.navigate("https://www.komus.ru")
2. search_input = browser.find_element("input[name='q']")
3. search_input.type("ÐŸÐ¾Ð»Ð¾Ñ‚Ð½Ð¾ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð‘Ð¯Ð—Ð¬ ÐžÐ¢Ð‘Ð•Ð›Ð•ÐÐÐÐ¯")
4. search_input.press("Enter")
5. # Ð–Ð´ÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð¿Ð¾Ð¸ÑÐºÐ°
6. first_product = browser.find_element(".product-item:first-child a")
7. product_url = first_product.get_attribute("href")
8. browser.navigate(product_url)  # ÐŸÐ•Ð Ð•Ð¥ÐžÐ”Ð˜Ðœ ÐÐ Ð¡Ð¢Ð ÐÐÐ˜Ð¦Ð£ Ð¢ÐžÐ’ÐÐ Ð!
9. # Ð–Ð´ÐµÐ¼ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
10. price = browser.find_element(".price-current").text
11. availability = browser.find_element(".availability").text
12. # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ
```

## ÐžÐ¡ÐžÐ‘Ð•ÐÐÐžÐ¡Ð¢Ð˜ ÐÐ Ð¥Ð˜Ð¢Ð•ÐšÐ¢Ð£Ð Ð«

- **ÐšÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð¸Ñ€ÑƒÑŽÑ‰Ð°Ñ Ñ€Ð¾Ð»ÑŒ**: Ð¡ÐµÑ€Ð²ÐµÑ€ Ð½Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ Ð²ÐµÐ±-ÑÐºÑ€Ð°Ð¿Ð¸Ð½Ð³ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ, Ð° ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð¸Ñ€ÑƒÐµÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ñ‡ÐµÑ€ÐµÐ· MCP Playwright
- **ÐÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°**: ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾ Ð¿Ð¾Ð¸ÑÐºÐ° Ð½Ð° Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¸Ñ… Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ°Ñ…
- **ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº**: Graceful degradation Ð¿Ñ€Ð¸ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ¾Ð²
- **Rate limiting**: Ð¡Ð¾Ð±Ð»ÑŽÐ´ÐµÐ½Ð¸Ðµ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ð¹ ÑÐºÐ¾Ñ€Ð¾ÑÑ‚Ð¸ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ°
- **ÐšÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð´Ð°Ð½Ð½Ñ‹Ñ…**: ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ñ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ð¾Ð³Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð¸ÑÐºÐ¾Ð¼Ð¾Ð¼Ñƒ
- **Ð¢Ñ€Ð°ÑÑÐ¸Ñ€Ð¾Ð²ÐºÐ°**: Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ URL ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ† Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð´Ð»Ñ Ð¿Ð¾ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¹ Ð²ÐµÑ€Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸

## Ð¤ÐžÐ ÐœÐÐ¢Ð« Ð”ÐÐÐÐ«Ð¥

### Ð’Ñ…Ð¾Ð´Ð½Ð¾Ð¹ Excel
Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð¿Ð¾Ð»Ñ Ñ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð°Ð¼Ð¸ Ð¿ÐµÑ€ÐµÐ½Ð¾ÑÐ° ÑÑ‚Ñ€Ð¾Ðº:
- "ÐšÐ¾Ð´\nÐ¼Ð¾Ð´ÐµÐ»Ð¸" - ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÐºÐ¾Ð´ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
- "model_name" - Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð¼Ð¾Ð´ÐµÐ»Ð¸ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
- "ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ" - ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
- "Ð•Ð´Ð¸Ð½Ð¸Ñ†Ð° Ð¸Ð·Ð¼ÐµÑ€ÐµÐ½Ð¸Ñ" - ÐµÐ´Ð¸Ð½Ð¸Ñ†Ð° Ð¸Ð·Ð¼ÐµÑ€ÐµÐ½Ð¸Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
- "ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚ \n1 Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ¸" - Ð¿ÐµÑ€Ð²Ð¸Ñ‡Ð½Ñ‹Ð¹ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº Ð¿Ð¾Ð¸ÑÐºÐ°
- "ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚ \n2 Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ¸" - Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‡Ð½Ñ‹Ð¹ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº Ð¿Ð¾Ð¸ÑÐºÐ°
- "Ð¦ÐµÐ½Ð° Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¸\nÐœÐŸ c ÐÐ”Ð¡" - Ð¿ÑƒÑÑ‚Ð¾Ðµ Ð¿Ð¾Ð»Ðµ Ð´Ð»Ñ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ
- "Ð¦ÐµÐ½Ð° Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¸\nB2C c ÐÐ”Ð¡" - Ð¿ÑƒÑÑ‚Ð¾Ðµ Ð¿Ð¾Ð»Ðµ Ð´Ð»Ñ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ
- "Ð”ÐµÐ»ÑŒÑ‚Ð° Ð² Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð°Ñ…" - Ð¿ÑƒÑÑ‚Ð¾Ðµ Ð¿Ð¾Ð»Ðµ Ð´Ð»Ñ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ
- "Ð¡ÑÑ‹Ð»ÐºÐ° Ð½Ð° Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº" - Ð¿ÑƒÑÑ‚Ð¾Ðµ Ð¿Ð¾Ð»Ðµ Ð´Ð»Ñ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ
- "Ð¦ÐµÐ½Ð° 2 Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¸\nB2C c ÐÐ”Ð¡" - Ð¿ÑƒÑÑ‚Ð¾Ðµ Ð¿Ð¾Ð»Ðµ Ð´Ð»Ñ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ

### Ð’Ñ‹Ñ…Ð¾Ð´Ð½Ð¾Ð¹ Excel
Ð”Ð¾Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð¿Ð¾Ð»ÑÐ¼Ð¸:
- "Ð¦ÐµÐ½Ð° Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¸\nÐœÐŸ c ÐÐ”Ð¡" - Ñ†ÐµÐ½Ð° Ð½Ð° Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐµ
- "Ð¦ÐµÐ½Ð° Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¸\nB2C c ÐÐ”Ð¡" - B2C Ñ†ÐµÐ½Ð°
- "Ð”ÐµÐ»ÑŒÑ‚Ð° Ð² Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð°Ñ…" - Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð½Ð°Ñ Ñ€Ð°Ð·Ð½Ð¸Ñ†Ð° Ñ†ÐµÐ½
- "Ð¡ÑÑ‹Ð»ÐºÐ° Ð½Ð° Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº" - URL Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð½Ð° Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐµ
- "Ð¦ÐµÐ½Ð° 2 Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¸\nB2C c ÐÐ”Ð¡" - Ñ†ÐµÐ½Ð° Ð½Ð° Ð²Ñ‚Ð¾Ñ€Ð¾Ð¼ Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐµ

## ÐšÐžÐÐ¢Ð ÐžÐ›Ð¬ ÐšÐÐ§Ð•Ð¡Ð¢Ð’Ð Ð”ÐÐÐÐ«Ð¥

### ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐ«Ð• ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ˜ ÐŸÐ•Ð Ð•Ð” Ð¡ÐžÐ¥Ð ÐÐÐ•ÐÐ˜Ð•Ðœ Ð¦Ð•ÐÐ«:

1. **ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð°**:
   - ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð´Ð¾Ð»Ð¶Ð½Ð¾ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ ÑÐ»Ð¾Ð²Ð° Ð¸Ð· Ð¸ÑÑ…Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°
   - ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð´Ð¾Ð»Ð¶Ð½Ð° Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð½Ð¾ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾Ð¶Ð¸Ð´Ð°ÐµÐ¼Ð¾Ð¹
   - Ð•Ð´Ð¸Ð½Ð¸Ñ†Ð° Ð¸Ð·Ð¼ÐµÑ€ÐµÐ½Ð¸Ñ Ð´Ð¾Ð»Ð¶Ð½Ð° ÑÐ¾Ð²Ð¿Ð°Ð´Ð°Ñ‚ÑŒ (ÑˆÑ‚, Ð¼, ÐºÐ³ Ð¸ Ñ‚.Ð´.)

2. **ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð·ÑƒÐ¼Ð½Ð¾ÑÑ‚Ð¸ Ñ†ÐµÐ½Ñ‹**:
   - Ð¦ÐµÐ½Ð° Ð½Ðµ Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ Ð½ÑƒÐ»ÐµÐ²Ð¾Ð¹ Ð¸Ð»Ð¸ Ð¾Ñ‚Ñ€Ð¸Ñ†Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¹
   - Ð¦ÐµÐ½Ð° Ð½Ðµ Ð´Ð¾Ð»Ð¶Ð½Ð° ÐºÐ°Ñ€Ð´Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾ Ð¾Ñ‚Ð»Ð¸Ñ‡Ð°Ñ‚ÑŒÑÑ Ð¾Ñ‚ Ð¾Ð¶Ð¸Ð´Ð°ÐµÐ¼Ð¾Ð¹ (Ð±Ð¾Ð»ÐµÐµ Ñ‡ÐµÐ¼ Ð² 10 Ñ€Ð°Ð·)
   - ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð²Ð°Ð»ÑŽÑ‚Ñƒ (Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ RUB Ð´Ð»Ñ Ñ€Ð¾ÑÑÐ¸Ð¹ÑÐºÐ¸Ñ… Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ¾Ð²)

3. **ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ Ñ‚Ð¾Ð²Ð°Ñ€Ð°**:
   - Ð¢Ð¾Ð²Ð°Ñ€ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð² Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ð¸ Ð¸Ð»Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð´Ð»Ñ Ð·Ð°ÐºÐ°Ð·Ð°
   - ÐÐµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑ‚ÑŒ Ñ†ÐµÐ½Ñ‹ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² "Ð½ÐµÑ‚ Ð² Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ð¸" Ð¸Ð»Ð¸ "ÑÐ½ÑÑ‚ Ñ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´ÑÑ‚Ð²Ð°"

4. **ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…**:
   - URL ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ð¼
   - Ð¡Ñ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° Ð´Ð¾Ð»Ð¶Ð½Ð° ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½ÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ
   - Ð¦ÐµÐ½Ð° Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹, Ð° Ð½Ðµ Ð°Ñ€Ñ…Ð¸Ð²Ð½Ð¾Ð¹

### ÐŸÐ Ð˜ÐœÐ•Ð Ð« ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐ«Ð¥ Ð˜ ÐÐ•ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐ«Ð¥ Ð”ÐÐÐÐ«Ð¥:

#### âœ… ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐž:
```json
{
  "marketplace": "komus.ru",
  "price": 1250.0,
  "currency": "RUB",
  "availability": "Ð² Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ð¸",
  "product_url": "https://www.komus.ru/catalog/office/paper/12345",
  "product_match_confidence": "high"
}
```

#### âŒ ÐÐ•ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐž:
```json
{
  "marketplace": "komus.ru",
  "price": 0.0,  // ÐÑƒÐ»ÐµÐ²Ð°Ñ Ñ†ÐµÐ½Ð°
  "currency": "USD",  // ÐÐµÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð°Ñ Ð²Ð°Ð»ÑŽÑ‚Ð°
  "availability": "Ð½ÐµÑ‚ Ð² Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ð¸",  // Ð¢Ð¾Ð²Ð°Ñ€ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½
  "product_url": "https://google.com/search?q=...",  // Ð¡ÑÑ‹Ð»ÐºÐ° Ð½Ð° Ð¿Ð¾Ð¸ÑÐº
  "product_match_confidence": "low"  // ÐÐ¸Ð·ÐºÐ¾Ðµ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ
}
```

## Ð Ð•ÐšÐžÐœÐ•ÐÐ”Ð£Ð•ÐœÐÐ¯ ÐŸÐžÐ¡Ð›Ð•Ð”ÐžÐ’ÐÐ¢Ð•Ð›Ð¬ÐÐžÐ¡Ð¢Ð¬ Ð”Ð•Ð™Ð¡Ð¢Ð’Ð˜Ð™

1. ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð°Ñ… Ñ‡ÐµÑ€ÐµÐ· `get_product_details`
2. ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ Ñ‡ÐµÑ€ÐµÐ· `get_statistics`
3. Ð”Ð»Ñ Ð¿Ð¾Ð¸ÑÐºÐ° Ð½Ð¾Ð²Ñ‹Ñ… Ñ†ÐµÐ½ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ MCP Playwright Ñ ÑÐ¾Ð±Ð»ÑŽÐ´ÐµÐ½Ð¸ÐµÐ¼ Ð²ÑÐµÑ… Ð¿Ñ€Ð°Ð²Ð¸Ð»
4. Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐ¹Ñ‚Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ðµ Ñ†ÐµÐ½Ñ‹ Ñ‡ÐµÑ€ÐµÐ· `save_product_prices` Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ÑÐ»Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð°
5. ÐŸÑ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸, Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚Ðµ Ð¿Ð¾Ð¸ÑÐº Ð´Ð»Ñ Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²

## ÐŸÐ Ð˜ÐœÐ•Ð Ð« Ð˜Ð¡ÐŸÐžÐ›Ð¬Ð—ÐžÐ’ÐÐÐ˜Ð¯

### ÐŸÑ€Ð¸Ð¼ÐµÑ€ 1: ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ðµ
```
get_product_details(195385.0)
```

### ÐŸÑ€Ð¸Ð¼ÐµÑ€ 2: ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¾Ð±Ñ‰ÐµÐ¹ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸
```
get_statistics()
```

## EXCEL Ð˜ÐÐ¡Ð¢Ð Ð£ÐœÐ•ÐÐ¢Ð«

### 1. parse_excel_file(file_path: str, sheet_name: Optional[str] = None, header_row: int = 0, max_rows: Optional[int] = None)
ÐŸÐ°Ñ€ÑÐ¸Ð½Ð³ Excel Ñ„Ð°Ð¹Ð»Ð° Ð¸ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ….
- **ÐŸÑ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÑ‚**: Ð¿ÑƒÑ‚ÑŒ Ðº Ñ„Ð°Ð¹Ð»Ñƒ, Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð»Ð¸ÑÑ‚Ð° (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾), Ð½Ð¾Ð¼ÐµÑ€ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¾Ð², Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÑ‚Ñ€Ð¾Ðº
- **Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚**: ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Excel Ñ„Ð°Ð¹Ð»Ð°
- **ÐžÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸**:
  - ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð½Ñ‹Ñ… Ð»Ð¸ÑÑ‚Ð¾Ð² Excel Ñ„Ð°Ð¹Ð»Ð°
  - ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¾Ð²
  - ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð½Ñ‹Ñ… Ñ‚Ð¸Ð¿Ð¾Ð² Ð´Ð°Ð½Ð½Ñ‹Ñ…
  - Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼Ñ‹Ñ… ÑÑ‚Ñ€Ð¾Ðº

**ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ**:
```
parse_excel_file("data/input.xlsx", sheet_name="Ð”Ð°Ð½Ð½Ñ‹Ðµ", header_row=0, max_rows=100)
```

### 2. get_excel_info(file_path: str)
ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ðµ Excel Ñ„Ð°Ð¹Ð»Ð° Ð±ÐµÐ· Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾ Ñ‡Ñ‚ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ….
- **ÐŸÑ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÑ‚**: Ð¿ÑƒÑ‚ÑŒ Ðº Excel Ñ„Ð°Ð¹Ð»Ñƒ
- **Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚**: Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð»Ð¸ÑÑ‚Ð°Ñ…, Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ°Ñ…, Ñ€Ð°Ð·Ð¼ÐµÑ€Ð°Ñ…
- **ÐžÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸**:
  - Ð‘Ñ‹ÑÑ‚Ñ€Ð¾Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð°
  - Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð²ÑÐµÑ… Ð»Ð¸ÑÑ‚Ð°Ñ… Ð² Ñ„Ð°Ð¹Ð»Ðµ
  - ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¾Ð² Ð¸ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð¾Ð² Ð´Ð°Ð½Ð½Ñ‹Ñ…

**ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ**:
```
get_excel_info("data/input.xlsx")
```

### 3. export_to_excel(data: List[Dict], file_path: str, sheet_name: str = "Data", include_index: bool = False, auto_adjust_columns: bool = True, apply_formatting: bool = True)
Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð² Excel Ñ„Ð°Ð¹Ð» Ñ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼.
- **ÐŸÑ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÑ‚**: Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð°, Ð¿ÑƒÑ‚ÑŒ Ðº Ñ„Ð°Ð¹Ð»Ñƒ, Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
- **Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚**: Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð°
- **ÐžÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸**:
  - ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†
  - ÐŸÐ¾Ð´Ð³Ð¾Ð½ÐºÐ° ÑˆÐ¸Ñ€Ð¸Ð½Ñ‹ ÐºÐ¾Ð»Ð¾Ð½Ð¾Ðº
  - ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ ÑÑ‚Ð¸Ð»ÐµÐ¹ Ðº Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ°Ð¼
  - ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼Ñ‹Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð°

**ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ**:
```
export_to_excel(data, "data/output.xlsx", sheet_name="Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹", apply_formatting=True)
```

### 4. filter_excel_data(data: List[Dict], filters: Dict)
Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Excel Ð¿Ð¾ Ð·Ð°Ð´Ð°Ð½Ð½Ñ‹Ð¼ ÐºÑ€Ð¸Ñ‚ÐµÑ€Ð¸ÑÐ¼.
- **ÐŸÑ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÑ‚**: Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ð¸, ÐºÑ€Ð¸Ñ‚ÐµÑ€Ð¸Ð¸ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ð¸
- **Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚**: Ð¾Ñ‚Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
- **ÐžÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸**:
  - ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° ÑÐ»Ð¾Ð¶Ð½Ñ‹Ñ… ÐºÑ€Ð¸Ñ‚ÐµÑ€Ð¸ÐµÐ² Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ð¸
  - Ð§Ð¸ÑÐ»Ð¾Ð²Ñ‹Ðµ Ð¸ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ðµ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹
  - ÐœÐ½Ð¾Ð¶ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ð¸

**ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ**:
```
filter_excel_data(data, {"ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ": "Ð¥Ð¾Ð·Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹", "Ð¦ÐµÐ½Ð°": {"greater_than": 1000}})
```

### 5. transform_excel_data(data: List[Dict], transformations: Dict)
Ð¢Ñ€Ð°Ð½ÑÑ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Excel ÑÐ¾Ð³Ð»Ð°ÑÐ½Ð¾ Ð·Ð°Ð´Ð°Ð½Ð½Ñ‹Ð¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°Ð¼.
- **ÐŸÑ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÑ‚**: Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ñ‚Ñ€Ð°Ð½ÑÑ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸, Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° Ñ‚Ñ€Ð°Ð½ÑÑ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸
- **Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚**: Ñ‚Ñ€Ð°Ð½ÑÑ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
- **ÐžÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸**:
  - ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ‚Ð¸Ð¿Ð¾Ð² Ð´Ð°Ð½Ð½Ñ‹Ñ…
  - Ð¡Ñ‚Ñ€Ð¾ÐºÐ¾Ð²Ñ‹Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ (Ð·Ð°Ð¼ÐµÐ½Ð°, Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°)
  - ÐœÐ°Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ñ Ñ‡Ð¸ÑÐ»Ð°Ð¼Ð¸
  - ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° Ñ‚Ñ€Ð°Ð½ÑÑ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸

**ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ**:
```
transform_excel_data(data, {"model_name": {"to_upper": true}, "price": {"multiply": 1.2}})
```

### 6. parse_excel_and_save_to_database(file_path: str, sheet_name: Optional[str] = None, header_row: int = 0, start_row: Optional[int] = None, max_rows: Optional[int] = None)
**Ð£Ð›Ð£Ð§Ð¨Ð•ÐÐÐ«Ð™ Ð˜ÐÐ¡Ð¢Ð Ð£ÐœÐ•ÐÐ¢** - ÐŸÐ°Ñ€ÑÐ¸Ð½Ð³ Excel Ñ„Ð°Ð¹Ð»Ð° Ð¸ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð² Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¾Ð¹ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ð¾Ð².
- **ÐŸÑ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÑ‚**: Ð¿ÑƒÑ‚ÑŒ Ðº Ñ„Ð°Ð¹Ð»Ñƒ, Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð»Ð¸ÑÑ‚Ð° (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾), Ð½Ð¾Ð¼ÐµÑ€ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¾Ð², Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð°Ñ ÑÑ‚Ñ€Ð¾ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…, Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÑ‚Ñ€Ð¾Ðº
- **Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚**: Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð° Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð² Ð‘Ð”
- **ÐžÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸**:
  - ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ð°Ñ€ÑÐ¸Ñ‚ Excel Ñ„Ð°Ð¹Ð» Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð°Ð¼Ð¸
  - **ÐÐžÐ’ÐžÐ•**: ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Ñ‡Ñ‚ÐµÐ½Ð¸Ñ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ð° ÑÑ‚Ñ€Ð¾Ðº (start_row, max_rows)
  - **ÐÐžÐ’ÐžÐ•**: Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°Ñ‚ÑŒ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ñ‡Ð°ÑÑ‚ÑÐ¼Ð¸
  - Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ Ð½Ð¾Ð²Ñ‹Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ Ð² Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ… SQLite
  - ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ Ð¿Ñ€Ð¸ ÑÐ¾Ð²Ð¿Ð°Ð´ÐµÐ½Ð¸Ð¸ ÐºÐ¾Ð´Ð°
  - ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Excel Ñ Ð¿Ð¾Ð»ÑÐ¼Ð¸: "ÐšÐ¾Ð´\nÐ¼Ð¾Ð´ÐµÐ»Ð¸", "model_name", "ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ", "Ð•Ð´Ð¸Ð½Ð¸Ñ†Ð° Ð¸Ð·Ð¼ÐµÑ€ÐµÐ½Ð¸Ñ", "ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚ \n1 Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ¸", "ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚ \n2 Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ¸"
  - ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð¸ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½ÑƒÑŽ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ
  - Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ñ… Ñ‚Ð¾Ð²Ð°Ñ€Ð°Ñ…

**ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ**:
```
# Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹
parse_excel_and_save_to_database("data/Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð½Ð° Ð²Ñ…Ð¾Ð´.xlsx", sheet_name="Ð›Ð¸ÑÑ‚1", header_row=0)

# Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ Ñ 151 Ð¿Ð¾ 300 ÑÑ‚Ñ€Ð¾ÐºÑƒ
parse_excel_and_save_to_database("data/Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð½Ð° Ð²Ñ…Ð¾Ð´.xlsx", sheet_name="Ð›Ð¸ÑÑ‚1", header_row=0, start_row=150, max_rows=150)

# Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ 100 Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð½Ð°Ñ‡Ð¸Ð½Ð°Ñ Ñ 301 ÑÑ‚Ñ€Ð¾ÐºÐ¸
parse_excel_and_save_to_database("data/Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð½Ð° Ð²Ñ…Ð¾Ð´.xlsx", sheet_name="Ð›Ð¸ÑÑ‚1", header_row=0, start_row=300, max_rows=100)
```

**ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¾Ñ‚Ð²ÐµÑ‚Ð°**:
```json
{
  "status": "success",
  "message": "Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾ 150 Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð¸Ð· Excel Ñ„Ð°Ð¹Ð»Ð°",
  "file_path": "data/Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð½Ð° Ð²Ñ…Ð¾Ð´.xlsx",
  "start_row": 150,
  "rows_requested": 150,
  "total_rows_parsed": 150,
  "products_created": 120,
  "products_updated": 30,
  "total_processed": 150,
  "products_saved": [
    {
      "code": 195385.0,
      "model_name": "ÐŸÐ¾Ð»Ð¾Ñ‚Ð½Ð¾ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð‘Ð¯Ð—Ð¬ ÐžÐ¢Ð‘Ð•Ð›Ð•ÐÐÐÐ¯ Ð“ÐžÐ¡Ð¢",
      "action": "created",
      "id": 1
    }
  ],
  "parse_info": {
    "sheet_name": "Ð›Ð¸ÑÑ‚1",
    "columns": ["ÐšÐ¾Ð´\nÐ¼Ð¾Ð´ÐµÐ»Ð¸", "model_name", "ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ"],
    "available_sheets": ["Ð›Ð¸ÑÑ‚1", "Ð›Ð¸ÑÑ‚2"],
    "data_range": "ÑÑ‚Ñ€Ð¾ÐºÐ¸ 150-299"
  },
  "timestamp": "2023-07-21T15:30:45"
}
```

## Ð ÐÐ‘ÐžÐ§Ð˜Ð™ ÐŸÐ ÐžÐ¦Ð•Ð¡Ð¡ Ð¡ EXCEL

### Ð‘Ð«Ð¡Ð¢Ð Ð«Ð™ Ð¡ÐŸÐžÐ¡ÐžÐ‘ (Ð Ð•ÐšÐžÐœÐ•ÐÐ”Ð£Ð•Ð¢Ð¡Ð¯)
**Ð”Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð¸Ð· Excel Ð² Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…:**
1. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ `parse_excel_and_save_to_database` Ð´Ð»Ñ Ð¾Ð´Ð½Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð° Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ
2. Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐ¾Ð·Ð´Ð°ÑÑ‚ Ð½Ð¾Ð²Ñ‹Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ
3. ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½ÑƒÑŽ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ Ð¿Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ð¼ Ñ‚Ð¾Ð²Ð°Ñ€Ð°Ð¼

### ÐŸÐžÐ¨ÐÐ“ÐžÐ’Ð«Ð™ Ð¡ÐŸÐžÐ¡ÐžÐ‘ (Ð”Ð›Ð¯ Ð¡Ð›ÐžÐ–ÐÐžÐ™ ÐžÐ‘Ð ÐÐ‘ÐžÐ¢ÐšÐ˜)

#### Ð­Ñ‚Ð°Ð¿ 1: ÐÐ½Ð°Ð»Ð¸Ð· ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ñ„Ð°Ð¹Ð»Ð°
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ `get_excel_info` Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ðµ Excel Ñ„Ð°Ð¹Ð»Ð°
- ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚Ðµ Ð»Ð¸ÑÑ‚Ñ‹, Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¸ Ð¸ Ñ€Ð°Ð·Ð¼ÐµÑ€Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…

#### Ð­Ñ‚Ð°Ð¿ 2: ÐŸÐ°Ñ€ÑÐ¸Ð½Ð³ Ð´Ð°Ð½Ð½Ñ‹Ñ…
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ `parse_excel_file` Ð´Ð»Ñ Ñ‡Ñ‚ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸Ð· Excel Ñ„Ð°Ð¹Ð»Ð°
- ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ñ‡Ñ‚ÐµÐ½Ð¸Ñ (Ð»Ð¸ÑÑ‚, Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¸, ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÑ‚Ñ€Ð¾Ðº)

#### Ð­Ñ‚Ð°Ð¿ 3: ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…
- ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐ¹Ñ‚Ðµ `filter_excel_data` Ð´Ð»Ñ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾ ÐºÑ€Ð¸Ñ‚ÐµÑ€Ð¸ÑÐ¼
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ `transform_excel_data` Ð´Ð»Ñ Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…

#### Ð­Ñ‚Ð°Ð¿ 4: Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²
- Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ `export_to_excel`
- ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸ ÑÑ‚Ð¸Ð»Ð¸ Ð´Ð»Ñ Ð»ÑƒÑ‡ÑˆÐµÐ³Ð¾ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ñ

### Ð˜ÐÐ¢Ð•Ð“Ð ÐÐ¦Ð˜Ð¯ Ð¡ ÐžÐ¡ÐÐžÐ’ÐÐžÐ™ Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐžÐ™
ÐŸÐ¾ÑÐ»Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð² Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ñ‡ÐµÑ€ÐµÐ· `parse_excel_and_save_to_database`:
1. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ `get_product_list` Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐ¿Ð¸ÑÐºÐ° Ð²ÑÐµÑ… Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²
2. Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐ¹Ñ‚Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ðµ Ñ†ÐµÐ½Ñ‹ Ñ‡ÐµÑ€ÐµÐ· `save_product_prices`
3. ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ð¹Ñ‚Ðµ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ Ñ‡ÐµÑ€ÐµÐ· `get_statistics`

Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð¿Ð¾ÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð´Ð»Ñ Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð¸ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð¾Ð².

---
## Ð Ð•Ð—Ð®ÐœÐ• ÐšÐ›Ð®Ð§Ð•Ð’Ð«Ð¥ Ð¢Ð Ð•Ð‘ÐžÐ’ÐÐÐ˜Ð™:

ðŸ”´ **ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜ Ð’ÐÐ–ÐÐž**: 
- ÐÐ• Ð±Ñ€Ð°Ñ‚ÑŒ Ñ†ÐµÐ½Ñ‹ Ð¸Ð· Google/Yandex Ð¿Ð¾Ð¸ÑÐºÐ°
- ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐž Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ñ‚ÑŒ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð½Ð° Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ°Ñ…
- ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑ‚ÑŒ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ð¾Ð³Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð¸ÑÐºÐ¾Ð¼Ð¾Ð¼Ñƒ
- Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÑ‚ÑŒ URL ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ† Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð´Ð»Ñ Ð²ÐµÑ€Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸

ðŸŸ¡ **Ð¢Ð•Ð¥ÐÐ˜Ð§Ð•Ð¡ÐšÐ˜Ð• Ð¢Ð Ð•Ð‘ÐžÐ’ÐÐÐ˜Ð¯**:
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ MCP Playwright Ð´Ð»Ñ Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ð¸
- Ð¡Ð¾Ð±Ð»ÑŽÐ´Ð°Ñ‚ÑŒ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ¸ Ð¼ÐµÐ¶Ð´Ñƒ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°Ð¼Ð¸ (2-3 ÑÐµÐº)
- ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°Ñ‚ÑŒ Ð°Ð½Ñ‚Ð¸Ð±Ð¾Ñ‚-Ð·Ð°Ñ‰Ð¸Ñ‚Ñƒ
- ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑ‚ÑŒ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿ÐµÑ€ÐµÐ´ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸ÐµÐ¼

ðŸŸ¢ **Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢**: Ð¢Ð¾Ñ‡Ð½Ñ‹Ðµ, Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ñ†ÐµÐ½Ñ‹ Ñ Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ñ… ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ† Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ¾Ð²
---
"""

@mcp.prompt("system")
def get_system_prompt() -> str:
    """Get system prompt for AI agent"""
    return SYSTEM_PROMPT

# MCP Tools implementations

@handle_errors(
    category=ErrorCategory.DATABASE,
    severity=ErrorSeverity.MEDIUM,
    component="mcp_server",
    recovery_action="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ"
)
@mcp.tool()
async def get_product_details(product_code: float, ctx: Context = None) -> dict:
    """
    Get detailed information about a product including price comparison
    
    Args:
        product_code: Unique product code from the database
        ctx: MCP context object
        
    Returns:
        Dictionary with detailed product information and price data
    """
    from .error_handling import (
        create_user_friendly_error,
        ValidationError,
        error_handler,
        ErrorCategory,
        ErrorSeverity,
        log_recovery_attempt
    )
    
    logger.info(f"Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ðµ Ñ ÐºÐ¾Ð´Ð¾Ð¼: {product_code}")
    
    try:
        # Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
        if not isinstance(product_code, (int, float)):
            error = ValidationError("ÐšÐ¾Ð´ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ñ‡Ð¸ÑÐ»Ð¾Ð¼", field="product_code", value=product_code)
            return create_user_friendly_error(error, "Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ðµ")
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
        if database_manager is None:
            logger.error("ÐœÐµÐ½ÐµÐ´Ð¶ÐµÑ€ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½")
            return {
                "status": "error",
                "message": "Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ°: Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½",
                "error_code": "COMPONENT_NOT_INITIALIZED",
                "user_message": "Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ",
                "recoverable": True,
                "retry_suggested": True
            }
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ðµ Ð¸Ð· Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
        product = await database_manager.get_product_by_code(product_code)
        
        if not product:
            logger.warning(f"ÐŸÑ€Ð¾Ð´ÑƒÐºÑ‚ Ñ ÐºÐ¾Ð´Ð¾Ð¼ {product_code} Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…")
            log_recovery_attempt(
                component="server",
                action=f"ÐŸÑ€Ð¾Ð´ÑƒÐºÑ‚ Ñ ÐºÐ¾Ð´Ð¾Ð¼ {product_code} Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½",
                success=False
            )
            return {
                "status": "not_found",
                "message": f"ÐŸÑ€Ð¾Ð´ÑƒÐºÑ‚ Ñ ÐºÐ¾Ð´Ð¾Ð¼ {product_code} Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½",
                "error_code": "PRODUCT_NOT_FOUND",
                "user_message": "Ð¢Ð¾Ð²Ð°Ñ€ Ñ ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ð¼ ÐºÐ¾Ð´Ð¾Ð¼ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…",
                "recoverable": False,
                "retry_suggested": False
            }
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ†ÐµÐ½Ñ‹ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð° Ñ Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ¾Ð²
        prices = await database_manager.get_product_prices(product["id"])
        
        # Ð•ÑÐ»Ð¸ Ñ†ÐµÐ½Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹, Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ðµ
        if not prices:
            logger.info(f"Ð”Ð»Ñ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð° Ñ ÐºÐ¾Ð´Ð¾Ð¼ {product_code} Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ñ†ÐµÐ½Ñ‹")
            log_recovery_attempt(
                component="server",
                action="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ðµ Ð±ÐµÐ· Ñ†ÐµÐ½",
                success=True
            )
            return {
                "status": "success",
                "product": {
                    "code": product["code"],
                    "model_name": product["model_name"],
                    "category": product["category"],
                    "unit": product["unit"],
                    "priority_1_source": product["priority_1_source"],
                    "priority_2_source": product["priority_2_source"]
                },
                "prices": [],
                "price_analysis": {
                    "min_price": None,
                    "max_price": None,
                    "delta_percent": None
                },
                "message": "Ð”Ð»Ñ Ð´Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ñ†ÐµÐ½Ñ‹ Ð½Ð° Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ°Ñ…"
            }
        
        # ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ñ†ÐµÐ½Ñ‹ Ð´Ð»Ñ Ñ€Ð°ÑÑ‡ÐµÑ‚Ð° Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð¹, Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð¸ Ð´ÐµÐ»ÑŒÑ‚Ñ‹
        valid_prices = [p for p in prices if p["price"] is not None and p["price"] > 0]
        
        price_analysis = {
            "min_price": None,
            "max_price": None,
            "delta_percent": None
        }
        
        if valid_prices:
            # ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½ÑƒÑŽ Ñ†ÐµÐ½Ñƒ
            min_price_item = min(valid_prices, key=lambda x: x["price"])
            price_analysis["min_price"] = {
                "value": min_price_item["price"],
                "marketplace": min_price_item["marketplace"]
            }
            
            # ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½ÑƒÑŽ Ñ†ÐµÐ½Ñƒ
            max_price_item = max(valid_prices, key=lambda x: x["price"])
            price_analysis["max_price"] = {
                "value": max_price_item["price"],
                "marketplace": max_price_item["marketplace"]
            }
            
            # Ð Ð°ÑÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð½ÑƒÑŽ Ð´ÐµÐ»ÑŒÑ‚Ñƒ Ð¼ÐµÐ¶Ð´Ñƒ Ð¼Ð¸Ð½ Ð¸ Ð¼Ð°ÐºÑ Ñ†ÐµÐ½Ð°Ð¼Ð¸
            if min_price_item["price"] > 0:
                delta = ((max_price_item["price"] - min_price_item["price"]) / min_price_item["price"]) * 100
                price_analysis["delta_percent"] = round(delta, 2)
        
        # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð¸Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚
        response = {
            "status": "success",
            "product": {
                "code": product["code"],
                "model_name": product["model_name"],
                "category": product["category"],
                "unit": product["unit"],
                "priority_1_source": product["priority_1_source"],
                "priority_2_source": product["priority_2_source"]
            },
            "prices": prices,
            "price_analysis": price_analysis
        }
        
        logger.info(f"Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð° Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ðµ Ñ ÐºÐ¾Ð´Ð¾Ð¼ {product_code}")
        log_recovery_attempt(
            component="server",
            action=f"Ð£ÑÐ¿ÐµÑˆÐ½Ð¾Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ðµ {product_code}",
            success=True
        )
        return response
        
    except Exception as e:
        error_handler.log_error(
            error=e,
            category=ErrorCategory.DATABASE,
            severity=ErrorSeverity.HIGH,
            component="server",
            details={"tool": "get_product_details", "product_code": product_code},
            recovery_action="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ"
        )
        return create_user_friendly_error(e, "Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ðµ")

@handle_errors(
    category=ErrorCategory.DATABASE,
    severity=ErrorSeverity.MEDIUM,
    component="mcp_server",
    recovery_action="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ"
)
@mcp.tool()
async def get_product_list(offset: int = 0, limit: int = 150, filter_status: str = "all", ctx: Context = None) -> dict:
    """
    Get list of all product SKUs from the database with pagination support
    
    Args:
        offset: Starting position (0-based index) for pagination
        limit: Maximum number of products to return (default: 150, if None, returns all from offset)
        filter_status: Filter by processing status ("all", "processed", "not_processed")
        ctx: MCP context object
        
    Returns:
        Dictionary with list of product codes (SKUs) and basic info with pagination info
        Each product includes processing status (processed/not_processed)
        
    Usage Examples:
        - Get first 150 products (recommended): offset=0, limit=150
        - Get products 151-300: offset=150, limit=150
        - Get products 301-450: offset=300, limit=150
        - Get all products from position 100: offset=99, limit=None
        - Get all products: offset=0, limit=None
        - Get only processed products: filter_status="processed"
        - Get only unprocessed products: filter_status="not_processed"
        
    Recommendation: Use limit=150 for optimal performance and memory usage
    """
    from .error_handling import (
        create_user_friendly_error,
        error_handler,
        ErrorCategory,
        ErrorSeverity,
        log_recovery_attempt
    )
    
    logger.info("Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÐ¿Ð¸ÑÐºÐ° SKU Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²")
    
    try:
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
        if database_manager is None:
            logger.error("ÐœÐµÐ½ÐµÐ´Ð¶ÐµÑ€ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½")
            return {
                "status": "error",
                "message": "Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ°: Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½",
                "error_code": "COMPONENT_NOT_INITIALIZED",
                "user_message": "Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ",
                "recoverable": True,
                "retry_suggested": True
            }
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÑÐµ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹ Ð¸Ð· Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
        products = await database_manager.get_all_products()
        
        if not products:
            logger.info("Ð’ Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½ÐµÑ‚ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²")
            return {
                "status": "no_data",
                "message": "Ð’ Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½ÐµÑ‚ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²",
                "user_message": "Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾ÐºÐ° Ð½Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²",
                "products": [],
                "total_count": 0,
                "recoverable": True,
                "retry_suggested": False
            }
        
        # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº SKU Ñ Ð±Ð°Ð·Ð¾Ð²Ð¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹ Ð¸ ÑÑ‚Ð°Ñ‚ÑƒÑÐ¾Ð¼ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
        product_list = []
        for product in products:
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ñƒ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ñ†ÐµÐ½Ñ‹ (Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½ Ð»Ð¸ Ð¾Ð½)
            has_prices = await database_manager.has_product_prices(product["id"])
            
            product_info = {
                "sku": product["code"],
                "model_name": product["model_name"],
                "category": product["category"],
                "unit": product["unit"],
                "processed": has_prices,
                "status": "processed" if has_prices else "not_processed"
            }
            
            # ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÐ¼ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€ Ð¿Ð¾ ÑÑ‚Ð°Ñ‚ÑƒÑÑƒ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
            if filter_status == "all":
                product_list.append(product_info)
            elif filter_status == "processed" and has_prices:
                product_list.append(product_info)
            elif filter_status == "not_processed" and not has_prices:
                product_list.append(product_info)
        
        total_count = len(product_list)
        
        # ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÐ¼ Ð¿Ð°Ð³Ð¸Ð½Ð°Ñ†Ð¸ÑŽ
        if offset < 0:
            offset = 0
        
        if offset >= total_count:
            logger.info(f"Offset {offset} Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐ°ÐµÑ‚ Ð¾Ð±Ñ‰ÐµÐµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² {total_count}")
            return {
                "status": "success",
                "products": [],
                "total_count": total_count,
                "offset": offset,
                "limit": limit,
                "filter_status": filter_status,
                "returned_count": 0,
                "has_more": False,
                "timestamp": datetime.now().isoformat()
            }
        
        # ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÐ¼ ÑÑ€ÐµÐ· Ð´Ð»Ñ Ð¿Ð°Ð³Ð¸Ð½Ð°Ñ†Ð¸Ð¸
        if limit is None:
            paginated_products = product_list[offset:]
        else:
            if limit <= 0:
                limit = 150  # Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÐ¼Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
            paginated_products = product_list[offset:offset + limit]
        
        returned_count = len(paginated_products)
        has_more = (offset + returned_count) < total_count
        
        logger.info(f"ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¸Ð· {returned_count} Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² (offset: {offset}, limit: {limit}, total: {total_count})")
        
        log_recovery_attempt(
            component="server",
            action=f"Ð£ÑÐ¿ÐµÑˆÐ½Ð¾Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÐ¿Ð¸ÑÐºÐ° {returned_count} Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ñ Ð¿Ð°Ð³Ð¸Ð½Ð°Ñ†Ð¸ÐµÐ¹",
            success=True
        )
        
        return {
            "status": "success",
            "products": paginated_products,
            "total_count": total_count,
            "offset": offset,
            "limit": limit,
            "filter_status": filter_status,
            "returned_count": returned_count,
            "has_more": has_more,
            "timestamp": datetime.now().isoformat()
        }
        
    except Exception as e:
        error_handler.log_error(
            error=e,
            category=ErrorCategory.DATABASE,
            severity=ErrorSeverity.HIGH,
            component="server",
            details={"tool": "get_product_list"},
            recovery_action="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ"
        )
        return create_user_friendly_error(e, "Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÐ¿Ð¸ÑÐºÐ° Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²")

@handle_errors(
    category=ErrorCategory.SYSTEM,
    severity=ErrorSeverity.MEDIUM,
    component="mcp_server",
    recovery_action="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ"
)
@mcp.tool()
async def get_statistics(ctx: Context = None) -> dict:
    """
    Get statistics about processed products and price comparisons
    
    Args:
        ctx: MCP context object
        
    Returns:
        Dictionary with comprehensive statistics about the processed data
    """
    from .error_handling import (
        create_user_friendly_error,
        error_handler,
        ErrorCategory,
        ErrorSeverity,
        log_recovery_attempt
    )
    
    logger.info("Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸")
    
    try:
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
        if statistics_generator is None:
            logger.error("Ð“ÐµÐ½ÐµÑ€Ð°Ñ‚Ð¾Ñ€ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½")
            return {
                "status": "error",
                "message": "Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ°: Ð³ÐµÐ½ÐµÑ€Ð°Ñ‚Ð¾Ñ€ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½",
                "error_code": "COMPONENT_NOT_INITIALIZED",
                "user_message": "Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ",
                "recoverable": True,
                "retry_suggested": True
            }
        
        if database_manager is None:
            logger.error("ÐœÐµÐ½ÐµÐ´Ð¶ÐµÑ€ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½")
            return {
                "status": "error",
                "message": "Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ°: Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½",
                "error_code": "COMPONENT_NOT_INITIALIZED",
                "user_message": "Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ",
                "recoverable": True,
                "retry_suggested": True
            }
        
        # Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾Ð»Ð½ÑƒÑŽ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ Ñ‡ÐµÑ€ÐµÐ· StatisticsGenerator
        logger.info("Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ñ‡ÐµÑ€ÐµÐ· StatisticsGenerator...")
        full_statistics = await statistics_generator.generate_full_statistics()
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð°
        if not full_statistics:
            logger.warning("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ")
            log_recovery_attempt(
                component="server",
                action="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð¿ÑƒÑÑ‚Ð¾Ð¹ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸",
                success=True
            )
            return {
                "status": "no_data",
                "message": "ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸",
                "user_message": "Ð’ Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾ÐºÐ° Ð½ÐµÑ‚ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ñ… Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°",
                "statistics": {
                    "total_products": 0,
                    "products_with_prices": 0,
                    "average_delta_percent": 0.0,
                    "category_breakdown": {},
                    "marketplace_coverage": {}
                },
                "timestamp": datetime.now().isoformat(),
                "recoverable": True,
                "retry_suggested": False
            }
        
        # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ñ‚Ð²ÐµÑ‚ Ð² ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ð¸ Ñ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸ÑÐ¼Ð¸
        response = {
            "status": "success",
            "statistics": {
                "total_products": full_statistics.total_products,
                "products_with_prices": full_statistics.products_with_prices,
                "average_delta_percent": round(full_statistics.average_delta_percent, 2),
                "category_breakdown": full_statistics.category_breakdown,
                "marketplace_coverage": full_statistics.marketplace_coverage
            },
            "timestamp": full_statistics.processing_timestamp.isoformat() if hasattr(full_statistics, 'processing_timestamp') and full_statistics.processing_timestamp else datetime.now().isoformat()
        }
        
        # Ð›Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸
        logger.info(
            f"Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð°: {full_statistics.total_products} Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð², "
            f"{full_statistics.products_with_prices} Ñ Ñ†ÐµÐ½Ð°Ð¼Ð¸, "
            f"ÑÑ€ÐµÐ´Ð½ÑÑ Ð´ÐµÐ»ÑŒÑ‚Ð°: {full_statistics.average_delta_percent:.2f}%"
        )
        
        log_recovery_attempt(
            component="server",
            action=f"Ð£ÑÐ¿ÐµÑˆÐ½Ð°Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ð´Ð»Ñ {full_statistics.total_products} Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²",
            success=True
        )
        
        return response
        
    except Exception as e:
        error_handler.log_error(
            error=e,
            category=ErrorCategory.SYSTEM,
            severity=ErrorSeverity.HIGH,
            component="server",
            details={"tool": "get_statistics"},
            recovery_action="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ"
        )
        return create_user_friendly_error(e, "Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸")

@handle_errors(
    category=ErrorCategory.DATABASE,
    severity=ErrorSeverity.MEDIUM,
    component="mcp_server",
    recovery_action="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ"
)
@mcp.tool()
async def save_product_prices(product_code: float, search_results: dict, ctx: Context = None) -> dict:
    """
    Save found prices for a specific product to the database
    
    Args:
        product_code: Unique product code from the database
        search_results: Dictionary with search results (supports multiple formats)
        ctx: MCP context object
        
    Returns:
        Dictionary with save operation results
    """
    from .error_handling import (
        create_user_friendly_error,
        ValidationError,
        error_handler,
        ErrorCategory,
        ErrorSeverity,
        log_recovery_attempt
    )
    
    logger.info(f"Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ñ†ÐµÐ½ Ð´Ð»Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ñ ÐºÐ¾Ð´Ð¾Ð¼: {product_code}")
    logger.debug(f"ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ðµ: {search_results}")
    
    try:
        # Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
        if not isinstance(product_code, (int, float)):
            error = ValidationError("ÐšÐ¾Ð´ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ñ‡Ð¸ÑÐ»Ð¾Ð¼", field="product_code", value=product_code)
            return create_user_friendly_error(error, "ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ñ†ÐµÐ½ Ñ‚Ð¾Ð²Ð°Ñ€Ð°")
        
        if not search_results or not isinstance(search_results, dict):
            error = ValidationError("Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð¿Ð¾Ð¸ÑÐºÐ° Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ ÑÐ»Ð¾Ð²Ð°Ñ€ÐµÐ¼", field="search_results", value=search_results)
            return create_user_friendly_error(error, "ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ñ†ÐµÐ½ Ñ‚Ð¾Ð²Ð°Ñ€Ð°")
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
        if database_manager is None:
            logger.error("ÐœÐµÐ½ÐµÐ´Ð¶ÐµÑ€ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½")
            return {
                "status": "error",
                "message": "Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ°: Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½",
                "error_code": "COMPONENT_NOT_INITIALIZED",
                "user_message": "Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ",
                "recoverable": True,
                "retry_suggested": True
            }
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚ Ð¸Ð· Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
        product = await database_manager.get_product_by_code(product_code)
        if not product:
            logger.warning(f"ÐŸÑ€Ð¾Ð´ÑƒÐºÑ‚ Ñ ÐºÐ¾Ð´Ð¾Ð¼ {product_code} Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…")
            return {
                "status": "not_found",
                "message": f"ÐŸÑ€Ð¾Ð´ÑƒÐºÑ‚ Ñ ÐºÐ¾Ð´Ð¾Ð¼ {product_code} Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½",
                "error_code": "PRODUCT_NOT_FOUND",
                "user_message": "Ð¢Ð¾Ð²Ð°Ñ€ Ñ ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ð¼ ÐºÐ¾Ð´Ð¾Ð¼ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…",
                "recoverable": False,
                "retry_suggested": False
            }
        
        # ÐÐ¾Ñ€Ð¼Ð°Ð»Ð¸Ð·ÑƒÐµÐ¼ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ - Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÐ¼ Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ñ‹
        results = []
        
        # Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ 1: {"results": [...]}
        if "results" in search_results and isinstance(search_results["results"], list):
            results = search_results["results"]
            logger.debug(f"ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ 1: results array Ñ {len(results)} ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð°Ð¼Ð¸")
        
        # Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ 2: {"found_offers": [...]}
        elif "found_offers" in search_results and isinstance(search_results["found_offers"], list):
            results = search_results["found_offers"]
            logger.debug(f"ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ 2: found_offers array Ñ {len(results)} ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð°Ð¼Ð¸")
            # ÐÐ¾Ñ€Ð¼Ð°Ð»Ð¸Ð·ÑƒÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð´Ð»Ñ found_offers
            for result in results:
                if "product_found" not in result:
                    result["product_found"] = True  # Ð•ÑÐ»Ð¸ Ñ†ÐµÐ½Ð° ÐµÑÑ‚ÑŒ, Ð·Ð½Ð°Ñ‡Ð¸Ñ‚ Ñ‚Ð¾Ð²Ð°Ñ€ Ð½Ð°Ð¹Ð´ÐµÐ½
        
        # Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ 3: ÐŸÑ€ÑÐ¼Ñ‹Ðµ Ð¿Ð¾Ð»Ñ Ð² ÐºÐ¾Ñ€Ð½Ðµ (Ð¾Ð´Ð¸Ð½ Ñ‚Ð¾Ð²Ð°Ñ€)
        elif "marketplace" in search_results and "price" in search_results:
            results = [search_results]
            search_results["product_found"] = True
            logger.debug("ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ 3: Ð¿Ñ€ÑÐ¼Ñ‹Ðµ Ð¿Ð¾Ð»Ñ Ð² ÐºÐ¾Ñ€Ð½Ðµ")
        
        # Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ 4: ÐœÐ°ÑÑÐ¸Ð² Ð² ÐºÐ¾Ñ€Ð½Ðµ
        elif isinstance(search_results, list):
            results = search_results
            logger.debug(f"ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ 4: Ð¼Ð°ÑÑÐ¸Ð² Ð² ÐºÐ¾Ñ€Ð½Ðµ Ñ {len(results)} ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð°Ð¼Ð¸")
            # ÐÐ¾Ñ€Ð¼Ð°Ð»Ð¸Ð·ÑƒÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ
            for result in results:
                if "product_found" not in result:
                    result["product_found"] = True
        
        # Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ 5: ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð° Ñ marketplaces (Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹)
        elif "marketplaces" in search_results and isinstance(search_results["marketplaces"], dict):
            results = []
            marketplaces = search_results["marketplaces"]
            logger.debug(f"ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ 5: marketplaces Ñ {len(marketplaces)} Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ°Ð¼Ð¸")
            
            for marketplace_name, marketplace_data in marketplaces.items():
                if isinstance(marketplace_data, dict) and "price" in marketplace_data:
                    # ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ Ñ†ÐµÐ½Ñƒ Ð¸Ð· ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ð² Ñ‡Ð¸ÑÐ»Ð¾
                    price_str = marketplace_data.get("price", "")
                    price_value = None
                    
                    if price_str:
                        # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ñ‡Ð¸ÑÐ»Ð¾Ð²Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð¸Ð· ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ñ‚Ð¸Ð¿Ð° "299 Ñ€ÑƒÐ±" Ð¸Ð»Ð¸ "Ð¾Ñ‚ 280 Ñ€ÑƒÐ±"
                        import re
                        price_match = re.search(r'(\d+(?:\.\d+)?)', str(price_str))
                        if price_match:
                            price_value = float(price_match.group(1))
                    
                    if price_value and price_value > 0:
                        result_item = {
                            "marketplace": marketplace_name,
                            "price": price_value,
                            "currency": "RUB",
                            "availability": marketplace_data.get("availability", "ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾"),
                            "product_url": marketplace_data.get("url"),
                            "rating": marketplace_data.get("rating"),
                            "reviews_count": marketplace_data.get("reviews_count"),
                            "product_found": True
                        }
                        results.append(result_item)
                        logger.debug(f"Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð´Ð»Ñ {marketplace_name}: {price_value} Ñ€ÑƒÐ±")
                    else:
                        logger.debug(f"ÐŸÑ€Ð¾Ð¿ÑƒÑ‰ÐµÐ½ {marketplace_name}: Ð½ÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð°Ñ Ñ†ÐµÐ½Ð° '{price_str}'")
        
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ñƒ Ð½Ð°Ñ ÐµÑÑ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ
        if not results:
            logger.warning(f"ÐÐµÑ‚ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² Ð¿Ð¾Ð¸ÑÐºÐ° Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ")
            logger.debug(f"Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…: {list(search_results.keys())}")
            logger.debug(f"ÐŸÐ¾Ð»Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ: {search_results}")
            
            # Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ°
            diagnostic_info = {
                "received_keys": list(search_results.keys()),
                "has_marketplaces": "marketplaces" in search_results,
                "has_results": "results" in search_results,
                "has_found_offers": "found_offers" in search_results,
                "is_list": isinstance(search_results, list),
                "has_direct_fields": "marketplace" in search_results and "price" in search_results
            }
            
            if "marketplaces" in search_results:
                marketplaces = search_results["marketplaces"]
                diagnostic_info["marketplaces_type"] = type(marketplaces).__name__
                if isinstance(marketplaces, dict):
                    diagnostic_info["marketplaces_keys"] = list(marketplaces.keys())
                    diagnostic_info["marketplaces_count"] = len(marketplaces)
                    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹Ñ
                    for mp_name, mp_data in marketplaces.items():
                        diagnostic_info[f"{mp_name}_has_price"] = "price" in mp_data if isinstance(mp_data, dict) else False
                        if isinstance(mp_data, dict) and "price" in mp_data:
                            diagnostic_info[f"{mp_name}_price_value"] = mp_data["price"]
            
            return {
                "status": "no_data",
                "message": "ÐÐµÑ‚ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² Ð¿Ð¾Ð¸ÑÐºÐ° Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ",
                "user_message": "Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð¿Ð¾Ð¸ÑÐºÐ° Ð¿ÑƒÑÑ‚Ñ‹, Ð½ÐµÑ‡ÐµÐ³Ð¾ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑ‚ÑŒ",
                "diagnostic_info": diagnostic_info,
                "recoverable": True,
                "retry_suggested": False
            }
        
        # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ†ÐµÐ½Ñ‹ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ°
        saved_count = 0
        errors = []
        saved_prices = []
        
        for i, result in enumerate(results):
            logger.debug(f"ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð° {i+1}: {result}")
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ†ÐµÐ½Ñ‹ (Ð³Ð¸Ð±ÐºÐ¾)
            price = result.get("price")
            if not price:
                logger.debug(f"Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ {i+1}: Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ñ†ÐµÐ½Ð°, ÐºÐ»ÑŽÑ‡Ð¸: {list(result.keys())}")
                errors.append(f"Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ {i+1}: Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð¿Ð¾Ð»Ðµ 'price'")
                continue
                
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€ Ð½Ð°Ð¹Ð´ÐµÐ½ (ÐµÑÐ»Ð¸ Ð¿Ð¾Ð»Ðµ ÐµÑÑ‚ÑŒ)
            if "product_found" in result and not result.get("product_found"):
                logger.debug(f"Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ {i+1}: Ñ‚Ð¾Ð²Ð°Ñ€ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ (product_found=False)")
                errors.append(f"Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ {i+1}: Ñ‚Ð¾Ð²Ð°Ñ€ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð½Ð° Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐµ")
                continue
                
            try:
                # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ñ†ÐµÐ½Ð° Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ð° Ð² Ñ‡Ð¸ÑÐ»Ð¾
                try:
                    price_float = float(price)
                    if price_float <= 0:
                        raise ValueError(f"Ð¦ÐµÐ½Ð° Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼ Ñ‡Ð¸ÑÐ»Ð¾Ð¼, Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¾: {price_float}")
                except (ValueError, TypeError) as e:
                    error_msg = f"Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ {i+1}: Ð½ÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð°Ñ Ñ†ÐµÐ½Ð° '{price}': {e}"
                    errors.append(error_msg)
                    logger.warning(error_msg)
                    continue
                
                price_data = {
                    "marketplace": result.get("marketplace", "unknown"),
                    "price": price_float,
                    "currency": result.get("currency", "RUB"),
                    "availability": result.get("availability", "ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾"),
                    "product_url": result.get("product_url") or result.get("url")
                }
                
                logger.debug(f"ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ñ†ÐµÐ½Ñ‹: {price_data}")
                await database_manager.save_price(product["id"], price_data)
                saved_count += 1
                saved_prices.append({
                    "marketplace": price_data["marketplace"],
                    "price": price_data["price"],
                    "currency": price_data["currency"],
                    "availability": price_data["availability"]
                })
                logger.info(f"Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð° Ñ†ÐµÐ½Ð° Ð´Ð»Ñ {price_data['marketplace']}: {price_data['price']} {price_data['currency']}")
                
            except Exception as price_error:
                error_msg = f"ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ñ†ÐµÐ½Ñ‹ Ð´Ð»Ñ {result.get('marketplace', 'unknown')}: {price_error}"
                errors.append(error_msg)
                logger.error(error_msg)
                logger.debug(f"Ð”ÐµÑ‚Ð°Ð»Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ¸: Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚={result}, Ð¾ÑˆÐ¸Ð±ÐºÐ°={type(price_error).__name__}: {price_error}")
        
        # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ñ‚Ð²ÐµÑ‚
        if saved_count > 0:
            logger.info(f"Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¾ {saved_count} Ñ†ÐµÐ½ Ð´Ð»Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð° {product_code}")
            log_recovery_attempt(
                component="server",
                action=f"Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ {saved_count} Ñ†ÐµÐ½ Ð´Ð»Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð° {product_code}",
                success=True
            )
            
            response = {
                "status": "success",
                "message": f"Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¾ {saved_count} Ñ†ÐµÐ½ Ð´Ð»Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð° {product_code}",
                "product_code": product_code,
                "product_name": product["model_name"],
                "saved_prices": saved_count,
                "total_results": len(results),
                "prices_saved": saved_prices,
                "timestamp": datetime.now().isoformat()
            }
            
            if errors:
                response["warnings"] = errors
                
            return response
        else:
            logger.warning(f"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð½Ð¸ Ð¾Ð´Ð½Ð¾Ð¹ Ñ†ÐµÐ½Ñ‹ Ð´Ð»Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð° {product_code}")
            return {
                "status": "no_data",
                "message": "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð½Ð¸ Ð¾Ð´Ð½Ð¾Ð¹ Ñ†ÐµÐ½Ñ‹",
                "user_message": "Ð’ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°Ñ… Ð¿Ð¾Ð¸ÑÐºÐ° Ð½ÐµÑ‚ Ð²Ð°Ð»Ð¸Ð´Ð½Ñ‹Ñ… Ñ†ÐµÐ½ Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ",
                "product_code": product_code,
                "total_results": len(results),
                "errors": errors,
                "recoverable": True,
                "retry_suggested": True
            }
        
    except Exception as e:
        error_handler.log_error(
            error=e,
            category=ErrorCategory.DATABASE,
            severity=ErrorSeverity.HIGH,
            component="server",
            details={"tool": "save_product_prices", "product_code": product_code},
            recovery_action="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ"
        )
        return create_user_friendly_error(e, "ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ñ†ÐµÐ½ Ñ‚Ð¾Ð²Ð°Ñ€Ð°")


@handle_errors(
    category=ErrorCategory.SYSTEM,
    severity=ErrorSeverity.LOW,
    component="mcp_server",
    recovery_action="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¸"
)
@mcp.tool()
async def check_license_status(ctx: Context = None) -> dict:
    """
    Check the current license status and information
    
    Args:
        ctx: MCP context object
        
    Returns:
        Dictionary with license status and information
    """
    from .error_handling import (
        create_user_friendly_error,
        error_handler,
        ErrorCategory,
        ErrorSeverity,
        log_recovery_attempt
    )
    
    logger.info("Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¸")
    
    try:
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÐ·ÐµÐ¼Ð¿Ð»ÑÑ€ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ð° Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¹
        license_manager = LicenseManager()
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¸
        license_info = license_manager.get_license_info()
        
        is_valid = license_info["is_valid"]
        license_data = license_info["license_data"]
        
        if is_valid:
            logger.info("Ð›Ð¸Ñ†ÐµÐ½Ð·Ð¸Ñ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°")
            log_recovery_attempt(
                component="server",
                action="Ð£ÑÐ¿ÐµÑˆÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¸",
                success=True
            )
            
            return {
                "status": "valid",
                "message": "Ð›Ð¸Ñ†ÐµÐ½Ð·Ð¸Ñ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°",
                "license_key": license_info["license_key"],
                "license_info": {
                    "valid": license_data.get("valid", False),
                    "checked_at": license_data.get("checked_at"),
                    "expires_at": license_data.get("expires_at"),
                    "plan": license_data.get("plan"),
                    "features": license_data.get("features", [])
                },
                "api_url": license_info["api_url"]
            }
        else:
            logger.warning("Ð›Ð¸Ñ†ÐµÐ½Ð·Ð¸Ñ Ð½ÐµÐ´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°")
            log_recovery_attempt(
                component="server",
                action="ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð° Ð½ÐµÐ´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ñ",
                success=False
            )
            
            return {
                "status": "invalid",
                "message": "Ð›Ð¸Ñ†ÐµÐ½Ð·Ð¸Ñ Ð½ÐµÐ´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°",
                "license_key": license_info["license_key"],
                "error": license_data.get("error", "UNKNOWN_ERROR"),
                "error_message": license_data.get("message", "ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°"),
                "user_message": license_data.get("user_message", "Ð›Ð¸Ñ†ÐµÐ½Ð·Ð¸Ñ Ð½ÐµÐ´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°"),
                "api_url": license_info["api_url"]
            }
            
    except Exception as e:
        error_handler.log_error(
            error=e,
            category=ErrorCategory.SYSTEM,
            severity=ErrorSeverity.MEDIUM,
            component="server",
            details={"tool": "check_license_status"},
            recovery_action="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¸"
        )
        return create_user_friendly_error(e, "Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¸")

@handle_errors(
    category=ErrorCategory.SYSTEM,
    severity=ErrorSeverity.MEDIUM,
    component="mcp_server",
    recovery_action="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¸"
)
@mcp.tool()
async def set_license_key(license_key: str, ctx: Context = None) -> dict:
    """
    Set a new license key for the system
    
    Args:
        license_key: New license key to set
        ctx: MCP context object
        
    Returns:
        Dictionary with result of license key setting
    """
    from .error_handling import (
        create_user_friendly_error,
        ValidationError,
        error_handler,
        ErrorCategory,
        ErrorSeverity,
        log_recovery_attempt
    )
    
    logger.info("Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¾Ð½Ð½Ð¾Ð³Ð¾ ÐºÐ»ÑŽÑ‡Ð°")
    
    try:
        # Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
        if not license_key or not isinstance(license_key, str) or len(license_key.strip()) == 0:
            error = ValidationError("ÐÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ ÑƒÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð½ÐµÐ¿ÑƒÑÑ‚Ð¾Ð¹ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡", field="license_key", value=license_key)
            return create_user_friendly_error(error, "ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¾Ð½Ð½Ð¾Ð³Ð¾ ÐºÐ»ÑŽÑ‡Ð°")
        
        license_key = license_key.strip()
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÐ·ÐµÐ¼Ð¿Ð»ÑÑ€ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ð° Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¹
        license_manager = LicenseManager()
        
        # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡
        success = license_manager.set_license_key(license_key, save_to_config=True)
        
        if success:
            logger.info("ÐÐ¾Ð²Ñ‹Ð¹ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½")
            log_recovery_attempt(
                component="server",
                action="Ð£ÑÐ¿ÐµÑˆÐ½Ð°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¾Ð½Ð½Ð¾Ð³Ð¾ ÐºÐ»ÑŽÑ‡Ð°",
                success=True
            )
            
            # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð½Ð¾Ð²Ð¾Ð¹ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¸
            license_info = license_manager.get_license_info()
            
            return {
                "status": "success",
                "message": "Ð›Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½",
                "license_key": license_key,
                "license_info": license_info["license_data"],
                "saved_to_config": True
            }
        else:
            logger.error("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ð¹ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡")
            log_recovery_attempt(
                component="server",
                action="ÐÐµÑƒÐ´Ð°Ñ‡Ð½Ð°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¾Ð½Ð½Ð¾Ð³Ð¾ ÐºÐ»ÑŽÑ‡Ð°",
                success=False
            )
            
            return {
                "status": "error",
                "message": "Ð›Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ Ð½ÐµÐ´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÐµÐ½",
                "error_code": "INVALID_LICENSE_KEY",
                "user_message": "Ð£ÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ð¹ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ Ð½ÐµÐ´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÐµÐ½",
                "license_key": license_key,
                "recoverable": True,
                "retry_suggested": True
            }
            
    except Exception as e:
        error_handler.log_error(
            error=e,
            category=ErrorCategory.SYSTEM,
            severity=ErrorSeverity.HIGH,
            component="server",
            details={"tool": "set_license_key", "license_key": license_key[:8] + "..." if license_key else "None"},
            recovery_action="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ"
        )
        return create_user_friendly_error(e, "ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¾Ð½Ð½Ð¾Ð³Ð¾ ÐºÐ»ÑŽÑ‡Ð°")

# Excel Tools MCP Functions

@handle_errors(
    category=ErrorCategory.PARSING,
    severity=ErrorSeverity.MEDIUM,
    component="mcp_server",
    recovery_action="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ"
)
@mcp.tool()
async def parse_excel_file(file_path: str, sheet_name: Optional[str] = None, 
                          header_row: int = 0, max_rows: Optional[int] = None, 
                          ctx: Context = None) -> dict:
    """
    Parse Excel file and return structured data
    
    Args:
        file_path: Path to Excel file
        sheet_name: Sheet name (if None, uses first sheet)
        header_row: Header row number (0-based)
        max_rows: Maximum number of rows to read
        ctx: MCP context object
        
    Returns:
        Dictionary with parsed Excel data
    """
    from .error_handling import (
        create_user_friendly_error,
        ValidationError,
        error_handler,
        ErrorCategory,
        ErrorSeverity,
        log_recovery_attempt
    )
    
    logger.info(f"Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³ Excel Ñ„Ð°Ð¹Ð»Ð°: {file_path}")
    
    try:
        # Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
        if not file_path or not isinstance(file_path, str):
            error = ValidationError("ÐÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ ÑƒÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¿ÑƒÑ‚ÑŒ Ðº Excel Ñ„Ð°Ð¹Ð»Ñƒ", field="file_path", value=file_path)
            return create_user_friendly_error(error, "Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³ Excel Ñ„Ð°Ð¹Ð»Ð°")
        
        if header_row < 0:
            error = ValidationError("ÐÐ¾Ð¼ÐµÑ€ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¾Ð² Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ñ‚Ñ€Ð¸Ñ†Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼", field="header_row", value=header_row)
            return create_user_friendly_error(error, "Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³ Excel Ñ„Ð°Ð¹Ð»Ð°")
        
        if max_rows is not None and max_rows <= 0:
            error = ValidationError("ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÑ‚Ñ€Ð¾Ðº Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼", field="max_rows", value=max_rows)
            return create_user_friendly_error(error, "Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³ Excel Ñ„Ð°Ð¹Ð»Ð°")
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
        if excel_tools is None:
            logger.error("Excel Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹")
            return {
                "status": "error",
                "message": "Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ°: Excel Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹",
                "error_code": "COMPONENT_NOT_INITIALIZED",
                "user_message": "Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ",
                "recoverable": True,
                "retry_suggested": True
            }
        
        # ÐŸÐ°Ñ€ÑÐ¸Ð¼ Excel Ñ„Ð°Ð¹Ð»
        result = await excel_tools.parse_excel_file(
            file_path=file_path,
            sheet_name=sheet_name,
            header_row=header_row,
            max_rows=max_rows
        )
        
        logger.info(f"Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ Ñ€Ð°ÑÐ¿Ð°Ñ€ÑÐµÐ½ Excel Ñ„Ð°Ð¹Ð»: {result.get('total_rows', 0)} ÑÑ‚Ñ€Ð¾Ðº")
        
        log_recovery_attempt(
            component="server",
            action=f"Ð£ÑÐ¿ÐµÑˆÐ½Ñ‹Ð¹ Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³ Excel Ñ„Ð°Ð¹Ð»Ð° {file_path}",
            success=True
        )
        
        return result
        
    except Exception as e:
        error_handler.log_error(
            error=e,
            category=ErrorCategory.PARSING,
            severity=ErrorSeverity.HIGH,
            component="server",
            details={"tool": "parse_excel_file", "file_path": file_path},
            recovery_action="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ"
        )
        return create_user_friendly_error(e, "Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³ Excel Ñ„Ð°Ð¹Ð»Ð°")

@handle_errors(
    category=ErrorCategory.PARSING,
    severity=ErrorSeverity.MEDIUM,
    component="mcp_server",
    recovery_action="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ"
)
@mcp.tool()
async def get_excel_info(file_path: str, ctx: Context = None) -> dict:
    """
    Get information about Excel file structure without reading all data
    
    Args:
        file_path: Path to Excel file
        ctx: MCP context object
        
    Returns:
        Dictionary with Excel file structure information
    """
    from .error_handling import (
        create_user_friendly_error,
        ValidationError,
        error_handler,
        ErrorCategory,
        ErrorSeverity,
        log_recovery_attempt
    )
    
    logger.info(f"Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Excel Ñ„Ð°Ð¹Ð»Ðµ: {file_path}")
    
    try:
        # Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
        if not file_path or not isinstance(file_path, str):
            error = ValidationError("ÐÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ ÑƒÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¿ÑƒÑ‚ÑŒ Ðº Excel Ñ„Ð°Ð¹Ð»Ñƒ", field="file_path", value=file_path)
            return create_user_friendly_error(error, "Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Excel Ñ„Ð°Ð¹Ð»Ðµ")
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
        if excel_tools is None:
            logger.error("Excel Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹")
            return {
                "status": "error",
                "message": "Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ°: Excel Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹",
                "error_code": "COMPONENT_NOT_INITIALIZED",
                "user_message": "Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ",
                "recoverable": True,
                "retry_suggested": True
            }
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ñ„Ð°Ð¹Ð»Ðµ
        result = await excel_tools.get_excel_info(file_path)
        
        logger.info(f"ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð° Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Excel Ñ„Ð°Ð¹Ð»Ðµ: {result.get('total_sheets', 0)} Ð»Ð¸ÑÑ‚Ð¾Ð²")
        
        log_recovery_attempt(
            component="server",
            action=f"Ð£ÑÐ¿ÐµÑˆÐ½Ð¾Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Excel Ñ„Ð°Ð¹Ð»Ðµ {file_path}",
            success=True
        )
        
        return result
        
    except Exception as e:
        error_handler.log_error(
            error=e,
            category=ErrorCategory.PARSING,
            severity=ErrorSeverity.HIGH,
            component="server",
            details={"tool": "get_excel_info", "file_path": file_path},
            recovery_action="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ"
        )
        return create_user_friendly_error(e, "Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Excel Ñ„Ð°Ð¹Ð»Ðµ")

@handle_errors(
    category=ErrorCategory.PARSING,
    severity=ErrorSeverity.MEDIUM,
    component="mcp_server",
    recovery_action="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ"
)
@mcp.tool()
async def export_to_excel(data: List[Dict[str, Any]], file_path: str,
                         sheet_name: str = "Data", include_index: bool = False,
                         auto_adjust_columns: bool = True, apply_formatting: bool = True,
                         ctx: Context = None) -> dict:
    """
    Export data to Excel file with formatting
    
    Args:
        data: List of dictionaries with data to export
        file_path: Path to save Excel file
        sheet_name: Sheet name
        include_index: Whether to include row index
        auto_adjust_columns: Auto-adjust column widths
        apply_formatting: Apply formatting to the file
        ctx: MCP context object
        
    Returns:
        Dictionary with export result
    """
    from .error_handling import (
        create_user_friendly_error,
        ValidationError,
        error_handler,
        ErrorCategory,
        ErrorSeverity,
        log_recovery_attempt
    )
    
    logger.info(f"Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° ÑÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð² Excel Ñ„Ð°Ð¹Ð»: {file_path}")
    
    try:
        # Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
        if not file_path or not isinstance(file_path, str):
            error = ValidationError("ÐÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ ÑƒÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¿ÑƒÑ‚ÑŒ Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Excel Ñ„Ð°Ð¹Ð»Ð°", field="file_path", value=file_path)
            return create_user_friendly_error(error, "ÑÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð² Excel Ñ„Ð°Ð¹Ð»")
        
        if not data or not isinstance(data, list):
            error = ValidationError("Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐºÐ¾Ð¼ ÑÐ»Ð¾Ð²Ð°Ñ€ÐµÐ¹", field="data", value=type(data).__name__)
            return create_user_friendly_error(error, "ÑÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð² Excel Ñ„Ð°Ð¹Ð»")
        
        if not sheet_name or not isinstance(sheet_name, str):
            error = ValidationError("ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð»Ð¸ÑÑ‚Ð° Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ð½ÐµÐ¿ÑƒÑÑ‚Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¾Ð¹", field="sheet_name", value=sheet_name)
            return create_user_friendly_error(error, "ÑÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð² Excel Ñ„Ð°Ð¹Ð»")
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
        if excel_tools is None:
            logger.error("Excel Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹")
            return {
                "status": "error",
                "message": "Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ°: Excel Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹",
                "error_code": "COMPONENT_NOT_INITIALIZED",
                "user_message": "Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ",
                "recoverable": True,
                "retry_suggested": True
            }
        
        # Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ
        result = await excel_tools.export_to_excel(
            data=data,
            file_path=file_path,
            sheet_name=sheet_name,
            include_index=include_index,
            auto_adjust_columns=auto_adjust_columns,
            apply_formatting=apply_formatting
        )
        
        logger.info(f"Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð² Excel Ñ„Ð°Ð¹Ð»: {result.get('rows_exported', 0)} ÑÑ‚Ñ€Ð¾Ðº")
        
        log_recovery_attempt(
            component="server",
            action=f"Ð£ÑÐ¿ÐµÑˆÐ½Ñ‹Ð¹ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð² Excel Ñ„Ð°Ð¹Ð» {file_path}",
            success=True
        )
        
        return result
        
    except Exception as e:
        error_handler.log_error(
            error=e,
            category=ErrorCategory.PARSING,
            severity=ErrorSeverity.HIGH,
            component="server",
            details={"tool": "export_to_excel", "file_path": file_path},
            recovery_action="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ"
        )
        return create_user_friendly_error(e, "ÑÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð² Excel Ñ„Ð°Ð¹Ð»")

@handle_errors(
    category=ErrorCategory.PARSING,
    severity=ErrorSeverity.MEDIUM,
    component="mcp_server",
    recovery_action="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ"
)
@mcp.tool()
async def filter_excel_data(data: List[Dict[str, Any]], filters: Dict[str, Any], 
                           ctx: Context = None) -> dict:
    """
    Filter Excel data by specified criteria
    
    Args:
        data: Source data to filter
        filters: Dictionary with filter criteria
        ctx: MCP context object
        
    Returns:
        Filtered data
    """
    from .error_handling import (
        create_user_friendly_error,
        ValidationError,
        error_handler,
        ErrorCategory,
        ErrorSeverity,
        log_recovery_attempt
    )
    
    logger.info(f"Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸ÑŽ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾ ÐºÑ€Ð¸Ñ‚ÐµÑ€Ð¸ÑÐ¼: {filters}")
    
    try:
        # Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
        if not data or not isinstance(data, list):
            error = ValidationError("Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐºÐ¾Ð¼ ÑÐ»Ð¾Ð²Ð°Ñ€ÐµÐ¹", field="data", value=type(data).__name__)
            return create_user_friendly_error(error, "Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…")
        
        if not filters or not isinstance(filters, dict):
            error = ValidationError("Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ ÑÐ»Ð¾Ð²Ð°Ñ€ÐµÐ¼", field="filters", value=type(filters).__name__)
            return create_user_friendly_error(error, "Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…")
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
        if excel_tools is None:
            logger.error("Excel Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹")
            return {
                "status": "error",
                "message": "Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ°: Excel Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹",
                "error_code": "COMPONENT_NOT_INITIALIZED",
                "user_message": "Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ",
                "recoverable": True,
                "retry_suggested": True
            }
        
        # Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ÑƒÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ
        result = await excel_tools.filter_excel_data(data, filters)
        
        logger.info(f"Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°: {result.get('filtered_count', 0)} Ð¸Ð· {result.get('original_count', 0)} ÑÑ‚Ñ€Ð¾Ðº")
        
        log_recovery_attempt(
            component="server",
            action=f"Ð£ÑÐ¿ÐµÑˆÐ½Ð°Ñ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…",
            success=True
        )
        
        return result
        
    except Exception as e:
        error_handler.log_error(
            error=e,
            category=ErrorCategory.PARSING,
            severity=ErrorSeverity.HIGH,
            component="server",
            details={"tool": "filter_excel_data", "filters": filters},
            recovery_action="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ"
        )
        return create_user_friendly_error(e, "Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…")

@handle_errors(
    category=ErrorCategory.PARSING,
    severity=ErrorSeverity.MEDIUM,
    component="mcp_server",
    recovery_action="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ"
)
@mcp.tool()
async def transform_excel_data(data: List[Dict[str, Any]], transformations: Dict[str, Any], 
                              ctx: Context = None) -> dict:
    """
    Transform Excel data according to specified rules
    
    Args:
        data: Source data to transform
        transformations: Dictionary with transformation rules
        ctx: MCP context object
        
    Returns:
        Transformed data
    """
    from .error_handling import (
        create_user_friendly_error,
        ValidationError,
        error_handler,
        ErrorCategory,
        ErrorSeverity,
        log_recovery_attempt
    )
    
    logger.info(f"Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° Ñ‚Ñ€Ð°Ð½ÑÑ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°Ð¼: {transformations}")
    
    try:
        # Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
        if not data or not isinstance(data, list):
            error = ValidationError("Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐºÐ¾Ð¼ ÑÐ»Ð¾Ð²Ð°Ñ€ÐµÐ¹", field="data", value=type(data).__name__)
            return create_user_friendly_error(error, "Ñ‚Ñ€Ð°Ð½ÑÑ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…")
        
        if not transformations or not isinstance(transformations, dict):
            error = ValidationError("ÐŸÑ€Ð°Ð²Ð¸Ð»Ð° Ñ‚Ñ€Ð°Ð½ÑÑ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ ÑÐ»Ð¾Ð²Ð°Ñ€ÐµÐ¼", field="transformations", value=type(transformations).__name__)
            return create_user_friendly_error(error, "Ñ‚Ñ€Ð°Ð½ÑÑ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…")
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
        if excel_tools is None:
            logger.error("Excel Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹")
            return {
                "status": "error",
                "message": "Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ°: Excel Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹",
                "error_code": "COMPONENT_NOT_INITIALIZED",
                "user_message": "Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ",
                "recoverable": True,
                "retry_suggested": True
            }
        
        # Ð¢Ñ€Ð°Ð½ÑÑ„Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ
        result = await excel_tools.transform_excel_data(data, transformations)
        
        logger.info(f"Ð¢Ñ€Ð°Ð½ÑÑ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°: {result.get('transformed_count', 0)} ÑÑ‚Ñ€Ð¾Ðº")
        
        log_recovery_attempt(
            component="server",
            action=f"Ð£ÑÐ¿ÐµÑˆÐ½Ð°Ñ Ñ‚Ñ€Ð°Ð½ÑÑ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…",
            success=True
        )
        
        return result
        
    except Exception as e:
        error_handler.log_error(
            error=e,
            category=ErrorCategory.PARSING,
            severity=ErrorSeverity.HIGH,
            component="server",
            details={"tool": "transform_excel_data", "transformations": transformations},
            recovery_action="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ"
        )
        return create_user_friendly_error(e, "Ñ‚Ñ€Ð°Ð½ÑÑ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…")

@handle_errors(
    category=ErrorCategory.DATABASE,
    severity=ErrorSeverity.HIGH,
    component="mcp_server",
    recovery_action="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ"
)
@mcp.tool()
async def parse_excel_and_save_to_database(file_path: str, sheet_name: Optional[str] = None, 
                                          header_row: int = 0, start_row: Optional[int] = None,
                                          max_rows: Optional[int] = None,
                                          ctx: Context = None) -> dict:
    """
    Parse Excel file and automatically save products to database
    
    Args:
        file_path: Path to Excel file
        sheet_name: Sheet name (if None, uses first sheet)
        header_row: Header row number (0-based)
        start_row: Starting row number for data reading (0-based, after header). If None, starts from header_row + 1
        max_rows: Maximum number of rows to read from start_row. If None, reads all remaining rows
        ctx: MCP context object
        
    Returns:
        Dictionary with parsing and saving results
    """
    from .error_handling import (
        create_user_friendly_error,
        ValidationError,
        error_handler,
        ErrorCategory,
        ErrorSeverity,
        log_recovery_attempt
    )
    
    logger.info(f"Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³ Excel Ñ„Ð°Ð¹Ð»Ð° Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð² Ð‘Ð”: {file_path}")
    
    try:
        # Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
        if not file_path or not isinstance(file_path, str):
            error = ValidationError("ÐÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ ÑƒÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¿ÑƒÑ‚ÑŒ Ðº Excel Ñ„Ð°Ð¹Ð»Ñƒ", field="file_path", value=file_path)
            return create_user_friendly_error(error, "Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³ Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Excel Ñ„Ð°Ð¹Ð»Ð°")
        
        if start_row is not None and start_row < 0:
            error = ValidationError("ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ð°Ñ ÑÑ‚Ñ€Ð¾ÐºÐ° Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ñ‚Ñ€Ð¸Ñ†Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¹", field="start_row", value=start_row)
            return create_user_friendly_error(error, "Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³ Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Excel Ñ„Ð°Ð¹Ð»Ð°")
        
        if max_rows is not None and max_rows <= 0:
            error = ValidationError("ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÑ‚Ñ€Ð¾Ðº Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼", field="max_rows", value=max_rows)
            return create_user_friendly_error(error, "Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³ Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Excel Ñ„Ð°Ð¹Ð»Ð°")
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
        if excel_tools is None:
            logger.error("Excel Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹")
            return {
                "status": "error",
                "message": "Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ°: Excel Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹",
                "error_code": "COMPONENT_NOT_INITIALIZED",
                "user_message": "Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ",
                "recoverable": True,
                "retry_suggested": True
            }
        
        if database_manager is None:
            logger.error("ÐœÐµÐ½ÐµÐ´Ð¶ÐµÑ€ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½")
            return {
                "status": "error",
                "message": "Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ°: Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½",
                "error_code": "COMPONENT_NOT_INITIALIZED",
                "user_message": "Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ",
                "recoverable": True,
                "retry_suggested": True
            }
        
        # Ð¨Ð°Ð³ 1: ÐŸÐ°Ñ€ÑÐ¸Ð¼ Excel Ñ„Ð°Ð¹Ð»
        logger.info("Ð¨Ð°Ð³ 1: ÐŸÐ°Ñ€ÑÐ¸Ð½Ð³ Excel Ñ„Ð°Ð¹Ð»Ð°...")
        
        # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð´Ð»Ñ Ñ‡Ñ‚ÐµÐ½Ð¸Ñ Excel
        if start_row is not None:
            # Ð•ÑÐ»Ð¸ ÑƒÐºÐ°Ð·Ð°Ð½Ð° Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð°Ñ ÑÑ‚Ñ€Ð¾ÐºÐ°, Ð½ÑƒÐ¶Ð½Ð¾ Ð¿Ñ€Ð¾Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ð´Ð¾ Ð½ÐµÑ‘
            skip_rows = start_row
            # Ð§Ð¸Ñ‚Ð°ÐµÐ¼ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¸ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾
            header_result = await excel_tools.parse_excel_file(
                file_path=file_path,
                sheet_name=sheet_name,
                header_row=header_row,
                max_rows=1  # Ð§Ð¸Ñ‚Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¸
            )
            
            if header_result.get("status") != "success":
                logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‡Ñ‚ÐµÐ½Ð¸Ñ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¾Ð² Excel Ñ„Ð°Ð¹Ð»Ð°: {header_result}")
                return {
                    "status": "error",
                    "message": "ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‡Ñ‚ÐµÐ½Ð¸Ñ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¾Ð² Excel Ñ„Ð°Ð¹Ð»Ð°",
                    "parse_result": header_result,
                    "user_message": "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¸ Excel Ñ„Ð°Ð¹Ð»Ð°",
                    "recoverable": True,
                    "retry_suggested": True
                }
            
            # Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð½Ð°Ñ‡Ð¸Ð½Ð°Ñ Ñ ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¸
            # ÐÑƒÐ¶Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð±Ð¾Ð»ÐµÐµ Ð½Ð¸Ð·ÐºÐ¾ÑƒÑ€Ð¾Ð²Ð½ÐµÐ²Ñ‹Ð¹ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ Ð´Ð»Ñ Ñ‡Ñ‚ÐµÐ½Ð¸Ñ Ñ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð½Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¸
            logger.info(f"Ð§Ñ‚ÐµÐ½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ð°Ñ‡Ð¸Ð½Ð°Ñ ÑÐ¾ ÑÑ‚Ñ€Ð¾ÐºÐ¸ {start_row}, Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ {max_rows or 'Ð²ÑÐµ'} ÑÑ‚Ñ€Ð¾Ðº")
            
            # Ð”Ð»Ñ ÑƒÐ¿Ñ€Ð¾Ñ‰ÐµÐ½Ð¸Ñ, Ð¿Ð¾ÐºÐ° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ Ð¼ÐµÑ‚Ð¾Ð´ Ñ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð¸Ñ€Ð¾Ð²ÐºÐ¾Ð¹
            total_rows_to_read = (start_row + max_rows) if max_rows else None
            parse_result = await excel_tools.parse_excel_file(
                file_path=file_path,
                sheet_name=sheet_name,
                header_row=header_row,
                max_rows=total_rows_to_read
            )
            
            if parse_result.get("status") == "success":
                # ÐžÐ±Ñ€ÐµÐ·Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð¾ Ð½ÑƒÐ¶Ð½Ð¾Ð³Ð¾ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ð°
                all_data = parse_result.get("data", [])
                if start_row < len(all_data):
                    end_row = start_row + max_rows if max_rows else len(all_data)
                    parse_result["data"] = all_data[start_row:end_row]
                    parse_result["total_rows"] = len(parse_result["data"])
                    logger.info(f"Ð’Ñ‹Ð±Ñ€Ð°Ð½ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½ ÑÑ‚Ñ€Ð¾Ðº {start_row}-{min(end_row, len(all_data))}, Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ {len(parse_result['data'])} ÑÑ‚Ñ€Ð¾Ðº")
                else:
                    parse_result["data"] = []
                    parse_result["total_rows"] = 0
                    logger.warning(f"ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ð°Ñ ÑÑ‚Ñ€Ð¾ÐºÐ° {start_row} Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐ°ÐµÑ‚ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð² Ñ„Ð°Ð¹Ð»Ðµ ({len(all_data)})")
        else:
            # ÐžÐ±Ñ‹Ñ‡Ð½Ð¾Ðµ Ñ‡Ñ‚ÐµÐ½Ð¸Ðµ Ñ Ð½Ð°Ñ‡Ð°Ð»Ð°
            parse_result = await excel_tools.parse_excel_file(
                file_path=file_path,
                sheet_name=sheet_name,
                header_row=header_row,
                max_rows=max_rows
            )
        
        if parse_result.get("status") != "success":
            logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð° Excel Ñ„Ð°Ð¹Ð»Ð°: {parse_result}")
            return {
                "status": "error",
                "message": "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð° Excel Ñ„Ð°Ð¹Ð»Ð°",
                "parse_result": parse_result,
                "user_message": "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ Excel Ñ„Ð°Ð¹Ð», Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¸ Ð¿ÑƒÑ‚ÑŒ Ðº Ñ„Ð°Ð¹Ð»Ñƒ",
                "recoverable": True,
                "retry_suggested": True
            }
        
        data = parse_result.get("data", [])
        if not data:
            logger.warning("Excel Ñ„Ð°Ð¹Ð» Ð½Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…")
            return {
                "status": "no_data",
                "message": "Excel Ñ„Ð°Ð¹Ð» Ð½Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…",
                "user_message": "Excel Ñ„Ð°Ð¹Ð» Ð¿ÑƒÑÑ‚ Ð¸Ð»Ð¸ Ð½Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸",
                "parse_result": parse_result,
                "recoverable": False,
                "retry_suggested": False
            }
        
        range_info = f" (ÑÑ‚Ñ€Ð¾ÐºÐ¸ {start_row}-{start_row + len(data) - 1})" if start_row is not None else ""
        logger.info(f"Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ Ñ€Ð°ÑÐ¿Ð°Ñ€ÑÐµÐ½Ð¾ {len(data)} ÑÑ‚Ñ€Ð¾Ðº Ð¸Ð· Excel Ñ„Ð°Ð¹Ð»Ð°{range_info}")
        
        # Ð¨Ð°Ð³ 2: Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ Ð² Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…
        logger.info("Ð¨Ð°Ð³ 2: Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð² Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…...")
        saved_count = 0
        updated_count = 0
        errors = []
        saved_products = []
        
        for i, row_data in enumerate(data):
            try:
                # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð¿Ð¾Ð»ÐµÐ¹
                code = row_data.get("ÐšÐ¾Ð´\nÐ¼Ð¾Ð´ÐµÐ»Ð¸") or row_data.get("code")
                model_name = row_data.get("model_name")
                
                if not code or not model_name:
                    error_msg = f"Ð¡Ñ‚Ñ€Ð¾ÐºÐ° {i+1}: Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ð¾Ð»Ñ (ÐºÐ¾Ð´ Ð¸Ð»Ð¸ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð¼Ð¾Ð´ÐµÐ»Ð¸)"
                    errors.append(error_msg)
                    logger.warning(error_msg)
                    continue
                
                # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð»Ð¸ Ñ‚Ð¾Ð²Ð°Ñ€ Ð² Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
                existing_product = await database_manager.get_product_by_code(float(code))
                
                if existing_product:
                    # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ Ñ‚Ð¾Ð²Ð°Ñ€
                    product_data = {
                        "code": float(code),
                        "model_name": model_name,
                        "category": row_data.get("ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ") or row_data.get("category", ""),
                        "unit": row_data.get("Ð•Ð´Ð¸Ð½Ð¸Ñ†Ð° Ð¸Ð·Ð¼ÐµÑ€ÐµÐ½Ð¸Ñ") or row_data.get("unit", ""),
                        "priority_1_source": row_data.get("ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚ \n1 Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ¸") or row_data.get("priority_1_source", ""),
                        "priority_2_source": row_data.get("ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚ \n2 Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ¸") or row_data.get("priority_2_source", "")
                    }
                    
                    success = await database_manager.update_product(product_data)
                    if success:
                        updated_count += 1
                        saved_products.append({
                            "code": code,
                            "model_name": model_name,
                            "action": "updated"
                        })
                        logger.info(f"ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½ Ñ‚Ð¾Ð²Ð°Ñ€ Ñ ÐºÐ¾Ð´Ð¾Ð¼ {code}")
                    else:
                        error_msg = f"Ð¡Ñ‚Ñ€Ð¾ÐºÐ° {i+1}: Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€ Ñ ÐºÐ¾Ð´Ð¾Ð¼ {code}"
                        errors.append(error_msg)
                        logger.warning(error_msg)
                else:
                    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ‚Ð¾Ð²Ð°Ñ€
                    try:
                        product_id = await database_manager.save_product(row_data)
                        saved_count += 1
                        saved_products.append({
                            "code": code,
                            "model_name": model_name,
                            "action": "created",
                            "id": product_id
                        })
                        logger.info(f"Ð¡Ð¾Ð·Ð´Ð°Ð½ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ‚Ð¾Ð²Ð°Ñ€ Ñ ÐºÐ¾Ð´Ð¾Ð¼ {code}, ID: {product_id}")
                    except Exception as save_error:
                        error_msg = f"Ð¡Ñ‚Ñ€Ð¾ÐºÐ° {i+1}: Ð¾ÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ñ ÐºÐ¾Ð´Ð¾Ð¼ {code}: {save_error}"
                        errors.append(error_msg)
                        logger.error(error_msg)
                        
            except Exception as row_error:
                error_msg = f"Ð¡Ñ‚Ñ€Ð¾ÐºÐ° {i+1}: Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸: {row_error}"
                errors.append(error_msg)
                logger.error(error_msg)
        
        # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð¸Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚
        total_processed = saved_count + updated_count
        
        if total_processed > 0:
            logger.info(f"Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾ {total_processed} Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²: {saved_count} Ð½Ð¾Ð²Ñ‹Ñ…, {updated_count} Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾")
            log_recovery_attempt(
                component="server",
                action=f"Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ {total_processed} Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð¸Ð· Excel Ð² Ð‘Ð”",
                success=True
            )
            
            response = {
                "status": "success",
                "message": f"Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾ {total_processed} Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð¸Ð· Excel Ñ„Ð°Ð¹Ð»Ð°",
                "file_path": file_path,
                "start_row": start_row,
                "rows_requested": max_rows,
                "total_rows_parsed": len(data),
                "products_created": saved_count,
                "products_updated": updated_count,
                "total_processed": total_processed,
                "products_saved": saved_products,
                "parse_info": {
                    "sheet_name": parse_result.get("sheet_name"),
                    "columns": parse_result.get("columns"),
                    "available_sheets": parse_result.get("available_sheets"),
                    "data_range": f"ÑÑ‚Ñ€Ð¾ÐºÐ¸ {start_row}-{start_row + len(data) - 1}" if start_row is not None else "Ð²ÑÐµ ÑÑ‚Ñ€Ð¾ÐºÐ¸"
                },
                "timestamp": datetime.now().isoformat()
            }
            
            if errors:
                response["warnings"] = errors
                response["errors_count"] = len(errors)
                
            return response
        else:
            logger.warning("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð½Ð¸ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð°")
            return {
                "status": "no_data",
                "message": "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð½Ð¸ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð°",
                "user_message": "Ð’ÑÐµ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Excel Ñ„Ð°Ð¹Ð»Ð° ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð¸Ð»Ð¸ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ð¾Ð»Ñ",
                "file_path": file_path,
                "start_row": start_row,
                "rows_requested": max_rows,
                "total_rows_parsed": len(data),
                "errors": errors,
                "errors_count": len(errors),
                "recoverable": True,
                "retry_suggested": True
            }
        
    except Exception as e:
        error_handler.log_error(
            error=e,
            category=ErrorCategory.DATABASE,
            severity=ErrorSeverity.HIGH,
            component="server",
            details={"tool": "parse_excel_and_save_to_database", "file_path": file_path},
            recovery_action="Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ"
        )
        return create_user_friendly_error(e, "Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³ Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Excel Ñ„Ð°Ð¹Ð»Ð°")

# Runners
async def run_stdio():
    print("Ð—Ð°Ð¿ÑƒÑÐº MCP ÑÐµÑ€Ð²ÐµÑ€Ð° offers-check-marketplaces Ð² Ñ€ÐµÐ¶Ð¸Ð¼Ðµ STDIO")
    print(f"ID Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ: {APP_ID}")
    print(f"Ð’ÐµÑ€ÑÐ¸Ñ Python: {sys.version}")
    print(f"Ð Ð°Ð±Ð¾Ñ‡Ð°Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: {os.getcwd()}")
    print(f"ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ:")
    for key in ['HOST', 'PORT', 'DEBUG']:
        value = os.getenv(key, 'Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾')
        print(f"   {key}: {value}")
    
    # Initialize all system components
    print("Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹...")
    try:
        await initialize_components()
        print("ÐšÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹")
    except Exception as e:
        print(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸: {e}")
        print("ÐŸÑ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° Ð¸Ð·-Ð·Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸")
        sys.exit(1)
    
    # Show registered tools
    print("Ð—Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ MCP Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹:")
    print("   1. get_product_details - Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ðµ")
    print("   2. get_product_list - ÑÐ¿Ð¸ÑÐ¾Ðº Ð²ÑÐµÑ… SKU Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²")
    print("   3. get_statistics - ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¿Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ð¼ Ñ‚Ð¾Ð²Ð°Ñ€Ð°Ð¼")
    print("   4. save_product_prices - ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ñ… Ñ†ÐµÐ½ Ð² Ð‘Ð”")
    print("   5. check_license_status - Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¸")
    print("   6. set_license_key - ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¾Ð½Ð½Ð¾Ð³Ð¾ ÐºÐ»ÑŽÑ‡Ð°")
    
    print("ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ñ‡ÐµÑ€ÐµÐ· STDIO...")
    await mcp.run_stdio_async()

async def run_sse_async(host: str, port: int):
    print("Ð—Ð°Ð¿ÑƒÑÐº MCP ÑÐµÑ€Ð²ÐµÑ€Ð° offers-check-marketplaces Ð² Ñ€ÐµÐ¶Ð¸Ð¼Ðµ SSE")
    print(f"ID Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ: {APP_ID}")
    print(f"Ð’ÐµÑ€ÑÐ¸Ñ Python: {sys.version}")
    print(f"Ð Ð°Ð±Ð¾Ñ‡Ð°Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: {os.getcwd()}")
    print(f"Ð¥Ð¾ÑÑ‚: {host}")
    print(f"ÐŸÐ¾Ñ€Ñ‚: {port}")
    print(f"URL ÑÐµÑ€Ð²ÐµÑ€Ð°: http://{host}:{port}")
    print(f"ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ:")
    for key in ['HOST', 'PORT', 'DEBUG']:
        value = os.getenv(key, 'Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾')
        print(f"   {key}: {value}")
    
    # Initialize all system components
    print("Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹...")
    try:
        await initialize_components()
        print("ÐšÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹")
    except Exception as e:
        print(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸: {e}")
        print("ÐŸÑ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° Ð¸Ð·-Ð·Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸")
        sys.exit(1)
    
    # Show registered tools
    print("Ð—Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ MCP Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹:")
    print("   1. get_product_details - Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ðµ")
    print("   2. get_product_list - ÑÐ¿Ð¸ÑÐ¾Ðº Ð²ÑÐµÑ… SKU Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²")
    print("   3. get_statistics - ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¿Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ð¼ Ñ‚Ð¾Ð²Ð°Ñ€Ð°Ð¼")
    print("   4. save_product_prices - ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ñ… Ñ†ÐµÐ½ Ð² Ð‘Ð”")
    print("   5. check_license_status - Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¸")
    print("   6. set_license_key - ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¾Ð½Ð½Ð¾Ð³Ð¾ ÐºÐ»ÑŽÑ‡Ð°")
    
    print("Ð—Ð°Ð¿ÑƒÑÐº Uvicorn ÑÐµÑ€Ð²ÐµÑ€Ð°...")
    
    # Create uvicorn config and server
    config = uvicorn.Config(starlette_app, host=host, port=port, log_level="info")
    server = uvicorn.Server(config)
    
    # Run server in current event loop
    await server.serve()

def run_sse(host: str, port: int):
    anyio.run(run_sse_async, host, port)

# CLI
@click.command()
@click.option("--sse", is_flag=True, help="Start as SSE server (otherwise stdio).")
@click.option("--host", default=lambda: os.getenv("HOST", "0.0.0.0"),
              show_default=True, help="Host for SSE mode")
@click.option("--port", type=int, default=lambda: int(os.getenv("PORT", 8000)),
              show_default=True, help="Port for SSE mode")
def main(sse: bool, host: str, port: int):
    print("=" * 60)
    print("Begin start MCP offers-check-marketplaces")
    print("=" * 60)
    print(f"* Ð ÐµÐ¶Ð¸Ð¼ Ð·Ð°Ð¿ÑƒÑÐºÐ°: {'SSE' if sse else 'STDIO'}")
    print(f"* Ð’Ñ€ÐµÐ¼Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°: {os.getenv('TZ', 'ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ')}")
    print(f"* ÐŸÐ»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ð°: {sys.platform}")
    print(f"* Ð”Ð¾Ð¼Ð°ÑˆÐ½ÑÑ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: {os.path.expanduser('~')}")
    print("=" * 60)
    
    if sse:
        run_sse(host, port)
    else:
        anyio.run(run_stdio)

if __name__ == "__main__":
    main()