# Документ требований

## Введение

Данная функция включает создание полнофункционального MCP (Model Context Protocol) сервера под названием `offers-check-marketplaces`, который автоматизирует поиск товаров и сравнение цен на различных маркетплейсах. Сервер будет интегрирован с MCP Playwright для возможностей веб-скрапинга и обработки Excel данных для генерации комплексных отчетов по сравнению цен.

Система будет читать данные о товарах из входного Excel файла (`data/Таблица на вход.xlsx`), искать товары на множественных маркетплейсах (Комус, ВсеИнструменты и др.), собирать информацию о ценах и генерировать выходной Excel файл (`data/Таблица на выход (отработанная).xlsx`) с полным анализом и сравнением цен.

## Требования

### Требование 1

**Пользовательская история:** Как разработчик, я хочу создать MCP сервер, который отображается в списке MCP серверов, чтобы использовать его для автоматизации сравнения цен на маркетплейсах.

#### Критерии приемки

1. КОГДА MCP сервер настроен, ТО сервер ДОЛЖЕН отображаться как `offers-check-marketplaces` в списке MCP серверов
2. КОГДА сервер инициализирован, ТО он ДОЛЖЕН зарегистрировать три инструмента: `search_products`, `get_statistics` и `get_product_details`
3. КОГДА сервер запускается, ТО он ДОЛЖЕН успешно подключиться и быть готовым к получению вызовов инструментов

### Требование 2

**Пользовательская история:** Как пользователь, я хочу обрабатывать входные Excel данные в структурированный формат, чтобы система могла программно работать с информацией о товарах.

#### Критерии приемки

1. КОГДА система читает `data/Таблица на вход.xlsx`, ТО она ДОЛЖНА парсить данные в JSON формат с точной структурой:

```json
[
  {
    "Код\nмодели": 195385.0,
    "model_name": "Полотно техническое БЯЗЬ ОТБЕЛЕННАЯ ГОСТ, рулон 1,5х50 м, плотность 140 (±5) г/м2, в пакете, LAIMA, 607520",
    "Категория": "Хозтовары и посуда",
    "Единица измерения": "м",
    "Приоритет \n1 Источники": "Комус",
    "Приоритет \n2 Источники": "ВсеИнструменты",
    "Цена позиции\nМП c НДС": "",
    "Цена позиции\nB2C c НДС": "",
    "Дельта в процентах": "",
    "Ссылка на источник": "",
    "Цена 2 позиции\nB2C c НДС": ""
  }
]
```

2. КОГДА парсятся Excel данные, ТО система ДОЛЖНА корректно обрабатывать отсутствующие или пустые ячейки, сохраняя пустые строки для ценовых полей
3. КОГДА создается JSON структура, ТО она ДОЛЖНА точно соответствовать указанному формату с сохранением всех символов переноса строк в названиях полей
4. КОГДА данные обработаны, ТО система ДОЛЖНА сохранить их в SQLite базу данных для эффективных запросов с сохранением исходной структуры полей

### Требование 3

**Пользовательская история:** Как пользователь, я хочу искать товары на множественных маркетплейсах, чтобы найти актуальную ценовую информацию для сравнения.

#### Критерии приемки

1. КОГДА вызывается инструмент `search_products` с названием модели товара, ТО система ДОЛЖНА искать на источниках приоритета 1 и приоритета 2
2. КОГДА выполняется поиск на маркетплейсах, ТО система ДОЛЖНА делегировать веб-скрапинг MCP Playwright серверу, работая в связке с ним
3. КОГДА товар найден, ТО система ДОЛЖНА извлечь информацию о цене, наличии и URL товара
4. КОГДА поиск завершен, ТО система ДОЛЖНА вернуть структурированные данные с названием маркетплейса, ценой, валютой, статусом наличия и ссылкой на товар
5. ЕСЛИ товар не найден на маркетплейсе, ТО система ДОЛЖНА вернуть соответствующий статус, указывающий на недоступность

### Требование 4

**Пользовательская история:** Как пользователь, я хочу получать детальную информацию о товаре включая сравнение цен, чтобы анализировать рыночное позиционирование и ценовые стратегии.

#### Критерии приемки

1. КОГДА вызывается инструмент `get_product_details` с кодом товара, ТО система ДОЛЖНА вернуть полную информацию о товаре из базы данных
2. КОГДА извлекаются детали товара, ТО система ДОЛЖНА включить текущие цены со всех найденных маркетплейсов
3. КОГДА существуют ценовые данные, ТО система ДОЛЖНА рассчитать процентную дельту между ценами разных маркетплейсов
4. КОГДА возвращаются детали, ТО система ДОЛЖНА включить категорию товара, единицу измерения и информацию о приоритетных источниках
5. ЕСЛИ доступны данные сравнения цен, ТО система ДОЛЖНА определить самые низкие и высокие цены с указанием источников

### Требование 5

**Пользовательская история:** Как пользователь, я хочу получать статистику об обработанных товарах и сравнении цен, чтобы понимать общие результаты рыночного анализа.

#### Критерии приемки

1. КОГДА вызывается инструмент `get_statistics`, ТО система ДОЛЖНА вернуть общее количество обработанных товаров
2. КОГДА генерируется статистика, ТО система ДОЛЖНА включить количество товаров с успешными совпадениями цен
3. КОГДА рассчитывается статистика, ТО система ДОЛЖНА предоставить средние процентные дельты цен по всем товарам
4. КОГДА генерируется статистика, ТО система ДОЛЖНА включить разбивку по категориям товаров
5. КОГДА возвращается статистика, ТО система ДОЛЖНА включить информацию о покрытии маркетплейсов (сколько товаров найдено на каждом маркетплейсе)

### Требование 6

**Пользовательская история:** Как пользователь, я хочу, чтобы система генерировала комплексный выходной Excel файл, чтобы я мог просматривать и делиться полным анализом сравнения цен.

#### Критерии приемки

1. КОГДА все товары обработаны, ТО система ДОЛЖНА сгенерировать `data/Таблица на выход (отработанная).xlsx`
2. КОГДА создается выходной файл, ТО он ДОЛЖЕН включать все исходные данные о товарах плюс собранную ценовую информацию
3. КОГДА записываются ценовые данные, ТО система ДОЛЖНА заполнить поля Цена позиции МП c НДС, Цена позиции B2C c НДС, Дельта в процентах, Ссылка на источник, Цена 2 позиции B2C c НДС
4. КОГДА рассчитываются дельты, ТО система ДОЛЖНА вычислить процентные различия между ценами маркетплейсов
5. КОГДА вывод завершен, ТО Excel файл ДОЛЖЕН сохранить ту же структуру, что и входной файл, но с заполненными ценовыми данными

### Требование 7

**Пользовательская история:** Как разработчик, я хочу, чтобы MCP сервер корректно обрабатывал ошибки, чтобы система оставалась стабильной во время операций скрапинга маркетплейсов.

#### Критерии приемки

1. КОГДА маркетплейс недоступен, ТО система ДОЛЖНА продолжить обработку других маркетплейсов
2. КОГДА веб-скрапинг не удается, ТО система ДОЛЖНА записать ошибку в лог и вернуть соответствующий статус
3. КОГДА чтение Excel файла не удается, ТО система ДОЛЖНА предоставить понятные сообщения об ошибках
4. КОГДА операции с базой данных не удаются, ТО система ДОЛЖНА обрабатывать исключения и поддерживать целостность данных
5. КОГДА вызовы инструментов получают недопустимые параметры, ТО система ДОЛЖНА возвращать описательные сообщения об ошибках

### Требование 8

**Пользовательская история:** Как пользователь, я хочу, чтобы система поддерживала интеграции с множественными маркетплейсами, чтобы эффективно сравнивать цены на разных платформах.

#### Критерии приемки

1. КОГДА система настроена, ТО она ДОЛЖНА поддерживать следующие маркетплейсы через MCP Playwright:
   - komus.ru (Комус)
   - vseinstrumenti.ru (ВсеИнструменты)
   - ozon.ru (Озон)
   - wildberries.ru (Wildberries)
   - officemag.ru (Офисмаг)
2. КОГДА выполняется поиск товаров, ТО система ДОЛЖНА использовать приоритетные источники из Excel данных для определения порядка поиска
3. КОГДА добавляются новые маркетплейсы, ТО система ДОЛЖНА использовать подключаемую архитектуру для легкого расширения
4. КОГДА выполняется скрапинг маркетплейсов, ТО система ДОЛЖНА передавать задачи веб-скрапинга MCP Playwright серверу через соответствующие вызовы инструментов
5. КОГДА изменяется структура маркетплейса, ТО система ДОЛЖНА предоставлять настраиваемые селекторы для передачи в MCP Playwright
6. КОГДА система инициализируется, ТО она ДОЛЖНА загрузить конфигурацию для всех поддерживаемых маркетплейсов с их URL и селекторами для передачи в MCP Playwright
7. КОГДА система работает с веб-скрапингом, ТО она ДОЛЖНА понимать, что является координирующим сервером, а не выполняет скрапинг напрямую

### Требование 9

**Пользовательская история:** Как ИИ-агент, я хочу получать четкие инструкции и контекст от MCP сервера, чтобы понимать как правильно использовать инструменты для сравнения цен.

#### Критерии приемки

1. КОГДА MCP сервер инициализируется, ТО он ДОЛЖЕН предоставить системный промпт с описанием своего назначения и возможностей
2. КОГДА ИИ-агент подключается к серверу, ТО сервер ДОЛЖЕН предоставить инструкции по использованию каждого инструмента
3. КОГДА предоставляются промпты, ТО они ДОЛЖНЫ включать примеры использования инструментов для типичных сценариев
4. КОГДА описываются инструменты, ТО промпт ДОЛЖЕН объяснить последовательность действий: загрузка данных → поиск товаров → получение деталей → генерация статистики
5. КОГДА инициализируется контекст, ТО промпт ДОЛЖЕН включать информацию о поддерживаемых маркетплейсах и форматах данных
