name: Create Bioconda PR

# Creates pull request to bioconda-recipes repository
# Triggered when GitHub release is published or manually
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.2.0)'
        required: true
  release:
    types: [published]

jobs:
  create-bioconda-pr:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Get version
      id: version
      run: |
        if [ "${{ github.event_name }}" == "release" ]; then
          VERSION="${{ github.event.release.tag_name }}"
        else
          VERSION="v${{ github.event.inputs.version }}"
        fi
        # Store both with and without 'v' prefix
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "version_clean=${VERSION#v}" >> $GITHUB_OUTPUT
    
    - name: Generate Bioconda recipe
      run: |
        pip install requests pyyaml
        python .github/scripts/update_bioconda.py
      env:
        GITHUB_REF: "refs/tags/${{ steps.version.outputs.version }}"
        RELEASE_VERSION: "${{ steps.version.outputs.version_clean }}"
    
    - name: Fork and clone bioconda-recipes
      run: |
        # This uses GitHub CLI to fork if needed and clone
        gh repo fork bioconda/bioconda-recipes --clone=true --remote=true
        cd bioconda-recipes
        
        # Set up git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Create branch
        BRANCH="update-remag-${{ steps.version.outputs.version }}"
        git checkout -b $BRANCH
        
        # Copy recipe
        mkdir -p recipes/remag
        cp ../.github/bioconda-recipe/meta.yaml recipes/remag/
        
        # Commit
        git add recipes/remag/meta.yaml
        git commit -m "Update remag to ${{ steps.version.outputs.version }}"
        
        # Push to fork
        git push origin $BRANCH
        
        # Create PR  
        cat << 'EOF' > pr_body.txt
        This PR updates REMAG to version ${{ steps.version.outputs.version }}.

        REMAG is a specialized metagenomic binning tool designed for recovering high-quality eukaryotic genomes from mixed prokaryotic-eukaryotic samples.

        - **homepage**: https://github.com/danielzmbp/remag
        - **documentation**: https://github.com/danielzmbp/remag#readme
        - **doi**: [10.5281/zenodo.16443991](https://doi.org/10.5281/zenodo.16443991)

        This PR was automatically generated by the REMAG release workflow.
        EOF
        
        gh pr create \
          --repo bioconda/bioconda-recipes \
          --head danielzmbp:$BRANCH \
          --title "Update remag to ${{ steps.version.outputs.version }}" \
          --body-file pr_body.txt
      env:
        GH_TOKEN: ${{ secrets.BIOCONDA_PAT }}
    
    - name: Comment on PR
      if: success()
      run: |
        echo "Bioconda PR created successfully!"
        echo "Check https://github.com/bioconda/bioconda-recipes/pulls?q=is%3Apr+author%3Adanielzmbp"