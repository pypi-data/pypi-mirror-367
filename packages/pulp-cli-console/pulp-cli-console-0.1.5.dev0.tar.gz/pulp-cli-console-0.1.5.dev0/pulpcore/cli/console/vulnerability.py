from typing import IO

import click
from pulp_glue.common.context import PulpContext, PulpEntityContext
from pulp_glue.console.context import PulpVulnerabilityReportContext

from pulpcore.cli.common.generic import (
    PulpCLIContext,
    chunk_size_option,
    href_option,
    list_command,
    pass_entity_context,
    pass_pulp_context,
    show_command,
)


def attach_vulnerability_commands(console_group: click.Group) -> None:
    @console_group.group()
    @pass_pulp_context
    @click.pass_context
    def vulnerability(ctx: click.Context, pulp_ctx: PulpContext, /) -> None:
        """Manage vulnerability reports."""
        ctx.obj = PulpVulnerabilityReportContext(pulp_ctx)

    lookup_options = [href_option]

    @vulnerability.command()
    @click.option(
        "--file",
        type=click.File("rb"),
        required=True,
        help="Package Lock JSON file with NPM packages to upload",
    )
    @chunk_size_option
    @pass_entity_context
    @pass_pulp_context
    def npm(
        pulp_ctx: PulpCLIContext,
        vulnerability_ctx: PulpEntityContext,
        /,
        file: IO[bytes],
        chunk_size: int,
    ) -> None:
        """Create a vulnerability report from NPM package JSON file."""
        assert isinstance(vulnerability_ctx, PulpVulnerabilityReportContext)
        result = vulnerability_ctx.create_report(file, chunk_size)
        pulp_ctx.output_result(result)

    @vulnerability.command()
    @click.option(
        "--repo-version",
        required=True,
        help="Repository version reference to use for the report, e.g. "
        "'/api/pulp/{Domain-Name}/api/v3/repositories/rpm/rpm/{Repository-ID}/versions/1/'",
    )
    @pass_entity_context
    @pass_pulp_context
    def rpm(
        pulp_ctx: PulpCLIContext,
        vulnerability_ctx: PulpEntityContext,
        /,
        repo_version: str,
    ) -> None:
        """Create a vulnerability report from an RPM repository version."""
        assert isinstance(vulnerability_ctx, PulpVulnerabilityReportContext)
        result = vulnerability_ctx.create_rpm_report(repo_version)
        pulp_ctx.output_result(result)

    # Add commands to the vulnerability group
    vulnerability.add_command(list_command())
    vulnerability.add_command(show_command(decorators=lookup_options))
