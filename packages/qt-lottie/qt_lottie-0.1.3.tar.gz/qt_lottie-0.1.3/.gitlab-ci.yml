stages:
  - build
  - test
  - deploy-testpypi
  - deploy-pypi

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"
  # Prevent Qt from trying to use GUI
  QT_QPA_PLATFORM: "offscreen"

cache:
  paths:
    - .pip-cache/

build:
  stage: build
  image: python:3.10
  before_script:
    - pip install --upgrade pip setuptools wheel build setuptools-scm
  script:
    - python -m build
  artifacts:
    paths:
      - dist/

test:
  stage: test
  image: python:3.10
  before_script:
    # Install system dependencies for Qt
    - apt-get update -qq && apt-get install -y -qq 
        libgl1-mesa-glx libgl1-mesa-dri libegl1-mesa 
        libxrender1 libxrandr2 libxkbcommon0 libdbus-1-3 
        libfontconfig1 libfreetype6 libxss1 libglib2.0-0 xvfb
    # Start virtual display
    - Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
    - sleep 2
    # Install Qt binding
    - pip install PySide6>=6.0.0
  script:
    - pip install dist/*.whl
    - python -c "import qtlottie; print('✓ qtlottie import successful')"
    - python -c "from qtlottie.compat import get_binding_info; print('✓ Binding info:', get_binding_info())"
    - python -c "from qtlottie.core.animation import LottieAnimation; print('✓ LottieAnimation import successful')"
    - python -c "import PIL; print('✓ Pillow available:', PIL.__version__)"
    - python -c "from qtlottie.rlottie.wrapper import RLottieWrapper; w=RLottieWrapper(); print('✓ RLottie wrapper created')"
  environment:
    name: test
  variables:
    DISPLAY: ":99"

deploy-testpypi:
  stage: deploy-testpypi
  image: python:3.10
  before_script:
    - pip install --upgrade twine
  script:
    - TWINE_PASSWORD=$TWINE_PASSWORD_TESTPYPI twine upload --repository testpypi dist/* --verbose
  rules:
    - if: '$CI_COMMIT_TAG =~ /-dev|-rc/'
  environment:
    name: testpypi
    url: https://test.pypi.org/project/qt-lottie/

deploy-pypi:
  stage: deploy-pypi
  image: python:3.10
  before_script:
    - pip install --upgrade twine
  script:
    - TWINE_PASSWORD=$TWINE_PASSWORD_PYPI twine upload dist/* --verbose
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
      when: manual
  environment:
    name: production
    url: https://pypi.org/project/qt-lottie/